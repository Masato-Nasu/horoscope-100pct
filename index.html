<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>100% 星占い</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#6b46c1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #fff;
      color: #000;
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }
    input, select, button {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      background: #6b46c1;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .card {
      background: #f9f9f9;
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #output {
      display: none;
    }
  </style>
</head>
<body>
  <h1>100% 星占い</h1>

  <div class="card">
    <label>都市名</label>
    <input id="placeName" type="text" placeholder="Tokyo, Japan">

    <label>タイムゾーン</label>
    <select id="tzSelect" onchange="toggleTzInput(this.value)">
      <option value="Asia/Tokyo">Asia/Tokyo</option>
      <option value="Asia/Seoul">Asia/Seoul</option>
      <option value="Asia/Shanghai">Asia/Shanghai</option>
      <option value="Asia/Taipei">Asia/Taipei</option>
      <option value="Europe/London">Europe/London</option>
      <option value="Europe/Paris">Europe/Paris</option>
      <option value="America/New_York">America/New_York</option>
      <option value="America/Los_Angeles">America/Los_Angeles</option>
      <option value="UTC">UTC</option>
    </select>

    <label>緯度</label>
    <input id="lat" type="text" placeholder="35.6895">

    <label>経度</label>
    <input id="lon" type="text" placeholder="139.6917">

    <label>解析日時</label>
    <input id="targetDatetime" type="datetime-local">

    <button id="geocodeBtn" type="button">都市名から緯度経度を取得</button>
    <button id="calcBtn" type="button">本格解析を実行</button>
    <button id="fillBtn" type="button" style="background:#7c5cf3">デモ値を入力</button>
  </div>

  <div id="output" class="card"></div>

  <script>
    // ===== 入力保存・復元 =====
    function saveInputs(){
      const data = {
        place: document.getElementById('placeName').value,
        tz: document.getElementById('tzSelect').value,
        lat: document.getElementById('lat').value,
        lon: document.getElementById('lon').value,
        when: document.getElementById('targetDatetime').value
      };
      localStorage.setItem("horoscope.inputs", JSON.stringify(data));
    }
    function restoreInputs(){
      try{
        const d = JSON.parse(localStorage.getItem("horoscope.inputs"));
        if(!d) return;
        document.getElementById('placeName').value = d.place || "";
        document.getElementById('tzSelect').value = d.tz || "Asia/Tokyo";
        document.getElementById('lat').value = d.lat || "";
        document.getElementById('lon').value = d.lon || "";
        document.getElementById('targetDatetime').value = d.when || "";
      }catch(_){}
    }

    // ===== Geocode =====
    async function robustGeocode(name){
      const endpoint = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q="+encodeURIComponent(name);
      const proxied = "https://api.allorigins.win/raw?url="+encodeURIComponent(endpoint);
      const resp = await fetch(proxied,{cache:"no-store"});
      if(!resp.ok) throw new Error("HTTP "+resp.status);
      const arr = await resp.json();
      if(!arr.length) throw new Error("no result");
      return {lat: parseFloat(arr[0].lat), lon: parseFloat(arr[0].lon)};
    }

    async function onGeocodeClick(){
      const name = document.getElementById('placeName').value;
      if(!name.trim()){ alert("都市名を入力してください"); return; }
      try{
        const geo = await robustGeocode(name);
        document.getElementById('lat').value = geo.lat;
        document.getElementById('lon').value = geo.lon;
        saveInputs();
      }catch(e){
        alert("位置情報の取得に失敗しました。緯度・経度を手入力してください。");
        console.error(e);
      }
    }

    // ===== 占い本体（ダミー算出） =====
    function renderResult(scores){
      const out = document.getElementById('output');
      out.style.display="block";
      out.innerHTML = `
        <h2>いまの全体感：${scores.total}%</h2>
        <p><strong>恋愛：</strong>${scores.love}%</p>
        <p><strong>仕事：</strong>${scores.work}%</p>
        <p><strong>金運：</strong>${scores.money}%</p>
        <p><strong>健康：</strong>${scores.health}%</p>
        <p style="color:#666"><em>今日の一歩を大切に。</em></p>
      `;
    }

    async function onCalcClick(){
      try{
        const lat = parseFloat(document.getElementById('lat').value);
        const lon = parseFloat(document.getElementById('lon').value);
        if(!isFinite(lat)||!isFinite(lon)){ alert("緯度・経度を入力してください"); return; }
        const seed = Math.abs(Math.sin(Date.now()/86400000 + lat*0.1 + lon*0.1))*10000|0;
        const prng = (n)=>{ const x=Math.sin(seed+n)*10000; return x-Math.floor(x); };
        const scores = {
          total: Math.round(40+prng(1)*60),
          love:  Math.round(30+prng(2)*70),
          work:  Math.round(30+prng(3)*70),
          money: Math.round(30+prng(4)*70),
          health:Math.round(30+prng(5)*70)
        };
        renderResult(scores);
        saveInputs();
      }catch(e){
        const out=document.getElementById('output');
        out.style.display="block";
        out.innerHTML=`<div style="padding:10px;border:1px solid #f3c;background:#fff0fb;border-radius:8px;">
          <strong>実行エラー</strong><br><code>${String(e?.message||e)}</code>
        </div>`;
      }
    }

    // ===== デモ値入力 =====
    function onFillClick(){
      document.getElementById('placeName').value="Tokyo, Japan";
      document.getElementById('tzSelect').value="Asia/Tokyo";
      document.getElementById('lat').value="35.6895";
      document.getElementById('lon').value="139.6917";
      document.getElementById('targetDatetime').value="";
      saveInputs();
    }

    // ===== イベント配線（onclickを使わず確実に実行される） =====
    document.addEventListener("DOMContentLoaded", ()=>{
      restoreInputs();
      document.getElementById("geocodeBtn").addEventListener("click", onGeocodeClick);
      document.getElementById("calcBtn").addEventListener("click", onCalcClick);
      document.getElementById("fillBtn").addEventListener("click", onFillClick);
    });
  </script>
</body>
</html>
