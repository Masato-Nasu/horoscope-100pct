<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>æœ¬æ ¼æ˜Ÿå ã„ (Astro Logic)</title>
<meta name="theme-color" content="#6b46c1">

<link rel="apple-touch-icon" href="/horoscope-100pct/icon-192.png">
<link rel="icon" href="/horoscope-100pct/favicon.svg" type="image/svg+xml">

<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js?v=final"></script>

<style>
/* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
body{font-family:'Noto Sans JP',system-ui,-apple-system,sans-serif;background:#fafafa;color:#222;margin:0;text-align:center; padding-bottom: 80px;}
header{background:#6b46c1;color:#fff;padding:1.2em 0;font-weight:700;font-size:1.3em}
main{padding:1.2em;max-width:720px;margin:0 auto}
input,button{font:inherit;padding:.8em;border-radius:.6em;border:1px solid #ccc;box-sizing:border-box;width:100%}
button{background:#6b46c1;color:#fff;border:none;cursor:pointer;margin-top:15px;font-weight:bold;font-size:1.1em;box-shadow: 0 4px 6px rgba(107, 70, 193, 0.3);} 
button:active{transform: translateY(2px);}

.card{background:#fff;border-radius:1em;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:1.1em;margin-top:1em;text-align:left}
.muted{color:#666;font-size:.9em}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between}
.title{font-weight:700}
.score{display:flex;align-items:center;gap:8px;margin-left:auto}
.zodiac-badge { background: #f3e8ff; color: #6b46c1; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em; }

/* è¨ºæ–­ç”¨è¡¨ç¤º */
.debug-info { font-size: 0.75em; color: #999; margin-top: 5px; border-top: 1px dashed #eee; padding-top: 5px; }

/* èµ·å‹•ç”»é¢ */
#app-splash { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
#app-splash.fadeout { opacity: 0; pointer-events: none; }
.spinner { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #6b46c1; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#confettiCanvas{position:fixed;inset:0;pointer-events:none;z-index:5000}
</style>
</head>
<body>

<div id="app-splash">
  <div class="title" style="font-weight:bold; margin-bottom:10px;">æ˜Ÿå ã„</div>
  <div class="spinner"></div>
  <div id="loading-msg" style="margin-top:10px; font-size:0.8em; color:#666;">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
</div>

<header>æœ¬æ ¼ å¤©ä½“æ˜Ÿå ã„</header>

<main>
<section id="inputArea">
  <div class="card">
    <h3>ğŸ“ ã‚ãªãŸã®æƒ…å ±</h3>
    <label>ç”Ÿå¹´æœˆæ—¥ <span style="color:red">*</span></label>
    <input type="date" id="birthDate"><br><br>
    
    <label>å‡ºç”Ÿæ™‚åˆ»ï¼ˆä¸æ˜ãªã‚‰12:00ã§OKï¼‰</label>
    <input type="time" id="birthTime" value="12:00"><br><br>
    
    <label>å‡ºç”Ÿéƒ½å¸‚ï¼ˆæ±äº¬ä»¥å¤–ãªã‚‰å…¥åŠ›ï¼‰</label>
    <input type="text" id="placeName" placeholder="Tokyo">
    <button id="geoBtn" type="button" style="background:#888; margin-top:5px; font-size:0.9em;">éƒ½å¸‚åã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’æ¤œç´¢</button>
    <input type="hidden" id="lat" value="35.6895">
    <input type="hidden" id="lon" value="139.6917">
  </div>

  <div class="card" style="border: 2px solid #ffd166;">
    <h3>ğŸ”® å ã„ãŸã„æ—¥</h3>
    <label>æ—¥ä»˜ï¼ˆæœªæ¥ã‚„éå»ã®æ—¥ä»˜ã‚‚OKï¼‰</label>
    <input type="date" id="targetDate">
  </div>

  <button id="runBtn" type="button">ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä½œæˆ</button>
  
  <div style="margin-top:30px; text-align:center;">
    <button onclick="hardReload()" style="background:#666; font-size:0.8em; padding:5px 10px; width:auto;">â†» ä¿®å¾©ãƒ»å†èª­ã¿è¾¼ã¿</button>
  </div>
</section>

<section id="outputArea" style="display:none;">
  <h2>é‘‘å®šçµæœ</h2>
  <div id="resultContainer"></div>
  <div style="margin-top:20px;">
    <button id="backBtn" type="button" style="background:#666;">æˆ»ã‚‹</button>
  </div>
</section>
</main>

<canvas id="confettiCanvas" style="display:none;"></canvas>

<script>
const $ = id => document.getElementById(id);
function saveInputs(){
  const d={birthDate:$('birthDate').value, birthTime:$('birthTime').value, targetDate:$('targetDate').value, placeName:$('placeName').value, lat:$('lat').value, lon:$('lon').value};
  localStorage.setItem('horo.inputs',JSON.stringify(d));
}
function loadInputs(){
  try{
    const d=JSON.parse(localStorage.getItem('horo.inputs')||'{}');
    for(const k in d){if($(k)) $(k).value=d[k];}
    if(!$('targetDate').value) $('targetDate').value = new Date().toISOString().split('T')[0];
  }catch(e){}
}

const ZODIAC_SIGNS = ['â™ˆ ç‰¡ç¾Šåº§', 'â™‰ ç‰¡ç‰›åº§', 'â™Š åŒå­åº§', 'â™‹ èŸ¹åº§', 'â™Œ ç…å­åº§', 'â™ ä¹™å¥³åº§', 'â™ å¤©ç§¤åº§', 'â™ è åº§', 'â™ å°„æ‰‹åº§', 'â™‘ å±±ç¾Šåº§', 'â™’ æ°´ç“¶åº§', 'â™“ é­šåº§'];
const PLANET_DEFS = [
  { key: 'Sun',     label: 'â˜€ï¸ å¤ªé™½',  desc: 'äººç”Ÿã®ç›®çš„ãƒ»æœ¬è³ª' },
  { key: 'Moon',    label: 'ğŸŒ™ æœˆ',    desc: 'æ„Ÿæƒ…ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ' },
  { key: 'Mercury', label: 'â˜¿ æ°´æ˜Ÿ',  desc: 'çŸ¥æ€§ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³' },
  { key: 'Venus',   label: 'â™€ é‡‘æ˜Ÿ',  desc: 'æ„›ãƒ»æ¥½ã—ã¿ãƒ»é‡‘é‹' },
  { key: 'Mars',    label: 'â™‚ ç«æ˜Ÿ',  desc: 'è¡Œå‹•åŠ›ãƒ»æƒ…ç†±' },
  { key: 'Jupiter', label: 'â™ƒ æœ¨æ˜Ÿ',  desc: 'å¹¸é‹ãƒ»æ‹¡å¤§ãƒ»ç™ºå±•' },
  { key: 'Saturn',  label: 'â™„ åœŸæ˜Ÿ',  desc: 'èª²é¡Œãƒ»è²¬ä»»ãƒ»å®‰å®š' },
];

// â˜…ä¿®æ­£2: ã©ã‚“ãªç’°å¢ƒã§ã‚‚æ—¥ä»˜ã‚’æ•°å€¤ã¨ã—ã¦ç¢ºå®Ÿã«å‡¦ç†ã™ã‚‹é–¢æ•°
function createSafeDate(dateStr, timeStr) {
  if(!dateStr) return null;
  // æ–‡å­—åˆ— "-" ã‚„ ":" ã§åˆ†å‰²ã—ã€å…¨ã¦æ•°å€¤ã«å¤‰æ›
  const ymd = dateStr.split(/[-/]/).map(n => parseInt(n, 10));
  const hm = timeStr ? timeStr.split(':').map(n => parseInt(n, 10)) : [12, 0];
  
  // æ•°å€¤åŒ–ã«å¤±æ•—ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
  if (ymd.some(isNaN) || hm.some(isNaN)) return null;

  // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ (æœˆã¯0-11)
  return new Date(ymd[0], ymd[1] - 1, ymd[2], hm[0], hm[1], 0);
}

function calculateRealPlanets(date) {
  if (typeof Astronomy === 'undefined') throw new Error('ã‚¨ãƒ³ã‚¸ãƒ³æœªãƒ­ãƒ¼ãƒ‰');
  
  const results = [];
  PLANET_DEFS.forEach(p => {
    const body = Astronomy.Body[p.key];
    
    // â˜…é‡è¦: false ã‚’æ˜ç¤ºçš„ã«æ¸¡ã™
    const vector = Astronomy.GeoVector(body, date, false); 
    const ecliptic = Astronomy.Ecliptic(vector); 
    const lon = ecliptic.lon;
    
    // ãã‚Œã§ã‚‚NaNãªã‚‰è¨ºæ–­æƒ…å ±ã‚’å‡ºã™
    if (isNaN(lon)) {
        results.push({ key: p.key, name: p.label, desc: p.desc, lon: 0, sign: 'è¨ˆæ¸¬ä¸èƒ½', signDegree: '0.0', debug: `Date: ${date.toISOString()}` });
        return;
    }

    const signIndex = Math.floor(lon / 30) % 12;
    const signText = ZODIAC_SIGNS[signIndex] || ZODIAC_SIGNS[0];
    const signDegree = lon % 30;
    
    results.push({ key: p.key, name: p.label, desc: p.desc, lon: lon, sign: signText, signDegree: signDegree.toFixed(1) });
  });
  return results;
}

function predictJupiterLuck(birthDate, targetDate) {
  const natalVec = Astronomy.GeoVector(Astronomy.Body.Jupiter, birthDate, false);
  const natalLon = Astronomy.Ecliptic(natalVec).lon;
  const transitVec = Astronomy.GeoVector(Astronomy.Body.Jupiter, targetDate, false);
  const transitLon = Astronomy.Ecliptic(transitVec).lon;
  
  let diff = Math.abs(transitLon - natalLon);
  if (diff > 180) diff = 360 - diff;
  const orb = 6; 

  let result = { title: "æœ¨æ˜Ÿã¯é€šå¸¸é‹è¡Œä¸­", msg: "ç¾åœ¨ã¯ç©ã‚„ã‹ãªé‹æ°—ã§ã™ã€‚", score: 50, isLucky: false };
  if(isNaN(diff)) {
      result.title = "ãƒ‡ãƒ¼ã‚¿è¨ˆç®—ã‚¨ãƒ©ãƒ¼";
      result.msg = "æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå‡¦ç†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
      return result;
  }

  if (diff <= orb) {
    result.title = "âœ¨ 12å¹´ã«ä¸€åº¦ã®å¹¸é‹æœŸ"; result.msg = "æœ¨æ˜ŸãŒã‚ãªãŸã®ç”Ÿã¾ã‚ŒãŸä½ç½®ã«æˆ»ã£ã¦ãã¾ã—ãŸã€‚æ–°ã—ã„ã‚¹ã‚¿ãƒ¼ãƒˆã«æœ€é©ã§ã™ï¼"; result.score = 100; result.isLucky = true;
  } else if (Math.abs(diff - 120) <= orb) {
    result.title = "ğŸŒˆ å¹¸é‹ã®è¿½ã„é¢¨"; result.msg = "ç‰©äº‹ãŒã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚€å¤§å‰é‹ã§ã™ã€‚"; result.score = 90; result.isLucky = true;
  } else if (Math.abs(diff - 60) <= orb) {
    result.title = "ğŸ€ ãƒãƒ£ãƒ³ã‚¹åˆ°æ¥"; result.msg = "å”åŠ›è€…ã‚„æ©Ÿä¼šã«æµã¾ã‚Œã¾ã™ã€‚"; result.score = 80;
  } else if (Math.abs(diff - 90) <= orb || Math.abs(diff - 180) <= orb) {
    result.title = "ğŸ”¥ è©¦ç·´ã¨æˆé•·"; result.msg = "è²¬ä»»ãŒå¢—ãˆã¾ã™ãŒã€æˆé•·ã§ãã‚‹æ™‚ã§ã™ã€‚"; result.score = 65;
  }
  return result;
}

function getSignMeaning(planetKey, sign) {
  if (!sign || typeof sign !== 'string') return '';
  const signName = sign.split(' ')[1] || sign; 
  if (planetKey === 'Sun') return `ã‚ãªãŸã®åŸºæœ¬æ€§æ ¼ã¯ã€Œ${signName}ã€çš„ã§ã™ã€‚`;
  if (planetKey === 'Moon') return `ãƒªãƒ©ãƒƒã‚¯ã‚¹æ™‚ã¯ã€Œ${signName}ã€ã£ã½ããªã‚Šã¾ã™ã€‚`;
  if (planetKey === 'Venus') return `ã€Œ${signName}ã€çš„ãªæ¥½ã—ã¿æ–¹ã‚’å¥½ã¿ã¾ã™ã€‚`;
  return '';
}

async function runHoroscope(){
  try {
    saveInputs();
    const birthStr = $('birthDate').value;
    if(!birthStr){ alert('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    
    // â˜…ä¿®æ­£3: æ™‚é–“å…¥åŠ›ãŒãªã„å ´åˆã®å®‰å…¨ç­–
    const timeStr = $('birthTime').value || '12:00';
    
    // å®‰å…¨ãªæ—¥ä»˜ç”Ÿæˆ
    const birthDate = createSafeDate(birthStr, timeStr);
    
    const targetStr = $('targetDate').value || new Date().toISOString().split('T')[0];
    const targetDate = createSafeDate(targetStr, "12:00");

    // æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
    if(!birthDate || isNaN(birthDate.getTime())){ 
        alert("ç”Ÿå¹´æœˆæ—¥ã®å½¢å¼ãŒç„¡åŠ¹ã§ã™ã€‚\nå…¥åŠ›å€¤: " + birthStr); 
        return; 
    }
    
    if (typeof Astronomy === 'undefined') {
       alert("è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
       return;
    }

    const planets = calculateRealPlanets(birthDate);
    const jupPred = predictJupiterLuck(birthDate, targetDate);

    let html = '';
    
    // æœ¨æ˜Ÿäºˆå ±ã‚«ãƒ¼ãƒ‰
    html += `<div class="card" style="border: 3px solid ${jupPred.score >= 80 ? '#ffd166' : '#eee'}; background: ${jupPred.score >= 80 ? '#fffbe6' : '#fff'};">
      <div class="row"><div class="title" style="color:#b7791f">ğŸª æœ¨æ˜Ÿã®äºˆå ±</div><div class="score"><strong>å¹¸é‹åº¦ ${jupPred.score}%</strong></div></div>
      <h3 style="margin:10px 0;">${jupPred.title}</h3><p class="muted">${jupPred.msg}</p></div>`;

    // æƒ‘æ˜Ÿä¸€è¦§
    html += `<div style="margin:20px 0 10px; font-weight:bold; color:#6b46c1;">ã‚ãªãŸã®ç”Ÿã¾ã‚ŒãŸç¬é–“ã®æ˜ŸãŸã¡</div>`;
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆè¨ˆæ¸¬ä¸èƒ½ã®æ™‚ã ã‘æ—¥ä»˜ã‚’è¡¨ç¤ºï¼‰
    if(planets[0].lon === 0) {
        html += `<div style="font-size:0.8em; color:red; margin-bottom:10px;">âš ï¸ æ—¥ä»˜è¨ºæ–­: ${birthDate.toString()}</div>`;
    }

    planets.forEach(p => {
      html += `<div class="card" style="padding:0.8em;"><div class="row"><div style="font-weight:bold;">${p.name}</div><div class="zodiac-badge">${p.sign} ${p.signDegree}Â°</div></div>
        <div class="muted" style="font-size:0.8em; margin-top:4px;">${p.desc}</div>
        <div style="font-size:0.9em; margin-top:6px;">${getSignMeaning(p.key, p.sign)}</div>
        ${p.debug ? `<div class="debug-info">Err: ${p.debug}</div>` : ''}
      </div>`;
    });

    $('resultContainer').innerHTML = html;
    $('inputArea').style.display='none';
    $('outputArea').style.display='block';
    window.scrollTo({top:0, behavior:'smooth'});
    if(jupPred.isLucky) requestAnimationFrame(()=>triggerConfetti(5000, 100));

  } catch(e) {
    console.error(e);
    alert('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

// å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
function hardReload() {
  if(confirm("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã‹ï¼Ÿ")){
      if('serviceWorker' in navigator){
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) { registration.unregister(); }
        });
      }
      setTimeout(() => location.reload(true), 500);
  }
}

async function onGeocodeClick(){
  const q=($('placeName').value||'').trim();
  if(!q){alert('éƒ½å¸‚åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  try{
    const r=await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q)); 
    const j=await r.json(); 
    if(!j||!j.length){alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return;}
    $('lat').value = j[0].lat; $('lon').value = j[0].lon;
    saveInputs(); alert(`ã€Œ${q}ã€ã‚’è¨­å®šã—ã¾ã—ãŸ`);
  }catch(e){ alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: '+e); }
}

function backToInput(){
  $('outputArea').style.display='none'; $('inputArea').style.display='block'; $('confettiCanvas').style.display='none';
}

function triggerConfetti(durationMs, count){
  const cvs=$('confettiCanvas'); const ctx=cvs.getContext('2d');
  const DPR=window.devicePixelRatio||1;
  cvs.style.display='block'; cvs.width=innerWidth*DPR; cvs.height=innerHeight*DPR;
  const colors=['#6b46c1','#ffd166','#ff6b6b','#48bb78'];
  let pcs=[];
  for(let i=0;i<count;i++) pcs.push({x:Math.random()*cvs.width, y:-Math.random()*cvs.height, vx:(Math.random()-0.5)*2*DPR, vy:(Math.random()*2+1)*DPR, color:colors[i%colors.length], size:(Math.random()*8+4)*DPR});
  const start=performance.now();
  function loop(t){
    const e=t-start; if(e>durationMs){cvs.style.display='none';return;}
    ctx.clearRect(0,0,cvs.width,cvs.height);
    pcs.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.y>cvs.height) p.y=-20; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); });
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadInputs();
  $('geoBtn').addEventListener('click', onGeocodeClick);
  $('runBtn').addEventListener('click', runHoroscope);
  $('backBtn').addEventListener('click', backToInput);
  
  // ã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿å¾…æ©Ÿ
  const checkEngine = setInterval(()=>{
      if(typeof Astronomy !== 'undefined') {
          $('loading-msg').textContent = "æº–å‚™å®Œäº†";
          setTimeout(()=>{
              const splash = $('app-splash');
              if(splash) splash.classList.add('fadeout');
          }, 500);
          clearInterval(checkEngine);
      }
  }, 500);

  // 15ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  setTimeout(()=>{
      if(typeof Astronomy === 'undefined') {
          $('loading-msg').textContent = "èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™...";
      }
  }, 15000);
});
</script>
</body>
</html>