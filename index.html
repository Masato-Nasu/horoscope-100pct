<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æœ¬æ ¼æ˜Ÿå ã„ï¼ˆPWAæº–å‚™æ¸ˆãƒ»å˜ä¸€HTMLï¼‰ - ä¿®æ­£ç‰ˆ</title>
<meta name="theme-color" content="#6b46c1" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª</text></svg>">

<!-- Astronomy Engine (browser build) -->
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<style>
  :root { --accent:#6b46c1; --bg:#f6f7fb; --card:#fff; --muted:#666; }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:#222}
  .wrap{max-width:720px;margin:28px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
  h1{margin:0;font-size:1.25rem;color:var(--accent)}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:16px}
  label{display:block;margin-bottom:6px;font-weight:600;color:#333}
  .row{display:flex;gap:8px}
  input[type="date"], input[type="time"], input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e6f0;font-size:14px}
  button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  .result-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f0f0f6}
  .planet-name{font-weight:700}
  .planet-sign{background:#f3e8ff;color:var(--accent);padding:6px 10px;border-radius:16px;font-weight:700}
  #status{font-size:0.95rem;margin-bottom:10px;color:var(--muted)}
  #luckyResult{padding:12px;border-radius:10px;background:#fffbe6;border:1px solid #ffe58f;margin-bottom:12px;font-weight:700}
  .small{font-size:0.9rem;color:var(--muted)}
  footer{font-size:0.8rem;color:var(--muted);text-align:center;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-size:34px">ğŸª</div>
      <div>
        <h1>æœ¬æ ¼æ˜Ÿå ã„ï¼ˆPWAæº–å‚™æ¸ˆãƒ»å˜ä¸€HTMLï¼‰</h1>
        <div class="small">Astronomy Engine å¯¾å¿œ â€” æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹å …ç‰¢åŒ–ãƒ»SWç™»éŒ²è§£é™¤ä»˜ã</div>
      </div>
    </header>

    <div id="status" class="card">
      <div id="statusText">èµ·å‹•ä¸­â€¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚</div>
      <div class="small" style="margin-top:8px">Service Worker ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è§£é™¤ã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿ï¼‰ã€‚</div>
    </div>

    <div class="card">
      <label for="birthDate">ç”Ÿå¹´æœˆæ—¥ï¼ˆå¿…é ˆï¼‰</label>
      <div class="row" style="margin-bottom:8px">
        <input id="birthDate" type="date" />
        <input id="birthTime" type="time" value="12:00" />
      </div>
      <label for="tzOffset">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è£œæ­£ï¼ˆä»»æ„ã€ä¾‹: +09:00ï¼‰</label>
      <input id="tzOffset" type="text" placeholder="ä¾‹: +09:00ï¼ˆç©ºæ¬„ã§ãƒ–ãƒ©ã‚¦ã‚¶ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä½¿ç”¨ï¼‰" />

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="goBtn">é‘‘å®šã‚’å®Ÿè¡Œ</button>
        <button id="exampleBtn" style="background:#444">ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ2000-01-01 12:00ï¼‰</button>
      </div>
    </div>

    <div id="resultArea" class="card" style="display:none">
      <div id="luckyResult"></div>
      <div id="planetList"></div>
    </div>

    <footer class="small">ç”»åƒã¯ä¸è¦ãƒ»DataURI ä½¿ç”¨ / manifest / sw.js ãŒã‚ã£ã¦ã‚‚ã¾ãšã¯ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§å‹•ä½œã—ã¾ã™</footer>
  </div>

<script>
/* ãƒ˜ãƒ«ãƒ‘ãƒ¼ã¨ UI æ“ä½œ */
const STATUS = document.getElementById('statusText');
const PLANETS = [
  { body: Astronomy.Body.Sun, label: 'â˜€ï¸ å¤ªé™½' },
  { body: Astronomy.Body.Moon, label: 'ğŸŒ™ æœˆ' },
  { body: Astronomy.Body.Mercury, label: 'â˜¿ æ°´æ˜Ÿ' },
  { body: Astronomy.Body.Venus, label: 'â™€ é‡‘æ˜Ÿ' },
  { body: Astronomy.Body.Mars, label: 'â™‚ ç«æ˜Ÿ' },
  { body: Astronomy.Body.Jupiter, label: 'â™ƒ æœ¨æ˜Ÿ' },
  { body: Astronomy.Body.Saturn, label: 'â™„ åœŸæ˜Ÿ' },
];
const SIGNS = ['â™ˆ ç‰¡ç¾Šåº§','â™‰ ç‰¡ç‰›åº§','â™Š åŒå­åº§','â™‹ èŸ¹åº§','â™Œ ç…å­åº§','â™ ä¹™å¥³åº§','â™ å¤©ç§¤åº§','â™ è åº§','â™ å°„æ‰‹åº§','â™‘ å±±ç¾Šåº§','â™’ æ°´ç“¶åº§','â™“ é­šåº§'];

function safeLog(...args){ if(console && console.log) console.log(...args); }

/* ServiceWorker ã®ç™»éŒ²ãŒã‚ã‚Œã°è§£é™¤ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿ï¼‰ */
async function unregisterAllServiceWorkers(){
  if('serviceWorker' in navigator){
    try{
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs){ await r.unregister(); }
      safeLog('ServiceWorker: unregistered', regs);
    }catch(e){
      safeLog('ServiceWorker unregister error', e);
    }
  }
}

/* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æº–å‚™ãƒã‚§ãƒƒã‚¯ */
function checkLibraryReady(timeout=4000){
  return new Promise((resolve, reject) => {
    const start = Date.now();
    (function poll(){
      if(typeof Astronomy !== 'undefined' && Astronomy.Body){
        resolve(true);
      } else if(Date.now() - start > timeout){
        reject(new Error('Astronomy Engine ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
      } else {
        setTimeout(poll, 120);
      }
    })();
  });
}

/* æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹ï¼ˆå®‰å…¨ï¼‰: å…¥åŠ›ãŒ YYYY-MM-DD ä»¥å¤–ã®å½¢å¼ï¼ˆä¾‹: 2000/01/01ï¼‰ã§ã‚‚å¯¾å¿œ */
function parseUserDate(dateStr, timeStr, tzOffsetStr){
  try{
    if(!dateStr) return null;

    // Normalize common delimiters to hyphen
    let normalized = dateStr.replace(/\//g,'-').trim();

    // If user typed like "YYYY-MM-DD" or "YYYY-M-D", split and zero-pad
    const parts = normalized.split('-').map(s => s.trim()).filter(s=>s.length>0);
    if(parts.length >= 3){
      const y = parseInt(parts[0],10);
      const m = parseInt(parts[1],10);
      const d = parseInt(parts[2],10);
      if(Number.isFinite(y) && Number.isFinite(m) && Number.isFinite(d)){
        const time = (timeStr && timeStr.trim()) ? timeStr.trim() : '12:00';
        // If tzOffset provided like +09:00, construct ISO with offset (preserves wall-clock)
        if(tzOffsetStr && /^\s*[+-]\d{2}:\d{2}\s*$/.test(tzOffsetStr)){
          const iso = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00${tzOffsetStr}`;
          const dt = new Date(iso);
          if(isNaN(dt.getTime())) return null;
          return dt;
        }
        // Otherwise create local Date (browser timezone)
        const [hh,mm] = time.split(':').map(v=>parseInt(v,10)||0);
        const dtLocal = new Date(y, m-1, d, hh, mm, 0, 0);
        if(isNaN(dtLocal.getTime())){
          // Fallback: try basic ISO
          const iso2 = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00`;
          const dt2 = new Date(iso2);
          if(isNaN(dt2.getTime())) return null;
          return dt2;
        }
        return dtLocal;
      }
    }
    // Final fallback: try Date.parse
    const parsed = new Date(dateStr);
    if(!isNaN(parsed.getTime())) return parsed;
    return null;
  }catch(e){
    safeLog('parseUserDate error', e);
    return null;
  }
}

/* çµŒåº¦æ­£è¦åŒ– */
function norm360(x){
  if(!Number.isFinite(x)) return NaN;
  let v = x % 360;
  if(v < 0) v += 360;
  return v;
}
function angleDiff(a,b){
  if(!Number.isFinite(a) || !Number.isFinite(b)) return NaN;
  let diff = Math.abs(norm360(a) - norm360(b));
  if(diff > 180) diff = 360 - diff;
  return diff;
}

/* AstroTime ã¸å¤‰æ›ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªäº’æ›æ€§è€ƒæ…®ï¼‰ */
function toAstroTime(jsDate){
  try{
    if(typeof Astronomy === 'undefined') return jsDate;
    // æœ€æ–°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ new Astronomy.AstroTime(date) ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹
    if(typeof Astronomy.AstroTime === 'function'){
      return new Astronomy.AstroTime(jsDate);
    }
    // ä»£æ›¿: MakeTime(year, month, day, hour, min, sec) - ã‚‚ã—å­˜åœ¨ã™ã‚‹ãªã‚‰ä½¿ã†
    if(typeof Astronomy.MakeTime === 'function'){
      const y = jsDate.getFullYear();
      const m = jsDate.getMonth() + 1;
      const d = jsDate.getDate();
      const hh = jsDate.getHours();
      const mm = jsDate.getMinutes();
      const ss = jsDate.getSeconds();
      return Astronomy.MakeTime(y, m, d, hh, mm, ss);
    }
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ Date ã‚’å—ã‘ä»˜ã‘ã‚‹å ´åˆã¯ãã®ã¾ã¾æ¸¡ã™
    return jsDate;
  }catch(e){
    safeLog('toAstroTime error', e);
    return jsDate;
  }
}

/* çµæœè¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
function renderPlanetList(itemsHtml, luckHtml){
  document.getElementById('planetList').innerHTML = itemsHtml;
  document.getElementById('luckyResult').innerHTML = luckHtml;
  document.getElementById('resultArea').style.display = 'block';
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”»é¢ä½ç½®ã‚’è€ƒæ…®ï¼‰
  setTimeout(()=>window.scrollTo({top: document.getElementById('resultArea').offsetTop - 20, behavior: 'smooth'}), 60);
}

/* å®Ÿè¨ˆç®—: ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰å¤ªé™½ã€œåœŸæ˜Ÿã¾ã§ç®—å‡ºã€æœ¨æ˜Ÿã§ã€Œ12å¹´ã«ä¸€åº¦ã€åˆ¤å®š */
async function calculate(){
  const dateInput = document.getElementById('birthDate').value;
  const timeInput = document.getElementById('birthTime').value;
  const tzInput = document.getElementById('tzOffset').value.trim();

  const natalDate = parseUserDate(dateInput, timeInput, tzInput);
  if(!natalDate){
    alert('ç”Ÿå¹´æœˆæ—¥ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2000-01-01 ã¾ãŸã¯ 2000/01/01ï¼‰ã€‚');
    return;
  }

  if(typeof Astronomy === 'undefined' || !Astronomy.Body){
    alert('Astronomy Engine ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // AstroTime ã«å¤‰æ›ï¼ˆäº’æ›æ€§å¯¾å¿œï¼‰
  const natalAstro = toAstroTime(natalDate);

  const items = [];
  let natalJupiterLon = NaN;

  for(const p of PLANETS){
    try{
      // GeoVector( body, time, aberration ) â€” time ã¯ AstroTime ãŒæœ›ã¾ã—ã„
      const vec = Astronomy.GeoVector(p.body, natalAstro, true);
      // Ecliptic(vec) ãŒ lon/lat ã‚’è¿”ã™ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªä»•æ§˜ï¼‰
      const ecl = Astronomy.Ecliptic(vec);
      const lon = norm360(ecl && ecl.lon);
      const signIndex = Number.isFinite(lon) ? Math.floor(lon / 30) % 12 : null;
      const degree = Number.isFinite(lon) ? (lon % 30) : NaN;
      items.push({ label: p.label, lon, sign: signIndex !== null ? SIGNS[signIndex] : 'è¨ˆç®—ä¸èƒ½', degree });
      if(p.body === Astronomy.Body.Jupiter && Number.isFinite(lon)) natalJupiterLon = lon;
    }catch(err){
      safeLog('planet calc error', p, err);
      items.push({ label: p.label, lon: NaN, sign: 'è¨ˆç®—ä¸èƒ½', degree: NaN });
    }
  }

  // ä»Šæ—¥ã®æœ¨æ˜ŸçµŒåº¦ï¼ˆæ¯”è¼ƒç”¨ï¼‰
  let todayJupiterLon = NaN;
  try{
    const today = new Date();
    const todayAstro = toAstroTime(today);
    const vecT = Astronomy.GeoVector(Astronomy.Body.Jupiter, todayAstro, true);
    const eclT = Astronomy.Ecliptic(vecT);
    todayJupiterLon = norm360(eclT && eclT.lon);
  }catch(e){
    safeLog('today jupiter calc failed', e);
  }

  // HTML ä½œæˆ
  let html = '';
  for(const it of items){
    const degText = Number.isFinite(it.degree) ? it.degree.toFixed(1) + 'Â°' : 'â€”';
    const signText = it.sign || 'â€”';
    html += `<div class="result-row">
      <div class="planet-name">${it.label}</div>
      <div class="planet-sign">${signText} ${degText}</div>
    </div>`;
  }

  // æœ¨æ˜Ÿã®12å¹´ã«ä¸€åº¦åˆ¤å®šï¼ˆé–¾å€¤ 8Â°ï¼‰
  let luckHtml = 'æœ¨æ˜Ÿã®æ¯”è¼ƒæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
  if(Number.isFinite(natalJupiterLon) && Number.isFinite(todayJupiterLon)){
    const diff = angleDiff(natalJupiterLon, todayJupiterLon);
    if(diff < 8){
      luckHtml = `<div style="color:#1b5e20">âœ¨ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>ç¾åœ¨ã¯ <strong>12å¹´ã«ä¸€åº¦ã®æœ¨æ˜Ÿå¸°é‚„ï¼ˆå¹¸é‹æœŸï¼‰</strong> ã«è¿‘ã„ä½ç½®ã§ã™ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    } else if(Math.abs(diff - 120) < 8){
      luckHtml = `<div style="color:#e65100">ğŸŒˆ å¤§å‰é‹ï¼ˆãƒˆãƒ©ã‚¤ãƒ³ï¼‰: æœ¨æ˜Ÿã‹ã‚‰è¿½ã„é¢¨ãŒæ¥ã¦ã„ã¾ã™ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    } else if(Math.abs(diff - 60) < 6){
      luckHtml = `<div style="color:#2e7d32">ğŸ‘ è‰¯ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆã‚»ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰: ç©ã‚„ã‹ãªå¥½æ©Ÿï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    } else {
      luckHtml = `<div>æœ¨æ˜Ÿã¯ç‰¹åˆ¥ãªè§’åº¦ã«ã‚ã‚Šã¾ã›ã‚“ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    }
    luckHtml += `<div class="small" style="margin-top:8px">å‡ºç”Ÿæ™‚ã®æœ¨æ˜ŸçµŒåº¦: ${natalJupiterLon.toFixed(1)}Â° / ä»Šæ—¥ã®æœ¨æ˜ŸçµŒåº¦: ${todayJupiterLon.toFixed(1)}Â°</div>`;
  }

  renderPlanetList(html, luckHtml);
}

/* åˆæœŸåŒ– */
(async function init(){
  await unregisterAllServiceWorkers();

  try{
    await checkLibraryReady(4000);
    document.getElementById('statusText').textContent = 'âœ… æº–å‚™å®Œäº† â€” è¨ˆç®—å¯èƒ½ã§ã™ï¼ˆAstronomy Engine èª­ã¿è¾¼ã¿æ¸ˆï¼‰';
  }catch(e){
    document.getElementById('statusText').textContent = 'âš ï¸ Astronomy Engine ã®ãƒ­ãƒ¼ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
    safeLog(e);
  }

  document.getElementById('goBtn').addEventListener('click', function(){
    calculate();
  });
  document.getElementById('exampleBtn').addEventListener('click', function(){
    document.getElementById('birthDate').value = '2000-01-01';
    document.getElementById('birthTime').value = '12:00';
  });
})();
</script>
</body>
</html>
