<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æœ¬æ ¼æ˜Ÿå ã„ï¼ˆå‡ºç”Ÿåœ°ãƒ»æœ¬æ—¥ã®å ã„ä»˜ãï¼‰</title>
<meta name="theme-color" content="#6b46c1" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª</text></svg>">

<!-- Astronomy Engine (browser build) -->
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<style>
  :root { --accent:#6b46c1; --bg:#f6f7fb; --card:#fff; --muted:#666; }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:#222}
  .wrap{max-width:920px;margin:24px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  h1{margin:0;font-size:1.25rem;color:var(--accent)}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:14px}
  label{display:block;margin-bottom:6px;font-weight:600;color:#333}
  .row{display:flex;gap:8px}
  input[type="date"], input[type="time"], input[type="text"], select{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e6f0;font-size:14px}
  button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  .small{font-size:0.9rem;color:var(--muted)}
  .result-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f0f0f6}
  .planet-name{font-weight:700}
  .planet-sign{background:#f3e8ff;color:var(--accent);padding:6px 10px;border-radius:16px;font-weight:700}
  #status{font-size:0.95rem;margin-bottom:6px;color:var(--muted)}
  #luckyResult{padding:12px;border-radius:10px;background:#fffbe6;border:1px solid #ffe58f;margin-bottom:12px;font-weight:700}
  .interpretation{margin-top:10px;padding:12px;border-radius:10px;background:#f7f6ff;border:1px solid #efe8ff}
  .interpretation h3{margin:0 0 8px 0;font-size:1rem}
  pre.debug{background:#f7f7fb;padding:8px;border-radius:8px;overflow:auto;font-size:12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:820px){ .two-col{grid-template-columns:1fr} }
  .aspects-list li{margin:6px 0}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-size:34px">ğŸª</div>
      <div>
        <h1>æœ¬æ ¼æ˜Ÿå ã„ â€” å‡ºç”Ÿåœ° + æœ¬æ—¥ã®å ã„</h1>
        <div class="small">å‡ºç”Ÿåœ°å…¥åŠ›ã¨ä»Šæ—¥ã®ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆã«ã‚ˆã‚‹ã€Œæœ¬æ—¥ã®å ã„ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚</div>
      </div>
    </header>

    <div id="status" class="card">
      <div id="statusText">èµ·å‹•ä¸­â€¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚</div>
      <div class="small" style="margin-top:8px">Service Worker ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è§£é™¤ã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿ï¼‰ã€‚</div>
    </div>

    <div class="card">
      <div class="two-col">
        <div>
          <label for="birthDate">ç”Ÿå¹´æœˆæ—¥ï¼ˆå¿…é ˆï¼‰</label>
          <div class="row" style="margin-bottom:8px">
            <input id="birthDate" type="date" />
            <input id="birthTime" type="time" value="12:00" />
          </div>
          <label for="tzOffset">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è£œæ­£ï¼ˆä»»æ„ã€ä¾‹: +09:00ï¼‰</label>
          <input id="tzOffset" type="text" placeholder="ä¾‹: +09:00ï¼ˆç©ºæ¬„ã§ãƒ–ãƒ©ã‚¦ã‚¶ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä½¿ç”¨ï¼‰" />
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="goBtn">é‘‘å®šã‚’å®Ÿè¡Œ</button>
            <button id="exampleBtn" style="background:#444">ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ2000-01-01 12:00ï¼‰</button>
            <button id="debugBtn" style="background:#888">ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›</button>
          </div>
        </div>

        <div>
          <label>å‡ºç”Ÿåœ°ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆã¾ãŸã¯ç·¯åº¦çµŒåº¦ã§æŒ‡å®šï¼‰</label>
          <select id="cityPreset">
            <option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠï¼ˆã¾ãŸã¯ç·¯åº¦çµŒåº¦ã‚’ç›´æ¥å…¥åŠ›ï¼‰</option>
            <option value="tokyo">æ±äº¬ â€” (35.6812, 139.7671)</option>
            <option value="kyoto">äº¬éƒ½ â€” (35.0116, 135.7681)</option>
            <option value="sapporo">æœ­å¹Œ â€” (43.0642, 141.3469)</option>
            <option value="london">ãƒ­ãƒ³ãƒ‰ãƒ³ â€” (51.5074, -0.1278)</option>
            <option value="newyork">ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯ â€” (40.7128, -74.0060)</option>
          </select>
          <div class="row" style="margin-top:8px">
            <input id="birthLat" type="text" placeholder="ç·¯åº¦ï¼ˆä¾‹: 35.6812ï¼‰" />
            <input id="birthLon" type="text" placeholder="çµŒåº¦ï¼ˆä¾‹: 139.7671ï¼‰" />
          </div>
          <div class="small" style="margin-top:8px">â€» ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¯ä¸Šã®æ¬„ã§æ˜ç¤ºã—ã¦ãã ã•ã„ã€‚è‡ªå‹•ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æ¤œç´¢ã¯æœªå®Ÿè£…ï¼ˆå°†æ¥å¯¾å¿œå¯ï¼‰ã€‚</div>
        </div>
      </div>
    </div>

    <div id="resultArea" class="card" style="display:none">
      <div id="luckyResult"></div>

      <div id="planetList"></div>

      <div id="interpretArea" class="interpretation" style="display:none;">
        <h3>ç°¡æ˜“ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</h3>
        <div id="interpretSummary" class="small"></div>
        <ul id="interpretPerPlanet"></ul>
      </div>

      <div id="todayArea" style="margin-top:12px;display:none;">
        <h3>æœ¬æ—¥ã®å ã„ï¼ˆä»Šæ—¥ã®ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆï¼‰</h3>
        <div id="todaySummary" class="small"></div>
        <ul id="todayAspects" class="aspects-list"></ul>
      </div>

      <div style="margin-top:10px;">
        <div class="small">è©³ã—ã„ãƒ‡ãƒãƒƒã‚°ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰:</div>
        <pre id="debugOut" class="debug" style="display:none"></pre>
      </div>
    </div>

    <footer class="small" style="margin-top:10px">ç”»åƒã¯ä¸è¦ãƒ»DataURI ä½¿ç”¨ / manifest / sw.js ãŒã‚ã£ã¦ã‚‚ã¾ãšã¯ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§å‹•ä½œã—ã¾ã™</footer>
  </div>

<script>
/* äº†è§£ã—ã¾ã—ãŸ â€” å‡ºç”Ÿåœ°å…¥åŠ›ã¨æœ¬æ—¥ã®å ã„ã‚’è¿½åŠ ã—ãŸå˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆ */
const PLANETS = [
  { body: Astronomy.Body.Sun, label: 'â˜€ï¸ å¤ªé™½' },
  { body: Astronomy.Body.Moon, label: 'ğŸŒ™ æœˆ' },
  { body: Astronomy.Body.Mercury, label: 'â˜¿ æ°´æ˜Ÿ' },
  { body: Astronomy.Body.Venus, label: 'â™€ é‡‘æ˜Ÿ' },
  { body: Astronomy.Body.Mars, label: 'â™‚ ç«æ˜Ÿ' },
  { body: Astronomy.Body.Jupiter, label: 'â™ƒ æœ¨æ˜Ÿ' },
  { body: Astronomy.Body.Saturn, label: 'â™„ åœŸæ˜Ÿ' },
];
const SIGNS = ['â™ˆ ç‰¡ç¾Šåº§','â™‰ ç‰¡ç‰›åº§','â™Š åŒå­åº§','â™‹ èŸ¹åº§','â™Œ ç…å­åº§','â™ ä¹™å¥³åº§','â™ å¤©ç§¤åº§','â™ è åº§','â™ å°„æ‰‹åº§','â™‘ å±±ç¾Šåº§','â™’ æ°´ç“¶åº§','â™“ é­šåº§'];
const PLANET_MEANING = {
  'â˜€ï¸ å¤ªé™½': 'è‡ªå·±è¡¨ç¾ãƒ»ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è¡¨ã—ã¾ã™ã€‚', 
  'ğŸŒ™ æœˆ': 'æ„Ÿæƒ…ã‚„ç„¡æ„è­˜ã€å®‰å¿ƒæ„Ÿã«é–¢ã‚ã‚Šã¾ã™ã€‚', 
  'â˜¿ æ°´æ˜Ÿ': 'æ€è€ƒãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§˜å¼ã‚’ç¤ºã—ã¾ã™ã€‚', 
  'â™€ é‡‘æ˜Ÿ': 'æ„›æƒ…ãƒ»ç¾æ„è­˜ãƒ»äººã¨ã®èª¿å’Œã‚’è¡¨ã—ã¾ã™ã€‚', 
  'â™‚ ç«æ˜Ÿ': 'è¡Œå‹•åŠ›ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å‘ã‘ã©ã“ã‚ã‚’ç¤ºã—ã¾ã™ã€‚', 
  'â™ƒ æœ¨æ˜Ÿ': 'æˆé•·ãƒ»æ‹¡å¤§ãƒ»å¹¸é‹ã‚’ã‚‚ãŸã‚‰ã™å‚¾å‘ã‚’ç¤ºã—ã¾ã™ã€‚', 
  'â™„ åœŸæ˜Ÿ': 'è²¬ä»»ãƒ»åˆ¶é™ãƒ»æˆç†Ÿã®ãƒ†ãƒ¼ãƒã‚’ç¤ºã—ã¾ã™ã€‚'
};
const SIGN_KEYWORDS = {
  'ç‰¡ç¾Šåº§': 'ç©æ¥µæ€§ãƒ»ç›´æ„Ÿçš„ãƒ»æŒ‘æˆ¦çš„',
  'ç‰¡ç‰›åº§': 'å®‰å®šå¿—å‘ãƒ»æ„Ÿè¦šé‡è¦–ãƒ»å¿è€',
  'åŒå­åº§': 'å¥½å¥‡å¿ƒãƒ»æƒ…å ±äº¤æ›ãƒ»é©å¿œåŠ›',
  'èŸ¹åº§': 'å®¶åº­çš„ãƒ»ä¿è­·æ¬²ãƒ»æ„Ÿå—æ€§',
  'ç…å­åº§': 'è¡¨ç¾åŠ›ãƒ»è‡ªä¿¡ãƒ»å‰µé€ æ€§',
  'ä¹™å¥³åº§': 'å®Ÿå‹™çš„ãƒ»åˆ†æçš„ãƒ»ç¹Šç´°',
  'å¤©ç§¤åº§': 'å”èª¿ãƒ»ç¾æ„è­˜ãƒ»ç¤¾äº¤æ€§',
  'è åº§': 'æƒ…ç†±ãƒ»å¤‰å®¹ãƒ»æ´å¯ŸåŠ›',
  'å°„æ‰‹åº§': 'æ‹¡å¼µå¿—å‘ãƒ»æ¢æ±‚ãƒ»æ¥½è¦³',
  'å±±ç¾Šåº§': 'è²¬ä»»æ„Ÿãƒ»è¨ˆç”»æ€§ãƒ»å®Ÿè¡ŒåŠ›',
  'æ°´ç“¶åº§': 'ç‹¬å‰µæ€§ãƒ»æœªæ¥å¿—å‘ãƒ»å‹æ„›',
  'é­šåº§': 'å…±æ„Ÿãƒ»å¤¢æƒ³ãƒ»ç›´æ„ŸåŠ›'
};

/* ãƒ˜ãƒ«ãƒ‘ãƒ¼ */
function safeLog(...args){ if(console && console.log) console.log(...args); }
async function unregisterAllServiceWorkers(){ if('serviceWorker' in navigator){ try{ const regs = await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); safeLog('ServiceWorker: unregistered', regs);}catch(e){safeLog(e);} } }
function checkLibraryReady(timeout=4000){ return new Promise((res,rej)=>{ const start=Date.now();(function poll(){ if(typeof Astronomy !== 'undefined' && Astronomy.Body) res(true); else if(Date.now()-start>timeout) rej(new Error('Astronomy load failed')); else setTimeout(poll,120); })(); }); }

function parseUserDate(dateStr, timeStr, tzOffsetStr){
  try{
    if(!dateStr) return null;
    let normalized = dateStr.replace(/\//g,'-').trim();
    const parts = normalized.split('-').map(s=>s.trim()).filter(Boolean);
    if(parts.length>=3){
      const y=parseInt(parts[0],10), m=parseInt(parts[1],10), d=parseInt(parts[2],10);
      if(Number.isFinite(y)&&Number.isFinite(m)&&Number.isFinite(d)){
        const time=(timeStr&&timeStr.trim())?timeStr.trim():'12:00';
        if(tzOffsetStr && /^\s*[+-]\d{2}:\d{2}\s*$/.test(tzOffsetStr)){
          const iso = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00${tzOffsetStr}`;
          const dt = new Date(iso); if(isNaN(dt.getTime())) return null; return dt;
        }
        const [hh,mm]=time.split(':').map(v=>parseInt(v,10)||0);
        const dtLocal = new Date(y,m-1,d,hh,mm,0,0);
        if(!isNaN(dtLocal.getTime())) return dtLocal;
        const iso2 = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00`;
        const dt2 = new Date(iso2); if(!isNaN(dt2.getTime())) return dt2;
      }
    }
    const parsed = new Date(dateStr); return isNaN(parsed.getTime())?null:parsed;
  }catch(e){ safeLog('parseUserDate',e); return null; }
}

function norm360(x){ if(!Number.isFinite(x)) return NaN; let v = x % 360; if(v < 0) v += 360; return v; }
function angleDiff(a,b){ if(!Number.isFinite(a)||!Number.isFinite(b)) return NaN; let diff = Math.abs(norm360(a)-norm360(b)); if(diff>180) diff=360-diff; return diff; }

function toAstroTime(jsDate){
  try{
    if(typeof Astronomy === 'undefined') return jsDate;
    if(typeof Astronomy.AstroTime === 'function') return new Astronomy.AstroTime(jsDate);
    if(typeof Astronomy.MakeTime === 'function'){ const y=jsDate.getFullYear(), m=jsDate.getMonth()+1, d=jsDate.getDate(); const hh=jsDate.getHours(), mm=jsDate.getMinutes(), ss=jsDate.getSeconds(); return Astronomy.MakeTime(y,m,d,hh,mm,ss); }
    return jsDate;
  }catch(e){ safeLog('toAstroTime',e); return jsDate; }
}

function eclipticLongitude(ecl){
  if(!ecl) return NaN;
  const candidates = ['lon','elon','el','lambda'];
  for(const k of candidates){ if(Object.prototype.hasOwnProperty.call(ecl,k)){ const v = Number(ecl[k]); if(Number.isFinite(v)) return v; } }
  if(ecl && typeof ecl === 'object'){
    for(const val of Object.values(ecl)){
      if(val && typeof val === 'object' && Number.isFinite(Number(val.elon))) return Number(val.elon);
    }
  }
  return NaN;
}

/* éƒ½å¸‚ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ç·¯åº¦çµŒåº¦æ¬„ã«åæ˜  */
document.getElementById('cityPreset').addEventListener('change', (e)=>{
  const v = e.target.value;
  const map = {
    tokyo: [35.6812,139.7671],
    kyoto: [35.0116,135.7681],
    sapporo: [43.0642,141.3469],
    london: [51.5074,-0.1278],
    newyork: [40.7128,-74.0060]
  };
  if(v && map[v]){
    document.getElementById('birthLat').value = String(map[v][0]);
    document.getElementById('birthLon').value = String(map[v][1]);
  }
});

/* è§£é‡ˆç”Ÿæˆï¼ˆä»Šæ—¥ã®å ã„ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰ */
function aspectNameAndRange(diff){
  const abs = Math.abs(diff);
  if(abs < 5) return {name: 'åˆï¼ˆã‚³ãƒ³ã‚¸ãƒ£ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ï¼‰', score: 100};
  if(Math.abs(abs-60) <= 6) return {name: 'ã‚»ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ60Â°ï¼‰', score: 70};
  if(Math.abs(abs-90) <= 6) return {name: 'ã‚¹ã‚¯ã‚¨ã‚¢ï¼ˆ90Â°ï¼‰', score: 50};
  if(Math.abs(abs-120) <= 8) return {name: 'ãƒˆãƒ©ã‚¤ãƒ³ï¼ˆ120Â°ï¼‰', score: 80};
  if(Math.abs(abs-180) <= 8) return {name: 'ã‚ªãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ˆ180Â°ï¼‰', score: 40};
  return null;
}

function shortAspectInterpret(planetLabel, aspectName){
  // ç°¡æ½”ãªæ–‡è¨€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦å¢—ã‚„ã—ã¦ãã ã•ã„ï¼‰
  const base = {
    'â˜€ï¸ å¤ªé™½': 'è¡Œå‹•ã‚„è‡ªå·±è¡¨ç¾ã«å½±éŸ¿ã—ã¾ã™ã€‚',
    'ğŸŒ™ æœˆ': 'æ„Ÿæƒ…é¢ã‚„æ°—åˆ†ã«å½±éŸ¿ã—ã¾ã™ã€‚',
    'â˜¿ æ°´æ˜Ÿ': 'æ€è€ƒã‚„ä¼é”ãŒæ´»æ€§åŒ–ã—ã¾ã™ã€‚',
    'â™€ é‡‘æ˜Ÿ': 'é–¢ä¿‚ãƒ»æ„›æƒ…ãƒ»é‡‘éŠ­é‹ã«é–¢ã‚ã‚Šã¾ã™ã€‚',
    'â™‚ ç«æ˜Ÿ': 'è¡Œå‹•åŠ›ã‚„è¡å‹•ãŒåˆºæ¿€ã•ã‚Œã¾ã™ã€‚',
    'â™ƒ æœ¨æ˜Ÿ': 'æ‹¡å¤§ãƒ»ãƒãƒ£ãƒ³ã‚¹ã®æµã‚ŒãŒå‡ºã‚„ã™ã„ã§ã™ã€‚',
    'â™„ åœŸæ˜Ÿ': 'åˆ¶ç´„ã‚„è²¬ä»»ã€ç¾å®Ÿçš„ãªèª²é¡ŒãŒè¡¨é¢åŒ–ã—ã¾ã™ã€‚'
  };
  const ptext = base[planetLabel] || '';
  return `${planetLabel} ãŒ ${aspectName}ï¼š${ptext}`;
}

/* ãƒ¡ã‚¤ãƒ³è¨ˆç®— â€” ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰ãƒã‚¤ã‚¿ãƒ«ç®—å‡ºã€ä»Šæ—¥ã®ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆè§£æ */
async function calculate(showDebug=false){
  const dateInput = document.getElementById('birthDate').value;
  const timeInput = document.getElementById('birthTime').value;
  const tzInput = document.getElementById('tzOffset').value.trim();
  const latInput = parseFloat(document.getElementById('birthLat').value);
  const lonInput = parseFloat(document.getElementById('birthLon').value);

  const natalDate = parseUserDate(dateInput, timeInput, tzInput);
  if(!natalDate){ alert('ç”Ÿå¹´æœˆæ—¥ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); return; }
  if(typeof Astronomy === 'undefined' || !Astronomy.Body){ alert('Astronomy Engine ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚'); return; }

  const natalAstro = toAstroTime(natalDate);

  // --- natal planets ---
  const natal = [];
  let natalJupiterLon = NaN;
  const debugRecords = [];
  for(const p of PLANETS){
    try{
      const vec = Astronomy.GeoVector(p.body, natalAstro, true);
      const ecl = Astronomy.Ecliptic(vec);
      const lonRaw = eclipticLongitude(ecl);
      const lon = norm360(lonRaw);
      const signIndex = Number.isFinite(lon) ? Math.floor(lon/30) % 12 : null;
      const degree = Number.isFinite(lon) ? (lon % 30) : NaN;
      natal.push({ label: p.label, body: p.body, lon, sign: signIndex!==null ? SIGNS[signIndex] : 'è¨ˆç®—ä¸èƒ½', degree });
      if(p.body === Astronomy.Body.Jupiter && Number.isFinite(lon)) natalJupiterLon = lon;
      debugRecords.push({planet:p.label, lonRaw, lon, ecl});
    }catch(e){ safeLog(e); natal.push({ label: p.label, body: p.body, lon: NaN, sign: 'è¨ˆç®—ä¸èƒ½', degree: NaN }); debugRecords.push({planet:p.label, error:String(e)}); }
  }

  // --- today's planets ---
  const today = new Date();
  const todayAstro = toAstroTime(today);
  const todayPlanets = [];
  let todayJupiterLon = NaN;
  for(const p of PLANETS){
    try{
      const vec = Astronomy.GeoVector(p.body, todayAstro, true);
      const ecl = Astronomy.Ecliptic(vec);
      const lon = norm360(eclipticLongitude(ecl));
      const signIndex = Number.isFinite(lon) ? Math.floor(lon/30)%12 : null;
      const degree = Number.isFinite(lon) ? (lon % 30) : NaN;
      todayPlanets.push({ label: p.label, body: p.body, lon, sign: signIndex!==null?SIGNS[signIndex]:'è¨ˆç®—ä¸èƒ½', degree });
      if(p.body === Astronomy.Body.Jupiter && Number.isFinite(lon)) todayJupiterLon = lon;
      debugRecords.push({planet:`today ${p.label}`, lon});
    }catch(e){ safeLog(e); todayPlanets.push({ label: p.label, lon: NaN, sign: 'è¨ˆç®—ä¸èƒ½', degree: NaN }); debugRecords.push({planet:`today ${p.label}`, error:String(e)}); }
  }

  // --- build planet list HTML (natal) ---
  let html = '';
  for(const it of natal){
    const degText = Number.isFinite(it.degree) ? it.degree.toFixed(1) + 'Â°' : 'â€”';
    html += `<div class="result-row"><div class="planet-name">${it.label}</div><div class="planet-sign">${it.sign} ${degText}</div></div>`;
  }

  // --- Jupiter comparison and primary lucky message ---
  let luckHtml = 'æœ¨æ˜Ÿã®æ¯”è¼ƒæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
  if(Number.isFinite(natalJupiterLon) && Number.isFinite(todayJupiterLon)){
    const diff = angleDiff(natalJupiterLon, todayJupiterLon);
    if(diff < 8){
      luckHtml = `<div style="color:#1b5e20">âœ¨ ç¾åœ¨ã¯æœ¨æ˜Ÿå¸°é‚„ã«è¿‘ãã€12å¹´ã«ä¸€åº¦ã®å¹¸é‹æœŸã«å…¥ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    } else if(diff < 20){
      luckHtml = `<div style="color:#2e7d32">ğŸŒŸ æœ¨æ˜Ÿã¯æ¯”è¼ƒçš„è¿‘ãã€è¿½ã„é¢¨ãŒæ„Ÿã˜ã‚‰ã‚Œã‚‹æ™‚æœŸã§ã™ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    } else {
      luckHtml = `<div>ğŸ” æœ¨æ˜Ÿã®å½±éŸ¿ã¯å¼·ãã¯è¦‹ãˆã¾ã›ã‚“ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    }
    luckHtml += `<div class="small" style="margin-top:8px">å‡ºç”Ÿã®æœ¨æ˜Ÿ: ${natalJupiterLon.toFixed(1)}Â° / ä»Šæ—¥ã®æœ¨æ˜Ÿ: ${todayJupiterLon.toFixed(1)}Â°</div>`;
  }

  // --- generate interpretation (summary + per-planet) ---
  const interpretation = (()=>{
    const summary = luckHtml;
    const perPlanet = natal.map(it=>{
      const deg = Number.isFinite(it.degree) ? it.degree.toFixed(1)+'Â°':''; 
      const signName = (it.sign||'').replace(/^[^\u3040-\u30FF\u4E00-\u9FFF]*/,'').split(' ')[0];
      const pmean = PLANET_MEANING[it.label]||'';
      const skey = SIGN_KEYWORDS[signName] || '';
      let line = `${it.label}ï¼š${it.sign} ${deg} â€” ${pmean} ${skey? 'ï¼ˆ'+skey+'ï¼‰':''}`;
      if(it.label.includes('â™ƒ') && it.sign && it.sign.indexOf('ç…å­')!==-1) line += ' å‰µé€ æ€§ã‚„è‡ªå·±è¡¨ç¾ã§å¹¸é‹ã®ãƒãƒ£ãƒ³ã‚¹ãŒå‡ºã‚„ã™ã„é…ç½®ã§ã™ã€‚';
      return line;
    });
    return {summary, perPlanetLines: perPlanet};
  })();

  // --- Today: find notable aspects between todayPlanets and natal ---
  const aspects = [];
  for(const t of todayPlanets){
    for(const n of natal){
      if(!Number.isFinite(t.lon) || !Number.isFinite(n.lon)) continue;
      const diff = angleDiff(n.lon, t.lon);
      const a = aspectNameAndRange(diff);
      if(a){
        aspects.push({
          natalPlanet: n.label,
          transitPlanet: t.label,
          natalLon: n.lon,
          transitLon: t.lon,
          diff,
          aspectName: a.name,
          score: a.score
        });
      }
    }
  }
  // sort aspects by score and closeness
  aspects.sort((A,B)=> (B.score - A.score) || (A.diff - B.diff));
  const topAspects = aspects.slice(0,10); // ä¸Šä½10ä»¶ã¾ã§è¡¨ç¤º

  // Create today summary text
  let todaySummary = '';
  if(topAspects.length===0) todaySummary = 'æœ¬æ—¥ã€å‡ºç”Ÿå›³ã¨ã®ä¸»è¦ãªãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆãƒ»ã‚¢ã‚¹ãƒšã‚¯ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
  else {
    todaySummary = `æœ¬æ—¥æ³¨ç›®ã®ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆï¼ˆä¸Šä½ ${topAspects.length} ä»¶ï¼‰:`;
  }
  const aspectHtml = topAspects.map(a=>{
    return `<li><strong>${a.transitPlanet}</strong> ãŒ <strong>${a.natalPlanet}</strong> ã¨ <strong>${a.aspectName}</strong>ï¼ˆå·® ${a.diff.toFixed(1)}Â°ï¼‰ â€” ${shortAspectInterpret(a.transitPlanet, a.aspectName)}</li>`;
  }).join('');

  // --- render ---
  const dbgText = showDebug ? JSON.stringify({ natal, todayPlanets, aspects }, replacerForDebug, 2) : '';
  document.getElementById('planetList').innerHTML = html;
  document.getElementById('luckyResult').innerHTML = interpretation.summary;
  // interpretation
  document.getElementById('interpretArea').style.display = 'block';
  document.getElementById('interpretSummary').innerHTML = interpretation.summary;
  const ul = document.getElementById('interpretPerPlanet');
  ul.innerHTML = '';
  for(const p of interpretation.perPlanetLines){ const li = document.createElement('li'); li.style.margin='6px 0'; li.innerHTML = p; ul.appendChild(li); }

  // today area
  document.getElementById('todayArea').style.display = 'block';
  document.getElementById('todaySummary').textContent = todaySummary;
  document.getElementById('todayAspects').innerHTML = aspectHtml || '<li>æ³¨ç›®ã•ã‚Œã‚‹ä¸»è¦ãªãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';

  const dbgOut = document.getElementById('debugOut');
  if(dbgText){ dbgOut.style.display='block'; dbgOut.textContent = dbgText; } else { dbgOut.style.display='none'; }
  document.getElementById('resultArea').style.display = 'block';
  setTimeout(()=>window.scrollTo({top: document.getElementById('resultArea').offsetTop - 20, behavior: 'smooth'}),60);
}

/* JSON replacer for debug (circular safe) */
function replacerForDebug(){
  const seen = new WeakSet();
  return function(key,value){
    if(value && typeof value==='object'){
      if(seen.has(value)) return '[Circular]';
      seen.add(value);
      if('x' in value && 'y' in value && 'z' in value) return {x:Number(value.x), y:Number(value.y), z:Number(value.z)};
    }
    return value;
  };
}

/* åˆæœŸåŒ– */
(async function init(){
  await unregisterAllServiceWorkers();
  try{ await checkLibraryReady(4000); document.getElementById('statusText').textContent = 'âœ… æº–å‚™å®Œäº† â€” è¨ˆç®—å¯èƒ½ã§ã™ï¼ˆAstronomy Engine èª­ã¿è¾¼ã¿æ¸ˆï¼‰'; }
  catch(e){ document.getElementById('statusText').textContent = 'âš ï¸ Astronomy Engine ã®ãƒ­ãƒ¼ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚'; safeLog(e); }

  document.getElementById('goBtn').addEventListener('click', ()=>calculate(false));
  document.getElementById('exampleBtn').addEventListener('click', ()=>{ document.getElementById('birthDate').value='2000-01-01'; document.getElementById('birthTime').value='12:00'; });
  document.getElementById('debugBtn').addEventListener('click', ()=>calculate(true));
})();
</script>
</body>
</html>
