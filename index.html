<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æœ¬æ ¼æ˜Ÿå ã„ â€” TZè‡ªå‹•åˆ¤å®šãƒ»ãƒã‚¦ã‚¹è¨ˆç®—ãƒ»ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ï¼‹è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</title>
<meta name="theme-color" content="#6b46c1" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª</text></svg>">

<!-- Astronomy Engine (browser build) -->
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<style>
:root{--accent:#6b46c1;--bg:#f6f7fb;--card:#fff;--muted:#666}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:#111}
.wrap{max-width:980px;margin:20px auto;padding:18px}
header{display:flex;gap:12px;align-items:center}
h1{margin:0;color:var(--accent);font-size:1.15rem}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-top:12px}
.row{display:flex;gap:8px}
input,select,button{font-size:14px}
input[type="date"],input[type="time"],input[type="text"],select{flex:1;padding:10px;border-radius:8px;border:1px solid #e9e9f2}
button{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
.small{font-size:0.88rem;color:var(--muted)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:820px){ .form-grid{grid-template-columns:1fr} }
.result-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f6}
.planet-name{font-weight:700}
.planet-sign{background:#f3e8ff;color:var(--accent);padding:6px 10px;border-radius:16px;font-weight:700}
.canvas-wrap{text-align:center;margin-top:12px}
#chart{width:100%;max-width:720px;height:720px;background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.badge{background:#f3f3ff;padding:6px 8px;border-radius:8px;color:var(--muted);font-weight:700}
.debug-pre{background:#f7f7fb;padding:8px;border-radius:8px;overflow:auto;font-size:12px;margin-top:8px}
#longReport{white-space:pre-wrap;line-height:1.6}
.section-title{margin-top:12px;font-weight:700;color:#333;border-left:4px solid #d3c4ff;padding-left:6px;font-size:0.95rem}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-size:34px">ğŸª</div>
      <div>
        <h1>æœ¬æ ¼æ˜Ÿå ã„ â€” TZè‡ªå‹•åˆ¤å®šãƒ»ãƒã‚¦ã‚¹ï¼‹ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ï¼‹è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</h1>
        <div class="small">å‡ºç”Ÿåœ°ã‹ã‚‰ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ¨å®šã—ã€Asc/MCãƒ»ãƒã‚¦ã‚¹ã‚’è¨ˆç®—ã€‚ãƒ›ã‚¤ãƒ¼ãƒ«ã¨é•·æ–‡ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</div>
      </div>
    </header>

    <div id="status" class="card small">åˆæœŸåŒ–ä¸­â€¦Astronomy Engine ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚Service Worker ãŒã‚ã‚Œã°è§£é™¤ã—ã¾ã™ã€‚</div>

    <div class="card">
      <div class="form-grid">
        <div>
          <label>ç”Ÿå¹´æœˆæ—¥ï¼ˆå¿…é ˆï¼‰</label>
          <div class="row" style="margin-top:6px">
            <input id="birthDate" type="date" />
            <input id="birthTime" type="time" value="12:00" />
          </div>
          <label style="margin-top:8px">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è£œæ­£ï¼ˆä»»æ„ï¼‰</label>
          <input id="tzOffset" type="text" placeholder="ä¾‹: +09:00ï¼ˆè‡ªå‹•æ¨å®š or ä¸Šæ›¸ãå¯ï¼‰" />
          <div class="controls">
            <button id="tzFromBrowser">ãƒ–ãƒ©ã‚¦ã‚¶ã®ç¾åœ° TZ ã‚’ä½¿ã†</button>
            <button id="calcBtn">é‘‘å®šã‚’å®Ÿè¡Œ</button>
            <button id="exampleBtn" style="background:#444">ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ2000-01-01 12:00ï¼‰</button>
            <button id="debugBtn" style="background:#888">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º</button>
          </div>
        </div>

        <div>
          <label>å‡ºç”Ÿåœ°ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆâ†’ç·¯åº¦çµŒåº¦ã‚’è‡ªå‹•å…¥åŠ›ï¼‰</label>
          <select id="cityPreset" style="margin-top:6px">
            <option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠï¼ˆã¾ãŸã¯ç·¯åº¦çµŒåº¦ã‚’ç›´æ¥å…¥åŠ›ï¼‰</option>
            <option value="tokyo">æ±äº¬ â€” (35.6812, 139.7671) â€” +09:00</option>
            <option value="kyoto">äº¬éƒ½ â€” (35.0116, 135.7681) â€” +09:00</option>
            <option value="sapporo">æœ­å¹Œ â€” (43.0642, 141.3469) â€” +09:00</option>
            <option value="london">ãƒ­ãƒ³ãƒ‰ãƒ³ â€” (51.5074, -0.1278) â€” +00:00</option>
            <option value="newyork">NY â€” (40.7128, -74.0060) â€” -05:00</option>
          </select>

          <div class="row" style="margin-top:8px">
            <input id="birthLat" type="text" placeholder="ç·¯åº¦ï¼ˆä¾‹: 35.6812ï¼‰" />
            <input id="birthLon" type="text" placeholder="çµŒåº¦ï¼ˆä¾‹: 139.7671ï¼‰" />
          </div>

          <label style="margin-top:8px">ãƒã‚¦ã‚¹æ–¹å¼</label>
          <select id="houseMethod" style="margin-top:6px">
            <option value="equal">Equalï¼ˆã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆèµ·ç‚¹ã§30Â°ã”ã¨ï¼‰</option>
            <option value="whole">Whole Signï¼ˆã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆãŒå«ã‚€æ˜Ÿåº§ã‚’ç¬¬1å®¤ï¼‰</option>
          </select>

          <div class="small" style="margin-top:8px">â€» Placidus ç­‰ã®é«˜åº¦ãªæ–¹å¼ã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§è¿½åŠ å¯èƒ½ã§ã™ã€‚</div>
        </div>
      </div>
    </div>

    <div id="output" class="card" style="display:none">
      <div id="lucky" class="small"></div>

      <div id="planetList"></div>

      <div class="canvas-wrap">
        <div class="small" style="margin-bottom:6px">ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆãƒ›ã‚¤ãƒ¼ãƒ«ï¼‰</div>
        <canvas id="chart" width="720" height="720"></canvas>
        <div class="legend">
          <div class="badge">Asc = ã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆ</div>
          <div class="badge">MC = ãƒŸãƒƒãƒ‰ãƒ˜ãƒ–ãƒ³</div>
          <div class="badge">è¡¨ç¤º: å¤ªé™½ã€œåœŸæ˜Ÿ</div>
        </div>
      </div>

      <div id="todayTransit" style="margin-top:12px"></div>

      <div class="section-title">è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆï¼ˆèª­ã¿ç‰©ãƒ¢ãƒ¼ãƒ‰ï¼‰</div>
      <div id="longReport" class="small"></div>

      <pre id="debugInfo" class="debug-pre" style="display:none"></pre>
    </div>

  </div>

<script>
/* ----------------- å®šæ•°ãƒ»å…±é€šæƒ…å ± ----------------- */
const SIGNS = ['â™ˆ ç‰¡ç¾Šåº§','â™‰ ç‰¡ç‰›åº§','â™Š åŒå­åº§','â™‹ èŸ¹åº§','â™Œ ç…å­åº§','â™ ä¹™å¥³åº§','â™ å¤©ç§¤åº§','â™ è åº§','â™ å°„æ‰‹åº§','â™‘ å±±ç¾Šåº§','â™’ æ°´ç“¶åº§','â™“ é­šåº§'];
const PLANETS = [
  { body: Astronomy.Body.Sun,    label: 'â˜€ï¸ å¤ªé™½' },
  { body: Astronomy.Body.Moon,   label: 'ğŸŒ™ æœˆ' },
  { body: Astronomy.Body.Mercury,label: 'â˜¿ æ°´æ˜Ÿ' },
  { body: Astronomy.Body.Venus,  label: 'â™€ é‡‘æ˜Ÿ' },
  { body: Astronomy.Body.Mars,   label: 'â™‚ ç«æ˜Ÿ' },
  { body: Astronomy.Body.Jupiter,label: 'â™ƒ æœ¨æ˜Ÿ' },
  { body: Astronomy.Body.Saturn, label: 'â™„ åœŸæ˜Ÿ' },
];
// é»„é“å‚¾æ–œè§’ï¼ˆJ2000è¿‘ä¼¼ï¼‰
const EPSILON_DEG = 23.4392911;

// æƒ‘æ˜Ÿã®æ„å‘³ï¼ˆãƒã‚¤ã‚¿ãƒ«ç”¨ï¼‰
const PLANET_MEANING = {
  'â˜€ï¸ å¤ªé™½':'è‡ªå·±è¡¨ç¾ãƒ»ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è»¸ã‚’è¡¨ã—ã¾ã™ã€‚',
  'ğŸŒ™ æœˆ':'æ„Ÿæƒ…ãƒ»ç„¡æ„è­˜ãƒ»å®‰å¿ƒæ„Ÿã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ã—ã¾ã™ã€‚',
  'â˜¿ æ°´æ˜Ÿ':'æ€è€ƒãƒ»æƒ…å ±å‡¦ç†ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¡¨ã—ã¾ã™ã€‚',
  'â™€ é‡‘æ˜Ÿ':'æ„›æƒ…ãƒ»ç¾æ„è­˜ãƒ»äººé–“é–¢ä¿‚ã‚„ä¾¡å€¤è¦³ã‚’è¡¨ã—ã¾ã™ã€‚',
  'â™‚ ç«æ˜Ÿ':'è¡Œå‹•åŠ›ãƒ»æ€’ã‚Šãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å‡ºã—æ–¹ã‚’è¡¨ã—ã¾ã™ã€‚',
  'â™ƒ æœ¨æ˜Ÿ':'æˆé•·ãƒ»æ‹¡å¤§ãƒ»ãƒãƒ£ãƒ³ã‚¹ã‚„ä¿è­·ã®å…¥ã‚Šæ–¹ã‚’è¡¨ã—ã¾ã™ã€‚',
  'â™„ åœŸæ˜Ÿ':'è²¬ä»»ãƒ»åˆ¶é™ãƒ»è©¦ç·´ã¨æˆç†Ÿã®ãƒ†ãƒ¼ãƒã‚’è¡¨ã—ã¾ã™ã€‚'
};

// æ˜Ÿåº§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒã‚¤ã‚¿ãƒ«ç”¨ï¼‰
const SIGN_KEYWORDS = {
  'ç‰¡ç¾Šåº§':'ç©æ¥µæ€§ãƒ»ç›´æ„Ÿãƒ»ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç²¾ç¥',
  'ç‰¡ç‰›åº§':'å®‰å®šå¿—å‘ãƒ»æ„Ÿè¦šçš„ãªè±Šã‹ã•ãƒ»å¿è€',
  'åŒå­åº§':'å¥½å¥‡å¿ƒãƒ»çŸ¥çš„æ´»å‹•ãƒ»æƒ…å ±äº¤æ›',
  'èŸ¹åº§':'å®¶åº­ãƒ»å…±æ„Ÿãƒ»å®ˆã‚ŠãŸã„å¯¾è±¡',
  'ç…å­åº§':'è‡ªå·±è¡¨ç¾ãƒ»å‰µé€ æ€§ãƒ»èª‡ã‚Š',
  'ä¹™å¥³åº§':'åˆ†æåŠ›ãƒ»å®Ÿå‹™èƒ½åŠ›ãƒ»ä¸å¯§ã•',
  'å¤©ç§¤åº§':'å”èª¿ãƒ»ãƒãƒ©ãƒ³ã‚¹æ„Ÿè¦šãƒ»ç¾æ„è­˜',
  'è åº§':'é›†ä¸­åŠ›ãƒ»æ·±ã„çµã³ã¤ããƒ»å¤‰å®¹',
  'å°„æ‰‹åº§':'æ¢æ±‚å¿ƒãƒ»è‡ªç”±ãƒ»ç²¾ç¥çš„ãªæ‹¡å¤§',
  'å±±ç¾Šåº§':'è²¬ä»»æ„Ÿãƒ»ç¤¾ä¼šçš„é”æˆãƒ»ç¾å®Ÿå¿—å‘',
  'æ°´ç“¶åº§':'ç‹¬å‰µæ€§ãƒ»æ”¹é©ãƒ»æœªæ¥å¿—å‘',
  'é­šåº§':'å…±æ„Ÿãƒ»å¢ƒç•Œã®æ›–æ˜§ã•ãƒ»æƒ³åƒåŠ›'
};

// ãƒã‚¦ã‚¹ã®æ„å‘³
const HOUSE_MEANING = {
  1:'è‡ªå·±åƒãƒ»ç¬¬ä¸€å°è±¡ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«',
  2:'ãŠé‡‘ãƒ»æ‰€æœ‰ãƒ»ä¾¡å€¤è¦³',
  3:'å­¦ã³ãƒ»èº«è¿‘ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»å…„å¼Ÿå§‰å¦¹',
  4:'å®¶åº­ãƒ»å±…å ´æ‰€ãƒ»ãƒ«ãƒ¼ãƒ„',
  5:'å‰µé€ æ€§ãƒ»æ‹æ„›ãƒ»è¶£å‘³ãƒ»å­ã©ã‚‚',
  6:'ä»•äº‹ãƒ»ç¾©å‹™ãƒ»å¥åº·ç®¡ç†ãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³',
  7:'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—ãƒ»å¥‘ç´„ãƒ»å¯¾äººé–¢ä¿‚',
  8:'å…±æœ‰è³‡ç”£ãƒ»æ·±ã„çµã³ã¤ããƒ»å¤‰å®¹',
  9:'é«˜ç­‰æ•™è‚²ãƒ»å“²å­¦ãƒ»é æ–¹ãƒ»ç²¾ç¥æ€§',
 10:'è·æ¥­ãƒ»ç¤¾ä¼šçš„åœ°ä½ãƒ»å¤©è·',
 11:'å‹äººãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ»æœªæ¥ã¸ã®å¸Œæœ›',
 12:'ç„¡æ„è­˜ãƒ»ä¼‘æ¯ãƒ»éš”é›¢ãƒ»æ‰‹æ”¾ã—'
};

// ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆç”¨ï¼šæƒ‘æ˜Ÿã”ã¨ã®ãƒ†ãƒ¼ãƒçŸ­æ–‡
const TRANSIT_ROLE = {
  'â˜€ï¸ å¤ªé™½':'è¡Œå‹•ã‚„è‡ªå·±è¡¨ç¾ã®ãƒ†ãƒ¼ãƒãŒå¼·èª¿ã•ã‚Œã‚„ã™ã„ã§ã—ã‚‡ã†ã€‚',
  'ğŸŒ™ æœˆ':'æ°—åˆ†ã‚„æ„Ÿæƒ…ã®æ³¢ãŒå‹•ãã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚',
  'â˜¿ æ°´æ˜Ÿ':'è€ƒãˆæ–¹ã‚„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ´»ç™ºã«ãªã‚Šã‚„ã™ã„ã§ã™ã€‚',
  'â™€ é‡‘æ˜Ÿ':'äººé–“é–¢ä¿‚ã‚„ãŠé‡‘ã€ç¾çš„ãªãƒ†ãƒ¼ãƒãŒã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚',
  'â™‚ ç«æ˜Ÿ':'è¡Œå‹•åŠ›ã‚„é—˜äº‰å¿ƒãŒåˆºæ¿€ã•ã‚Œã‚„ã™ã„æ™‚æœŸã§ã™ã€‚',
  'â™ƒ æœ¨æ˜Ÿ':'æ‹¡å¤§ãƒ»ç™ºå±•ãƒ»ãƒãƒ£ãƒ³ã‚¹ãŒå…¥ã‚Šã‚„ã™ã„æµã‚Œã§ã™ã€‚',
  'â™„ åœŸæ˜Ÿ':'è²¬ä»»ã‚„èª²é¡Œã¨å‘ãåˆã†å ´é¢ãŒå¢—ãˆã‚„ã™ã„ã§ã—ã‚‡ã†ã€‚'
};

function safeLog(...a){ if(console && console.log) console.log(...a); }

/* ----------------- SWè§£é™¤ï¼†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ­ãƒ¼ãƒ‰ ----------------- */
async function unregisterAllServiceWorkers(){
  if('serviceWorker' in navigator){
    try{
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs) await r.unregister();
      safeLog('ServiceWorker: unregistered', regs);
    }catch(e){ safeLog('SW unregister error', e); }
  }
}
function checkAstronomyReady(timeout=4000){
  return new Promise((resolve,reject)=>{
    const start = Date.now();
    (function poll(){
      if(typeof Astronomy !== 'undefined' && Astronomy.Body) resolve(true);
      else if(Date.now() - start > timeout) reject(new Error('Astronomy load timeout'));
      else setTimeout(poll,100);
    })();
  });
}

/* ----------------- æ—¥ä»˜ï¼†ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç† ----------------- */
function parseUserDate(dateStr, timeStr, tzOffsetStr){
  try{
    if(!dateStr) return null;
    let normalized = dateStr.replace(/\//g,'-').trim();
    const parts = normalized.split('-').map(s=>s.trim()).filter(Boolean);
    if(parts.length>=3){
      const y=parseInt(parts[0],10), m=parseInt(parts[1],10), d=parseInt(parts[2],10);
      if(Number.isFinite(y)&&Number.isFinite(m)&&Number.isFinite(d)){
        const time = (timeStr && timeStr.trim())?timeStr.trim():'12:00';
        if(tzOffsetStr && /^\s*[+-]\d{2}:\d{2}\s*$/.test(tzOffsetStr)){
          const iso = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00${tzOffsetStr}`;
          const dt = new Date(iso);
          if(isNaN(dt.getTime())) return null;
          return dt;
        }
        const [hh,mm] = time.split(':').map(v=>parseInt(v,10)||0);
        const dtLocal = new Date(y,m-1,d,hh,mm,0,0);
        if(!isNaN(dtLocal.getTime())) return dtLocal;
        const iso2 = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00`;
        const dt2 = new Date(iso2);
        if(!isNaN(dt2.getTime())) return dt2;
      }
    }
    const parsed = new Date(dateStr);
    return isNaN(parsed.getTime())?null:parsed;
  }catch(e){ safeLog('parseUserDate',e); return null; }
}
function toAstroTime(jsDate){
  try{
    if(typeof Astronomy === 'undefined') return jsDate;
    if(typeof Astronomy.AstroTime === 'function') return new Astronomy.AstroTime(jsDate);
    if(typeof Astronomy.MakeTime === 'function'){
      const y=jsDate.getFullYear(), m=jsDate.getMonth()+1, d=jsDate.getDate();
      const hh=jsDate.getHours(), mm=jsDate.getMinutes(), ss=jsDate.getSeconds();
      return Astronomy.MakeTime(y,m,d,hh,mm,ss);
    }
    return jsDate;
  }catch(e){ safeLog('toAstroTime',e); return jsDate; }
}
function eclipticLongitude(ecl){
  if(!ecl) return NaN;
  const candidates=['elon','lon','el','lambda'];
  for(const k of candidates){
    if(Object.prototype.hasOwnProperty.call(ecl,k)){
      const v=Number(ecl[k]); if(Number.isFinite(v)) return v;
    }
  }
  if(ecl && typeof ecl==='object'){
    for(const val of Object.values(ecl)){
      if(val && typeof val==='object' && Number.isFinite(Number(val.elon))) return Number(val.elon);
    }
  }
  return NaN;
}
function norm360(x){ if(!Number.isFinite(x)) return NaN; let v=x%360; if(v<0)v+=360; return v; }
function angleDiff(a,b){ if(!Number.isFinite(a)||!Number.isFinite(b)) return NaN; let d=Math.abs(norm360(a)-norm360(b)); if(d>180)d=360-d; return d; }
function approxTzFromLon(lon){
  if(!Number.isFinite(lon)) return '';
  const offset=Math.round(lon/15);
  const sign=offset>=0?'+':'-';
  const hh=String(Math.abs(offset)).padStart(2,'0');
  return `${sign}${hh}:00`;
}

/* ----------------- Asc / MC / ãƒã‚¦ã‚¹è¨ˆç®— ----------------- */
function computeAscMc(astime, lon_deg, lat_deg){
  let gastHours;
  try{
    if(typeof Astronomy.SiderealTime === 'function'){
      gastHours = Astronomy.SiderealTime(astime);
    }else{
      const d=(astime instanceof Date)?astime:(astime&&astime.date)?astime.date:new Date();
      const utcHours=d.getUTCHours()+d.getUTCMinutes()/60+d.getUTCSeconds()/3600;
      gastHours=(utcHours*1.00273790935)%24;
    }
  }catch(e){ safeLog('SiderealTime error',e); throw e; }

  const lstHours=(gastHours + lon_deg/15)%24;
  const lstDeg=lstHours*15;
  const lstRad=lstDeg*Math.PI/180;
  const latRad=lat_deg*Math.PI/180;
  const epsRad=EPSILON_DEG*Math.PI/180;

  const mcRad=Math.atan2(Math.sin(lstRad)*Math.cos(epsRad),Math.cos(lstRad));
  let mcDeg=mcRad*180/Math.PI; mcDeg=norm360(mcDeg);

  const x=-Math.cos(lstRad);
  const y=Math.sin(lstRad)*Math.cos(epsRad)+Math.tan(latRad)*Math.sin(epsRad);
  let ascRad=Math.atan2(y,x);
  let ascDeg=ascRad*180/Math.PI;
  ascDeg=norm360(ascDeg);
  if(ascDeg<180) ascDeg+=180; else ascDeg-=180;
  ascDeg=norm360(ascDeg);

  return { lstHours, lstDeg, ascDeg, mcDeg, gastHours };
}
function computeHouseCusps(ascDeg, method='equal'){
  if(method==='whole'){
    const signIndex=Math.floor(ascDeg/30)%12;
    const signStart=signIndex*30;
    const cusps=[];
    for(let i=0;i<12;i++) cusps.push(norm360(signStart+i*30));
    return cusps;
  }else{
    const cusps=[];
    for(let i=0;i<12;i++) cusps.push(norm360(ascDeg+i*30));
    return cusps;
  }
}
function houseFromLongitude(lonDeg,cusps){
  for(let h=11;h>=0;h--){
    const cusp=cusps[h];
    const d=norm360(lonDeg-cusp);
    if(d>=0 && d<30) return h+1;
  }
  return 1;
}

/* ----------------- ãƒ›ã‚¤ãƒ¼ãƒ«æç”» ----------------- */
function drawChart(cusps, planets, ascDeg, mcDeg){
  const canvas=document.getElementById('chart');
  const ctx=canvas.getContext('2d');
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2;
  const R=Math.min(w,h)/2-30;

  ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);

  ctx.strokeStyle='#ddd'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();

  for(let i=0;i<12;i++){
    const start=cusps[i];
    const mid=norm360(start+15);
    const labelAngle=((mid-ascDeg)-90)*Math.PI/180;
    const cuspAngle=((start-ascDeg)-90)*Math.PI/180;

    ctx.strokeStyle='#eee'; ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx+Math.cos(cuspAngle)*R, cy+Math.sin(cuspAngle)*R);
    ctx.stroke();

    ctx.fillStyle='#666'; ctx.font='14px system-ui';
    const lx=cx+Math.cos(labelAngle)*(R-22);
    const ly=cy+Math.sin(labelAngle)*(R-22);
    const signIndex=Math.floor(start/30)%12;
    ctx.fillText(SIGNS[signIndex], lx-18, ly+6);
  }

  ctx.strokeStyle='#f0f0f6'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.arc(cx,cy,R*0.7,0,Math.PI*2); ctx.stroke();

  const mcAngle=((mcDeg-ascDeg)-90)*Math.PI/180;
  ctx.fillStyle='#e26';
  ctx.beginPath(); ctx.arc(cx+Math.cos(mcAngle)*(R*0.85), cy+Math.sin(mcAngle)*(R*0.85),6,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#333'; ctx.font='12px system-ui';
  ctx.fillText('MC', cx+Math.cos(mcAngle)*(R*0.85)-8, cy+Math.sin(mcAngle)*(R*0.85)+20);

  const ascAngle=((ascDeg-ascDeg)-90)*Math.PI/180; // -90Â°
  ctx.fillStyle='#26a';
  ctx.beginPath(); ctx.arc(cx+Math.cos(ascAngle)*(R*0.85), cy+Math.sin(ascAngle)*(R*0.85),6,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#333';
  ctx.fillText('Asc', cx+Math.cos(ascAngle)*(R*0.85)-12, cy+Math.sin(ascAngle)*(R*0.85)+20);

  ctx.font='14px system-ui';
  planets.forEach(p=>{
    if(!Number.isFinite(p.lon)) return;
    const angle=((p.lon-ascDeg)-90)*Math.PI/180;
    const rpos=R*0.55;
    const x=cx+Math.cos(angle)*rpos;
    const y=cy+Math.sin(angle)*rpos;
    ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.arc(x,y,18,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#ddd'; ctx.stroke();
    ctx.fillStyle='#111';
    const label=`${p.label} ${Number.isFinite(p.degree)?p.degree.toFixed(1)+'Â°':'â€”'}`;
    ctx.fillText(label,x-20,y+5);
  });
}

/* ----------------- ã‚¢ã‚¹ãƒšã‚¯ãƒˆè§£èª¬ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ ----------------- */
function classifyAspectType(diff){
  const d=Math.abs(diff);
  if(d < 5) return 'åˆ';
  if(Math.abs(d-60) < 6) return 'ã‚»ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«';
  if(Math.abs(d-90) < 6) return 'ã‚¹ã‚¯ã‚¨ã‚¢';
  if(Math.abs(d-120) < 8) return 'ãƒˆãƒ©ã‚¤ãƒ³';
  if(Math.abs(d-180) < 8) return 'ã‚ªãƒã‚¸ã‚·ãƒ§ãƒ³';
  return null;
}
function aspectMeaning(type){
  switch(type){
    case 'åˆ': return 'äºŒã¤ã®å¤©ä½“ãŒå¼·ãçµã³ã¤ãã€æ€§è³ªãŒä¸€ä½“åŒ–ã—ã‚„ã™ã„é…ç½®ã§ã™ã€‚';
    case 'ã‚»ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«': return 'ç·©ã‚„ã‹ãªå”åŠ›é–¢ä¿‚ã‚’ä½œã‚Šã€ãƒãƒ£ãƒ³ã‚¹ã‚„ãã£ã‹ã‘ã‚’ä¸ãˆã‚‹é…ç½®ã§ã™ã€‚';
    case 'ã‚¹ã‚¯ã‚¨ã‚¢': return 'æ‘©æ“¦ã‚„è‘›è—¤ã‚’é€šã˜ã¦ã€èª²é¡Œã«å‘ãåˆã†ã“ã¨ã‚’ä¿ƒã™é…ç½®ã§ã™ã€‚';
    case 'ãƒˆãƒ©ã‚¤ãƒ³': return 'è‡ªç„¶ãªè¿½ã„é¢¨ã‚„ã‚¹ãƒ ãƒ¼ã‚ºãªæµã‚Œã‚’ã‚‚ãŸã‚‰ã™èª¿å’Œçš„ãªé…ç½®ã§ã™ã€‚';
    case 'ã‚ªãƒã‚¸ã‚·ãƒ§ãƒ³': return 'å¼•ãåˆã„ã¨å¯¾ç«‹ã®ä¸¡é¢ãŒã‚ã‚Šã€ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹é…ç½®ã§ã™ã€‚';
    default: return '';
  }
}
function aspectStrengthText(diff){
  const d=Math.abs(diff);
  if(d<=3) return `éå¸¸ã«å¼·ã„å½±éŸ¿ï¼ˆå·® ${d.toFixed(1)}Â°ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚`;
  if(d<=6) return `ã¯ã£ãã‚Šã¨æ„Ÿã˜ã‚‰ã‚Œã‚‹å½±éŸ¿ï¼ˆå·® ${d.toFixed(1)}Â°ï¼‰ã§ã™ã€‚`;
  if(d<=10) return `ç©ã‚„ã‹ã§ã™ãŒç„¡è¦–ã§ããªã„å½±éŸ¿ï¼ˆå·® ${d.toFixed(1)}Â°ï¼‰ã§ã™ã€‚`;
  return `å½±éŸ¿ã¯æ¯”è¼ƒçš„å¼±ãã€èƒŒæ™¯çš„ãªå‚¾å‘ã¨ã—ã¦ç¾ã‚Œã¾ã™ï¼ˆå·® ${d.toFixed(1)}Â°ï¼‰ã€‚`;
}

/* ----------------- ãƒ¡ã‚¤ãƒ³è¨ˆç®—ï¼†ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ ----------------- */
function generateLongReport(ctx){
  if(!ctx) return 'ä¸€åº¦ã€Œé‘‘å®šã‚’å®Ÿè¡Œã€ã—ã¦ã‹ã‚‰ã”è¦§ãã ã•ã„ã€‚';

  const {
    birthDateStr, birthTimeStr, tzOffsetStr,
    lat, lon, houseMethod,
    natalPlanets, cusps, ascDeg, mcDeg,
    natalJupiterLon, todayJupiterLon,
    aspectsDetailed
  } = ctx;

  const lines = [];

  // åŸºæœ¬æƒ…å ±
  lines.push('â–  åŸºæœ¬æƒ…å ±');
  lines.push(`ç”Ÿå¹´æœˆæ—¥ï¼š${birthDateStr || 'ï¼ˆæœªå…¥åŠ›ï¼‰'} ${birthTimeStr || ''}`);
  lines.push(`ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼š${tzOffsetStr || 'ãƒ–ãƒ©ã‚¦ã‚¶ãƒ­ãƒ¼ã‚«ãƒ«ï¼æ¨å®š'}`);
  if(Number.isFinite(lat) && Number.isFinite(lon)){
    lines.push(`å‡ºç”Ÿåœ°ï¼ˆè¿‘ä¼¼ï¼‰ï¼šç·¯åº¦ ${lat.toFixed(4)} / çµŒåº¦ ${lon.toFixed(4)}`);
  }else{
    lines.push('å‡ºç”Ÿåœ°ï¼šæœªæŒ‡å®šï¼ˆAsc/ãƒã‚¦ã‚¹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ±äº¬è¿‘å‚ã§è¨ˆç®—ï¼‰');
  }
  lines.push(`ãƒã‚¦ã‚¹æ–¹å¼ï¼š${houseMethod==='whole' ? 'Whole Signï¼ˆãƒ›ãƒ¼ãƒ«ã‚µã‚¤ãƒ³ï¼‰':'Equalï¼ˆã‚¤ã‚³ãƒ¼ãƒ«ãƒã‚¦ã‚¹ï¼‰'}`);
  lines.push('');

  // ãƒã‚¤ã‚¿ãƒ«æƒ‘æ˜Ÿ
  lines.push('â–  ãƒã‚¤ã‚¿ãƒ«ã®æƒ‘æ˜Ÿã¨ãƒã‚¦ã‚¹ï¼ˆã–ã£ãã‚Šã¨ã—ãŸè§£èª¬ï¼‰');
  natalPlanets.forEach(p=>{
    if(!Number.isFinite(p.lon)) return;
    const degText = Number.isFinite(p.degree)?p.degree.toFixed(1)+'Â°':'â€”';
    const signIndex = Math.floor(p.lon/30)%12;
    const signFull = SIGNS[signIndex];
    const signName = signFull.replace(/^[^\u3040-\u30FF\u4E00-\u9FFF]*/,'').split(' ')[0] || signFull;
    const houseNo = houseFromLongitude(p.lon,cusps);
    const pMean = PLANET_MEANING[p.label] || '';
    const sKey = SIGN_KEYWORDS[signName] || '';
    const hMean = HOUSE_MEANING[houseNo] || '';
    lines.push(
      `${p.label}ï¼š${signFull} ${degText} ï¼ ç¬¬${houseNo}å®¤\n` +
      `  - æƒ‘æ˜Ÿã®ãƒ†ãƒ¼ãƒï¼š${pMean}\n` +
      `  - æ˜Ÿåº§ã®ãƒ ãƒ¼ãƒ‰ï¼š${sKey ? sKey : 'ï¼ˆæ˜Ÿåº§ã®æ€§è³ªï¼‰'}\n` +
      `  - ãƒã‚¦ã‚¹ã®é ˜åŸŸï¼š${hMean}`
    );
  });
  lines.push('');

  // Asc / MC
  const ascSignIndex = Math.floor(ascDeg/30)%12;
  const ascSign = SIGNS[ascSignIndex];
  const mcSignIndex = Math.floor(mcDeg/30)%12;
  const mcSign = SIGNS[mcSignIndex];
  lines.push('â–  Ascï¼ˆã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆï¼‰ã¨ MC');
  lines.push(`Ascï¼ˆã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆï¼‰ï¼š${ascSign} ${ (ascDeg%30).toFixed(1) }Â°`);
  lines.push('  â†’ å¤–å´ã‹ã‚‰è¦‹ãˆã‚‹å°è±¡ã‚„ã€Œã‚­ãƒ£ãƒ©ã€ã®ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ã‚’è¡¨ã—ã¾ã™ã€‚');
  lines.push(`MCï¼ˆãƒŸãƒƒãƒ‰ãƒ˜ãƒ–ãƒ³ï¼‰ï¼š${mcSign} ${ (mcDeg%30).toFixed(1) }Â°`);
  lines.push('  â†’ ç¤¾ä¼šçš„ãªå½¹å‰²ãƒ»ã‚­ãƒ£ãƒªã‚¢ãƒ»åˆ°é”ç‚¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¡¨ã—ã¾ã™ã€‚');
  lines.push('');

  // æœ¨æ˜Ÿã®å‘¨æœŸ
  lines.push('â–  æœ¨æ˜Ÿã®å‘¨æœŸã¨ä»Šã®ä½ç½®');
  if(Number.isFinite(natalJupiterLon) && Number.isFinite(todayJupiterLon)){
    const diff = angleDiff(natalJupiterLon,todayJupiterLon);
    lines.push(`å‡ºç”Ÿæ™‚ã®æœ¨æ˜Ÿï¼š${natalJupiterLon.toFixed(1)}Â°`);
    lines.push(`æœ¬æ—¥ã®æœ¨æ˜Ÿï¼š${todayJupiterLon.toFixed(1)}Â°`);
    lines.push(`å·®ï¼š${diff.toFixed(1)}Â°`);
    if(diff<8){
      lines.push('â†’ æœ¨æ˜Ÿå¸°é‚„ã«ã‹ãªã‚Šè¿‘ã„é…ç½®ã§ã™ã€‚12å¹´ã«ä¸€åº¦ã®ã€Œæ‹¡å¤§ãƒ»æˆé•·ã®ãƒ”ãƒ¼ã‚¯ã€ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚');
      lines.push('   ãƒãƒ£ãƒ³ã‚¹ã‚’æ‹¾ã„ã«ã„ãã€é•·æœŸçš„ãƒ†ãƒ¼ãƒã«å¤§ãããƒ†ã‚³å…¥ã‚Œã™ã‚‹ã®ã«å‘ã„ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚');
    }else if(diff<20){
      lines.push('â†’ æ˜ç¢ºãªå¸°é‚„ã»ã©ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã€Œè¿½ã„é¢¨ã€ãŒæ„Ÿã˜ã‚‰ã‚Œã‚‹ç¯„å›²ã«ã‚ã‚Šã¾ã™ã€‚');
      lines.push('   ã™ã§ã«é€²è¡Œä¸­ã®ãƒ†ãƒ¼ãƒã‚’å°‘ã—æŠ¼ã—åºƒã’ã‚‹ã‚ˆã†ãªå‹•ããŒå‡ºã‚„ã™ã„ã§ã—ã‚‡ã†ã€‚');
    }else{
      lines.push('â†’ æœ¨æ˜Ÿã¯å‡ºç”Ÿæ™‚ã®ä½ç½®ã‹ã‚‰ã‚„ã‚„é›¢ã‚Œã¦ãŠã‚Šã€ç›´æ¥çš„ãªã€Œå¸°é‚„æœŸã€ã¨ã„ã†ã‚ˆã‚Šã¯é•·æœŸçš„ãªã‚µã‚¤ã‚¯ãƒ«ã®é€”ä¸­æ®µéšã§ã™ã€‚');
      lines.push('   ä»Šã¯åŸºç¤å›ºã‚ã‚„ç¨®ã¾ãã«é©ã—ãŸãƒ•ã‚§ãƒ¼ã‚ºã¨æ‰ãˆã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚');
    }
  }else{
    lines.push('æœ¨æ˜Ÿã®ä½ç½®æ¯”è¼ƒã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€å‘¨æœŸã®åˆ¤å®šã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚');
  }
  lines.push('');

  // ä»Šæ—¥ã®ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆ
  lines.push('â–  æœ¬æ—¥ã®ä¸»ãªãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆã¨è§£èª¬');
  if(!aspectsDetailed || aspectsDetailed.length===0){
    lines.push('æœ¬æ—¥ã¯ã€å³å¯†ãªã‚ªãƒ¼ãƒ–å†…ã§ã®ä¸»è¦ãªã‚¢ã‚¹ãƒšã‚¯ãƒˆã¯å¤šãã‚ã‚Šã¾ã›ã‚“ã€‚');
    lines.push('æ—¥å¸¸ã®ãƒšãƒ¼ã‚¹ã‚’æ•´ãˆãŸã‚Šã€åŸºç¤ã‚’è¦‹ç›´ã™æ™‚é–“ã¨ã—ã¦ä½¿ã†ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚');
  }else{
    aspectsDetailed.forEach(a=>{
      const baseMeaning = aspectMeaning(a.type);
      const strength = aspectStrengthText(a.diff);
      const role = TRANSIT_ROLE[a.transitLabel] || '';
      lines.push(
        `${a.transitLabel} ãŒå‡ºç”Ÿã® ${a.natalLabel} ã¨ ${a.type}ï¼ˆå·® ${a.diff.toFixed(1)}Â°ï¼‰ã€‚\n` +
        `  - è§£èª¬ï¼š${baseMeaning}\n` +
        `  - å¼·ã•ï¼š${strength}\n` +
        `  - ãƒ†ãƒ¼ãƒï¼š${role}`
      );
    });
  }

  return lines.join('\n');
}

/* ----------------- ãƒ¡ã‚¤ãƒ³è¨ˆç®— ----------------- */
async function runCalculation(showDebug=false){
  const dateInput = document.getElementById('birthDate').value;
  const timeInput = document.getElementById('birthTime').value;
  let tzInput   = document.getElementById('tzOffset').value.trim();
  const lat     = parseFloat(document.getElementById('birthLat').value);
  const lon     = parseFloat(document.getElementById('birthLon').value);
  const houseMethod = document.getElementById('houseMethod').value;

  if(!tzInput && Number.isFinite(lon)){
    tzInput = approxTzFromLon(lon);
    document.getElementById('tzOffset').value = tzInput;
  }

  const natalDate = parseUserDate(dateInput, timeInput, tzInput);
  if(!natalDate){
    alert('ç”Ÿå¹´æœˆæ—¥ / æ™‚åˆ»ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2000-01-01, 12:00ï¼‰ã€‚');
    return;
  }
  if(typeof Astronomy === 'undefined' || !Astronomy.Body){
    alert('Astronomy Engine ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  const natalAstro = toAstroTime(natalDate);

  const natalPlanets = [];
  let natalJupiterLon = NaN;
  const debug = { planets: [] };

  for(const p of PLANETS){
    try{
      const vec = Astronomy.GeoVector(p.body, natalAstro, true);
      const ecl = Astronomy.Ecliptic(vec);
      const lon = norm360(eclipticLongitude(ecl));
      const degree = Number.isFinite(lon)?(lon%30):NaN;
      natalPlanets.push({ label:p.label, lon, degree });
      if(p.body===Astronomy.Body.Jupiter && Number.isFinite(lon)) natalJupiterLon=lon;
      debug.planets.push({ planet:p.label, lon });
    }catch(e){
      safeLog('planet calc err', e);
      natalPlanets.push({ label:p.label, lon:NaN, degree:NaN });
      debug.planets.push({ planet:p.label, error:String(e) });
    }
  }

  let ascMc;
  try{
    ascMc = computeAscMc(
      natalAstro,
      Number.isFinite(lon)?lon:139.7671,
      Number.isFinite(lat)?lat:35.6812
    );
  }catch(e){
    safeLog('asc compute error', e);
    alert('ã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ãƒ‡ãƒãƒƒã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  const ascDeg = ascMc.ascDeg;
  const mcDeg  = ascMc.mcDeg;
  const cusps  = computeHouseCusps(ascDeg, houseMethod);

  let todayJupiterLon = NaN;
  try{
    const todayAst = toAstroTime(new Date());
    const vec = Astronomy.GeoVector(Astronomy.Body.Jupiter, todayAst, true);
    const ecl = Astronomy.Ecliptic(vec);
    todayJupiterLon = norm360(eclipticLongitude(ecl));
  }catch(e){ safeLog('today jupiter err', e); }

  // æƒ‘æ˜Ÿãƒªã‚¹ãƒˆHTMLï¼ˆãƒã‚¦ã‚¹ç•ªå·å…¥ã‚Šï¼‰
  let html = '';
  natalPlanets.forEach(p=>{
    const degText = Number.isFinite(p.degree)?p.degree.toFixed(1)+'Â°':'â€”';
    const signIndex = Number.isFinite(p.lon)?Math.floor(p.lon/30)%12:null;
    const signText = signIndex!==null?SIGNS[signIndex]:'â€”';
    const houseNo = Number.isFinite(p.lon)?houseFromLongitude(p.lon,cusps):'â€”';
    html += `<div class="result-row"><div class="planet-name">${p.label}</div><div class="planet-sign">${signText} ${degText} â€” ç¬¬${houseNo}å®¤</div></div>`;
  });

  // æœ¨æ˜Ÿæ¯”è¼ƒ
  let luckHtml = '';
  if(Number.isFinite(natalJupiterLon) && Number.isFinite(todayJupiterLon)){
    const diff = angleDiff(natalJupiterLon, todayJupiterLon);
    if(diff<8){
      luckHtml = `âœ¨ <strong>æœ¨æ˜Ÿå¸°é‚„ã«ã‹ãªã‚Šè¿‘ã„çŠ¶æ…‹ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã§ã™ã€‚</strong>12å¹´ã«ä¸€åº¦ã®æ‹¡å¤§æœŸã«å…¥ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
    }else if(diff<20){
      luckHtml = `ğŸŒŸ æœ¨æ˜Ÿã¯å‡ºç”Ÿä½ç½®ã«æ¯”è¼ƒçš„è¿‘ãï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€ç·©ã‚„ã‹ãªè¿½ã„é¢¨ãŒç¶šã„ã¦ã„ã¾ã™ã€‚`;
    }else{
      luckHtml = `ğŸ” æœ¨æ˜Ÿã®ä½ç½®å·®ã¯ ${diff.toFixed(1)}Â°ã€‚ç¾åœ¨ã¯æ˜ç¢ºãªã€Œå¸°é‚„æœŸã€ã§ã¯ãªãã€ã‚µã‚¤ã‚¯ãƒ«ã®é€”ä¸­æ®µéšã¨è¨€ãˆã¾ã™ã€‚`;
    }
    luckHtml += `<div class="small">å‡ºç”Ÿã®æœ¨æ˜Ÿï¼š${natalJupiterLon.toFixed(1)}Â° ï¼ ä»Šæ—¥ã®æœ¨æ˜Ÿï¼š${todayJupiterLon.toFixed(1)}Â°</div>`;
  }else{
    luckHtml = 'æœ¨æ˜Ÿæ¯”è¼ƒæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
  }

  document.getElementById('output').style.display='block';
  document.getElementById('planetList').innerHTML = html;
  document.getElementById('lucky').innerHTML = luckHtml;

  drawChart(cusps, natalPlanets, ascDeg, mcDeg);

  // ä»Šæ—¥ã®ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆâ†’ã‚¢ã‚¹ãƒšã‚¯ãƒˆ
  const todayPlanets = [];
  for(const p of PLANETS){
    try{
      const vec = Astronomy.GeoVector(p.body, toAstroTime(new Date()), true);
      const ecl = Astronomy.Ecliptic(vec);
      const lonT = norm360(eclipticLongitude(ecl));
      todayPlanets.push({ label:p.label, lon:lonT });
    }catch(e){
      todayPlanets.push({ label:p.label, lon:NaN });
    }
  }
  const aspects = [];
  todayPlanets.forEach(t=>{
    natalPlanets.forEach(n=>{
      if(!Number.isFinite(t.lon)||!Number.isFinite(n.lon)) return;
      const diff = angleDiff(n.lon,t.lon);
      const type = classifyAspectType(diff);
      if(type){
        aspects.push({ transitLabel:t.label, natalLabel:n.label, type, diff });
      }
    });
  });
  aspects.sort((A,B)=>A.diff-B.diff);

  const topAspects = aspects.slice(0,10);
  let aspectsHtml = '';
  if(topAspects.length===0){
    aspectsHtml = '<div class="small">æœ¬æ—¥ã¯ã€å³å¯†ãªã‚ªãƒ¼ãƒ–å†…ã§ã®ä¸»è¦ãªãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆãƒ»ã‚¢ã‚¹ãƒšã‚¯ãƒˆã¯å¤šãã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
  }else{
    aspectsHtml = '<ul>' + topAspects.map(a=>(
      `<li><strong>${a.transitLabel}</strong> ãŒ <strong>${a.natalLabel}</strong> ã¨ <strong>${a.type}</strong>ï¼ˆå·® ${a.diff.toFixed(1)}Â°ï¼‰</li>`
    )).join('') + '</ul>';
  }
  document.getElementById('todayTransit').innerHTML = `<h4>æœ¬æ—¥ã®ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆï¼ˆä¸»è¦ã‚¢ã‚¹ãƒšã‚¯ãƒˆï¼‰</h4>${aspectsHtml}`;

  // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  const ctx = {
    birthDateStr: dateInput,
    birthTimeStr: timeInput,
    tzOffsetStr: tzInput,
    lat, lon, houseMethod,
    natalPlanets, cusps, ascDeg, mcDeg,
    natalJupiterLon, todayJupiterLon,
    aspectsDetailed: topAspects
  };
  const reportText = generateLongReport(ctx);
  document.getElementById('longReport').textContent = reportText;

  // ãƒ‡ãƒãƒƒã‚°
  const dbgElem = document.getElementById('debugInfo');
  if(showDebug){
    dbgElem.style.display='block';
    dbgElem.textContent = JSON.stringify({natalPlanets,ascDeg,mcDeg,cusps,todayPlanets,aspects},null,2);
  }else dbgElem.style.display='none';
}

/* ----------------- åˆæœŸåŒ–ï¼†ã‚¤ãƒ™ãƒ³ãƒˆ ----------------- */
document.getElementById('cityPreset').addEventListener('change',(e)=>{
  const v=e.target.value;
  const map={
    tokyo:{lat:35.6812,lon:139.7671,tz:'+09:00'},
    kyoto:{lat:35.0116,lon:135.7681,tz:'+09:00'},
    sapporo:{lat:43.0642,lon:141.3469,tz:'+09:00'},
    london:{lat:51.5074,lon:-0.1278,tz:'+00:00'},
    newyork:{lat:40.7128,lon:-74.0060,tz:'-05:00'}
  };
  if(map[v]){
    document.getElementById('birthLat').value = map[v].lat;
    document.getElementById('birthLon').value = map[v].lon;
    document.getElementById('tzOffset').value = map[v].tz;
  }
});
document.getElementById('tzFromBrowser').addEventListener('click',()=>{
  try{
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const now = new Date();
    const local = new Date(now.toLocaleString('en-US',{timeZone:tz}));
    const diffHours = (local.getTime()-now.getTime())/3600000;
    const sign = diffHours>=0?'+':'-';
    const abs = Math.abs(diffHours);
    const hh = String(Math.floor(abs)).padStart(2,'0');
    const mm = String(Math.round((abs-Math.floor(abs))*60)).padStart(2,'0');
    const offset = `${sign}${hh}:${mm}`;
    document.getElementById('tzOffset').value = offset;
    alert(`ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼š${tz}\nç¾åœ¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’æ¨å®šã—ã¦å…¥åŠ›ã—ã¾ã—ãŸï¼š${offset}`);
  }catch(e){
    safeLog(e);
    alert('ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è‡ªå‹•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
});

(async function init(){
  await unregisterAllServiceWorkers();
  try{
    await checkAstronomyReady(4000);
    document.getElementById('status').textContent='âœ… Astronomy Engine èª­ã¿è¾¼ã¿æ¸ˆ â€” æº–å‚™å®Œäº†';
  }catch(e){
    document.getElementById('status').textContent='âš ï¸ Astronomy Engine ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
    safeLog(e);
  }
  document.getElementById('calcBtn').addEventListener('click',()=>runCalculation(false));
  document.getElementById('exampleBtn').addEventListener('click',()=>{
    document.getElementById('birthDate').value='2000-01-01';
    document.getElementById('birthTime').value='12:00';
    document.getElementById('birthLat').value='35.6812';
    document.getElementById('birthLon').value='139.7671';
    document.getElementById('tzOffset').value='+09:00';
  });
  document.getElementById('debugBtn').addEventListener('click',()=>runCalculation(true));
})();
</script>
</body>
</html>
