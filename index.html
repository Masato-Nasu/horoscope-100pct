<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>æœ¬æ ¼æ˜Ÿå ã„ (Astro Logic)</title>
<meta name="theme-color" content="#6b46c1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="apple-touch-icon" href="/horoscope-100pct/icon-180.png">
<link rel="manifest" href="/horoscope-100pct/manifest.json">
<link rel="icon" href="/horoscope-100pct/favicon.svg" type="image/svg+xml">

<link rel="stylesheet" href="/horoscope-100pct/splash.css">
<script defer src="/horoscope-100pct/splash.js"></script>

<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<style>
/* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
body{font-family:'Noto Sans JP',system-ui,-apple-system,sans-serif;background:#fafafa;color:#222;margin:0;text-align:center}
header{background:#6b46c1;color:#fff;padding:1.2em 0;font-weight:700;font-size:1.3em}
main{padding:1.2em;max-width:720px;margin:0 auto}
input,button{font:inherit;padding:.6em;border-radius:.6em;border:1px solid #ccc;box-sizing:border-box;width:100%}
button{background:#6b46c1;color:#fff;border:none;cursor:pointer;margin-top:10px;font-weight:bold;} 
button:hover{opacity:.9}

/* ã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.card{background:#fff;border-radius:1em;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:1.1em;margin-top:1em;text-align:left}
.muted{color:#666;font-size:.9em}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between}
.title{font-weight:700}
.score{display:flex;align-items:center;gap:8px;margin-left:auto}

/* çµæœè¡¨ç¤ºç”¨ã®è£…é£¾ */
.planet-icon { width: 24px; height: 24px; display: inline-block; text-align: center; margin-right: 5px; }
.zodiac-badge {
    background: #f3e8ff; color: #6b46c1; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em;
}

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 16px;border-radius:999px;opacity:0;transition:opacity .25s; pointer-events: none;}
.toast.show{opacity:1}

/* ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç´™å¹é›ªç”¨ï¼‰ */
#confettiCanvas{position:fixed;inset:0;pointer-events:none;z-index:9999}
</style>
</head>
<body>

<div id="app-splash" role="status" aria-live="polite">
  <img class="logo" src="/horoscope-100pct/icon-192.png" alt="">
  <div class="title">æ˜Ÿå ã„</div>
  <div class="sub">Calculated by Astronomy Engine</div>
</div>

<header>æœ¬æ ¼ å¤©ä½“æ˜Ÿå ã„</header>

<main>
<section id="inputArea">
  <div class="card">
    <h3>ğŸ“ ã‚ãªãŸã®æƒ…å ±</h3>
    <label>ç”Ÿå¹´æœˆæ—¥ <span style="color:red">*</span></label>
    <input type="date" id="birthDate"><br><br>
    
    <label>å‡ºç”Ÿæ™‚åˆ»ï¼ˆä¸æ˜ãªã‚‰12:00ã§OKï¼‰</label>
    <input type="time" id="birthTime" value="12:00"><br><br>
    
    <label>å‡ºç”Ÿéƒ½å¸‚ï¼ˆæ±äº¬ä»¥å¤–ãªã‚‰å…¥åŠ›ï¼‰</label>
    <input type="text" id="placeName" placeholder="Tokyo">
    <button id="geoBtn" type="button" style="background:#888; font-size:0.9em;">éƒ½å¸‚åã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’æ¤œç´¢</button>
    <input type="hidden" id="lat" value="35.6895">
    <input type="hidden" id="lon" value="139.6917">
  </div>

  <div class="card" style="border: 2px solid #ffd166;">
    <h3>ğŸ”® å ã„ãŸã„æ—¥</h3>
    <label>æ—¥ä»˜ï¼ˆæœªæ¥ã‚„éå»ã®æ—¥ä»˜ã‚‚OKï¼‰</label>
    <input type="date" id="targetDate">
    <p class="muted" style="font-size:0.8em;">â€»ã“ã“ã‚’å¤‰ãˆã‚‹ã¨æœªæ¥ã®é‹å‹¢ãŒè¦‹ã‚Œã¾ã™</p>
  </div>

  <button id="runBtn" type="button" style="padding: 1em; font-size: 1.1em;">ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä½œæˆ</button>
</section>

<section id="outputArea" style="display:none;">
  <h2>é‘‘å®šçµæœ</h2>
  <div id="resultContainer"></div>
  
  <div style="margin-top:20px;">
    <button id="backBtn" type="button" style="background:#666;">æˆ»ã‚‹</button>
  </div>
</section>
</main>

<canvas id="confettiCanvas" style="display:none;"></canvas>
<div class="toast" id="toast"></div>

<script>
// åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
const $ = id => document.getElementById(id);
function toast(m){const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000);}
function saveInputs(){
  const d={
    birthDate:$('birthDate').value||'',
    birthTime:$('birthTime').value||'',
    targetDate:$('targetDate').value||'',
    placeName:$('placeName').value||'',
    lat:$('lat').value||'',
    lon:$('lon').value||''
  };
  localStorage.setItem('horo.inputs',JSON.stringify(d));
}
function loadInputs(){
  try{
    const d=JSON.parse(localStorage.getItem('horo.inputs')||'{}');
    for(const k in d){if($(k)) $(k).value=d[k];}
    if(!$('targetDate').value) $('targetDate').value = new Date().toISOString().split('T')[0];
  }catch(e){}
}

// ---------------------------------------------------------
// â˜… æœ¬æ ¼å ã„ãƒ­ã‚¸ãƒƒã‚¯ (Astro Logic)
// ---------------------------------------------------------

const ZODIAC_SIGNS = [
  'â™ˆ ç‰¡ç¾Šåº§', 'â™‰ ç‰¡ç‰›åº§', 'â™Š åŒå­åº§', 'â™‹ èŸ¹åº§', 
  'â™Œ ç…å­åº§', 'â™ ä¹™å¥³åº§', 'â™ å¤©ç§¤åº§', 'â™ è åº§', 
  'â™ å°„æ‰‹åº§', 'â™‘ å±±ç¾Šåº§', 'â™’ æ°´ç“¶åº§', 'â™“ é­šåº§'
];

const PLANET_DEFS = [
  { key: 'Sun',     label: 'â˜€ï¸ å¤ªé™½',  desc: 'äººç”Ÿã®ç›®çš„ãƒ»æœ¬è³ª' },
  { key: 'Moon',    label: 'ğŸŒ™ æœˆ',    desc: 'æ„Ÿæƒ…ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ' },
  { key: 'Mercury', label: 'â˜¿ æ°´æ˜Ÿ',  desc: 'çŸ¥æ€§ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³' },
  { key: 'Venus',   label: 'â™€ é‡‘æ˜Ÿ',  desc: 'æ„›ãƒ»æ¥½ã—ã¿ãƒ»é‡‘é‹' },
  { key: 'Mars',    label: 'â™‚ ç«æ˜Ÿ',  desc: 'è¡Œå‹•åŠ›ãƒ»æƒ…ç†±' },
  { key: 'Jupiter', label: 'â™ƒ æœ¨æ˜Ÿ',  desc: 'å¹¸é‹ãƒ»æ‹¡å¤§ãƒ»ç™ºå±•' },
  { key: 'Saturn',  label: 'â™„ åœŸæ˜Ÿ',  desc: 'èª²é¡Œãƒ»è²¬ä»»ãƒ»å®‰å®š' },
];

// æƒ‘æ˜Ÿä½ç½®è¨ˆç®—
function calculateRealPlanets(date) {
  const results = [];
  PLANET_DEFS.forEach(p => {
    const body = Astronomy.Body[p.key];
    const vector = Astronomy.GeoVector(body, date);
    const ecliptic = Astronomy.Ecliptic(vector); 
    const lon = ecliptic.lon;
    const signIndex = Math.floor(lon / 30);
    const signDegree = lon % 30;
    
    results.push({
      key: p.key,
      name: p.label,
      desc: p.desc,
      lon: lon,
      sign: ZODIAC_SIGNS[signIndex],
      signDegree: signDegree.toFixed(1)
    });
  });
  return results;
}

// æœ¨æ˜Ÿã®æœªæ¥äºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯
function predictJupiterLuck(birthDate, targetDate) {
  // ç”Ÿã¾ã‚ŒãŸæ™‚ã®æœ¨æ˜Ÿ
  const natalVec = Astronomy.GeoVector(Astronomy.Body.Jupiter, birthDate);
  const natalLon = Astronomy.Ecliptic(natalVec).lon;

  // ä»Šï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ—¥ï¼‰ã®æœ¨æ˜Ÿ
  const transitVec = Astronomy.GeoVector(Astronomy.Body.Jupiter, targetDate);
  const transitLon = Astronomy.Ecliptic(transitVec).lon;

  // è§’åº¦å·®
  let diff = Math.abs(transitLon - natalLon);
  if (diff > 180) diff = 360 - diff;
  const orb = 6; // è¨±å®¹åº¦æ•°

  let result = {
    title: "æœ¨æ˜Ÿã¯é€šå¸¸é‹è¡Œä¸­",
    msg: "ç¾åœ¨ã¯ç©ã‚„ã‹ãªé‹æ°—ã§ã™ã€‚æ—¥ã€…ã®ç©ã¿é‡ã­ã‚’å¤§åˆ‡ã«éã”ã—ã¾ã—ã‚‡ã†ã€‚",
    score: 50,
    isLucky: false
  };

  if (diff <= orb) {
    result.title = "âœ¨ 12å¹´ã«ä¸€åº¦ã®å¹¸é‹æœŸ (ãƒªã‚¿ãƒ¼ãƒ³)";
    result.msg = "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æœ¨æ˜ŸãŒã‚ãªãŸã®ç”Ÿã¾ã‚ŒãŸä½ç½®ã«æˆ»ã£ã¦ãã¾ã—ãŸã€‚æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹ã®ã«æœ€é«˜ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚";
    result.score = 100;
    result.isLucky = true;
  } else if (Math.abs(diff - 120) <= orb) {
    result.title = "ğŸŒˆ å¹¸é‹ã®è¿½ã„é¢¨ (ãƒˆãƒ©ã‚¤ãƒ³)";
    result.msg = "ç‰©äº‹ãŒã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚€å¤§å‰é‹ã§ã™ã€‚åŠªåŠ›ä»¥ä¸Šã®æˆæœãŒå‡ºã‚„ã™ã„æ™‚ãªã®ã§ã€ç©æ¥µçš„ã«å‹•ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
    result.score = 90;
    result.isLucky = true;
  } else if (Math.abs(diff - 60) <= orb) {
    result.title = "ğŸ€ ãƒãƒ£ãƒ³ã‚¹åˆ°æ¥ (ã‚»ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«)";
    result.msg = "è‰¯ã„å”åŠ›è€…ãŒç¾ã‚ŒãŸã‚Šã€æ©Ÿä¼šã«æµã¾ã‚Œã‚‹æ™‚æœŸã§ã™ã€‚";
    result.score = 80;
  } else if (Math.abs(diff - 90) <= orb || Math.abs(diff - 180) <= orb) {
    result.title = "ğŸ”¥ è©¦ç·´ã¨æˆé•·ã®æ™‚";
    result.msg = "å°‘ã—å¿™ã—ããªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚è²¬ä»»ãŒå¢—ãˆã‚‹æ™‚æœŸã§ã™ãŒã€ã“ã‚Œã‚’ä¹—ã‚Šè¶Šãˆã‚‹ã¨å¤§ããå®ŸåŠ›ãŒã¤ãã¾ã™ã€‚";
    result.score = 65;
  }

  return result;
}

// æ˜Ÿåº§ã”ã¨ã®ç°¡æ˜“è§£èª¬ï¼ˆæœ¬æ¥ã¯ã“ã“ã‚’ã‚‚ã£ã¨å……å®Ÿã•ã›ã¾ã™ï¼‰
function getSignMeaning(planetKey, sign) {
  if (planetKey === 'Sun') return `ã‚ãªãŸã®åŸºæœ¬æ€§æ ¼ã¯ã€Œ${sign}ã€çš„ã§ã™ã€‚`;
  if (planetKey === 'Moon') return `ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã„ã‚‹æ™‚ã¯ã€Œ${sign}ã€ã®æ€§è³ªãŒå‡ºã¾ã™ã€‚`;
  if (planetKey === 'Venus') return `ã€Œ${sign}ã€ã®ã‚ˆã†ãªæ‹æ„›ã‚„æ¥½ã—ã¿æ–¹ã‚’å¥½ã¿ã¾ã™ã€‚`;
  return '';
}

// å®Ÿè¡Œãƒœã‚¿ãƒ³ã®å‡¦ç†
async function runHoroscope(){
  saveInputs();
  const birthStr = $('birthDate').value;
  if(!birthStr){ alert('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥ã‚Œã¦ãã ã•ã„'); return; }

  const timeStr = $('birthTime').value || '12:00';
  const birthDate = new Date(`${birthStr}T${timeStr}:00`);

  const targetStr = $('targetDate').value || new Date().toISOString().split('T')[0];
  const targetDate = new Date(`${targetStr}T12:00:00`);

  // 1. å‡ºç”Ÿå›³ã®è¨ˆç®—
  const planets = calculateRealPlanets(birthDate);

  // 2. æœ¨æ˜Ÿã®æœªæ¥äºˆæ¸¬
  const jupPred = predictJupiterLuck(birthDate, targetDate);

  // HTMLç”Ÿæˆ
  let html = '';

  // æœªæ¥äºˆæ¸¬ã‚«ãƒ¼ãƒ‰
  html += `<div class="card" style="border: 3px solid ${jupPred.score >= 80 ? '#ffd166' : '#eee'}; background: ${jupPred.score >= 80 ? '#fffbe6' : '#fff'};">
    <div class="row">
      <div class="title" style="color:#b7791f">ğŸª æœ¨æ˜Ÿã®æœªæ¥äºˆæ¸¬</div>
      <div class="score"><strong>å¹¸é‹åº¦ ${jupPred.score}%</strong></div>
    </div>
    <h3 style="margin:10px 0;">${jupPred.title}</h3>
    <p class="muted">${jupPred.msg}</p>
    <p class="muted" style="font-size:0.8em; text-align:right;">å ã£ãŸæ—¥: ${targetStr}</p>
  </div>`;

  // å‡ºç”Ÿå›³ä¸€è¦§
  html += `<div style="margin:20px 0 10px; font-weight:bold; color:#6b46c1;">ã‚ãªãŸã®ç”Ÿã¾ã‚ŒãŸç¬é–“ã®æ˜ŸãŸã¡</div>`;
  
  planets.forEach(p => {
    html += `<div class="card" style="padding:0.8em;">
      <div class="row">
        <div style="font-weight:bold;">${p.name}</div>
        <div class="zodiac-badge">${p.sign} ${p.signDegree}Â°</div>
      </div>
      <div class="muted" style="font-size:0.8em; margin-top:4px;">${p.desc}</div>
      <div style="font-size:0.9em; margin-top:6px;">${getSignMeaning(p.key, p.sign.split(' ')[1])}</div>
    </div>`;
  });

  $('resultContainer').innerHTML = html;
  $('inputArea').style.display='none';
  $('outputArea').style.display='block';
  window.scrollTo({top:0, behavior:'smooth'});

  if(jupPred.isLucky){
    requestAnimationFrame(()=>triggerConfetti(5000, 100));
  }
}

// ---------------------------------------------------------
// UIé–¢é€£ï¼ˆä½ç½®æƒ…å ±ã€ç”»é¢é·ç§»ã€ç´™å¹é›ªï¼‰
// ---------------------------------------------------------

async function onGeocodeClick(){
  const q=($('placeName').value||'').trim();
  if(!q){alert('éƒ½å¸‚åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  try{
    toast('æ¤œç´¢ä¸­...');
    const url='https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
    const r=await fetch(url); 
    const j=await r.json(); 
    if(!j||!j.length){alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return;}
    $('lat').value = j[0].lat;
    $('lon').value = j[0].lon;
    saveInputs();
    toast(`ã€Œ${q}ã€ã®åº§æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸ`);
  }catch(e){ alert('ã‚¨ãƒ©ãƒ¼: '+e); }
}

function backToInput(){
  $('outputArea').style.display='none';
  $('inputArea').style.display='block';
  $('confettiCanvas').style.display='none';
}

function triggerConfetti(durationMs, count){
  const cvs=$('confettiCanvas'); const ctx=cvs.getContext('2d');
  const DPR=window.devicePixelRatio||1;
  cvs.style.display='block'; cvs.width=innerWidth*DPR; cvs.height=innerHeight*DPR;
  const colors=['#6b46c1','#ffd166','#ff6b6b','#48bb78'];
  let pcs=[];
  for(let i=0;i<count;i++) pcs.push({
    x:Math.random()*cvs.width, y:-Math.random()*cvs.height,
    vx:(Math.random()-0.5)*2*DPR, vy:(Math.random()*2+1)*DPR,
    color:colors[i%colors.length], size:(Math.random()*8+4)*DPR
  });
  
  const start=performance.now();
  function loop(t){
    const e=t-start; if(e>durationMs){cvs.style.display='none';return;}
    ctx.clearRect(0,0,cvs.width,cvs.height);
    pcs.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy;
      if(p.y>cvs.height) p.y=-20;
      ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size);
    });
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', ()=>{
  loadInputs();
  $('geoBtn').addEventListener('click', onGeocodeClick);
  $('runBtn').addEventListener('click', runHoroscope);
  $('backBtn').addEventListener('click', backToInput);
  
  // Service Workerç™»éŒ² (PWAç”¨)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(e=>console.log('SW fail:',e));
  }
});
</script>
</body>
</html>