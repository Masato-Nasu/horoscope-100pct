<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <!-- manifest & ã‚¢ã‚¤ã‚³ãƒ³ -->
  <link rel="manifest" href="/horoscope-100pct/manifest.json?v=9">
  <link rel="icon" href="./icon-192.png" type="image/png">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <!-- PWA ã‚«ãƒ©ãƒ¼è¨­å®š -->
  <meta name="theme-color" content="#6b46c1">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- â˜… ä¸€æ™‚çš„ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼šURLã« ?reset=1 ãŒä»˜ã„ã¦ã„ã‚‹ã¨ãã ã‘ SW/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç­‰ã‚’å…¨å‰Šé™¤ã—ã¦å†èª­ã¿è¾¼ã¿ -->
  <script>
  (function(){
    try{
      const url = new URL(location.href);
      if (url.searchParams.get('reset') === '1') {
        (async () => {
          try {
            if ('serviceWorker' in navigator) {
              const regs = await navigator.serviceWorker.getRegistrations();
              for (const r of regs) { await r.unregister(); }
            }
            if (window.caches) {
              const keys = await caches.keys();
              for (const k of keys) { await caches.delete(k); }
            }
            try { localStorage.clear(); } catch(_) {}
            try { sessionStorage.clear(); } catch(_) {}
            // cookieã¯GitHub Pagesã§ã¯åŸºæœ¬ä¸è¦ã ãŒä¸€å¿œå…¨å‰Šé™¤
            document.cookie.split(';').forEach(c=>{
              document.cookie = c.replace(/^ +/,'').replace(/=.*/, '=;expires=' + new Date(0).toUTCString() + ';path=/');
            });
          } finally {
            // ã‚¯ã‚¨ãƒªã‚’å¤–ã—ã¦å†èª­ã¿è¾¼ã¿ï¼ˆæœ€æ–°HTMLã‚’å–å¾—ï¼‰
            url.searchParams.delete('reset');
            location.replace(url.toString());
          }
        })();
      }
    }catch(e){ console.warn('reset script error', e); }
  })();
  </script>

  <!-- Service Worker ç™»éŒ²ï¼ˆé€šå¸¸é‹ç”¨ï¼‰ -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js?v=26')
        .catch(e => console.warn('SWç™»éŒ²å¤±æ•—', e));
    }
  </script>

  <title>100% æ˜Ÿå ã„</title>

  <!-- CSS -->
  <style>
    :root{--bg:#fbfbfc;--card:#fff;--accent:#6b46c1;--muted:#666}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",system-ui,sans-serif;
      background:var(--bg); color:#111
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:8px 0;font-size:20px;color:#6b46c1}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(16,24,40,0.06);margin-top:12px}
    label{display:block;font-weight:600;margin-top:8px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input,select,button{
      width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ee;box-sizing:border-box;font-size:14px;background:#fff
    }
    button{background:#6b46c1;color:#fff;border:0;cursor:pointer;padding:10px;min-height:44px}
    .btn-secondary{background:#e9e6ff;color:#3b2fb3}
    .bar{height:12px;background:#eee;border-radius:999px;overflow:hidden}
    .bar>i{height:100%;display:block;background:linear-gradient(90deg,#ffd166,#ef476f)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px;border-bottom:1px solid #f0f0f0;text-align:left}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{background:#f3f0ff;color:#473592;font-size:12px;border-radius:999px;padding:4px 8px}
    #status{margin-left:auto;font-size:12px;color:#666}
    #log{white-space:pre-wrap;background:#0b1020;color:#e6f0ff;padding:10px;border-radius:8px;font-family:ui-monospace,Menlo,monospace;font-size:12px;max-height:260px;overflow:auto}
    details{border:1px solid #eee;border-radius:10px;padding:8px;margin:8px 0;background:#fff}
    details>summary{cursor:pointer;font-weight:600}
    @media(max-width:700px){.row{flex-direction:column}}
    .muted{color:#666}
    .toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999;opacity:0.95}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  </style>

  <!-- astronomy-engine UMD -->
  <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js" defer></script>
  <script>
    // äºˆå‚™CDN
    window.addEventListener('DOMContentLoaded', ()=>{
      setTimeout(()=>{
        if(!window.Astronomy){
          const s=document.createElement('script');
          s.src='https://unpkg.com/astronomy-engine@2.1.19/astronomy.browser.min.js';
          document.head.appendChild(s);
        }
      },800);
    });
  </script>
</head>
<body>
  <noscript>
    <div style="background:#ffdfdf;color:#900;padding:10px">JavaScriptãŒç„¡åŠ¹ã§ã™ã€‚ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚</div>
  </noscript>

  <div class="wrap">
    <header>
      <h1>100ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆæ˜Ÿå ã„</h1>
      <div id="status">èµ·å‹•æº–å‚™ä¸­â€¦</div>
    </header>
    <div class="card" id="inputCard">
      <div class="row" style="margin-top:10px">
        <div class="col"><label>å‡ºç”Ÿæ—¥</label><input type="date" id="birthDate" /></div>
        <div class="col"><label>å‡ºç”Ÿæ™‚åˆ»</label><input type="time" id="birthTime" step="1" /></div>
      </div>

      <div class="row">
        <div class="col"><label>å‡ºç”Ÿåœ°ï¼ˆéƒ½å¸‚åï¼‰</label><input type="text" id="placeName" placeholder="Tokyo, Japan" /></div>
        <div class="col">
          <label>ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</label>
          <select id="tzSelect">
            <option value="Asia/Tokyo">Asia/Tokyo (æ—¥æœ¬)</option>
            <option value="UTC">UTC</option>
            <option value="Europe/London">Europe/London</option>
            <option value="America/New_York">America/New_York</option>
            <option value="America/Los_Angeles">America/Los_Angeles</option>
            <option value="Asia/Seoul">Asia/Seoul</option>
            <option value="Asia/Shanghai">Asia/Shanghai</option>
            <option value="OTHER">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
          </select>
          <input id="tzInput" type="text" placeholder="ä¾‹: Asia/Tokyo" style="display:none;margin-top:6px" inputmode="latin-name" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>ç·¯åº¦</label>
          <select id="latSelect">
            <option value="35.6895">æ±äº¬ (35.6895)</option>
            <option value="34.6937">å¤§é˜ª (34.6937)</option>
            <option value="43.0621">æœ­å¹Œ (43.0621)</option>
            <option value="33.5902">ç¦å²¡ (33.5902)</option>
            <option value="38.2682">ä»™å° (38.2682)</option>
            <option value="35.4437">æ¨ªæµœ (35.4437)</option>
            <option value="36.3890">å‰æ©‹ (36.3890)</option>
            <option value="35.1815">åå¤å±‹ (35.1815)</option>
            <option value="34.6851">å¥ˆè‰¯ (34.6851)</option>
            <option value="34.2250">åºƒå³¶ (34.2250)</option>
            <option value="32.7503">ç†Šæœ¬ (32.7503)</option>
            <option value="26.2124">é‚£è¦‡ (26.2124)</option>
            <option value="37.9026">é‡‘æ²¢ (37.9026)</option>
            <option value="36.5748">é•·é‡ (36.5748)</option>
            <option value="34.7336">é«˜æ¾ (34.7336)</option>
            <option value="33.8416">æ¾å±± (33.8416)</option>
            <option value="31.5966">é¹¿å…å³¶ (31.5966)</option>
            <option value="40.8246">é’æ£® (40.8246)</option>
            <option value="39.7036">ç››å²¡ (39.7036)</option>
            <option value="0">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
          </select>
          <input type="number" id="lat" step="0.0001" placeholder="ç·¯åº¦ã‚’å…¥åŠ›" style="display:none" />
        </div>

        <div class="col">
          <label>çµŒåº¦</label>
          <select id="lonSelect">
            <option value="139.6917">æ±äº¬ (139.6917)</option>
            <option value="135.5023">å¤§é˜ª (135.5023)</option>
            <option value="141.3544">æœ­å¹Œ (141.3544)</option>
            <option value="130.4017">ç¦å²¡ (130.4017)</option>
            <option value="140.8719">ä»™å° (140.8719)</option>
            <option value="139.6380">æ¨ªæµœ (139.6380)</option>
            <option value="139.0600">å‰æ©‹ (139.0600)</option>
            <option value="136.9066">åå¤å±‹ (136.9066)</option>
            <option value="135.8049">å¥ˆè‰¯ (135.8049)</option>
            <option value="132.4553">åºƒå³¶ (132.4553)</option>
            <option value="130.7417">ç†Šæœ¬ (130.7417)</option>
            <option value="127.6809">é‚£è¦‡ (127.6809)</option>
            <option value="136.9066">é‡‘æ²¢ (136.9066)</option>
            <option value="138.1810">é•·é‡ (138.1810)</option>
            <option value="134.0434">é«˜æ¾ (134.0434)</option>
            <option value="132.7661">æ¾å±± (132.7661)</option>
            <option value="130.5571">é¹¿å…å³¶ (130.5571)</option>
            <option value="140.7400">é’æ£® (140.7400)</option>
            <option value="141.1527">ç››å²¡ (141.1527)</option>
            <option value="0">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
          </select>
          <input type="number" id="lon" step="0.0001" placeholder="çµŒåº¦ã‚’å…¥åŠ›" style="display:none" />
        </div>
      </div>

      <label>è§£ææ—¥ï¼ˆç©ºãªã‚‰ä»Šæ—¥ï¼‰</label><input type="date" id="targetDate" />

      <div class="toolbar">
        <button id="geocodeBtn" type="button">éƒ½å¸‚åã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—</button>
        <button id="calcBtn" type="button">æœ¬æ ¼è§£æã‚’å®Ÿè¡Œ</button>
        <button id="fillBtn" type="button" class="btn-secondary">ãƒ‡ãƒ¢å€¤ã‚’å…¥åŠ›</button>
        <button id="resetBtn" type="button" class="btn-secondary">å…¨ã¦ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div id="output" class="card" style="display:none"></div>
    <div class="card" id="logCard" style="margin-top:12px"><div><strong>ãƒ­ã‚°</strong> <span class="muted">ï¼ˆå•é¡ŒãŒå‡ºãŸã‚‰ã“ã“ã‚’é–‹ã„ã¦ã‚¹ã‚¯ã‚·ãƒ§ãã ã•ã„ï¼‰</span></div><pre id="log"></pre></div>
  </div>

  <!-- ===== ã“ã“ã‹ã‚‰ã‚¢ãƒ—ãƒªæœ¬ä½“JS ===== -->
  <script>
    const $status = document.getElementById('status');
    const $log = document.getElementById('log');
    const NS = 'astro_' + (location.pathname || 'root').replace(/[^\w]/g,'_') + '_'; // å®‰å…¨ãªåå‰ç©ºé–“ã‚­ãƒ¼
    function log(msg){ try{ const t=new Date().toLocaleTimeString(); $log.textContent += `[${t}] ${msg}\n`; }catch(e){} }
    function setStatus(s){ try{ $status.textContent = s; }catch(e){} }
    function toast(text){ try{ const n=document.createElement('div'); n.className='toast'; n.textContent=text; document.body.appendChild(n); setTimeout(()=>n.remove(),1300);}catch(_){ } }

    window.addEventListener('error', e=>{ if(String(e.message||'').includes('Unexpected token <')){ log('CDNãŒHTMLã‚’è¿”ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ­ãƒƒã‚¯/404ã®å¯èƒ½æ€§ï¼‰ã€‚'); } });

    document.addEventListener('DOMContentLoaded', ()=>{
      setStatus(window.Astronomy ? 'å¤©ä½“è¨ˆç®—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªOK' : 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­è¾¼');

      // Button bindings
      document.getElementById('geocodeBtn').addEventListener('click', onGeocodeClick);
      document.getElementById('calcBtn').addEventListener('click', onCalcClick);
      document.getElementById('fillBtn').addEventListener('click', onFillClick);
      document.getElementById('resetBtn').addEventListener('click', onResetClick);

      document.getElementById('latSelect').addEventListener('change', e=>toggleLatInput(e.target.value));
      document.getElementById('lonSelect').addEventListener('change', e=>toggleLonInput(e.target.value));
      document.getElementById('tzSelect').addEventListener('change', e=>toggleTzInput(e.target.value));

      // Auto-save hooks
      const ids = ['birthDate','birthTime','placeName','lat','lon','tzSelect','targetDate','tzInput','latSelect','lonSelect'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', saveInputs);
        el.addEventListener('change', saveInputs);
      });

      loadInputs();
      setStatus('æº–å‚™OK');
    });

    /* ===== Core logicï¼ˆæ­£åˆå›ºå®šï¼‹è‡ªå‹•ä¿å­˜ï¼‰ ===== */
    window.onerror = function(message){ log(`JSã‚¨ãƒ©ãƒ¼: ${message}`); };
    window.addEventListener('unhandledrejection', e=>{ log('Promiseæœªæ•æ‰: '+ String(e.reason)); });

    function storageSet(k,v){ try{ localStorage.setItem(NS+k, v); }catch(e){ log('localStorageä¿å­˜ä¸å¯: '+e.message); } }
    function storageGet(k){ try{ return localStorage.getItem(NS+k); }catch(e){ log('localStorageå–å¾—ä¸å¯: '+e.message); return null; } }
    function storageRemoveAll(){
      try{
        for(let i=localStorage.length-1;i>=0;i--){
          const key = localStorage.key(i);
          if(key && key.startsWith(NS)){ localStorage.removeItem(key); }
        }
        log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã—ã¾ã—ãŸã€‚');
      }catch(e){ log('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: '+e.message); }
    }

    function toggleTzInput(val){
      const inEl=document.getElementById('tzInput');
      if(val==='OTHER'){
        inEl.style.display='block';
        const saved = storageGet('tz')||'';
        if(saved && saved!=='OTHER') inEl.value = saved;
      }else{
        inEl.style.display='none';
        inEl.value='';
        storageSet('tz', val);
      }
      saveInputs();
    }
    function toggleLatInput(val){
      const latInput=document.getElementById('lat');
      if(val==="0"){ latInput.style.display="block"; if(!latInput.value) latInput.value=""; }
      else{ latInput.style.display="none"; latInput.value=val; }
      saveInputs();
    }
    function toggleLonInput(val){
      const lonInput=document.getElementById('lon');
      if(val==="0"){ lonInput.style.display="block"; if(!lonInput.value) lonInput.value=""; }
      else{ lonInput.style.display="none"; lonInput.value=val; }
      saveInputs();
    }

    const PERSIST_KEYS = ['birthDate','birthTime','placeName','lat','lon','tzSelect','targetDate','tzInput','latSelect','lonSelect'];
    function saveInputs(){
      try{
        for(const id of PERSIST_KEYS){
          const el=document.getElementById(id);
          if(!el) continue;
          const val = (el.tagName==='SELECT') ? el.value : el.value;
          storageSet('fld_'+id, val ?? '');
        }
        log('å…¥åŠ›ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
      }catch(e){ log('ä¿å­˜ã‚¨ãƒ©ãƒ¼: '+(e.message||e)); }
    }
    function loadInputs(){
      try{
        for(const id of PERSIST_KEYS){
          const el=document.getElementById(id);
          if(!el) continue;
          const val = storageGet('fld_'+id);
          if(val!==null){ el.value = val; }
        }
        toggleLatInput(document.getElementById('latSelect').value);
        toggleLonInput(document.getElementById('lonSelect').value);
        toggleTzInput(document.getElementById('tzSelect').value);
        log('å…¥åŠ›ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚');
      }catch(e){ log('å¾©å…ƒã‚¨ãƒ©ãƒ¼: '+(e.message||e)); }
    }

    (function tzInit(){
      const sel=document.getElementById('tzSelect');
      let deviceTz='Asia/Tokyo';
      try{deviceTz=Intl.DateTimeFormat().resolvedOptions().timeZone||'Asia/Tokyo';}catch(e){}
      if (![...sel.options].some(o=>o.value===deviceTz)){
        const o=document.createElement('option');o.value=deviceTz;o.textContent=deviceTz+'ï¼ˆç«¯æœ«ï¼‰';sel.insertBefore(o,sel.firstChild);
      }
      const saved = storageGet('tz');
      if(saved && saved!=='OTHER'){
        if ([...sel.options].some(o=>o.value===saved)){ sel.value=saved; }
        else{ sel.value='OTHER'; document.getElementById('tzInput').value=saved; }
      }else{
        sel.value=sel.value || deviceTz;
      }
    })();

    let __rng = Math.random;
    function seedRngFromDateOnly(localDateStr){
      const nums = localDateStr.replace(/-/g,'').slice(0,8);
      let s = parseInt(nums,10) >>> 0;
      __rng = (function(seed){
        return function(){
          seed = (seed + 0x6D2B79F5) | 0;
          let t = Math.imul(seed ^ (seed>>>15), 1 | seed);
          t = (t + Math.imul(t ^ (t>>>7), 61 | t)) ^ t;
          return ((t ^ (t>>>14)) >>> 0) / 4294967296;
        };
      })(s);
    }

    function normalizeDeg(d){d=d%360; if(d<0)d+=360; return d;}
    function toJulianDate(date){return(date.getTime()/86400000.0)+2440587.5;}
    function gmstDegrees(date){const JD=toJulianDate(date);const T=(JD-2451545.0)/36525.0;let GMST=280.46061837+360.98564736629*(JD-2451545.0)+0.000387933*T*T-(T*T*T)/38710000.0;GMST=((GMST%360)+360)%360;return GMST;}
    function lstDegrees(dateUTC,lon){let lst=gmstDegrees(dateUTC)+lon;lst=((lst%360)+360)%360;return lst;}
    function deg2rad(d){return d*Math.PI/180;} function rad2deg(r){return r*180/Math.PI;}
    function calcAscendant(dateUTC,lat,lon){const lst=lstDegrees(dateUTC,lon);const eps=23.4392911*Math.PI/180;const theta=deg2rad(lst),phi=deg2rad(lat);const y=-Math.cos(theta);const x=Math.sin(theta)*Math.cos(eps)+Math.tan(phi)*Math.sin(eps);let asc=Math.atan2(y,x);asc=rad2deg(asc);if(asc<0)asc+=360;if(asc<180)asc+=180;else asc-=180;return normalizeDeg(asc);}
    function calcMC(dateUTC,lon){const lst=lstDegrees(dateUTC,lon);const eps=deg2rad(23.4392911);const ramc=deg2rad(lst);let L=Math.atan2(Math.sin(ramc),Math.cos(ramc)*Math.cos(eps));L=rad2deg(L);if(L<0)L+=360;return normalizeDeg(L);}
    function isoWithTZoffset(localIso,tz){
      const dt=new Date(localIso);
      try{
        const parts=new Intl.DateTimeFormat('en-US',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).formatToParts(dt);
        const map={}; for(const p of parts) map[p.type]=p.value;
        const asTzISO=`${map.year}-${map.month}-${map.day}T${map.hour}:${map.minute}:${map.second}Z`;
        const tUtc=Date.parse(asTzISO),localMillis=dt.getTime();
        const diffMin=Math.round((tUtc-localMillis)/60000);
        const sign=diffMin>=0?'+':'-'; const mm=Math.abs(diffMin);
        return localIso+sign+String(Math.floor(mm/60)).padStart(2,'0')+':'+String(mm%60).padStart(2,'0');
      }catch(e){
        return localIso;
      }
    }
    function parseLocalToUTCdate(localDateStr,tz){try{return new Date(isoWithTZoffset(localDateStr,tz));}catch(e){return new Date(localDateStr);} }

    function planetEclipticLongitude(body,dateUTC){
      try{ if(body==='Sun' && Astronomy.SunLongitude) return normalizeDeg(Astronomy.SunLongitude(dateUTC)); }catch(e){}
      try{ if(body==='Sun' && Astronomy.SunPosition){ const sp = Astronomy.SunPosition(dateUTC); const lon = (typeof sp.elon==='number')?sp.elon : (sp.ecliptic&&typeof sp.ecliptic.lon==='number')?sp.ecliptic.lon : sp.lon; if(typeof lon==='number') return normalizeDeg(lon);} }catch(e){}
      try{ if(body==='Sun'){ const ecl = Astronomy.Ecliptic('Sun', dateUTC); if(ecl && typeof ecl.lon==='number') return normalizeDeg(ecl.lon);} }catch(e){}
      try{ return normalizeDeg(Astronomy.EclipticLongitude(body,dateUTC)); }catch(e){ try{ const ecl=Astronomy.Ecliptic(body,dateUTC); return normalizeDeg(ecl.lon);}catch(err){ return NaN; } }
    }

    const ASPECTS=[{name:'Conjunction',deg:0,orb:8,weight:1.4},{name:'Sextile',deg:60,orb:6,weight:0.9},{name:'Square',deg:90,orb:8,weight:-1.2},{name:'Trine',deg:120,orb:8,weight:1.2},{name:'Opposition',deg:180,orb:8,weight:-1.5}];
    const CATEGORY_MAP={"ç·åˆ":['Sun','Moon','Jupiter','Saturn'],"æ‹æ„›":['Venus','Moon','Mars'],"ä»•äº‹":['Sun','Mars','Saturn'],"é‡‘é‹":['Jupiter','Venus'],"å¥åº·":['Moon','Saturn','Mars']};
    function angleDiff(a,b){let d=Math.abs(a-b)%360;if(d>180)d=360-d;return d;}
    function aspectStrength(delta,asp){const diff=Math.abs(delta-asp.deg);if(diff>asp.orb)return 0;return 1-(diff/asp.orb);}
    function detectAspects(natal,transit){
      const list=[];
      for(const p in natal){
        if(!(p in transit)) continue;
        const d=angleDiff(natal[p],transit[p]);
        for(const asp of ASPECTS){
          const clos=aspectStrength(d,asp);
          if(clos>0){ list.push({planet:p,aspect:asp.name,exactness:clos,weight:asp.weight,angle:d,orb:asp.orb});}
        }
      }
      // å¯„ä¸ã®å¤§ãã•ï¼ˆ|weight|Ã—exactnessï¼‰ã§é™é †
      return list.sort((a,b)=>(Math.abs(b.weight)*b.exactness)-(Math.abs(a.weight)*a.exactness));
    }
    function scoreCategories(aspects){
      const raw={}; for(const c in CATEGORY_MAP) raw[c]=0;
      for(const a of aspects){
        const importance={'Sun':1.1,'Moon':1.05,'Mercury':0.9,'Venus':1.0,'Mars':1.0,'Jupiter':1.0,'Saturn':1.0,'Uranus':0.6,'Neptune':0.5,'Pluto':0.5,'ASC':0.8,'MC':0.9}[a.planet]||0.6;
        const contrib=a.exactness*a.weight*importance;
        for(const c in CATEGORY_MAP){ if(CATEGORY_MAP[c].includes(a.planet)) raw[c]+=contrib; }
        raw['ç·åˆ']+=contrib*0.4;
      }
      const results={};
      for(const c in raw){ const x=raw[c]; results[c]=Math.round((1/(1+Math.exp(-(x))))*100); }
      return results;
    }

    const _recentLines=new Set();
    function _markRecent(line){ if(!line) return; _recentLines.add(line); if(_recentLines.size>180){ const it=_recentLines.values().next().value; _recentLines.delete(it);} }
    let RUN_USED = new Set();
    function beginRun(){ RUN_USED = new Set(); }
    function pickNoDup(arr){
      if(!arr || !arr.length) return "";
      const shuffled=[...arr].sort(()=>__rng()-0.5);
      for(const s of shuffled){
        if(!RUN_USED.has(s) && !_recentLines.has(s)){
          RUN_USED.add(s); _markRecent(s);
          return s;
        }
      }
      for(const s of shuffled){
        if(!RUN_USED.has(s)){
          RUN_USED.add(s); _markRecent(s);
          return s;
        }
      }
      const fb=shuffled[0]; RUN_USED.add(fb); _markRecent(fb);
      return fb;
    }
    function sampleUnique(arr, n){
      if(!arr || !arr.length) return [];
      const out=[]; const pool=[...arr];
      for(let i=0;i<n;i++){
        const candidate = pickNoDup(pool);
        if(!candidate) break;
        out.push(candidate);
        const idx = pool.indexOf(candidate);
        if(idx>=0) pool.splice(idx,1);
        if(pool.length===0) break;
      }
      return out;
    }

    const TPL={
      "å…¨ä½“é‹":{"å¥½èª¿":["è¿½ã„é¢¨ãŒãµã‚“ã‚ã‚Šå¹ã„ã¦ã„ã¾ã™ã€‚ã„ã¾ã®ãƒªã‚ºãƒ ã‚’å¤§åˆ‡ã«ã€‚","å°ã•ãªæ±ºæ–­ãŒå¤§ããªå‰é€²ã«ã€‚æ°—æŒã¡ã®â€œç´ ç›´ã•â€ã‚’ä¿¡ã˜ã¦ã€‚","æµã‚Œã¯è»½ã‚„ã‹ã€‚æ®µå–ã‚Šã‚ˆã‚Šâ€œã¾ãšç€æ‰‹â€ãŒå‰ã€‚","åŠ©ã‘ãŒè‡ªç„¶ã¨é›†ã¾ã‚Šã‚„ã™ã„æ—¥ã€‚æ„Ÿè¬ã‚’è¨€è‘‰ã«ã—ã¦å¾ªç’°ã‚’ã€‚","è‰¯ã„å¶ç„¶ã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé‡ãªã‚‹äºˆæ„Ÿã€‚ä½™ç™½ã‚’æ®‹ã—ã¦å‹•ã“ã†ã€‚","æŒã¡å‘³ãŒä¼ã‚ã‚Šã‚„ã™ã„ã¨ãã€‚ç­‰èº«å¤§ã§ååˆ†ã«é­…åŠ›çš„ã€‚","ç©ã¿ä¸Šã’ã®å®Ÿæ„ŸãŒå¾—ã‚„ã™ã„ä¸€æ—¥ã€‚å°ã•ãªå®Œäº†ã‚’ç©ã¿é‡ã­ã¦ã€‚","è¿·ã£ãŸã‚‰â€œè»½ã„ã»ã†â€ã€‚èº«ä½“ãŒæ¥½ãªé¸æŠãŒé€²ã‚€ã‚µã‚¤ãƒ³ã€‚","æ°—æŒã¡ã®è¼ªéƒ­ãŒã‚„ã‚ã‚‰ã‹ãæ•´ã„ã¾ã™ã€‚ç¬‘é¡”ãŒæœ€å¼·ã®ãŠå®ˆã‚Šã€‚","â€œä»Šã®ç§â€ã«åˆã†ã‚µã‚¤ã‚ºæ„Ÿã§OKã€‚ç„¡ç†ã›ãšè»½ã‚„ã‹ã«ã€‚"],"æ™®é€š":["ã»ã©ã‚ˆã„ãƒšãƒ¼ã‚¹ã§é€²ã‚ã°ååˆ†ã€‚ä¸å¯§ã•ãŒå‘³æ–¹ã«ãªã‚Šã¾ã™ã€‚","ç„¦ã‚‰ãšã€åŸºæœ¬ã‚’æ•´ãˆã‚‹ã»ã©å®‰å®šã€‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒå½¹ç«‹ã¡ã¾ã™ã€‚","ã‚„ã‚‹ã“ã¨ã‚’ä¸‰ã¤ã«çµã‚‹ã¨ã€å¿ƒã®ä½™è£•ãŒæˆ»ã£ã¦ãã¾ã™ã€‚","ä¼‘ã‚€ãƒ»é£Ÿã¹ã‚‹ãƒ»æ•´ãˆã‚‹ã®åŸºç¤ã‚’ä¸å¯§ã«ã€‚ä¸­åº¸ã®è‰¯ã•ãŒæ´»ãã‚‹æ—¥ã€‚","å®Œç’§ã‚ˆã‚Šç¶™ç¶šã€‚60ç‚¹ã§æå‡ºã—ã¦æ¬¡ã¸é€²ã‚‚ã†ã€‚"],"æ³¨æ„":["ãŒã‚“ã°ã‚Šéãã®ã‚µã‚¤ãƒ³ã€‚æ·±å‘¼å¸ã—ã¦å¿ƒã‚’ã‚†ã‚‹ã‚ã¦ã€‚","åˆ¤æ–­ã¯æ˜æ—¥ã«å›ã—ã¦ã‚‚OKã€‚ã¾ãšã¯ç¡çœ ã¨æ „é¤Šã‚’ã€‚","â€œã‚„ã‚‰ãªã„ã“ã¨â€ã‚’ä¸‰ã¤æ±ºã‚ã¦ã€è² è·ã‚’è»½ãã—ã¾ã—ã‚‡ã†ã€‚","æ„Ÿæƒ…ã¯æ³¢ç«‹ã¡ã‚„ã™ã„ã¨ãã€‚è¨€è‘‰ã¯ã²ã¨å‘¼å¸ç½®ã„ã¦ã‹ã‚‰ã€‚","ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ã€‚é ¼ã‚‹ã“ã¨ã‚‚å‰é€²ã®ä¸€éƒ¨ã§ã™ã€‚"]},
      "æ‹æ„›":{"å¥½èª¿":["ç´ ç›´ãªè¨€è‘‰ãŒå±Šãã‚„ã™ã„ã¨ãã€‚ã¡ã„ã•ãªå„ªã—ã•ã‚’æ·»ãˆã¦ã€‚","ç¬‘é¡”ã¨ã‚ã„ã¥ã¡ã§è·é›¢ãŒç¸®ã¾ã‚Šã¾ã™ã€‚èƒŒä¼¸ã³ã¯ä¸è¦ã€‚","å…±æœ‰ã‚ˆã‚Šå…±æ„Ÿã‚’å¤§åˆ‡ã«ã€‚çŸ­ã„ä¸€è¨€ãŒæƒ³åƒä»¥ä¸Šã«éŸ¿ãã¾ã™ã€‚","äºˆå®šã‚’ä¸€ã¤ã ã‘ä¸€ç·’ã«æ±ºã‚ã‚‹ã¨ã€é–¢ä¿‚ãŒå‰ã«é€²ã¿ã¾ã™ã€‚","èº«ã ã—ãªã¿ã®ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆã§å°è±¡UPã€‚é¦™ã‚Šã‚„ã‚¢ã‚¯ã‚»ãŒå‰ã€‚"],"æ™®é€š":["è‡ªç„¶ä½“ã®ã‚ãªãŸãŒä¸€ç•ªé­…åŠ›çš„ã€‚ç„¦ã‚‰ãšã€å¿ƒåœ°ã‚ˆã„ãƒ†ãƒ³ãƒã§ã€‚","ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã‚’å°Šé‡ã—ã¦ã€ä»Šæ—¥ã¯â€œåºƒã’ã™ããªã„â€ãŒæ­£è§£ã€‚","è©±é¡Œã¯è»½ã‚ã«ã€‚å…±é€šã®å°ãƒã‚¿ãŒè·é›¢ã‚’ç¸®ã‚ã¾ã™ã€‚","è¿”ä¿¡ã¯çŸ­ãã¦ã‚‚OKã€‚ä¸å¯§ã•ãŒä¼ã‚ã‚Œã°ååˆ†ã§ã™ã€‚","äºˆå®šã¯æ›–æ˜§ã«ã›ãšâ€œã„ã¤â€ã§ç· ã‚ã‚‹ã¨å®‰å¿ƒæ„ŸãŒå¢—ã—ã¾ã™ã€‚"],"æ³¨æ„":["è¨€ã„éããƒ»å—ã‘å–ã‚Šé•ã„ã«æ³¨æ„ã€‚è¨€è‘‰é¸ã³ã¯ã‚„ã•ã—ãã€‚","ä¸å®‰ã¯äº‹å®Ÿã¨åˆ†ã‘ã¦ãƒ¡ãƒ¢ã€‚æ„Ÿæƒ…ãŒæ•´ã†ã¨ä¼šè©±ã‚‚æ•´ã„ã¾ã™ã€‚","è¿”ä¿¡ã¯ä¸€æ—¦ä¿ç•™ã§ã‚‚OKã€‚ä»Šã¯ä¼‘ã‚€ã®ãŒæœ€å–„ã§ã™ã€‚","ç™½é»’ã‚’æ€¥ãŒãªã„ã€‚ã‚°ãƒ¬ãƒ¼ã‚’ä¸å¯§ã«ç¢ºèªã™ã‚‹ã»ã©å®‰å¿ƒã«ã€‚","æ²ˆé»™ã¯æ‚ªã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç›¸æ‰‹ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å°Šé‡ã—ã¦ã€‚"]},
      "ä»•äº‹":{"å¥½èª¿":["æ®µå–ã‚ŠãŒã™ã£ã¨ãƒãƒã‚‹æ—¥ã€‚å…ˆå›ã‚Šã®æ°—é…ã‚ŠãŒå¥½å°è±¡ã«ã€‚","æœ€åˆã®30åˆ†ã‚’å…¨åŠ›ã§ã€‚å‹¢ã„ãŒãã®ã¾ã¾æˆæœã«ã€‚","å°ã•ãªå®Œäº†ã‚’ç©ã¿é‡ã­ã‚‹ã»ã©è©•ä¾¡ãŒã¤ã„ã¦ãã¾ã™ã€‚","â€œä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ã‚’ä¸€è¡Œâ€ã§æ±ºã‚ã‚‹ã¨é€²ã¿ãŒåŠ é€Ÿã€‚","å¾—æ„é ˜åŸŸã«å¯„ã›ã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã€‚åˆ†ã‹ã‚‰ãªã„æ‰€ã¯æ—©ã‚ã«ç›¸è«‡ã€‚"],"æ™®é€š":["åŸºæœ¬ã«ç«‹ã¡è¿”ã‚‹ã»ã©å®‰å®šã—ã¾ã™ã€‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒé ¼ã‚‚ã—ã„å‘³æ–¹ã€‚","TODOã‚’3å€‹ã«çµã‚‹ã¨é›†ä¸­ãŒæˆ»ã‚Šã¾ã™ã€‚é€šçŸ¥ã¯åˆ‡ã£ã¦OKã€‚","é€²æ—ãŒè¦‹ãˆãªããªã£ãŸã‚‰â€œåˆ†ã‘ã‚‹ãƒ»ä¸¦ã¹ã‚‹ãƒ»æ¨ã¦ã‚‹â€ã€‚","ä¸€ç•ªè»½ã„ä½œæ¥­ã‹ã‚‰ç€æ‰‹ã€‚æ‰‹ãŒæ¸©ã¾ã‚‹ã¨é›£æ‰€ã‚‚é€²ã¿ã¾ã™ã€‚","5åˆ†ã ã‘ã®ãƒ‰ãƒ©ãƒ•ãƒˆã§è‰¯ã„ã®ã§ã€ã¾ãšæå‡ºã—ã¦ä¼šè©±ã‚’å§‹ã‚ã‚‹ã€‚"],"æ³¨æ„":["ãŒã‚“ã°ã‚Šã©ã“ã‚ã‚’é¸ã‚“ã§ã€‚æŠ±ãˆè¾¼ã¿éãã«ãƒ–ãƒ¬ãƒ¼ã‚­ã‚’ã€‚","åˆ¤æ–­ã¯çŸ­ãã€ä½œæ¥­ã¯é•·ãã€‚æ‚©ã¿ã™ãã¯ç”Ÿç”£æ€§ã‚’ä¸‹ã’ã¾ã™ã€‚","å¯ä¸è¶³ãƒ»ç©ºè…¹ã¯é›†ä¸­ã®æ•µã€‚ã¾ãšã¯èº«ä½“ã‚’æ•´ãˆã¦ã€‚","æœŸé™ã¨å“è³ªã¯ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã€‚â€œå¿…è¦ååˆ†â€ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚","æ€’ã‚Šã®ãƒ¡ãƒ¼ãƒ«ã¯â€œä¸‹æ›¸ãâ€ã¸ã€‚æ˜æœè¦‹ç›´ã—ã¦ã‹ã‚‰é€ä¿¡ã€‚"]},
      "é‡‘é‹":{"å¥½èª¿":["ã‚ˆã„é¸æŠçœ¼ã€‚å¿…è¦ãªã‚‚ã®ã‚’å¿…è¦ãªåˆ†ã ã‘è³¢ãã€‚","å°ã•ãªæŠ•è³‡ãŒå°†æ¥ã®å®‰å¿ƒã«ã€‚ã¾ãšã¯å›ºå®šè²»ã®æ”¹å–„ã‹ã‚‰ã€‚","å€¤æœ­ã‚ˆã‚Šâ€œä½¿ç”¨å›æ•°â€ã§è€ƒãˆã‚‹ã¨æº€è¶³åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚","ãƒã‚¤ãƒ³ãƒˆã‚ˆã‚Šç¾é‡‘ã®å¯è¦–åŒ–ãŒåŠ¹æœçš„ã€‚å®¶è¨ˆã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚","ã”è¤’ç¾ã¯ä¸Šè³ªã‚’å°‘é‡ã€‚æº€è¶³æ„Ÿã¨ç¯€åº¦ã®ãƒãƒ©ãƒ³ã‚¹â—ã€‚"],"æ™®é€š":["è¦‹ç›´ã—ã¨æ•´ãˆç›´ã—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚ã‚µãƒ–ã‚¹ã‚¯ç‚¹æ¤œãŒâ—ã€‚","é€±æ¬¡äºˆç®—ã‚’æ±ºã‚ã‚‹ã¨ã€ãƒ–ãƒ¬ãŒæ¸›ã£ã¦æ°—æŒã¡ã‚‚æ¥½ã«ã€‚","é£Ÿè²»ã¯â€œå›ºå®šã®å®šç•ªâ€ã‚’ä½œã‚‹ã¨å®‰å®šã—ã¾ã™ã€‚","ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®ã‚‹ã ã‘å®¶è¨ˆç°¿ã§ååˆ†ã€‚ç¶šã‘ã‚„ã™ã•å„ªå…ˆã€‚","è²·ã„æ›¿ãˆã¯â€œä¿®ç†ã§ãã‚‹ã‹â€ã‚’å…ˆã«ç¢ºèªã€‚é•·æŒã¡ãŒç¯€ç´„ã€‚"],"æ³¨æ„":["æ°—åˆ†è²·ã„ã«æ³¨æ„ã€‚ã‚«ãƒ¼ãƒˆã¯ä¸€åº¦é–‰ã˜ã¦ã€‚","å‹§èª˜ã‚„é™å®šè¡¨ç¤ºã¯æ·±å‘¼å¸ã—ã¦ã‹ã‚‰ã€‚å¿…è¦æ€§ã§åˆ¤æ–­ã‚’ã€‚","å¤§ããªå¥‘ç´„ã¯å…ˆé€ã‚Šã§ã‚‚OKã€‚æƒ…å ±ã‚’æ•´ç†ã—ã¦ã‹ã‚‰ã€‚","â€œå®‰ã„ã‹ã‚‰è²·ã†â€ã¯ã‚³ã‚¹ãƒˆå¢—ã®èŠ½ã€‚ä½¿ã†äºˆå®šã‚’ç¢ºèªã€‚","ãƒ­ãƒ¼ãƒ³ã‚„åˆ†å‰²ã¯ç·é¡ã§è¦‹ã‚‹ã€‚æ‰‹æ•°æ–™ã®å½±éŸ¿ã«æ³¨æ„ã€‚"]},
      "å¥åº·":{"å¥½èª¿":["å›å¾©åŠ›ãŒé«˜ã‚ã€‚è»½ã„é‹å‹•ã¨ãŸã£ã·ã‚Šã®æ°´åˆ†ã‚’ã€‚","å§¿å‹¢ã¨å‘¼å¸ã‚’æ•´ãˆã‚‹ã ã‘ã§ä½“æ„ŸãŒå¤‰ã‚ã‚‹æ—¥ã€‚","æœã®å…‰ã‚’æµ´ã³ã‚‹ã¨ãƒªã‚ºãƒ ãŒæ•´ã„ã€é›†ä¸­åŠ›ã‚‚ã‚¢ãƒƒãƒ—ã€‚","æ¸©ã‹ã„é£²ã¿ç‰©ãŒèº«ä½“ã‚’å†…å´ã‹ã‚‰ã‚µãƒãƒ¼ãƒˆã€‚","æ•£æ­©ã‚„ã‚¹ãƒˆãƒ¬ãƒƒãƒã§è¡€ã®å·¡ã‚Šã‚’è‰¯ãã—ã¦ã€‚"],"æ™®é€š":["å§¿å‹¢ã¨å‘¼å¸ã‚’æ„è­˜ã—ã¦ã€ç–²ã‚Œã‚’ãŸã‚ãªã„å·¥å¤«ã‚’ã€‚","æ°´åˆ†ãƒ»ãŸã‚“ã±ãè³ªãƒ»ç¡çœ ã®ä¸‰æœ¬æŸ±ã‚’ä¸å¯§ã«ã€‚","é–“é£Ÿã¯â€œãƒŠãƒƒãƒ„ï¼‹æ°´â€ãªã©ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚","ç”»é¢ã‹ã‚‰ç›®ã‚’é›¢ã—ã¦ã€é ãã‚’è¦‹ã‚‹ä¼‘æ†©ã‚’ã€‚","ä½“èª¿ãƒ¡ãƒ¢ã‚’ä¸€è¡Œã€‚å‚¾å‘ãŒè¦‹ãˆã‚‹ã¨å¯¾ç­–ãŒç«‹ã¦ã‚„ã™ã„ã€‚"],"æ³¨æ„":["ç„¡ç†ã¯ç¦ç‰©ã€‚ä»Šæ—¥ã¯çŸ­æ™‚é–“ã§åˆ‡ã‚Šä¸Šã’ã¦OKã€‚","å†·ãˆãƒ»ã ã‚‹ã•ã‚’æ„Ÿã˜ãŸã‚‰æ¸©ã‹ã„é£²ã¿ç‰©ã§ã‚±ã‚¢ã‚’ã€‚","ç¡çœ æœ€å„ªå…ˆã€‚æ·±å¤œã®ã‚¹ãƒãƒ›ã¯ãŠä¼‘ã¿ã—ã¾ã—ã‚‡ã†ã€‚","é ‘å¼µã‚Šéãã®ã‚µã‚¤ãƒ³ã€‚è»½ã„ã‚¹ãƒˆãƒ¬ãƒƒãƒã§ãƒªã‚»ãƒƒãƒˆã‚’ã€‚","äººæ··ã¿ã¯çŸ­æ™‚é–“ã«ã€‚é™ã‹ãªæ™‚é–“ã‚’ä½œã£ã¦ã€‚"]}
    };

    function bucketFromScore(s){ if(s>=67) return 'å¥½èª¿'; if(s>=34) return 'æ™®é€š'; return 'æ³¨æ„'; }

    function renderOutput({natal, transit, aspects, scores, meta}){
      const out = document.getElementById('output');
      const cats = [
        {key:'ç·åˆ', label:'ç·åˆ', tplKey:'å…¨ä½“é‹'},
        {key:'æ‹æ„›', label:'æ‹æ„›', tplKey:'æ‹æ„›'},
        {key:'ä»•äº‹', label:'ä»•äº‹', tplKey:'ä»•äº‹'},
        {key:'é‡‘é‹', label:'é‡‘é‹', tplKey:'é‡‘é‹'},
        {key:'å¥åº·', label:'å¥åº·', tplKey:'å¥åº·'}
      ];
      const bars = cats.map(c=>{
        const v = scores[c.key] ?? 50;
        return `<div style="margin:6px 0">
          <div style="display:flex;justify-content:space-between"><strong>${c.label}</strong><span>${v}%</span></div>
          <div class="bar"><i style="width:${v}%"></i></div>
        </div>`;
      }).join('');

      const aspRows = aspects.slice(0,24).map(a=>{
        return `<tr><td>${a.planet}</td><td>${a.aspect}</td><td>${a.angle.toFixed(1)}Â°</td><td>${(a.exactness*100|0)}%</td></tr>`;
      }).join('');

      beginRun();
      const readings = cats.map(c=>{
        const score = scores[c.key] ?? 50;
        const bucket = bucketFromScore(score);
        const tplKey = c.tplKey || c.key;
        const lines = sampleUnique(TPL[tplKey]?.[bucket]||[], 3).map(s=>`<li>${s}</li>`).join('');
        return `<details open><summary>${c.label}ï¼š${bucket}</summary><ul>${lines||'<li>â€¦</li>'}</ul></details>`;
      }).join('');

      const chips = `<div class="chips">
        <div class="chip">å‡ºç”Ÿ: ${meta.birthLocal}</div>
        <div class="chip">è§£æï¼ˆå›ºå®šï¼‰: ${meta.targetLocal}ï¼ˆæ­£åˆå›ºå®šï¼‰</div>
        <div class="chip">TZ: ${meta.tz}</div>
        <div class="chip">ç·¯åº¦: ${meta.lat.toFixed(4)}</div>
        <div class="chip">çµŒåº¦: ${meta.lon.toFixed(4)}</div>
      </div>`;

      out.innerHTML = `
        <div><strong>çµæœ</strong></div>
        ${chips}
        <div style="margin-top:10px">${bars}</div>
        <details style="margin-top:10px"><summary>ã‚¢ã‚¹ãƒšã‚¯ãƒˆä¸€è¦§ï¼ˆæœ€å¤§24ä»¶ï¼‰</summary>
          <table><thead><tr><th>å¤©ä½“</th><th>ç¨®åˆ¥</th><th>è§’åº¦</th><th>è¿‘ã•</th></tr></thead><tbody>${aspRows}</tbody></table>
        </details>
        <div class="explain" style="margin-top:12px">
          <h3 style="margin:6px 0">ä»Šæ—¥ã®èª­ã¿</h3>
          ${readings}
          <p class="muted">â€» è§£ææ—¥ã‚’<strong>ãƒ­ãƒ¼ã‚«ãƒ«æ­£åˆ</strong>ã«å›ºå®šã—ã€æ–‡ç« ä¹±æ•°ã‚‚<strong>æ—¥ä»˜ã®ã¿</strong>ã§æ±ºå®šã€‚<br/>åŒæ—¥ãƒ»åŒTZã§ã‚ã‚Œã°çµæœã¯ä¸å¤‰ã§ã™ã€‚å…¥åŠ›å€¤ã¯ localStorage ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
          <div style="margin-top:8px"><button class="btn-secondary" onclick="onResetClick()">å…¥åŠ›ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢</button></div>
        </div>
      `;
      out.style.display='block';
    }

    function getTZ(){
      const sel = document.getElementById('tzSelect').value;
      if(sel==='OTHER'){
        const custom = document.getElementById('tzInput').value.trim();
        return custom || 'UTC';
      }
      return sel || 'UTC';
    }
    function validateInputs(){
      const birthDate = document.getElementById('birthDate').value;
      const birthTime = document.getElementById('birthTime').value;
      const tz = getTZ();
      const lat = parseFloat(document.getElementById('lat').value || document.getElementById('latSelect').value);
      const lon = parseFloat(document.getElementById('lon').value || document.getElementById('lonSelect').value);
      if(!birthDate || !birthTime) throw new Error('å‡ºç”Ÿæ—¥ã¨å‡ºç”Ÿæ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      if(!isFinite(lat) || !isFinite(lon)) throw new Error('ç·¯åº¦ãƒ»çµŒåº¦ãŒä¸æ­£ã§ã™ã€‚éƒ½å¸‚åã‹ã‚‰å–å¾—ã™ã‚‹ã‹æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return { birthLocal: `${birthDate}T${birthTime}`, tz, lat, lon };
    }
    function planetList(){ return ['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto']; }
    function computeLongitudes(dateUTC, lat, lon){
      const out={};
      for(const b of planetList()){
        const L = planetEclipticLongitude(b, dateUTC);
        out[b]=isFinite(L)?L:NaN;
      }
      out['ASC'] = calcAscendant(dateUTC, lat, lon);
      out['MC']  = calcMC(dateUTC, lon);
      return out;
    }

    async function onCalcClick(){
      try{
        setStatus('è¨ˆç®—ä¸­â€¦');
        const targetDate = (document.getElementById('targetDate').value||'').trim();
        const { birthLocal, tz, lat, lon } = validateInputs();

        const todayLocal = new Date().toISOString().slice(0,10);
        const localDateOnly = targetDate || todayLocal;
        const targetLocalNoon = `${localDateOnly}T12:00:00`;

        const birthUTC  = parseLocalToUTCdate(birthLocal, tz);
        const targetUTC = parseLocalToUTCdate(targetLocalNoon, tz);

        seedRngFromDateOnly(localDateOnly);

        if(!window.Astronomy) throw new Error('astronomy-engine ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒãƒƒãƒˆã‚„CDNã‚’ã”ç¢ºèªãã ã•ã„ï¼‰');

        const natal   = computeLongitudes(birthUTC,  lat, lon);
        const transit = computeLongitudes(targetUTC, lat, lon);

        const aspects = detectAspects(natal, transit);
        const scores  = scoreCategories(aspects);

        renderOutput({
          natal, transit, aspects, scores,
          meta:{
            tz,
            lat, lon,
            birthLocal: birthLocal.replace('T',' '),
            targetLocal: targetLocalNoon.replace('T',' '),
          }
        });
        setStatus('è¨ˆç®—å®Œäº†');
      }catch(e){
        setStatus('æº–å‚™OK');
        alert(e.message || String(e));
        log(e.stack || (e.message || String(e)));
      }
    }

    async function onGeocodeClick(){
      const q = (document.getElementById('placeName').value||'').trim();
      if(!q){ alert('éƒ½å¸‚åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      try{
        setStatus('ä½ç½®æ¤œç´¢ä¸­â€¦');
        const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(!data || !data.length){ alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è¡¨è¨˜ã‚’å¤‰ãˆã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'); setStatus('æº–å‚™OK'); return; }
        const pt = data[0];
        document.getElementById('lat').value = String(pt.lat);
        document.getElementById('lon').value = String(pt.lon);
        document.getElementById('latSelect').value = "0"; document.getElementById('lat').style.display='block';
        document.getElementById('lonSelect').value = "0"; document.getElementById('lon').style.display='block';
        saveInputs();
        setStatus('ä½ç½®å–å¾—OK');
        log(`â†’ lat=${pt.lat}, lon=${pt.lon}`);
      }catch(e){
        setStatus('æº–å‚™OK');
        alert('ä½ç½®å–å¾—ã«å¤±æ•—: '+(e && e.message));
        log(e.stack || (e.message || String(e)));
      }
    }

    function onFillClick(){
      document.getElementById('birthDate').value = '1995-05-15';
      document.getElementById('birthTime').value = '14:30:00';
      document.getElementById('placeName').value = 'Tokyo, Japan';
      document.getElementById('latSelect').value = '35.6895'; toggleLatInput('35.6895');
      document.getElementById('lonSelect').value = '139.6917'; toggleLonInput('139.6917');
      document.getElementById('tzSelect').value = 'Asia/Tokyo'; toggleTzInput('Asia/Tokyo');
      document.getElementById('targetDate').value = new Date().toISOString().slice(0,10);
      saveInputs();
      toast('ãƒ‡ãƒ¢å€¤ã‚’å…¥åŠ›ã—ã¾ã—ãŸ');
      log('ãƒ‡ãƒ¢å€¤ã‚’å…¥åŠ›ã—ã¾ã—ãŸã€‚');
    }
    function onResetClick(){
      storageRemoveAll();
      const ids = ['birthDate','birthTime','placeName','lat','lon','tzInput','latSelect','lonSelect','tzSelect','targetDate'];
      ids.forEach(id=>{ const el=document.getElementById(id); if(el){ if(el.tagName==='SELECT'){ el.selectedIndex=0; } else { el.value=''; } } });
      toggleLatInput(document.getElementById('latSelect').value);
      toggleLonInput(document.getElementById('lonSelect').value);
      toggleTzInput(document.getElementById('tzSelect').value);
      toast('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }
  </script>

  <!-- ğŸ§ª PWA è¨ºæ–­ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆå¿…ãš </body> ç›´å‰ï¼‰ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let deferred;
      const box = document.createElement('div');
      box.style.cssText = 'position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:10px;border-radius:10px;font:12px/1.4 system-ui;z-index:99999;max-width:320px';
      box.innerHTML = `
        <div style="font-weight:700;margin-bottom:6px">PWA è¨ºæ–­</div>
        <div id="pwaStatus">ãƒã‚§ãƒƒã‚¯ä¸­â€¦</div>
        <button id="installBtn" style="margin-top:8px;display:none;background:#6b46c1;color:#fff;border:0;border-radius:8px;padding:8px 10px;cursor:pointer">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
        <button id="hideBtn" style="margin-top:8px;background:#333;color:#ddd;border:0;border-radius:8px;padding:6px 8px;cursor:pointer">é–‰ã˜ã‚‹</button>
      `;
      document.body.appendChild(box);

      document.getElementById('hideBtn').onclick = () => box.remove();
      const installBtn = document.getElementById('installBtn');
      installBtn.onclick = async () => {
        installBtn.disabled = true;
        try {
          await deferred.prompt();
          const choice = await deferred.userChoice;
          document.getElementById('pwaStatus').textContent = 'çµæœ: ' + choice.outcome;
        } catch(e) {
          document.getElementById('pwaStatus').textContent = 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹ã«å¤±æ•—: ' + e;
        } finally {
          installBtn.disabled = false;
        }
      };

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferred = e;
        installBtn.style.display = 'inline-block';
        document.getElementById('pwaStatus').textContent = 'Installable: OKï¼ˆãƒœã‚¿ãƒ³ã‹ã‚‰å®Ÿè¡Œå¯ï¼‰';
      });

      async function runChecks(){
        const lines = [];
        try {
          const r = await fetch('./manifest.json?v=8', {cache:'no-store'});
          lines.push(`manifest: ${r.status} ${r.ok?'OK':'NG'}`);
        } catch(e) { lines.push('manifest: fetchå¤±æ•— ' + e); }

        try {
          const controlled = !!navigator.serviceWorker?.controller;
          lines.push('ServiceWorker controlled: ' + controlled);
        } catch(e){ lines.push('ServiceWorker: ä¾‹å¤– ' + e); }

        try {
          const [i192, i512] = await Promise.all([
            fetch('./icon-192.png', {cache:'no-store'}),
            fetch('./icon-512.png', {cache:'no-store'})
          ]);
          lines.push(`icons: 192=${i192.status} / 512=${i512.status}`);
        } catch(e){ lines.push('icons: å–å¾—å¤±æ•— ' + e); }

        lines.push('URL pathname: ' + location.pathname);
        lines.push('æƒ³å®š scope/start_url: /horoscope-100pct/');

        document.getElementById('pwaStatus').innerHTML = lines.join('<br>');
      }
      runChecks();
    });
  </script>
</body>
</html>
