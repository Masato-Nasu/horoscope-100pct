<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>100% 星占い｜絶対評価</title>
<meta name="theme-color" content="#6b46c1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- 開発中のキャッシュ無効（安定後は削除可） -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="icon" href="data:,"><!-- favicon 404抑止 -->

<style>
  :root{--bg:#fbfbfc;--card:#fff;--accent:#6b46c1;--muted:#666}
  html,body{margin:0;padding:0}
  body{font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",system-ui,sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  h1{margin:8px 0;font-size:20px;color:#6b46c1}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(16,24,40,0.06);margin-top:12px}
  label{display:block;font-weight:600;margin-top:8px}
  .row{display:flex;gap:12px}
  .col{flex:1}
  input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;box-sizing:border-box;font-size:14px;background:#fff}
  button{background:#6b46c1;color:#fff;border:0;cursor:pointer;min-height:44px}
  small{color:#666}
  #log{white-space:pre-wrap;background:#0b1020;color:#e6f0ff;padding:10px;border-radius:8px;font-family:ui-monospace,Menlo,monospace;font-size:12px;max-height:260px;overflow:auto}
  @media(max-width:700px){.row{flex-direction:column}}
</style>
</head>
<body>
<noscript><div style="background:#ffdfdf;color:#900;padding:10px">JavaScriptが無効です。オンにしてください。</div></noscript>

<div class="wrap">
  <h1>100パーセント星占い</h1>

  <div class="card" id="inputCard">
    <div class="row" style="margin-top:10px">
      <div class="col"><label>出生日</label><input type="date" id="birthDate" /></div>
      <div class="col"><label>出生時刻</label><input type="time" id="birthTime" step="1" /></div>
    </div>

    <div class="row">
      <div class="col"><label>出生地（都市名）</label><input type="text" id="placeName" placeholder="Tokyo, Japan" /></div>
      <div class="col">
        <label>タイムゾーン</label>
        <select id="tzSelect" onchange="toggleTzInput(this.value)">
          <option value="Asia/Tokyo">Asia/Tokyo (日本)</option>
          <option value="UTC">UTC</option>
          <option value="Europe/London">Europe/London</option>
          <option value="America/New_York">America/New_York</option>
          <option value="America/Los_Angeles">America/Los_Angeles</option>
          <option value="Asia/Seoul">Asia/Seoul</option>
          <option value="Asia/Shanghai">Asia/Shanghai</option>
          <option value="OTHER">その他（自由入力）</option>
        </select>
        <input id="tzInput" type="text" placeholder="例: Asia/Tokyo" style="display:none;margin-top:6px" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>緯度</label>
        <select id="latSelect" onchange="toggleLatInput(this.value)">
          <option value="35.6895">東京 (35.6895)</option>
          <option value="34.6937">大阪 (34.6937)</option>
          <option value="43.0621">札幌 (43.0621)</option>
          <option value="33.5902">福岡 (33.5902)</option>
          <option value="0">その他（自由入力）</option>
        </select>
        <input type="number" id="lat" step="0.0001" placeholder="緯度を入力" style="display:none" />
      </div>
      <div class="col">
        <label>経度</label>
        <select id="lonSelect" onchange="toggleLonInput(this.value)">
          <option value="139.6917">東京 (139.6917)</option>
          <option value="135.5023">大阪 (135.5023)</option>
          <option value="141.3544">札幌 (141.3544)</option>
          <option value="130.4017">福岡 (130.4017)</option>
          <option value="0">その他（自由入力）</option>
        </select>
        <input type="number" id="lon" step="0.0001" placeholder="経度を入力" style="display:none" />
      </div>
    </div>

    <label>解析日時（空なら今）</label>
    <input type="datetime-local" id="targetDatetime" />

    <div class="row" style="margin-top:12px">
      <div class="col"><button id="geocodeBtn" type="button" onclick="onGeocodeClick()">都市名から緯度経度を取得</button></div>
      <div class="col"><button id="calcBtn" type="button" onclick="onCalcClick()">本格解析を実行</button></div>
      <div class="col"><button id="fillBtn" type="button" onclick="onFillClick()" style="background:#7c5cf3">デモ値を入力</button></div>
    </div>
  </div>

  <div id="output" class="card" style="display:none"></div>

  <div class="card" id="logCard" style="margin-top:12px">
    <div><strong>ログ</strong></div>
    <pre id="log"></pre>
  </div>

  <footer><small>astronomy-engine / 太陽〜冥王星＋ASC/MC対応。TZ・入力は自動保存。</small></footer>
</div>

<!-- astronomy-engine（マルチCDN／タイムアウト付） -->
<script>
  const $ = (s)=>document.querySelector(s);
  const logEl = $("#log");
  function log(m){ try{logEl.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`; logEl.scrollTop = logEl.scrollHeight;}catch(_){} }

  const CDN = [
    "https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js?v=1",
    "https://unpkg.com/astronomy-engine@2.1.19/astronomy.browser.min.js?v=1",
    "https://esm.sh/astronomy-engine@2.1.19?bundle&target=es2018"
  ];
  (async ()=>{
    for(const url of CDN){
      log("ライブラリ取得: " + url);
      try{
        await new Promise((res,rej)=>{
          const s=document.createElement('script'); s.src=url; s.async=true;
          let done=false;
          const t=setTimeout(()=>{ if(done) return; done=true; rej(new Error("timeout")); }, 8000);
          s.onload=()=>{ if(done) return; done=true; clearTimeout(t); res(); };
          s.onerror=()=>{ if(done) return; done=true; clearTimeout(t); rej(new Error("load error")); };
          document.head.appendChild(s);
        });
        if (window.Astronomy){ log("astronomy-engine 読み込み成功"); break; }
      }catch(e){ log("読み込み失敗: " + (e&&e.message)); }
    }
    if (!window.Astronomy) log("astronomy-engine を読み込めませんでした（オフライン？）");
  })();
</script>

<script>
/* ====== GUIはそのまま／必要な関数をグローバル定義 ====== */

/* 入力保存・復元 */
const PERSIST = ['birthDate','birthTime','placeName','lat','lon','tzSelect','targetDatetime','latSelect','lonSelect'];
function saveInputs(){
  try{ for(const id of PERSIST){ const el=document.getElementById(id); if(el) localStorage.setItem('astro_'+id, el.value||''); } }
  catch(_){}
}
function restoreInputs(){
  try{ for(const id of PERSIST){ const el=document.getElementById(id); const v=localStorage.getItem('astro_'+id); if(el && v!=null) el.value=v; } }
  catch(_){}
}

/* セレクト↔自由入力 切替（既存GUIの想定通り） */
function toggleTzInput(val){
  const inEl=$("#tzInput");
  if(val==='OTHER'){ inEl.style.display='block'; inEl.value = inEl.value || 'Asia/Tokyo'; }
  else { inEl.style.display='none'; inEl.value=''; }
  saveInputs();
}
function toggleLatInput(val){
  const inEl=$("#lat");
  if(val==="0"){ inEl.style.display='block'; if(!inEl.value) inEl.value=""; }
  else { inEl.style.display='none'; inEl.value=val; }
  saveInputs();
}
function toggleLonInput(val){
  const inEl=$("#lon");
  if(val==="0"){ inEl.style.display='block'; if(!inEl.value) inEl.value=""; }
  else { inEl.style.display='none'; inEl.value=val; }
  saveInputs();
}

/* 地名→緯度経度（CORS回避つき） */
async function robustGeocode(name){
  if(!name || !name.trim()) return null;
  const endpoint = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q="+encodeURIComponent(name);
  const proxied  = "https://api.allorigins.win/raw?url="+encodeURIComponent(endpoint);
  const resp = await fetch(proxied, {cache:"no-store"});
  if(!resp.ok) throw new Error("HTTP "+resp.status);
  const arr = await resp.json();
  if(!Array.isArray(arr)||!arr.length) throw new Error("no result");
  return { lat: parseFloat(arr[0].lat), lon: parseFloat(arr[0].lon) };
}

/* クリック関数（GUIの onclick から直接呼ばれる想定） */
async function onGeocodeClick(){
  const name = $("#placeName")?.value || "";
  if(!name.trim()){ alert("都市名を入力してください"); return; }
  try{
    const geo = await robustGeocode(name);
    // セレクトが“その他”の時は自由入力欄に値を入れる
    $("#latSelect").value = "0"; toggleLatInput("0"); $("#lat").value = geo.lat;
    $("#lonSelect").value = "0"; toggleLonInput("0"); $("#lon").value = geo.lon;
    saveInputs();
    log("Geocode OK: " + geo.lat + ", " + geo.lon);
  }catch(e){
    alert("位置情報の取得に失敗しました。緯度・経度を手入力してください。");
    log("Geocode error: "+(e&&e.message||e));
  }
}

/* 実行デデュープ */
let RUN_USED=new Set(); function beginRun(){ RUN_USED=new Set(); }
function pickNoDup(arr){
  if(!arr||!arr.length) return "";
  const shuffled=[...arr].sort(()=>Math.random()-0.5);
  for(const s of shuffled){ if(!RUN_USED.has(s)){ RUN_USED.add(s); return s; } }
  return shuffled[0];
}
function sampleUnique(arr,n){
  if(!arr||!arr.length) return [];
  const out=[], pool=[...arr];
  for(let i=0;i<n;i++){
    const idx=Math.floor(Math.random()*pool.length);
    const p=pool.splice(idx,1)[0];
    if(p) out.push(p);
    if(pool.length===0) break;
  }
  return out;
}

/* 結果レンダリング（簡易版：必要に応じてあなたのロジックに差し替え可能） */
function renderResult(scores){
  const out=$("#output");
  out.style.display="block";
  out.innerHTML = `
    <h2>いまの全体感：${scores.total}%</h2>
    <p><strong>恋愛：</strong>${scores.love}%</p>
    <p><strong>仕事：</strong>${scores.work}%</p>
    <p><strong>金運：</strong>${scores.money}%</p>
    <p><strong>健康：</strong>${scores.health}%</p>
    <p style="color:#666"><em>今日の一歩を大切に。</em></p>
  `;
}

/* 本格解析（ダミースコア。天体計算に差し替え可） */
async function onCalcClick(){
  beginRun();
  try{
    const tz = ($("#tzSelect").value==="OTHER" ? ($("#tzInput").value||"Asia/Tokyo") : $("#tzSelect").value);
    const lat = parseFloat($("#lat").value);
    const lon = parseFloat($("#lon").value);
    if(!isFinite(lat)||!isFinite(lon)){ alert("緯度・経度は数値で入力してください（例：35.6895 / 139.6917）"); return; }
    // ここで Astronomy を使った厳密計算に置換可能。今は安定確認用の擬似スコア。
    const seed=Math.abs(Math.sin(Date.now()/86400000 + lat*0.1 + lon*0.1))*10000|0;
    const prng=(n)=>{ const x=Math.sin(seed+n)*10000; return x-Math.floor(x); };
    const scores={
      total: Math.round(40+prng(1)*60),
      love:  Math.round(30+prng(2)*70),
      work:  Math.round(30+prng(3)*70),
      money: Math.round(30+prng(4)*70),
      health:Math.round(30+prng(5)*70)
    };
    renderResult(scores);
    saveInputs();
  }catch(e){
    const out=$("#output");
    out.style.display='block';
    out.innerHTML = `<div style="padding:10px;border:1px solid #f3c;background:#fff0fb;border-radius:8px;">
      <strong>実行エラー</strong><br><code>${String(e?.message||e)}</code><br>
      <small>都市名が失敗する場合は、緯度・経度・タイムゾーンを手入力してください。</small>
    </div>`;
    console.error(e);
  }
}

/* デモ値 */
function onFillClick(){
  $("#placeName").value="Tokyo, Japan";
  $("#tzSelect").value="Asia/Tokyo"; toggleTzInput("Asia/Tokyo");
  $("#latSelect").value="0"; toggleLatInput("0"); $("#lat").value="35.6895";
  $("#lonSelect").value="0"; toggleLonInput("0"); $("#lon").value="139.6917";
  $("#targetDatetime").value="";
  saveInputs();
}

/* 初期化 */
document.addEventListener("DOMContentLoaded", ()=>{
  restoreInputs();
  // セレクトと入力欄の同期（復元後ずれている場合に整える）
  if ($("#latSelect").value!=="0") toggleLatInput($("#latSelect").value);
  else toggleLatInput("0");
  if ($("#lonSelect").value!=="0") toggleLonInput($("#lonSelect").value);
  else toggleLonInput("0");
  toggleTzInput($("#tzSelect").value);
});
</script>

<!-- 画面に直接エラーを出す（開発補助。不要なら削除OK） -->
<script>
window.addEventListener('error', e => {
  const out = document.getElementById('output');
  if(out){
    out.style.display='block';
    out.innerHTML = `<div style="padding:10px;border:1px solid red;background:#fee;border-radius:8px;">
      <strong>エラー発生:</strong><br>${e.message}
    </div>`;
  }
  console.error("GlobalError:", e.message, e);
});
window.addEventListener('unhandledrejection', e => {
  const out = document.getElementById('output');
  if(out){
    out.style.display='block';
    out.innerHTML = `<div style="padding:10px;border:1px solid red;background:#fee;border-radius:8px;">
      <strong>Promiseエラー:</strong><br>${e.reason}
    </div>`;
  }
  console.error("UnhandledRejection:", e.reason);
});
</script>
</body>
</html>
