<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>100% æ˜Ÿå ã„</title>
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="./icon-192.png">
<meta name="theme-color" content="#6b46c1">
<style>
body{font-family:'Noto Sans JP',system-ui,-apple-system,sans-serif;background:#fafafa;color:#222;margin:0;text-align:center}
header{background:#6b46c1;color:#fff;padding:1.2em 0;font-weight:700;font-size:1.3em}
main{padding:1.2em;max-width:720px;margin:0 auto}
input,button{font:inherit;padding:.6em;border-radius:.6em;border:1px solid #ccc;box-sizing:border-box;width:100%}
button{background:#6b46c1;color:#fff;border:none;cursor:pointer} button:hover{opacity:.9}
.card{background:#fff;border-radius:1em;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:1.1em;margin-top:1em;text-align:left}
.muted{color:#666;font-size:.9em} .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 16px;border-radius:999px;opacity:0;transition:opacity .25s}
.toast.show{opacity:1} .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px} .chip{background:#eee;border-radius:999px;padding:3px 10px;font-size:.85em;color:#555}
</style>
</head>
<body>
<header>100% æ˜Ÿå ã„</header>
<main>
<section id="inputArea">
  <h2>ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›</h2>
  <label>ç”Ÿå¹´æœˆæ—¥</label>
  <input type="date" id="birthDate"><br><br>
  <label>å‡ºç”Ÿæ™‚åˆ»ï¼ˆä»»æ„ï¼‰</label>
  <input type="time" id="birthTime" step="60"><br><br>
  <label>éƒ½å¸‚å</label>
  <input type="text" id="placeName" placeholder="Tokyo"><br><br>
  <button id="geoBtn">éƒ½å¸‚åã‹ã‚‰å–å¾—</button><br><br>
  <label>ç·¯åº¦</label><input type="text" id="lat" placeholder="35.6895"><br><br>
  <label>çµŒåº¦</label><input type="text" id="lon" placeholder="139.6917"><br><br>
  <button id="runBtn">çµæœã‚’è¦‹ã‚‹</button>
</section>
<section id="outputArea" style="display:none;">
  <h2>çµæœ</h2>
  <div id="resultContainer"></div>
  <button id="saveBtn">JPEGä¿å­˜</button>
  <button id="backBtn">æˆ»ã‚‹</button>
</section>
</main>
<div class="toast" id="toast"></div>
<script>
/* ===== Utils ===== */
const $=id=>document.getElementById(id);
function toast(m){const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400);}
function escapeHtml(s){return String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
function saveInputs(){const d={birthDate:$('birthDate').value||'',birthTime:$('birthTime').value||'',placeName:$('placeName').value||'',lat:$('lat').value||'',lon:$('lon').value||''}; localStorage.setItem('horo.inputs',JSON.stringify(d));}
function loadInputs(){try{const d=JSON.parse(localStorage.getItem('horo.inputs')||'{}'); if(d.birthDate)$('birthDate').value=d.birthDate; if(d.birthTime)$('birthTime').value=d.birthTime; if(d.placeName)$('placeName').value=d.placeName; if(d.lat)$('lat').value=d.lat; if(d.lon)$('lon').value=d.lon;}catch{}}
function seasonToneByMonth(m){if([12,1,2].includes(m))return'é™ã‹ãªå†¬ã€è¶³å…ƒã‚’å›ºã‚ã‚‹ã¨ã'; if([3,4,5].includes(m))return'èŠ½å¹ãæ˜¥ã€å‹•ãå‡ºã—ã«è¿½ã„é¢¨'; if([6,7,8].includes(m))return'è¼ãå¤ã€å‹¢ã„ã¨ç™ºä¿¡ãŒåŠ¹ã'; if([9,10,11].includes(m))return'å®Ÿã‚Šã®ç§‹ã€ä»•ä¸Šã’ã¨æ•´ãˆãŒå‰'; return'å­£ç¯€ã®ãƒªã‚ºãƒ ã«ä¹—ã‚‹ã¨è‰¯ã„æ—¥';}

/* ===== City presets (Tokyo only fixed), Balance mode: near-snap 15km ===== */
const CITY_PRESETS=[{name:'æ±äº¬',lat:'35.6895',lon:'139.6917',aliases:['tokyo','tokyo japan','æ±äº¬','ã¨ã†ãã‚‡ã†']}];
function snapToPresetIfAlias(q){
  if(!q) return null;
  const s=String(q).toLowerCase().trim();
  if(['tokyo','tokyo japan','æ±äº¬','ã¨ã†ãã‚‡ã†'].includes(s)) return {lat:'35.6895',lon:'139.6917'};
  return null;
}
function haversine(a,b,c,d){const R=6371,toRad=x=>x*Math.PI/180; const dLat=toRad(c-a), dLon=toRad(d-b); const A=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(A));}
function snapNearPreset(lat,lon,km=15){ // 15km only
  let best=null,b=1e9;
  for(const c of CITY_PRESETS){
    const dist=haversine(+lat,+lon,+c.lat,+c.lon);
    if(dist<b){b=dist; best=c;}
  }
  return (b<=km)?{lat:best.lat,lon:best.lon}:null;
}

/* ===== News (GNews â†’ NHK RSS) ===== */
const GNEWS_API_KEY="0e21cddc975f5f620c1431fde88db5fe";
async function fetchNewsTopJP(){
  try{
    const url=`https://gnews.io/api/v4/top-headlines?lang=ja&country=jp&max=3&category=general&apikey=${GNEWS_API_KEY}`;
    const r=await fetch(url,{headers:{'Accept':'application/json'},cache:'no-store'});
    if(!r.ok) throw new Error('GNews HTTP '+r.status);
    const j=await r.json();
    const t=(j?.articles||[]).map(a=>a?.title).filter(Boolean).slice(0,2);
    if(t.length) return t;
  }catch(e){}
  try{
    const rss='https://www3.nhk.or.jp/rss/news/cat0.xml';
    const r=await fetch(rss,{cache:'no-store'}); if(!r.ok) throw new Error('NHK RSS HTTP '+r.status);
    const x=await r.text(); const doc=new DOMParser().parseFromString(x,'application/xml');
    return Array.from(doc.querySelectorAll('item>title')).map(n=>(n.textContent||'').trim()).filter(Boolean).slice(0,2);
  }catch(e){return []}
}
function escapeHtmlInline(s){return String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}

/* ===== High-precision Sun-Moon elongation (Meeus simplified) ===== */
const norm360 = d => ((d % 360) + 360) % 360;
const d2r = d => d * Math.PI / 180;
function toJD(date){ return date.getTime()/86400000 + 2440587.5; }
function sunLongitudeDeg(jd){
  const T=(jd-2451545.0)/36525;
  const L0=norm360(280.46646+36000.76983*T+0.0003032*T*T);
  const M =norm360(357.52911+35999.05029*T-0.0001537*T*T);
  const Mr=d2r(M);
  const C =(1.914602-0.004817*T-0.000014*T*T)*Math.sin(Mr)
         +(0.019993-0.000101*T)*Math.sin(2*Mr)
         +0.000289*Math.sin(3*Mr);
  return norm360(L0+C);
}
function moonLongitudeDeg(jd){
  const T=(jd-2451545.0)/36525;
  const Lp=norm360(218.3164477+481267.88123421*T-0.0015786*T*T+T*T*T/538841 - T*T*T*T/65194000);
  const D =norm360(297.8501921+445267.1114034*T -0.0018819*T*T+T*T*T/545868 - T*T*T*T/113065000);
  const M =norm360(357.5291092+35999.0502909*T -0.0001536*T*T+T*T*T/24490000);
  const Mp=norm360(134.9633964+477198.8675055*T +0.0087414*T*T+T*T*T/69699  - T*T*T*T/14712000);
  const Dr=d2r(D), Mr=d2r(M), Mpr=d2r(Mp);
  let lon=Lp
    +6.289*Math.sin(Mpr)
    +1.274*Math.sin(2*Dr - Mpr)
    +0.658*Math.sin(2*Dr)
    +0.214*Math.sin(2*Mpr)
    +0.110*Math.sin(Dr)
    -0.186*Math.sin(Mr)
    -0.059*Math.sin(2*Dr - 2*Mpr)
    -0.057*Math.sin(2*Dr - Mr - Mpr)
    +0.053*Math.sin(2*Dr + Mpr)
    +0.046*Math.sin(2*Dr - Mr)
    +0.041*Math.sin(M - Mp);
  return norm360(lon);
}
function sunMoonElongationDeg(date){
  const jd=toJD(date);
  const lamS=sunLongitudeDeg(jd);
  const lamM=moonLongitudeDeg(jd);
  return norm360(lamM - lamS);
}
function aspectName(a){
  a=((a%360)+360)%360; const eps=15;
  if(Math.abs(a-0)<=eps||Math.abs(a-360)<=eps) return 'æ–°æœˆä»˜è¿‘';
  if(Math.abs(a-90)<=eps) return 'ä¸Šå¼¦ä»˜è¿‘';
  if(Math.abs(a-180)<=eps) return 'æº€æœˆä»˜è¿‘';
  if(Math.abs(a-270)<=eps) return 'ä¸‹å¼¦ä»˜è¿‘';
  if(a<90) return 'æˆé•·ã®ç›¸'; if(a<180) return 'ç†Ÿæˆã®ç›¸'; if(a<270) return 'åç©«ã®ç›¸'; return 'å†…çœã®ç›¸';
}

/* ===== News + Season + Angle (with birth time) ===== */
async function fetchNewsAndSeasonContext(dateStr){
  const d=new Date(dateStr+'T12:00:00');
  const bt=$('birthTime')?.value||'00:00'; const [hh,mm]=(bt||'00:00').split(':').map(v=>parseInt(v||'0',10));
  d.setMinutes(d.getMinutes()+hh*60+mm - 12*60);
  const season=seasonToneByMonth(d.getMonth()+1);
  const ang=sunMoonElongationDeg(d);
  const star=`â˜† æ˜Ÿã®è§’åº¦ï¼šå¤ªé™½-æœˆ â‰ˆ ${Math.round(ang)}Â°ï¼ˆ${aspectName(ang)}ï¼‰`;
  const news=await fetchNewsTopJP();
  let line=`ä»Šæ—¥ã®ç©ºæ°—æ„Ÿï¼š${season}ã€‚<br><span class="muted">${star}</span>`;
  if(news.length){ const safe=news.map(escapeHtmlInline); line+=`<br><span class="muted">ğŸ—ï¸ æœ€è¿‘ã®è©±é¡Œï¼š${safe.join(' ï¼ ')}ã€‚</span>`; }
  return line;
}

/* ===== Templates and selection ===== */
const TPL={
 "å…¨ä½“é‹":[
   "è‚©ã®åŠ›ã‚’æŠœãã»ã©æµã‚ŒãŒæ•´ã†æ—¥ã€‚å°ã•ãªæ”¹å–„ãŒå¤§ããªå‰é€²ã«ã€‚",
   "æ—©ã‚ã®ç€æ‰‹ãŒå¥½æ©Ÿã‚’å‘¼ã¶ã€‚åˆå‰ä¸­ã®ä¸€æ­©ãŒåˆå¾Œã‚’å¤‰ãˆã‚‹ã€‚",
   "å‘¨å›²ã®å£°ã«ãƒ’ãƒ³ãƒˆã‚ã‚Šã€‚ã¾ãšè´ãã€æ¬¡ã«å‹•ãã€‚",
   "æ¸©ã‚ã¦ã„ãŸæ¡ˆã‚’è©¦ã™ã¨ç™ºè¦‹ãŒã‚ã‚‹ã€‚"
 ],
 "æ‹æ„›":[
   "æŒ¨æ‹¶ï¼‹ä¸€è¨€ã§è·é›¢ãŒç¸®ã‚€ã€‚é€£çµ¡ã¯çŸ­ãæ˜ã‚‹ãã€‚",
   "äºˆå®šã®å…±æœ‰ãŒå‰ã€‚ç›¸æ‰‹ã®éƒ½åˆã‚’å…ˆã«èã„ã¦ã€‚",
   "èãå½¹7å‰²ã§å®‰å¿ƒæ„Ÿã‚’ã€‚"
 ],
 "ä»•äº‹":[
   "5åˆ†ã§ç²—æ¡ˆâ†’15åˆ†ã§å©ãå°ã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒè©•ä¾¡ã«ç›´çµã€‚",
   "ç¢ºèªã¯äºŒæ®µæ§‹ãˆã§ã€‚ä¾é ¼â†’å¾©å”±â†’åˆæ„ã®é †ãŒå®‰å…¨ã€‚",
   "ToDoã‚’3ã¤ã«çµã‚‹ã¨é›†ä¸­ã§ãã‚‹ã€‚"
 ],
 "é‡‘é‹":[
   "å›ºå®šè²»ã®è¦‹ç›´ã—æ—¥ã€‚ã‚µãƒ–ã‚¹ã‚¯ã‚’ä¸€ä»¶ã ã‘æ•´ç†ã€‚",
   "ãƒã‚¤ãƒ³ãƒˆå¤±åŠ¹ã®ç¢ºèªã§å¾—ã€‚å°ã•ãªç©ã¿ä¸Šã’ãŒåŠ¹ãã€‚",
   "å¿…è¦ãªã‚‚ã®ã«ã ã‘æŠ•è³‡ã™ã‚‹ã€‚"
 ],
 "å¥åº·":[
   "å§¿å‹¢ãƒªã‚»ãƒƒãƒˆã§é›†ä¸­åŠ›UPã€‚æ·±å‘¼å¸Ã—3å›ã‚’ç¿’æ…£ã«ã€‚",
   "ç™½æ¹¯ã‹å¸¸æ¸©æ°´ã‚’å°‘é‡ã“ã¾ã‚ã«ã€‚",
   "ä»Šæ—¥ã¯æ­©æ•°ã‚’å°‘ã—ã ã‘å¤šã‚ã«ã€‚"
 ]
};
function pickNUnique(arr,n,seed){const out=[],used=new Set(); if(!arr||!arr.length)return out; for(let k=0;k<n;k++){const x=Math.abs(Math.sin(seed*(k+1)))*10000; let i=Math.floor(x)%arr.length,g=0,t=arr[i]; while(used.has(t)&&g<arr.length){i=(i+1)%arr.length;t=arr[i];g++;} used.add(t); out.push(t);} return out;}
function usedKey(d,t,txt){return `${d}|${t}|${txt}`} function isUsed(k){return new Set(JSON.parse(localStorage.getItem('horo.used')||'[]')).has(k)} function markUsed(k){const a=JSON.parse(localStorage.getItem('horo.used')||'[]'); a.push(k); if(a.length>480)a.shift(); localStorage.setItem('horo.used',JSON.stringify(a));}

/* ===== Geocode (balance mode) ===== */
async function onGeocodeClick(){
  const q=($('placeName').value||'').trim();
  if(!q){ alert('éƒ½å¸‚åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

  // Tokyo only fixed; others pass to geocoder
  const alias=snapToPresetIfAlias(q);
  if(alias){
    $('lat').value=alias.lat; $('lon').value=alias.lon; saveInputs(); toast(`${q} ã‚’æ±äº¬ã®ä»£è¡¨ç‚¹ã«å›ºå®šã—ã¾ã—ãŸ`);
    return;
  }

  try{
    toast('ä½ç½®æ¤œç´¢ä¸­â€¦');
    const url='https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
    const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('HTTP '+r.status);
    const j=await r.json(); if(!j||!j.length){alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); return;}
    let lat=String(j[0].lat), lon=String(j[0].lon);
    const near=snapNearPreset(lat,lon,15); if(near){lat=near.lat;lon=near.lon;}
    $('lat').value=lat; $('lon').value=lon; saveInputs(); toast('åº§æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸ');
  }catch(e){ alert('ä½ç½®å–å¾—ã«å¤±æ•—: '+(e.message||e)); }
}

/* ===== Run / Back ===== */
async function runHoroscope(){
  saveInputs();
  const birth=$('birthDate').value; if(!birth){alert('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');return;}
  const lat=parseFloat($('lat').value), lon=parseFloat($('lon').value); if(isNaN(lat)||isNaN(lon)){alert('ç·¯åº¦çµŒåº¦ãŒç„¡åŠ¹ã§ã™ã€‚');return;}
  const dateStr=new Date().toISOString().split('T')[0];
  const ctx={}; ctx.seasonNews=await fetchNewsAndSeasonContext(dateStr);

  const topics=['å…¨ä½“é‹','æ‹æ„›','ä»•äº‹','é‡‘é‹','å¥åº·']; const seedNum=new Date(dateStr).getDate()+lat+lon; const perTopic=2;
  let html=`<div class="muted">${ctx.seasonNews}</div>`;
  for(const t of topics){
    const c=pickNUnique(TPL[t], perTopic*3, seedNum*(t.length+1)); const shown=[];
    for(const p of c){ const k=usedKey(dateStr,t,p); if(!isUsed(k)){markUsed(k); shown.push(p);} if(shown.length>=perTopic) break; }
    if(!shown.length && c.length) shown.push(c[0]);
    html+=`<div class="card"><strong>${t}</strong><br>${shown.map(s=>'â€¢ '+escapeHtml(s)).join('<br>')}</div>`;
  }
  const today=new Date(), bd=new Date(birth);
  if(bd.getMonth()===today.getMonth() && bd.getDate()===today.getDate()){
    html+=`<div class="card"><strong>ğŸ‚ ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</strong><br>ã‚¹ã‚³ã‚¢+5%ã®å¹¸é‹æ—¥ã€‚</div>`;
  }
  $('resultContainer').innerHTML=html; $('inputArea').style.display='none'; $('outputArea').style.display='block';
}
function backToInput(){ $('outputArea').style.display='none'; $('inputArea').style.display='block'; }

/* ===== Save JPEG (timestamp + birth info) ===== */
let _h2c=null;
function loadHtml2Canvas(){ if(_h2c) return _h2c; _h2c=new Promise((ok,ng)=>{const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'; s.onload=()=>ok(); s.onerror=()=>ng(new Error('html2canvas load error')); document.head.appendChild(s);}); return _h2c; }
function ts(){const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;}
async function saveAsJPEG(){
  try{
    await loadHtml2Canvas();
    const node=$('resultContainer');
    const canvas=await html2canvas(node,{backgroundColor:'#ffffff',scale:2});
    const url=canvas.toDataURL('image/jpeg',0.92);
    const a=document.createElement('a'); a.href=url;
    const bd=$('birthDate').value||'unknown'; const bt=($('birthTime').value||'00:00').replace(':','-');
    a.download=`horoscope_${ts()}_${bd}_${bt}.jpg`;
    a.click(); toast('JPEGã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  }catch(e){ alert('ä¿å­˜ã«å¤±æ•—: '+(e.message||e)); }
}

/* ===== Init & SW ===== */
function init(){
  loadInputs();
  $('geoBtn').addEventListener('click', onGeocodeClick);
  $('runBtn').addEventListener('click', runHoroscope);
  $('backBtn').addEventListener('click', backToInput);
  $('saveBtn').addEventListener('click', saveAsJPEG);
  window.addEventListener('keydown', e=>{ if((e.key||'').toLowerCase()==='s' && $('outputArea').style.display==='block'){ e.preventDefault(); saveAsJPEG(); } });
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js?v=40'); }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body></html>
