<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æœ¬æ ¼æ˜Ÿå ã„ â€” ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è‡ªå‹•åˆ¤å®šãƒ»ãƒã‚¦ã‚¹è¨ˆç®—ãƒ»ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—æç”»</title>
<meta name="theme-color" content="#6b46c1" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª</text></svg>">

<!-- Astronomy Engine (browser build) -->
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<style>
:root{--accent:#6b46c1;--bg:#f6f7fb;--card:#fff;--muted:#666}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:#111}
.wrap{max-width:980px;margin:20px auto;padding:18px}
header{display:flex;gap:12px;align-items:center}
h1{margin:0;color:var(--accent);font-size:1.15rem}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-top:12px}
.row{display:flex;gap:8px}
input,select,button{font-size:14px}
input[type="date"],input[type="time"],input[type="text"],select{flex:1;padding:10px;border-radius:8px;border:1px solid #e9e9f2}
button{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
.small{font-size:0.88rem;color:var(--muted)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:820px){ .form-grid{grid-template-columns:1fr} }
.result-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f6}
.planet-name{font-weight:700}
.planet-sign{background:#f3e8ff;color:var(--accent);padding:6px 10px;border-radius:16px;font-weight:700}
.canvas-wrap{text-align:center;margin-top:12px}
#chart{width:100%;max-width:720px;height:720px;background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.badge{background:#f3f3ff;padding:6px 8px;border-radius:8px;color:var(--muted);font-weight:700}
.debug-pre{background:#f7f7fb;padding:8px;border-radius:8px;overflow:auto;font-size:12px;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-size:34px">ğŸª</div>
      <div>
        <h1>æœ¬æ ¼æ˜Ÿå ã„ â€” ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è‡ªå‹•åˆ¤å®šãƒ»ãƒã‚¦ã‚¹è¨ˆç®—ãƒ»ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—æç”»</h1>
        <div class="small">å‡ºç”Ÿåœ°ã‹ã‚‰å®Ÿç”¨çš„ã«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ¨å®šã—ã€Asc/MC ã‚’è¨ˆç®—ã€‚Whole/Equal ãƒã‚¦ã‚¹è¡¨ç¤ºã¨ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’æç”»ã—ã¾ã™ã€‚</div>
      </div>
    </header>

    <div id="status" class="card small">åˆæœŸåŒ–ä¸­â€¦Astronomy Engine ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚Service Worker ãŒã‚ã‚Œã°è§£é™¤ã—ã¾ã™ã€‚</div>

    <div class="card">
      <div class="form-grid">
        <div>
          <label>ç”Ÿå¹´æœˆæ—¥ï¼ˆå¿…é ˆï¼‰</label>
          <div class="row" style="margin-top:6px">
            <input id="birthDate" type="date" />
            <input id="birthTime" type="time" value="12:00" />
          </div>
          <label style="margin-top:8px">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è£œæ­£ï¼ˆä»»æ„ï¼‰</label>
          <input id="tzOffset" type="text" placeholder="ä¾‹: +09:00ï¼ˆè‡ªå‹•æ¨å®š or ä¸Šæ›¸ãå¯ï¼‰" />
          <div class="controls" style="margin-top:8px">
            <button id="tzFromBrowser">ãƒ–ãƒ©ã‚¦ã‚¶ã®ç¾åœ° TZ ã‚’ä½¿ã†</button>
            <button id="calcBtn">é‘‘å®šã‚’å®Ÿè¡Œ</button>
            <button id="exampleBtn" style="background:#444">ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ2000-01-01 12:00ï¼‰</button>
            <button id="debugBtn" style="background:#888">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º</button>
          </div>
        </div>

        <div>
          <label>å‡ºç”Ÿåœ°ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆâ†’ç·¯åº¦çµŒåº¦ã‚’è‡ªå‹•å…¥åŠ›ï¼‰</label>
          <select id="cityPreset" style="margin-top:6px">
            <option value="">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠï¼ˆã¾ãŸã¯ç·¯åº¦çµŒåº¦ã‚’ç›´æ¥å…¥åŠ›ï¼‰</option>
            <option value="tokyo">æ±äº¬ â€” (35.6812, 139.7671) â€” +09:00</option>
            <option value="kyoto">äº¬éƒ½ â€” (35.0116, 135.7681) â€” +09:00</option>
            <option value="sapporo">æœ­å¹Œ â€” (43.0642, 141.3469) â€” +09:00</option>
            <option value="london">ãƒ­ãƒ³ãƒ‰ãƒ³ â€” (51.5074, -0.1278) â€” +00:00</option>
            <option value="newyork">NY â€” (40.7128, -74.0060) â€” -05:00</option>
          </select>

          <div class="row" style="margin-top:8px">
            <input id="birthLat" type="text" placeholder="ç·¯åº¦ï¼ˆä¾‹: 35.6812ï¼‰" />
            <input id="birthLon" type="text" placeholder="çµŒåº¦ï¼ˆä¾‹: 139.7671ï¼‰" />
          </div>

          <label style="margin-top:8px">ãƒã‚¦ã‚¹æ–¹å¼</label>
          <select id="houseMethod" style="margin-top:6px">
            <option value="equal">Equalï¼ˆã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆèµ·ç‚¹ã§30Â°ã”ã¨ï¼‰</option>
            <option value="whole">Whole Signï¼ˆã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆãŒå«ã‚€æ˜Ÿåº§ã‚’ç¬¬1å®¤ï¼‰</option>
          </select>

          <div class="small" style="margin-top:8px">â€» é«˜åº¦ãª Placidus ç­‰ã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§è¿½åŠ å¯èƒ½ã§ã™ã€‚</div>
        </div>
      </div>
    </div>

    <div id="output" class="card" style="display:none">
      <div id="lucky" class="small"></div>

      <div id="planetList"></div>

      <div class="canvas-wrap">
        <div class="small" style="margin-bottom:6px">ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆãƒ›ã‚¤ãƒ¼ãƒ«ï¼‰</div>
        <canvas id="chart" width="720" height="720"></canvas>
        <div class="legend">
          <div class="badge">Asc = ã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆ</div>
          <div class="badge">MC = ãƒŸãƒƒãƒ‰ãƒ˜ãƒ–ãƒ³</div>
          <div class="badge">è¡¨ç¤º: å¤ªé™½ã€œåœŸæ˜Ÿ</div>
        </div>
      </div>

      <div id="todayTransit" style="margin-top:12px"></div>

      <pre id="debugInfo" class="debug-pre" style="display:none"></pre>
    </div>

  </div>

<script>
/* --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¨å®šç¾© --- */
const SIGNS = ['â™ˆ ç‰¡ç¾Šåº§','â™‰ ç‰¡ç‰›åº§','â™Š åŒå­åº§','â™‹ èŸ¹åº§','â™Œ ç…å­åº§','â™ ä¹™å¥³åº§','â™ å¤©ç§¤åº§','â™ è åº§','â™ å°„æ‰‹åº§','â™‘ å±±ç¾Šåº§','â™’ æ°´ç“¶åº§','â™“ é­šåº§'];
const PLANETS = [
  { body: Astronomy.Body.Sun, label: 'â˜€ï¸ å¤ªé™½' },
  { body: Astronomy.Body.Moon, label: 'ğŸŒ™ æœˆ' },
  { body: Astronomy.Body.Mercury, label: 'â˜¿ æ°´æ˜Ÿ' },
  { body: Astronomy.Body.Venus, label: 'â™€ é‡‘æ˜Ÿ' },
  { body: Astronomy.Body.Mars, label: 'â™‚ ç«æ˜Ÿ' },
  { body: Astronomy.Body.Jupiter, label: 'â™ƒ æœ¨æ˜Ÿ' },
  { body: Astronomy.Body.Saturn, label: 'â™„ åœŸæ˜Ÿ' },
];
// J2000 é»„é“å‚¾æ–œè§’ï¼ˆååˆ†å®Ÿç”¨çš„ãªå®šæ•°ï¼‰ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å€™è£œé–¢æ•°ãŒã‚ã‚Œã°å°†æ¥å·®ã—æ›¿ãˆå¯ã€‚
const EPSILON_DEG = 23.4392911;

function safeLog(...a){ if(console && console.log) console.log(...a); }

/* SWè§£é™¤ */
async function unregisterAllServiceWorkers(){
  if('serviceWorker' in navigator){
    try{
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs) await r.unregister();
      safeLog('ServiceWorker: unregistered', regs);
    }catch(e){ safeLog('SW unregister error', e); }
  }
}

/* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç¢ºèª */
function checkAstronomyReady(timeout=4000){
  return new Promise((resolve,reject)=>{
    const start = Date.now();
    (function poll(){
      if(typeof Astronomy !== 'undefined' && Astronomy.Body) resolve(true);
      else if(Date.now() - start > timeout) reject(new Error('Astronomy load timeout'));
      else setTimeout(poll,100);
    })();
  });
}

/* æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹ï¼ˆå …ç‰¢ï¼‰ */
function parseUserDate(dateStr, timeStr, tzOffsetStr){
  try{
    if(!dateStr) return null;
    let normalized = dateStr.replace(/\//g,'-').trim();
    const parts = normalized.split('-').map(s=>s.trim()).filter(Boolean);
    if(parts.length >= 3){
      const y = parseInt(parts[0],10), m = parseInt(parts[1],10), d = parseInt(parts[2],10);
      if(Number.isFinite(y) && Number.isFinite(m) && Number.isFinite(d)){
        const time = (timeStr && timeStr.trim()) ? timeStr.trim() : '12:00';
        if(tzOffsetStr && /^\s*[+-]\d{2}:\d{2}\s*$/.test(tzOffsetStr)){
          const iso = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00${tzOffsetStr}`;
          const dt = new Date(iso);
          if(isNaN(dt.getTime())) return null;
          return dt;
        }
        const [hh,mm] = time.split(':').map(v=>parseInt(v,10)||0);
        const dtLocal = new Date(y, m-1, d, hh, mm, 0, 0);
        if(!isNaN(dtLocal.getTime())) return dtLocal;
        const iso2 = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00`;
        const dt2 = new Date(iso2);
        if(!isNaN(dt2.getTime())) return dt2;
      }
    }
    const parsed = new Date(dateStr);
    return isNaN(parsed.getTime()) ? null : parsed;
  }catch(e){ safeLog('parseUserDate',e); return null; }
}

/* AstroTime äº’æ›ãƒ©ãƒƒãƒ‘ãƒ¼ */
function toAstroTime(jsDate){
  try{
    if(typeof Astronomy === 'undefined') return jsDate;
    if(typeof Astronomy.AstroTime === 'function') return new Astronomy.AstroTime(jsDate);
    if(typeof Astronomy.MakeTime === 'function'){
      const y = jsDate.getFullYear(), m = jsDate.getMonth()+1, d = jsDate.getDate();
      const hh = jsDate.getHours(), mm = jsDate.getMinutes(), ss = jsDate.getSeconds();
      return Astronomy.MakeTime(y,m,d,hh,mm,ss);
    }
    return jsDate;
  }catch(e){ safeLog('toAstroTime',e); return jsDate; }
}

/* ecliptic çµŒåº¦å–å¾—ï¼ˆelon/lon ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ */
function eclipticLongitude(ecl){
  if(!ecl) return NaN;
  const candidates = ['elon','lon','el','lambda'];
  for(const k of candidates){ if(Object.prototype.hasOwnProperty.call(ecl,k)){ const v = Number(ecl[k]); if(Number.isFinite(v)) return v; } }
  if(ecl && typeof ecl === 'object'){
    for(const val of Object.values(ecl)){
      if(val && typeof val === 'object' && Number.isFinite(Number(val.elon))) return Number(val.elon);
    }
  }
  return NaN;
}
function norm360(x){ if(!Number.isFinite(x)) return NaN; let v = x % 360; if(v<0) v+=360; return v; }
function angleDiff(a,b){ if(!Number.isFinite(a)||!Number.isFinite(b)) return NaN; let d = Math.abs(norm360(a)-norm360(b)); if(d>180) d=360-d; return d; }

/* --- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è‡ªå‹•æ¨å®šï¼ˆå®Ÿç”¨è¿‘ä¼¼ï¼‰ --- */
function approxTzFromLon(lon){
  // lon in degrees (-180..180)
  if(!Number.isFinite(lon)) return '';
  // round to nearest hour
  const offset = Math.round(lon / 15);
  const sign = offset >= 0 ? '+' : '-';
  const hh = String(Math.abs(offset)).padStart(2,'0');
  return `${sign}${hh}:00`;
}

/* éƒ½å¸‚ãƒ—ãƒªã‚»ãƒƒãƒˆ â†’ ç·¯åº¦çµŒåº¦ / æ¨å®š tz ã‚’ã‚»ãƒƒãƒˆ */
document.getElementById('cityPreset').addEventListener('change', (e)=>{
  const v = e.target.value;
  const map = {
    tokyo: {lat:35.6812, lon:139.7671, tz:'+09:00'},
    kyoto: {lat:35.0116, lon:135.7681, tz:'+09:00'},
    sapporo:{lat:43.0642, lon:141.3469, tz:'+09:00'},
    london:{lat:51.5074, lon:-0.1278, tz:'+00:00'},
    newyork:{lat:40.7128, lon:-74.0060, tz:'-05:00'}
  };
  if(map[v]){ document.getElementById('birthLat').value = map[v].lat; document.getElementById('birthLon').value = map[v].lon; document.getElementById('tzOffset').value = map[v].tz; }
});

/* ãƒ–ãƒ©ã‚¦ã‚¶ã®ç¾åœ°ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’å–å¾—ã—ã¦ã‚ªãƒ•ã‚»ãƒƒãƒˆä¾‹ã‚’æŒ¿å…¥ï¼ˆç°¡æ˜“ï¼‰ */
document.getElementById('tzFromBrowser').addEventListener('click', ()=>{
  try{
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    // ãƒ–ãƒ©ã‚¦ã‚¶ tz åã‹ã‚‰ç¾åœ¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—ï¼ˆä¾‹: Asia/Tokyo -> +09:00ï¼‰
    // ã“ã“ã¯ç°¡æ˜“: new Date().toLocaleString('en-US', {timeZone: tz}) ã§ç¾åœ¨æ™‚åˆ»ã‚’å¾—ã¦ offset ã‚’è¨ˆç®—
    const now = new Date();
    const local = new Date(now.toLocaleString('en-US', {timeZone: tz}));
    // difference between local (in tz) and UTC in hours:
    const diff = (local.getTime() - now.getTime()) / 3600000;
    const sign = diff >= 0 ? '+' : '-';
    const hh = String(Math.floor(Math.abs(diff))).padStart(2,'0');
    const mm = String(Math.round((Math.abs(diff) - Math.floor(Math.abs(diff))) * 60)).padStart(2,'0');
    document.getElementById('tzOffset').value = `${sign}${hh}:${mm}`;
    alert(`ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼š${tz}ï¼ˆç¾åœ¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’æ¨å®šã—ã¦å…¥åŠ›ã—ã¾ã—ãŸï¼š${document.getElementById('tzOffset').value}ï¼‰`);
  }catch(e){ safeLog(e); alert('ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è‡ªå‹•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
});

/* --- Asc, MC ã®è¨ˆç®—ï¼ˆSiderealTime ã‚’åˆ©ç”¨ï¼‰ --- */
/* å‚è€ƒå¼ï¼ˆæ–‡çŒ®ï¼‰ï¼šWikipedia ç­‰ã«ã‚ã‚‹æ¨™æº–å¼ã‚’æ¡ç”¨
   LST (deg) = (GAST_hours + lon/15) * 15
   MC  = atan2( sin(LST_rad) * cos(eps), cos(LST_rad) )  (deg)
   ASC = atan2( -cos(LST_rad), sin(LST_rad)*cos(eps) + tan(lat_rad)*sin(eps) )  (deg)
   ä¸Šè¨˜ã¯æ¨™æº–çš„ãªå‡¦ç†ã§å››åˆ†ä½ã‚’ atan2 ãŒæ‰±ã†ãŸã‚ 0..360 æ­£è¦åŒ–ã‚’è¡Œã†ã€‚
*/
function computeAscMc(astime, lon_deg, lat_deg){
  // astime is AstroTime or Date acceptable by Astronomy.SiderealTime
  // lon_deg: east positive
  // lat_deg: north positive
  let gastHours;
  try{
    if(typeof Astronomy.SiderealTime === 'function'){
      // Astronomy.SiderealTime expects an AstroTime-like object (we wrap earlier), returns GAST in sidereal hours (0..24)
      gastHours = Astronomy.SiderealTime(astime);
    } else {
      // fallback: approximate using Date -> not ideal
      const d = (astime instanceof Date) ? astime : (astime && astime.date) ? astime.date : new Date();
      // approximate: use current UTC hours scaled. This is rough fallback and should rarely be used.
      const utcHours = d.getUTCHours() + d.getUTCMinutes()/60 + d.getUTCSeconds()/3600;
      gastHours = (utcHours * 1.00273790935) % 24;
    }
  }catch(e){ safeLog('SiderealTime error', e); throw e; }

  // Local Sidereal Time (hours)
  const lstHours = (gastHours + lon_deg / 15) % 24;
  const lstDeg = lstHours * 15; // degrees
  const lstRad = lstDeg * Math.PI / 180;
  const latRad = lat_deg * Math.PI / 180;
  const epsRad = EPSILON_DEG * Math.PI / 180;

  // MC
  const mcRad = Math.atan2(Math.sin(lstRad) * Math.cos(epsRad), Math.cos(lstRad));
  let mcDeg = mcRad * 180/Math.PI;
  mcDeg = norm360(mcDeg);

  // Ascendant:
  // Using expression: atan2( -cos LST, sin LST * cos eps + tan phi * sin eps )
  const x = -Math.cos(lstRad);
  const y = Math.sin(lstRad) * Math.cos(epsRad) + Math.tan(latRad) * Math.sin(epsRad);
  let ascRad = Math.atan2(y, x);
  let ascDeg = ascRad * 180/Math.PI;
  ascDeg = norm360(ascDeg);
  // Theoretical adjustment to choose rising point:
  // By convention ensure Asc is the ecliptic longitude of the rising point (intersection east)
  // If ascDeg < 180 add 180 else subtract 180 (per Meeus and wiki)
  if(ascDeg < 180) ascDeg = ascDeg + 180;
  else ascDeg = ascDeg - 180;
  ascDeg = norm360(ascDeg);

  return { lstHours, lstDeg, ascDeg, mcDeg, gastHours };
}

/* ãƒã‚¦ã‚¹ã‚«ã‚¹ãƒ—ï¼ˆEqual / Wholeï¼‰ */
function computeHouseCusps(ascDeg, method='equal'){
  // returns array[12] of cusp degrees, house 1 is index 0
  if(method === 'whole'){
    // whole sign: find sign start that contains asc
    const signIndex = Math.floor(ascDeg / 30) % 12;
    const signStart = signIndex * 30;
    const cusps = [];
    for(let i=0;i<12;i++){
      cusps.push(norm360(signStart + i*30));
    }
    return cusps;
  } else {
    // equal houses: house 1 cusp = ascDeg, then +30n
    const cusps = [];
    for(let i=0;i<12;i++) cusps.push(norm360(ascDeg + i*30));
    return cusps;
  }
}

/* ãƒã‚¦ã‚¹ç•ªå·ã‚’å–å¾—ï¼ˆåº¦æ•°â†’ä½•å®¤ï¼‰ */
function houseFromLongitude(lonDeg, cusps){
  // find highest cusp <= lon in circular sense; if lon < min cusp adjust
  for(let h=11; h>=0; h--){
    const cusp = cusps[h];
    // compute diff = (lon - cusp) normalized 0..360
    const d = norm360(lonDeg - cusp);
    if(d >= 0 && d < 30) return h+1; // houses 1..12
  }
  return 1;
}

/* --- ãƒ›ã‚¤ãƒ¼ãƒ«æç”» --- */
function drawChart(cusps, planets, ascDeg, mcDeg){
  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);
  const cx = w/2, cy = h/2;
  const R = Math.min(w,h)/2 - 30;

  // background
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.rect(0,0,w,h); ctx.fill();

  // outer circle
  ctx.strokeStyle = '#ddd'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();

  // draw 12 house sectors and signs
  for(let i=0;i<12;i++){
    const start = cusps[i];
    const end = norm360(start + 30);
    // compute canvas angle: we map ecliptic lon -> canvas angle where 0deg ecliptic at 3 o'clock and increases CCW.
    // convert lon -> canvas rad: rad = (lon - ascDeg) * deg2rad * (-1) + Math.PI/2  (map so Asc at left visually)
    // Simpler: place 0 at top: rad = (lon - 90) * PI/180. We'll instead anchor by Asc so Asc is at left (270deg canvas).
    // Compute label position at middle of segment
    const mid = norm360(start + 15);
    const angle = ((mid - ascDeg) - 90) * Math.PI/180; // shift so asc at 90deg from x-axis
    // draw dividing line at cusp
    const cuspAngle = ((start - ascDeg) - 90) * Math.PI/180;
    ctx.strokeStyle = '#eee'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx + Math.cos(cuspAngle)*R, cy + Math.sin(cuspAngle)*R); ctx.stroke();

    // sign label
    ctx.fillStyle = '#666'; ctx.font = '14px system-ui';
    const lx = cx + Math.cos(angle) * (R - 22);
    const ly = cy + Math.sin(angle) * (R - 22);
    // sign name (Japanese) from SIGNS
    const signIndex = Math.floor(start/30) % 12;
    ctx.fillText(SIGNS[signIndex], lx - 18, ly + 6);
  }

  // draw inner circle and grid
  ctx.strokeStyle = '#f0f0f6'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.arc(cx,cy,R*0.7,0,Math.PI*2); ctx.stroke();

  // draw MC marker
  const mcAngle = ((mcDeg - ascDeg) - 90) * Math.PI/180;
  ctx.fillStyle = '#e26'; ctx.beginPath(); ctx.arc(cx + Math.cos(mcAngle)*(R*0.85), cy + Math.sin(mcAngle)*(R*0.85), 6, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#333'; ctx.font = '12px system-ui'; ctx.fillText('MC', cx + Math.cos(mcAngle)*(R*0.85) - 8, cy + Math.sin(mcAngle)*(R*0.85) + 20);

  // draw Asc marker
  const ascAngle = ((ascDeg - ascDeg) - 90) * Math.PI/180; // simplifies to -90deg
  ctx.fillStyle = '#26a'; ctx.beginPath(); ctx.arc(cx + Math.cos(ascAngle)*(R*0.85), cy + Math.sin(ascAngle)*(R*0.85), 6, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#333'; ctx.fillText('Asc', cx + Math.cos(ascAngle)*(R*0.85) - 12, cy + Math.sin(ascAngle)*(R*0.85) + 20);

  // draw planets (label with emoji and degree inside)
  ctx.font = '14px system-ui';
  planets.forEach(p=>{
    if(!Number.isFinite(p.lon)) return;
    const angle = ((p.lon - ascDeg) - 90) * Math.PI/180;
    const rpos = R*0.55;
    const x = cx + Math.cos(angle)*rpos;
    const y = cy + Math.sin(angle)*rpos;
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(x,y,18,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#ddd'; ctx.stroke();
    ctx.fillStyle = '#111';
    const label = `${p.label} ${ (Number.isFinite(p.degree) ? p.degree.toFixed(1)+'Â°':'â€”') }`;
    ctx.fillText(label, x-20, y+5);
  });
}

/* --- ä¸»è¦ãƒ­ã‚¸ãƒƒã‚¯: è¨ˆç®— + æç”» --- */
async function runCalculation(showDebug=false){
  // inputs
  const dateInput = document.getElementById('birthDate').value;
  const timeInput = document.getElementById('birthTime').value;
  let tzInput = document.getElementById('tzOffset').value.trim();
  const lat = parseFloat(document.getElementById('birthLat').value);
  const lon = parseFloat(document.getElementById('birthLon').value);
  const houseMethod = document.getElementById('houseMethod').value;

  // if tz empty and lat/lon present, propose approx
  if(!tzInput && Number.isFinite(lon)){
    tzInput = approxTzFromLon(lon);
    // write proposed to field but leave editable
    document.getElementById('tzOffset').value = tzInput;
  }

  const natalDate = parseUserDate(dateInput, timeInput, tzInput);
  if(!natalDate){
    alert('ç”Ÿå¹´æœˆæ—¥ / æ™‚åˆ»ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2000-01-01, 12:00ï¼‰ã€‚');
    return;
  }
  if(typeof Astronomy === 'undefined' || !Astronomy.Body){
    alert('Astronomy Engine ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // prepare AstroTime
  const natalAstro = toAstroTime(natalDate);

  // compute natal planets
  const natalPlanets = [];
  let natalJupiterLon = NaN;
  const debug = { planets: [] };

  for(const p of PLANETS){
    try{
      const vec = Astronomy.GeoVector(p.body, natalAstro, true);
      const ecl = Astronomy.Ecliptic(vec);
      const lonRaw = eclipticLongitude(ecl);
      const lonNorm = norm360(lonRaw);
      const degree = Number.isFinite(lonNorm) ? (lonNorm % 30) : NaN;
      natalPlanets.push({ label: p.label, lon: lonNorm, degree });
      if(p.body === Astronomy.Body.Jupiter && Number.isFinite(lonNorm)) natalJupiterLon = lonNorm;
      debug.planets.push({planet:p.label, lonRaw, lon:lonNorm});
    }catch(e){ safeLog('planet calc err', e); natalPlanets.push({ label: p.label, lon: NaN, degree: NaN }); debug.planets.push({planet:p.label, error:String(e)}); }
  }

  // compute Asc/MC
  const astimeForSidereal = natalAstro;
  let ascMc;
  try{
    ascMc = computeAscMc(astimeForSidereal, Number.isFinite(lon) ? lon : 139.7671, Number.isFinite(lat) ? lat : 35.6812);
  }catch(e){
    safeLog('asc compute error', e);
    alert('ã‚¢ã‚»ãƒ³ãƒ€ãƒ³ãƒˆã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ãƒ‡ãƒãƒƒã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  const ascDeg = ascMc.ascDeg;
  const mcDeg = ascMc.mcDeg;

  // house cusps
  const cusps = computeHouseCusps(ascDeg, houseMethod);

  // today jupiter
  let todayJupiterLon = NaN;
  try{
    const todayAst = toAstroTime(new Date());
    const vec = Astronomy.GeoVector(Astronomy.Body.Jupiter, todayAst, true);
    const ecl = Astronomy.Ecliptic(vec);
    todayJupiterLon = norm360(eclipticLongitude(ecl));
    debug.todayJupiter = todayJupiterLon;
  }catch(e){ safeLog('today jupiter err', e); }

  // produce planet list html + house assignment
  let html = '';
  natalPlanets.forEach(p=>{
    const degText = Number.isFinite(p.degree) ? p.degree.toFixed(1)+'Â°' : 'â€”';
    const signIndex = Number.isFinite(p.lon) ? Math.floor(p.lon / 30) % 12 : null;
    const signText = signIndex !== null ? SIGNS[signIndex] : 'â€”';
    const houseNo = Number.isFinite(p.lon) ? houseFromLongitude(p.lon, cusps) : 'â€”';
    html += `<div class="result-row"><div class="planet-name">${p.label}</div><div class="planet-sign">${signText} ${degText}  â€” ç¬¬${houseNo}å®¤</div></div>`;
  });

  // luck message (jupiter compare)
  let luckHtml = '';
  if(Number.isFinite(natalJupiterLon) && Number.isFinite(todayJupiterLon)){
    const diff = angleDiff(natalJupiterLon, todayJupiterLon);
    if(diff < 8) luckHtml = `âœ¨ <strong>æœ¨æ˜Ÿå¸°é‚„ã«è¿‘ã„ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚12å¹´ã«ä¸€åº¦ã®å¹¸é‹æœŸãŒè¿‘ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</strong>`;
    else if(diff < 20) luckHtml = `ğŸŒŸ æœ¨æ˜Ÿã¯æ¯”è¼ƒçš„è¿‘ã„ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ â€” è¿½ã„é¢¨ãŒæœŸå¾…ã§ãã¾ã™ã€‚`;
    else luckHtml = `ğŸ” æœ¨æ˜Ÿã®ä½ç½®å·®ã¯ ${diff.toFixed(1)}Â° â€” ç¾åœ¨ã¯å¼·ã„å¸°é‚„æœŸã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
    luckHtml += `<div class="small">å‡ºç”Ÿ: ${natalJupiterLon.toFixed(1)}Â° / ä»Šæ—¥: ${todayJupiterLon.toFixed(1)}Â°</div>`;
  } else {
    luckHtml = 'æœ¨æ˜Ÿæ¯”è¼ƒæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
  }

  // render
  document.getElementById('output').style.display = 'block';
  document.getElementById('planetList').innerHTML = html;
  document.getElementById('lucky').innerHTML = luckHtml;

  // draw chart
  drawChart(cusps, natalPlanets, ascDeg, mcDeg);

  // today transit summary (reuse previous transit code simplified)
  // find notable aspects between natal planets and today's transits for Sun..Saturn
  const todayPlanets = [];
  for(const p of PLANETS){
    try{
      const vec = Astronomy.GeoVector(p.body, toAstroTime(new Date()), true);
      const ecl = Astronomy.Ecliptic(vec);
      const lon = norm360(eclipticLongitude(ecl));
      todayPlanets.push({ label: p.label, lon });
    }catch(e){ todayPlanets.push({ label: p.label, lon: NaN }); }
  }
  const aspects = [];
  for(const t of todayPlanets){
    for(const n of natalPlanets){
      if(!Number.isFinite(t.lon) || !Number.isFinite(n.lon)) continue;
      const d = angleDiff(n.lon, t.lon);
      if(d < 5) aspects.push({ natal:n.label, transit:t.label, aspect:'åˆ', diff:d });
      else if(Math.abs(d - 60) < 6) aspects.push({ natal:n.label, transit:t.label, aspect:'ã‚»ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«', diff:d });
      else if(Math.abs(d - 90) < 6) aspects.push({ natal:n.label, transit:t.label, aspect:'ã‚¹ã‚¯ã‚¨ã‚¢', diff:d });
      else if(Math.abs(d - 120) < 8) aspects.push({ natal:n.label, transit:t.label, aspect:'ãƒˆãƒ©ã‚¤ãƒ³', diff:d });
      else if(Math.abs(d - 180) < 8) aspects.push({ natal:n.label, transit:t.label, aspect:'ã‚ªãƒã‚¸ã‚·ãƒ§ãƒ³', diff:d });
    }
  }
  const topAspectsHtml = aspects.length ? '<ul>' + aspects.map(a=>`<li><strong>${a.transit}</strong> ãŒ <strong>${a.natal}</strong> ã¨ ${a.aspect}ï¼ˆå·® ${a.diff.toFixed(1)}Â°ï¼‰</li>`).join('') + '</ul>' : '<div class="small">æœ¬æ—¥ã¯æ³¨ç›®ã‚¢ã‚¹ãƒšã‚¯ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
  document.getElementById('todayTransit').innerHTML = `<h4>æœ¬æ—¥ã®ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆæ³¨ç›®</h4>${topAspectsHtml}`;

  // debug
  const dbgElem = document.getElementById('debugInfo');
  if(showDebug){
    dbgElem.style.display = 'block';
    dbgElem.textContent = JSON.stringify({ natalPlanets, ascDeg, mcDeg, cusps, todayPlanets, ascMc }, null, 2);
  } else dbgElem.style.display = 'none';
}

/* åˆæœŸåŒ– */
(async function init(){
  await unregisterAllServiceWorkers();
  try{
    await checkAstronomyReady(4000);
    document.getElementById('status').textContent = 'âœ… Astronomy Engine èª­ã¿è¾¼ã¿æ¸ˆ â€” æº–å‚™å®Œäº†';
  }catch(e){
    document.getElementById('status').textContent = 'âš ï¸ Astronomy Engine ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
    safeLog(e);
  }

  document.getElementById('calcBtn').addEventListener('click', ()=>runCalculation(false));
  document.getElementById('exampleBtn').addEventListener('click', ()=>{
    document.getElementById('birthDate').value = '2000-01-01';
    document.getElementById('birthTime').value = '12:00';
    document.getElementById('birthLat').value = '35.6812';
    document.getElementById('birthLon').value = '139.7671';
    document.getElementById('tzOffset').value = '+09:00';
  });
  document.getElementById('debugBtn').addEventListener('click', ()=>runCalculation(true));
})();
</script>
</body>
</html>
