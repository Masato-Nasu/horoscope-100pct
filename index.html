<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>100% æ˜Ÿå ã„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#B79DF2">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">

  <style>
    * {
      box-sizing: border-box;
    }
    html,
    body {
      max-width: 100%;
      overflow-x: hidden;     /* â˜… æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif;
      background: #ffffff;
      color: #333333;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
      text-align: center;
      touch-action: pan-y;    /* â˜… ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ã¿ï¼ˆæ¨ªã‚¹ãƒ¯ã‚¤ãƒ—æŠ‘åˆ¶ï¼‰ */
    }
    .app-card {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      padding: 18px 16px 20px;
    }
    .app-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .app-icon {
      font-size: 28px;
    }
    .app-title-block {
      text-align: left;
    }
    .app-title {
      font-size: 16px;
      font-weight: 600;
      color: #7C4DFF;
      margin: 0;
    }

    .form-row {
      margin-bottom: 10px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      color: #555555;
    }
    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #DDDDFF;
      font-size: 13px;
      font-family: inherit;
    }
    input:focus {
      outline: none;
      border-color: #B79DF2;
      box-shadow: 0 0 0 1px rgba(183,157,242,0.5);
    }
    button {
      width: 100%;
      border: none;
      padding: 11px 12px;
      border-radius: 12px;
      margin-top: 14px;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #B79DF2, #7C4DFF);
      color: #ffffff;
      cursor: pointer;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2) inset;
    }
    /* ä¸‹ã®ã€Œçµæœã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ç”¨ï¼ˆã‚»ã‚«ãƒ³ãƒ€ãƒªï¼‰ */
    .secondary-button {
      margin-top: 18px;
      background: #ffffff;
      color: #7C4DFF;
      border: 1px solid #D4C4FF;
      box-shadow: none;
    }
    .secondary-button:active {
      box-shadow: 0 0 0 1px rgba(183,157,242,0.4) inset;
      transform: translateY(0);
    }

    .result {
      margin-top: 16px;
      text-align: left;
    }
    .section-title {
      margin: 18px 0 4px;
      font-size: 14px;
      font-weight: 600;
      color: #7C4DFF;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title span.icon {
      font-size: 18px;
    }
    .section-title span.label {
      flex: 1;
    }
    .section-title span.percent {
      font-size: 13px;
      color: #555555;
    }
    .text-block {
      font-size: 12px;
      color: #555555;
      line-height: 1.7;
      padding: 8px 10px;
      border-radius: 14px;
      background: #F7F4FF;
      margin-bottom: 6px;
    }
    .birthday {
      margin-top: 12px;
      font-size: 12px;
      color: #C06FD8;
      text-align: left;
    }
    #confettiCanvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      .app-card {
        border-radius: 20px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.10);
      }
    }
  </style>

  <!-- Astronomy Engine -->
  <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
  <!-- çµæœã‚’ç”»åƒåŒ–ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<canvas id="confettiCanvas"></canvas>

<div class="app-card" id="cardRoot">
  <div class="app-header">
    <div class="app-icon">ğŸª</div>
    <div class="app-title-block">
      <p class="app-title">100% æ˜Ÿå ã„</p>
    </div>
  </div>

  <div class="form-row">
    <label for="birth">ç”Ÿå¹´æœˆæ—¥</label>
    <input id="birth" type="date" value="1978-12-31">
  </div>

  <div class="form-row">
    <label for="targetDate">å ã„ãŸã„æ—¥ï¼ˆç©ºæ¬„ãªã‚‰ä»Šæ—¥ï¼‰</label>
    <input id="targetDate" type="date">
  </div>

  <button type="button" onclick="calc()">ã“ã®æ—¥ã®é‹å‹¢ã‚’è¦‹ã‚‹</button>

  <div id="result" class="result"></div>
  <div id="birthdayMessage" class="birthday"></div>

  <!-- åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºã€çµæœãŒå‡ºãŸã‚‰è¡¨ç¤ºã™ã‚‹ -->
  <button
    type="button"
    id="saveBtn"
    class="secondary-button"
    style="display:none"
    onclick="saveResultImage()"
  >
    çµæœã‚’ä¿å­˜
  </button>
</div>

<script>
(function () {
  'use strict';

  // --- PWA: Service Worker ç™»éŒ² ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('sw.js')
        .then(function (reg) {
          console.log('ServiceWorker registered:', reg.scope);
        })
        .catch(function (err) {
          console.log('ServiceWorker registration failed:', err);
        });
    });
  }

  function stableSeed(str) {
    var h = 1779033703 ^ str.length;
    for (var i = 0; i < str.length; i++) {
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = (h << 13) | (h >>> 19);
    }
    h = (h ^ (h >>> 16)) >>> 0;
    return h;
  }

  function makeRng(seed) {
    var a = seed >>> 0;
    return function () {
      a |= 0;
      a = (a + 0x6D2B79F5) | 0;
      var t = Math.imul(a ^ (a >>> 15), 1 | a);
      t = t + Math.imul(t ^ (t >>> 7), 61 | t) ^ t;
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  var TEXT_BANK = {
    total: {
      a: [
        "è¿½ã„é¢¨ã‚’æ„Ÿã˜ã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚ã‚„ã‚ŠãŸã„ã“ã¨ã‚’ä¸€ã¤ã ã‘æ±ºã‚ã¦ã€ãã“ã«æ™‚é–“ã‚’ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚ã¡ã‚‡ã£ã¨ã—ãŸè¡Œå‹•ãŒã€æ¬¡ã®ãã£ã‹ã‘ã«ã¤ãªãŒã£ã¦ã„ããã†ã§ã™ã€‚",
        "å…¨ä½“çš„ã«ã‚¹ãƒ ãƒ¼ã‚ºã«æµã‚Œã‚„ã™ã„æ—¥ã€‚å®Œç’§ã‚’ç›®æŒ‡ã™ã‚ˆã‚Šã‚‚ã€ã€Œä»Šæ—¥ã¯ã“ã“ã¾ã§ã§ãã‚Œã°ååˆ†ã€ã¨è‡ªåˆ†ã«è¨€ã£ã¦ã‚ã’ã‚‹ã¨ã€æ°—æŒã¡ã‚ˆãä¸€æ—¥ã‚’çµ‚ãˆã‚‰ã‚Œãã†ã§ã™ã€‚"
      ],
      b: [
        "å¤§ããªå±±ã¯ãªãã¦ã‚‚ã€æ—¥å¸¸ã‚’æ•´ãˆã‚„ã™ã„æ—¥ã€‚ã™ã¹ã¦ã‚’ä¸€åº¦ã«å¤‰ãˆã‚ˆã†ã¨ã›ãšã€èº«ã®å›ã‚Šã®å°ã•ãªã¨ã“ã‚ã‹ã‚‰æ•´ãˆã¦ã„ãã¨ã€å¿ƒã‚‚è½ã¡ç€ã„ã¦ãã¾ã™ã€‚",
        "ã„ã¤ã‚‚é€šã‚Šã®ä¸€æ—¥ã®ä¸­ã«ã‚‚ã€å°ã•ãªæ¥½ã—ã¿ã‚’è¦‹ã¤ã‘ã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚å¥½ããªé£²ã¿ç‰©ã‚„éŸ³æ¥½ã‚’ã²ã¨ã¤è¶³ã—ã¦ã€è‡ªåˆ†ã ã‘ã®ã”ã»ã†ã³æ™‚é–“ã‚’ä½œã£ã¦ã¿ã¦ãã ã•ã„ã€‚"
      ],
      c: [
        "å°‘ã—æ…é‡ã•ãŒå½¹ã«ç«‹ã¤æ—¥ã€‚ç„¡ç†ã«ç­”ãˆã‚’å‡ºãã†ã¨ã›ãšã€ã€Œä»Šæ—¥ã¯æ§˜å­ã‚’è¦‹ã‚‹ã€ã¨æ±ºã‚ã‚‹ã ã‘ã§ã‚‚ã€å¿ƒã«ä½™ç™½ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚è‡ªåˆ†ã‚’è²¬ã‚ã™ããªã„ã§ãã ã•ã„ã­ã€‚",
        "æ€ã„é€šã‚Šã«é€²ã¾ãªã„å ´é¢ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãã‚Œã§ã‚‚å¤§ä¸ˆå¤«ã€‚ã§ããªã‹ã£ãŸã“ã¨ã‚ˆã‚Šã€ä»Šæ—¥ã¡ã‚ƒã‚“ã¨ã§ããŸã“ã¨ã‚’ä¸€ã¤æ€ã„å‡ºã—ã¦ã€ãã£ã¨è‡ªåˆ†ã‚’ã­ãã‚‰ã£ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚"
      ]
    },
    love: {
      a: [
        "äººã¨ã®è·é›¢ãŒå¿ƒåœ°ã‚ˆãç¸®ã¾ã‚Šã‚„ã™ã„æ—¥ã€‚æ‹æ„›ã«é™ã‚‰ãšã€ç´ ç›´ãªã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚„ã€ŒãŠã¤ã‹ã‚Œã•ã¾ã€ãŒã€é–¢ä¿‚ã‚’ã‚ãŸãŸã‹ãã—ã¦ãã‚Œãã†ã§ã™ã€‚",
        "æ°—ã«ãªã‚‹äººã¨ã®ä¼šè©±ãŒå¼¾ã¿ã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚å¤§ããªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚ˆã‚Šã‚‚ã€ã¡ã‚‡ã£ã¨ã—ãŸæ°—é£ã„ã‚„ã‚¹ã‚¿ãƒ³ãƒ—ã²ã¨ã¤ãŒã€ç›¸æ‰‹ã®å¿ƒã«ã‚„ã•ã—ãå±Šããã†ã§ã™ã€‚"
      ],
      b: [
        "è¨€è‘‰ã®è¡Œãé•ã„ã«æ•æ„Ÿã«ãªã‚Šã‚„ã™ã„æ—¥ã€‚ç›¸æ‰‹ã®ä¸€è¨€ã‚’æ·±èª­ã¿ã—ã™ããšã€ã€Œä»Šæ—¥ã¯ãã†ã„ã†æ—¥ã‚‚ã‚ã‚‹ã€ã¨å—ã‘æ­¢ã‚ã¦ã¿ã‚‹ã¨ã€æ°—æŒã¡ãŒå°‘ã—è»½ããªã‚Šã¾ã™ã€‚",
        "éå»ã®å‡ºæ¥äº‹ã‚’ãµã¨æ€ã„å‡ºã—ã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã†ã¾ãã„ã‹ãªã‹ã£ãŸçµŒé¨“ã‚‚ã€ã€Œã‚ã®æ™‚ã®è‡ªåˆ†ã‚‚ã‚ˆããŒã‚“ã°ã£ã¦ã„ãŸã€ã¨èªã‚ã¦ã‚ã’ã‚‹ã¨ã€ä»Šã®æ‹ã«ã‚‚ã‚„ã•ã—ãå‘ãåˆãˆã¾ã™ã€‚"
      ],
      c: [
        "æ°—æŒã¡ãŒæºã‚Œã‚„ã™ã„æ—¥ã€‚ç„¡ç†ã«æ˜ã‚‹ãæŒ¯ã‚‹èˆã†ã‚ˆã‚Šã€ä¿¡é ¼ã§ãã‚‹äººã¨ã®ã‚†ã‚‹ã„ä¼šè©±ã‚„ä¸€äººæ™‚é–“ã§å¿ƒã‚’è½ã¡ç€ã‹ã›ã‚‹ã»ã†ãŒã€æ‹ã®ãƒãƒ©ãƒ³ã‚¹ã‚‚æ•´ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚",
        "ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã¨è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã®é•ã„ã‚’ã€å°‘ã—é‡ãæ„Ÿã˜ã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ç­”ãˆã‚’æ€¥ãŒãšã€ã€Œä»Šæ—¥ã¯è‡ªåˆ†ã®å¿ƒã®å£°ã‚’ã‚ˆãè´ãæ—¥ã€ã¨æ±ºã‚ã¦éã”ã—ã¦ã¿ã¦ãã ã•ã„ã€‚"
      ]
    },
    work: {
      a: [
        "é›†ä¸­åŠ›ã‚’ç™ºæ®ã—ã‚„ã™ã„æ—¥ã€‚çŸ­ã„æ™‚é–“ã§ã‚‚ã€Œã“ã“ã¾ã§ã‚„ã‚‹ã€ã¨æ±ºã‚ã¦å–ã‚Šçµ„ã‚€ã¨ã€æ‰‹å¿œãˆã¨é”æˆæ„Ÿã®ä¸¡æ–¹ã‚’å¾—ã‚‰ã‚Œãã†ã§ã™ã€‚",
        "å¾—æ„ãªä½œæ¥­ã§å‘¨ã‚Šã‚’æ”¯ãˆã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚ç„¡ç†ã®ãªã„ç¯„å›²ã§æ‰‹ã‚’å·®ã—ä¼¸ã¹ã‚‹ã¨ã€ä¿¡é ¼æ„ŸãŒãã£ã¨é«˜ã¾ã‚Šãã†ã§ã™ã€‚"
      ],
      b: [
        "æ·¡ã€…ã¨å–ã‚Šçµ„ã‚€ã“ã¨ã§ã€æ°—ã¥ã„ãŸã‚‰é€²ã‚“ã§ã„ã‚‹æ—¥ã€‚ä»•äº‹å‰ã«ä»Šæ—¥ã‚„ã‚‹ã“ã¨ã‚’ä¸‰ã¤ã ã‘æ›¸ãå‡ºã™ã¨ã€ã‚¹ãƒ ãƒ¼ã‚ºã«å‹•ãã‚„ã™ããªã‚Šã¾ã™ã€‚",
        "ã€ŒãŒã‚“ã°ã‚‹ã€ã¨ã€Œä¼‘ã‚€ã€ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ã¨ã‚ŠãŸã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚åŒã˜å§¿å‹¢ãŒç¶šãã¨ãã¯ã€è»½ãé¦–ã‚„è‚©ã‚’å›ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚ã’ã¦ãã ã•ã„ã€‚"
      ],
      c: [
        "é›†ä¸­ã—ã«ãã•ã‚’æ„Ÿã˜ãŸã‚‰ã€ã„ã£ãŸã‚“ã‚¿ã‚¹ã‚¯ã‚’ç´°ã‹ãåŒºåˆ‡ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã€Œã“ã“ã¾ã§ã§ããŸã‚‰ä¼‘æ†©ã€ã¨å°ã•ãªã‚´ãƒ¼ãƒ«ã‚’ä½œã‚‹ã¨ã€æ°—æŒã¡ãŒå°‘ã—æ¥½ã«ãªã‚Šã¾ã™ã€‚",
        "åˆ¤æ–­ã«è¿·ã†ã“ã¨ãŒå¢—ãˆãã†ãªæ—¥ã€‚å¤§ããªæ±ºæ–­ã¯æ˜æ—¥ä»¥é™ã«å›ã—ã€ä»Šæ—¥ã¯æƒ…å ±ã‚’é›†ã‚ã‚‹æ—¥ã«ã™ã‚‹ã®ã‚‚ä¸€ã¤ã®é¸æŠã§ã™ã€‚"
      ]
    },
    money: {
      a: [
        "ãŠé‡‘ã¨ã®ä»˜ãåˆã„æ–¹ã‚’æ•´ãˆã‚„ã™ã„æ—¥ã€‚ãƒ¬ã‚·ãƒ¼ãƒˆã‚„æ˜ç´°ã‚’ã–ã£ã¨çœºã‚ã¦ã€æ°—ã«ãªã‚‹é …ç›®ã«å°ã‚’ã¤ã‘ã‚‹ã ã‘ã§ã‚‚ã€æµã‚ŒãŒè¦‹ãˆã‚„ã™ããªã‚Šã¾ã™ã€‚",
        "æ¬²ã—ã„ã‚‚ã®ã¨å¿…è¦ãªã‚‚ã®ã®ç·šå¼•ããŒã—ã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚ä»Šæ—¥ã¯ã€Œæœ¬å½“ã«ã¨ãã‚ãã‚‚ã®ã€ã ã‘ã‚’é¸ã¶æ„è­˜ã§ã€ãŠé‡‘ã‚’ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚"
      ],
      b: [
        "ã€Œãªã‚“ã¨ãªãã€ã§ä½¿ã£ã¦ã—ã¾ã†ãŠé‡‘ã‚’è¦‹ç›´ã—ãŸããªã‚‹æ—¥ã€‚ã™ã¹ã¦ã‚’ç®¡ç†ã—ãã‚Œãªãã¦ã‚‚ã€ã€Œã“ã‚Œã¯ã‚„ã‚ã¦ã¿ã‚ˆã†ã‹ãªã€ã¨æ€ã†é …ç›®ã‚’ä¸€ã¤æ±ºã‚ã‚‹ã ã‘ã§ååˆ†ã§ã™ã€‚",
        "å¤§ããªå‡ºè²»ã‚ˆã‚Šã‚‚ã€æ—¥ã€…ã®å°ã•ãªç©ã¿é‡ã­ãŒæ°—ã«ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚ç„¡ç†ãªç¯€ç´„ã§ã¯ãªãã€ã€Œã“ã“ã ã‘å°‘ã—æ§ãˆã‚ã«ã—ã¦ã¿ã‚ˆã†ã€ãã‚‰ã„ãŒç¶šã‘ã‚„ã™ãã†ã§ã™ã€‚"
      ],
      c: [
        "ãŠé‡‘ã®ã“ã¨ã‚’è€ƒãˆã‚‹ã¨å°‘ã—ä¸å®‰ãŒå‡ºã¦ãã‚„ã™ã„æ—¥ã€‚ã²ã¨ã‚Šã§æŠ±ãˆè¾¼ã¾ãšã€ä¿¡é ¼ã§ãã‚‹äººã«è»½ãç›¸è«‡ã—ãŸã‚Šã€å®¶è¨ˆã‚¢ãƒ—ãƒªã§ç¾çŠ¶ã‚’ã€Œè¦‹ãˆã‚‹åŒ–ã€ã™ã‚‹ã¨ã“ã‚ã‹ã‚‰å§‹ã‚ã¦ã¿ã¦ãã ã•ã„ã€‚",
        "ä»Šæ—¥ã¯å¤§ããªå¥‘ç´„ã‚„é«˜é¡ãªè²·ã„ç‰©ã¯æ…é‡ã«ã€‚ã‚‚ã†ä¸€åº¦æ¡ä»¶ã‚’è¦‹ç›´ã—ãŸã‚Šã€ä¸€æ™©ãŠã„ã¦ã‹ã‚‰æ±ºã‚ã‚‹ã¨å¾Œæ‚”ãŒå°‘ãªãæ¸ˆã¿ãã†ã§ã™ã€‚"
      ]
    },
    health: {
      a: [
        "ä½“ã¨å¿ƒã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’æ•´ãˆã‚„ã™ã„æ—¥ã€‚æ—©ã‚ã«ãŠé¢¨å‘‚ã«å…¥ã£ãŸã‚Šã€å¥½ããªé¦™ã‚Šã‚’å–ã‚Šå…¥ã‚ŒãŸã‚Šã¨ã€äº”æ„Ÿã‹ã‚‰ãƒªãƒ©ãƒƒã‚¯ã‚¹ã•ã›ã¦ã‚ã’ã¦ãã ã•ã„ã€‚",
        "å°ã•ãªã‚±ã‚¢ãŒæ˜æ—¥ã®è‡ªåˆ†ã‚’åŠ©ã‘ã¦ãã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚æ°´åˆ†è£œçµ¦ã‚„è»½ã„ã‚¹ãƒˆãƒ¬ãƒƒãƒãªã©ã€ç¶šã‘ã‚„ã™ã„ã“ã¨ã‚’ã²ã¨ã¤é¸ã‚“ã§æ„è­˜ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚"
      ],
      b: [
        "å¤œã®ã‚¹ãƒãƒ›æ™‚é–“ã‚’å°‘ã—çŸ­ãã—ã¦ã¿ã‚‹ã ã‘ã§ã‚‚ã€ç¡çœ ã®è³ªãŒå¤‰ã‚ã£ã¦ããã†ãªæ—¥ã€‚å¯ã‚‹å‰ã«æ·±å‘¼å¸ã‚’æ•°å›ç¹°ã‚Šè¿”ã—ã€ä½“ã®åŠ›ã‚’æŠœãã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
        "ãªã‚“ã¨ãªãç–²ã‚Œã‚’æ„Ÿã˜ãŸã‚‰ã€ã€Œä»Šæ—¥ã¯æ—©ã‚ã«å¯ã‚‹ã€ã¨æ±ºã‚ã¦ã—ã¾ã†ã®ã‚‚ã‚¢ãƒªã€‚è‡ªåˆ†ã®é™ç•Œã‚’è¶…ãˆã‚‹å‰ã«ä¼‘ã‚€ã“ã¨ãŒã€æ˜æ—¥ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã¤ãªãŒã‚Šã¾ã™ã€‚"
      ],
      c: [
        "ç–²ã‚ŒãŒãŸã¾ã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚ç„¡ç†ã«äºˆå®šã‚’è©°ã‚è¾¼ã¾ãšã€å¸°å®…å¾Œã¯ä½“ã‚’ã‚ãŸãŸã‚ã‚‹ã“ã¨ã¨ã€ååˆ†ãªç¡çœ ã‚’å„ªå…ˆã—ã¦ã‚ã’ã¦ãã ã•ã„ã€‚",
        "æ°—åœ§ã‚„æ°—æ¸©ã®å¤‰åŒ–ã§ã€ä½“èª¿ã‚„æ°—åˆ†ãŒæºã‚Œã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚æ¸©ã‹ã„é£²ã¿ç‰©ã‚„ã€ã‚„ã•ã—ã„å‘³ã®ã”é£¯ã§ã€å†…å´ã‹ã‚‰ã˜ã‚“ã‚ã‚Šæ•´ãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚"
      ]
    }
  };

  function gradeFromScore(score) {
    if (score >= 75) return 'a';
    if (score >= 45) return 'b';
    return 'c';
  }

  function pickText(category, score, seedBase) {
    var g = gradeFromScore(score);
    var bank = (TEXT_BANK[category] && TEXT_BANK[category][g]) || [];
    if (!bank.length) return '';
    var rng = makeRng(stableSeed(category + '|' + g + '|' + seedBase));
    var idx = Math.floor(rng() * bank.length);
    return bank[idx];
  }

  function seasonPhrase(date, seedBase) {
    if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
    var month = date.getMonth() + 1;
    var rng = makeRng(stableSeed('season|' + month + '|' + seedBase));
    var arr;
    if (month === 12 || month === 1 || month === 2) {
      arr = [
        "å†·ãŸã„ç©ºæ°—ã®ä¸­ã«ã‚‚ã€é™ã‹ã«æ•´ãˆã‚‹åŠ›ãŒæµã‚Œã¦ã„ã¾ã™ã€‚æ¸©ã‹ã„é£²ã¿ç‰©ã§ã»ã£ã¨ä¸€æ¯ã¤ãæ™‚é–“ã‚’å¢—ã‚„ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
        "ä¸€å¹´ã®ç· ã‚ããã‚Šã‚„å§‹ã¾ã‚Šã‚’æ„è­˜ã—ã‚„ã™ã„å­£ç¯€ã€‚å°ã•ãªåŒºåˆ‡ã‚Šã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€å¿ƒã«ã‚‚ä½™ç™½ãŒç”Ÿã¾ã‚Œãã†ã§ã™ã€‚"
      ];
    } else if (month >= 3 && month <= 5) {
      arr = [
        "æ˜¥ã®ç©ºæ°—ãŒã‚†ã£ãã‚Šã¨æµã‚Œè¾¼ã¿ã€æ°—æŒã¡ã‚‚å°‘ã—ãšã¤ã»ãã‚Œã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚äºˆå®šã®ä¸­ã«ã€å°ã•ãªæ¥½ã—ã¿ã‚’æ··ãœã¦ã¿ã¦ãã ã•ã„ã€‚",
        "æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ãŸããªã‚‹å­£ç¯€ã€‚å…¨éƒ¨ã‚’ä¸€æ°—ã«å¤‰ãˆã‚ˆã†ã¨ã›ãšã€ã€Œã²ã¨ã¤ã ã‘è©¦ã—ã¦ã¿ã‚‹ã€ãã‚‰ã„ãŒã¡ã‚‡ã†ã©è‰¯ã•ãã†ã§ã™ã€‚"
      ];
    } else if (month >= 6 && month <= 8) {
      arr = [
        "æš‘ã•ã§ä½“åŠ›ã‚’å¥ªã‚ã‚Œã‚„ã™ã„å­£ç¯€ã€‚ç„¡ç†ã‚’é€šã™ã‚ˆã‚Šã€ã“ã¾ã‚ãªä¼‘æ†©ã¨æ°´åˆ†è£œçµ¦ã‚’å‘³æ–¹ã«ã¤ã‘ã¦ã‚ã’ã¦ãã ã•ã„ã€‚",
        "æ—¥å·®ã—ãŒå¼·ã„ã¶ã‚“ã€å¿ƒã‚‚å¤–ã«å‘ãã‚„ã™ã„æ™‚æœŸã€‚ç–²ã‚Œã‚’æ„Ÿã˜ãŸã‚‰ã€æ¶¼ã—ã„å ´æ‰€ã§ä¸€æ¯ã¤ã„ã¦ã‹ã‚‰æ¬¡ã®äºˆå®šã¸ã€‚"
      ];
    } else {
      arr = [
        "ç©ºæ°—ãŒå°‘ã—ãšã¤è½ã¡ç€ã„ã¦ãã‚‹å­£ç¯€ã€‚ã‚†ã£ãã‚Šã¨æŒ¯ã‚Šè¿”ã‚‹æ™‚é–“ã‚’ã¨ã‚‹ã“ã¨ã§ã€æ¬¡ã«é€²ã‚€ãƒ’ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šãã†ã§ã™ã€‚",
        "æ—¥ã€…ã®å¤‰åŒ–ã‚’æ„Ÿã˜ã‚„ã™ã„å­£ç¯€ã€‚å°ã•ãªé•ã„ã«æ°—ã¥ãã»ã©ã€æ˜æ—¥ã¸ã®æ¥½ã—ã¿ã‚‚å¢—ãˆã¦ã„ãã¾ã™ã€‚"
      ];
    }
    var idx = Math.floor(rng() * arr.length);
    return arr[idx] || '';
  }

  function aspectScore(diff) {
    var aspects = [
      { angle: 0,   sign:  1.0 },
      { angle: 60,  sign:  0.6 },
      { angle: 120, sign:  1.0 },
      { angle: 90,  sign: -0.8 },
      { angle: 180, sign: -0.8 }
    ];
    var sigma = 35;
    var rad2 = 2 * sigma * sigma;
    var score = 0;
    for (var i = 0; i < aspects.length; i++) {
      var a = aspects[i];
      var d = Math.abs(diff - a.angle);
      if (d > 180) d = 360 - d;
      var w = Math.exp(-(d * d) / rad2);
      score += a.sign * w;
    }
    score -= 0.2435;
    return score;
  }

  function clampNorm(x) {
    if (x < -1) return -1;
    if (x >  1) return  1;
    return x;
  }

  function softenBackground(bg, negScale) {
    if (bg < 0) {
      return bg * negScale;
    }
    return bg;
  }

  function mapNormToPercent(n, minP, maxP) {
    if (n < -1) n = -1;
    if (n >  1) n =  1;

    var z = (n < 0) ? -Math.sqrt(-n) : Math.sqrt(n);
    var mid = (minP + maxP) / 2;
    var amp = (maxP - minP) / 2;
    var p = mid + amp * z;

    if (n > 0.96) {
      p = 100;
    }

    if (p < minP) p = minP;
    if (p > 100) p = 100;
    return Math.round(p);
  }

  function parseDateInput(str) {
    if (!str) return null;
    var m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    var y  = parseInt(m[1], 10);
    var mo = parseInt(m[2], 10);
    var d  = parseInt(m[3], 10);
    if (!y || !mo || !d) return null;
    return new Date(y, mo - 1, d, 12, 0, 0);
  }

  function eclLon(body, date) {
    var time = new Astronomy.AstroTime(date);
    var vec  = Astronomy.GeoVector(body, time, true);
    var ecl  = Astronomy.Ecliptic(vec);
    return ecl.elon;
  }

  function fireConfetti() {
    var canvas = document.getElementById('confettiCanvas');
    var ctx = canvas.getContext('2d');
    var w = (canvas.width  = window.innerWidth);
    var h = (canvas.height = window.innerHeight);
    var COUNT = 150;
    var confs = [];
    for (var i = 0; i < COUNT; i++) {
      confs.push({
        x: Math.random() * w,
        y: Math.random() * -h,
        vy: 2 + Math.random() * 3,
        vx: (Math.random() - 0.5) * 1.5,
        size: 4 + Math.random() * 4,
        rot: Math.random() * Math.PI * 2,
        vr: (Math.random() - 0.5) * 0.2
      });
    }
    var start = performance.now();
    function loop(now) {
      var t = now - start;
      ctx.clearRect(0, 0, w, h);
      for (var i = 0; i < confs.length; i++) {
        var c = confs[i];
        c.y += c.vy;
        c.x += c.vx;
        c.rot += c.vr;
        if (c.y > h + 20) {
          c.y = -20;
          c.x = Math.random() * w;
        }
        ctx.save();
        ctx.translate(c.x, c.y);
        ctx.rotate(c.rot);
        ctx.fillStyle = 'hsla(' + (260 + Math.random() * 40) + ',70%,70%,0.9)';
        ctx.fillRect(-c.size / 2, -c.size / 2, c.size, c.size);
        ctx.restore();
      }
      if (t < 2500) {
        requestAnimationFrame(loop);
      } else {
        ctx.clearRect(0, 0, w, h);
      }
    }
    requestAnimationFrame(loop);
  }

  function calc() {
    var birthStr  = document.getElementById('birth').value;
    var targetStr = document.getElementById('targetDate').value;

    if (!birthStr) {
      alert('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (typeof Astronomy === 'undefined') {
      alert('Astronomy Engine ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    var birthDate = parseDateInput(birthStr);
    if (!birthDate) {
      alert('ç”Ÿå¹´æœˆæ—¥ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    var now = new Date();
    var targetDate = parseDateInput(targetStr);
    if (!targetDate) {
      targetDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0);
    }

    var Sun  = Astronomy.Body.Sun;
    var Moon = Astronomy.Body.Moon;
    var Merc = Astronomy.Body.Mercury;
    var Ven  = Astronomy.Body.Venus;
    var Mars = Astronomy.Body.Mars;
    var Jup  = Astronomy.Body.Jupiter;
    var Sat  = Astronomy.Body.Saturn;

    var bodies = [Sun, Moon, Merc, Ven, Mars, Jup, Sat];

    var nat = {};
    var cur = {};
    for (var i = 0; i < bodies.length; i++) {
      var b = bodies[i];
      nat[b] = eclLon(b, birthDate);
      cur[b] = eclLon(b, targetDate);
    }

    function diffLon(body) {
      var d = cur[body] - nat[body];
      d = d % 360;
      if (d < 0) d += 360;
      return d;
    }

    function A(body) {
      return aspectScore(diffLon(body));
    }

    var rawBgTotal =
      A(Jup) + A(Sat) + 0.6 * A(Sun);
    var rawDailyTotal =
      0.7 * A(Sun) + 1.0 * A(Moon) +
      0.5 * A(Merc) + 0.5 * A(Ven) +
      0.6 * A(Mars);

    var nBgTotal    = clampNorm(rawBgTotal    * 0.35);
    var nDailyTotal = clampNorm(rawDailyTotal * 0.45);
    nBgTotal = softenBackground(nBgTotal, 0.4);

    var nTotal = clampNorm(nBgTotal * 0.4 + nDailyTotal * 0.6);

    var rawLoveFast =
      1.2 * A(Ven) + 1.0 * A(Moon) + 0.5 * A(Merc);
    var rawLoveBg =
      0.6 * A(Jup);

    var nLoveFast = clampNorm(rawLoveFast * 0.45);
    var nLoveBg   = clampNorm(rawLoveBg   * 0.40);
    nLoveBg = softenBackground(nLoveBg, 0.5);

    var nLove = clampNorm(nLoveFast * 0.7 + nLoveBg * 0.3);

    var rawMoneyFast =
      0.7 * A(Ven) + 0.4 * A(Mars);
    var rawMoneyBg =
      1.0 * A(Jup) + 0.5 * A(Sat);

    var nMoneyFast = clampNorm(rawMoneyFast * 0.40);
    var nMoneyBg   = clampNorm(rawMoneyBg   * 0.35);
    nMoneyBg = softenBackground(nMoneyBg, 0.5);

    var nMoney = clampNorm(nMoneyFast * 0.4 + nMoneyBg * 0.6);

    var rawWorkFast =
      1.0 * A(Mars) + 0.5 * A(Merc) + 0.5 * A(Sun);
    var rawWorkBg =
      1.0 * A(Sat);

    var nWorkFast = clampNorm(rawWorkFast * 0.40);
    var nWorkBg   = clampNorm(rawWorkBg   * 0.35);
    nWorkBg = softenBackground(nWorkBg, 0.5);

    var nWork = clampNorm(nWorkFast * 0.5 + nWorkBg * 0.5);

    var rawHealthFast =
      0.8 * A(Moon) + 0.6 * A(Sun);
    var rawHealthBg =
      0.4 * A(Jup);

    var nHealthFast = clampNorm(rawHealthFast * 0.45);
    var nHealthBg   = clampNorm(rawHealthBg   * 0.35);
    nHealthBg = softenBackground(nHealthBg, 0.5);

    var nHealth = clampNorm(nHealthFast * 0.7 + nHealthBg * 0.3);

    var total  = mapNormToPercent(nTotal,  30, 95);
    var love   = mapNormToPercent(nLove,   25, 95);
    var money  = mapNormToPercent(nMoney,  25, 95);
    var work   = mapNormToPercent(nWork,   25, 95);
    var health = mapNormToPercent(nHealth, 25, 95);

    var seedBase = birthStr + '|' +
      (targetStr || (targetDate.getFullYear() + '-' +
                     (targetDate.getMonth() + 1) + '-' +
                     targetDate.getDate()));

    var overallText = pickText('total',  total,  seedBase);
    var loveText    = pickText('love',   love,   seedBase);
    var moneyText   = pickText('money',  money,  seedBase);
    var workText    = pickText('work',   work,   seedBase);
    var healthText  = pickText('health', health, seedBase);
    var seasonText  = seasonPhrase(targetDate, seedBase);

    var html = '';

    html += '<div class="section-title">' +
              '<span class="icon">ğŸª</span>' +
              '<span class="label">ä»Šæ—¥ã®ç·åˆé‹</span>' +
              '<span class="percent">' + total + '%</span>' +
            '</div>';
    var totalText = overallText;
    if (seasonText) {
      totalText += ' ' + seasonText;
    }
    html += '<div class="text-block">' + totalText + '</div>';

    html += '<div class="section-title">' +
              '<span class="icon">ğŸ’</span>' +
              '<span class="label">æ‹æ„›</span>' +
              '<span class="percent">' + love + '%</span>' +
            '</div>';
    html += '<div class="text-block">' + loveText + '</div>';

    html += '<div class="section-title">' +
              '<span class="icon">ğŸ’¼</span>' +
              '<span class="label">ä»•äº‹</span>' +
              '<span class="percent">' + work + '%</span>' +
            '</div>';
    html += '<div class="text-block">' + workText + '</div>';

    html += '<div class="section-title">' +
              '<span class="icon">ğŸ’°</span>' +
              '<span class="label">é‡‘é‹</span>' +
              '<span class="percent">' + money + '%</span>' +
            '</div>';
    html += '<div class="text-block">' + moneyText + '</div>';

    html += '<div class="section-title">' +
              '<span class="icon">ğŸ’—</span>' +
              '<span class="label">å¥åº·</span>' +
              '<span class="percent">' + health + '%</span>' +
            '</div>';
    html += '<div class="text-block">' + healthText + '</div>';

    document.getElementById('result').innerHTML = html;

    // çµæœãŒå‡ºãŸã®ã§ã€Œçµæœã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    var saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.style.display = 'block';
    }

    var birthdayEl = document.getElementById('birthdayMessage');
    birthdayEl.textContent = '';

    var now2 = new Date();
    var todayY = now2.getFullYear();
    var todayM = now2.getMonth();
    var todayD = now2.getDate();

    var isTodayTarget =
      targetDate.getFullYear() === todayY &&
      targetDate.getMonth() === todayM &&
      targetDate.getDate() === todayD;

    var isTodayBirthday =
      birthDate.getMonth() === todayM &&
      birthDate.getDate() === todayD;

    if (isTodayTarget && isTodayBirthday) {
      birthdayEl.textContent =
        'ğŸ‚ ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»Šæ—¥ã®ã‚ãªãŸã«ã€ã‚„ã•ã—ã„æµã‚ŒãŒã‚ã‚Šã¾ã™ã‚ˆã†ã«ã€‚';
      fireConfetti();
    }
  }

  // çµæœã‚«ãƒ¼ãƒ‰ã‚’ JPEG ã¨ã—ã¦ä¿å­˜
  function saveResultImage() {
    var result = document.getElementById('result');
    if (!result || !result.innerHTML.trim()) {
      alert('ã¾ãšã€Œã“ã®æ—¥ã®é‹å‹¢ã‚’è¦‹ã‚‹ã€ã§çµæœã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    if (typeof html2canvas === 'undefined') {
      alert('ä¿å­˜ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    var card = document.getElementById('cardRoot');
    var birthStr  = document.getElementById('birth').value || 'birth';
    var targetStr = document.getElementById('targetDate').value;

    var fileDate = targetStr || 'today';
    var fileBirth = birthStr.replace(/-/g, '');
    var filename = 'horoscope_' + fileDate.replace(/-/g, '') + '_' + fileBirth + '.jpg';

    html2canvas(card, {
      backgroundColor: '#ffffff',
      scale: window.devicePixelRatio > 1 ? 2 : 1
    }).then(function (canvas) {
      var link = document.createElement('a');
      link.href = canvas.toDataURL('image/jpeg', 0.92);
      link.download = filename;
      link.click();
    });
  }

  window.calc = calc;
  window.saveResultImage = saveResultImage;
})();
</script>
</body>
</html>
