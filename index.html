<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>100% æ˜Ÿå ã„</title>
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="./icon-192.png">
<meta name="theme-color" content="#6b46c1">
<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: #fafafa;
  color: #222;
  margin: 0;
  padding: 0;
  text-align: center;
}
header {
  background: #6b46c1;
  color: #fff;
  padding: 1.2em 0;
  font-size: 1.4em;
  font-weight: 700;
}
main {
  padding: 1.2em;
  max-width: 720px;
  margin: 0 auto;
}
input, select, button {
  font-family: inherit;
  font-size: 1em;
  padding: .6em;
  border-radius: .5em;
  border: 1px solid #ccc;
  width: 100%;
  box-sizing: border-box;
}
button {
  background: #6b46c1;
  color: #fff;
  border: none;
  cursor: pointer;
}
button:hover { opacity: 0.9; }
.card {
  background: #fff;
  border-radius: 1em;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 1.2em;
  margin-top: 1.5em;
  text-align: left;
}
.muted { color:#666; font-size:0.9em; }
.chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;}
.chip {
  background:#eee; border-radius:999px; padding:3px 10px;
  font-size:0.85em; color:#555;
}
.bar { height:8px; background:#ddd; border-radius:4px; overflow:hidden; }
.bar-fill { height:100%; background:#6b46c1; }
.toast {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  background:#333; color:#fff; padding:10px 20px; border-radius:999px;
  opacity:0; transition:opacity .3s;
}
.toast.show { opacity:1; }
</style>
</head>
<body>
<header>100% æ˜Ÿå ã„</header>
<main>
  <section id="inputArea">
    <h2>ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›</h2>
    <label>ç”Ÿå¹´æœˆæ—¥</label>
    <input type="date" id="birthDate"><br><br>
    <label>éƒ½å¸‚å</label>
    <input type="text" id="placeName" placeholder="Tokyo"><br><br>
    <button id="geoBtn">éƒ½å¸‚åã‹ã‚‰å–å¾—</button><br><br>
    <label>ç·¯åº¦</label>
    <input type="text" id="lat" placeholder="ä¾‹: 35.6895"><br><br>
    <label>çµŒåº¦</label>
    <input type="text" id="lon" placeholder="ä¾‹: 139.6917"><br><br>
    <button id="runBtn">çµæœã‚’è¦‹ã‚‹</button>
  </section>

  <section id="outputArea" style="display:none;">
    <h2>çµæœ</h2>
    <div id="resultContainer"></div>
    <button id="saveBtn">JPEGä¿å­˜</button>
    <button id="backBtn">æˆ»ã‚‹</button>
  </section>
</main>
<div class="toast" id="toast"></div>
<script>

/***** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ *****/
function $(id){ return document.getElementById(id); }
function log(...a){ try{ console.log(...a); }catch(_){ } }
function toast(msg){
  const el=$('toast'); el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),1500);
}
function setStatus(msg){ /* å°†æ¥ç”¨ï¼šUIã«çŠ¶æ…‹è¡¨ç¤ºã—ãŸã„å ´åˆã“ã“ã§ */ }
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

/***** å…¥åŠ›ä¿å­˜ï¼ˆlocalStorageï¼‰ *****/
function saveInputs(){
  const data={
    birthDate: $('birthDate').value || '',
    placeName: $('placeName').value || '',
    lat: $('lat').value || '',
    lon: $('lon').value || ''
  };
  localStorage.setItem('horo.inputs', JSON.stringify(data));
}
function loadInputs(){
  try{
    const data=JSON.parse(localStorage.getItem('horo.inputs')||'{}');
    if(data.birthDate) $('birthDate').value=data.birthDate;
    if(data.placeName) $('placeName').value=data.placeName;
    if(data.lat) $('lat').value=data.lat;
    if(data.lon) $('lon').value=data.lon;
  }catch(e){}
}

/***** å­£ç¯€ãƒˆãƒ¼ãƒ³ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ»è‡ªç„¶ï¼‰ *****/
function seasonToneByMonth(m){
  if([12,1,2].includes(m)) return 'é™ã‹ãªå†¬ã€è¶³å…ƒã‚’å›ºã‚ã‚‹ã¨ã';
  if([3,4,5].includes(m))  return 'èŠ½å¹ãæ˜¥ã€å‹•ãå‡ºã—ã«è¿½ã„é¢¨';
  if([6,7,8].includes(m))  return 'è¼ãå¤ã€å‹¢ã„ã¨ç™ºä¿¡ãŒåŠ¹ã';
  if([9,10,11].includes(m))return 'å®Ÿã‚Šã®ç§‹ã€ä»•ä¸Šã’ã¨æ•´ãˆãŒå‰';
  return 'å­£ç¯€ã®ãƒªã‚ºãƒ ã«ä¹—ã‚‹ã¨è‰¯ã„æ—¥';
}

/***** éƒ½å¸‚ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆTokyoå›ºå®šã»ã‹ï¼‰ *****/
const CITY_PRESETS = [
  {name:'æ±äº¬',   lat:'35.6895', lon:'139.6917', aliases:['tokyo','tokyo japan','æ±äº¬','ã¨ã†ãã‚‡ã†']},
  {name:'å¤§é˜ª',   lat:'34.6937', lon:'135.5023', aliases:['osaka','å¤§é˜ª']},
  {name:'æœ­å¹Œ',   lat:'43.0621', lon:'141.3544', aliases:['sapporo','æœ­å¹Œ']},
  {name:'ç¦å²¡',   lat:'33.5902', lon:'130.4017', aliases:['fukuoka','ç¦å²¡']},
  {name:'åå¤å±‹', lat:'35.1815', lon:'136.9066', aliases:['nagoya','åå¤å±‹']},
  {name:'æ¨ªæµœ',   lat:'35.4437', lon:'139.6380', aliases:['yokohama','æ¨ªæµœ']},
];

/***** ãƒ—ãƒªã‚»ãƒƒãƒˆå¸ç€ï¼ˆå¼·åŒ–ç‰ˆï¼‰ *****/
function snapToPresetIfAlias(q){
  if(!q) return null;
  let s=String(q).toLowerCase().trim();
  s=s.replace(/[.,]/g,' ').replace(/\s+/g,' ');
  s=s.replace(/\s+(city|prefecture|metropolis)$/,'').replace(/\s+japan$/,'').trim();
  for(const c of CITY_PRESETS){
    for(const a of c.aliases){
      const al=a.toLowerCase();
      if(s===al || s.includes(al)) return {lat:c.lat, lon:c.lon};
    }
  }
  return null;
}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function snapNearPreset(lat,lon,km=30){
  let best=null,bestD=1e9;
  for(const c of CITY_PRESETS){
    const d=haversine(+lat,+lon,+c.lat,+c.lon);
    if(d<bestD){bestD=d;best=c;}
  }
  return (bestD<=km)?{lat:best.lat,lon:best.lon}:null;
}

/***** ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼†å­£ç¯€ï¼ˆGNewsâ†’NHK RSSï¼‰ *****/
const GNEWS_API_KEY = "0e21cddc975f5f620c1431fde88db5fe"; // ãã®ã¾ã¾ä½¿ãˆã¾ã™

async function fetchNewsTopJP(){
  // 1) GNews
  try{
    const url=`https://gnews.io/api/v4/top-headlines?lang=ja&country=jp&max=3&category=general&apikey=${GNEWS_API_KEY}`;
    const res=await fetch(url,{headers:{'Accept':'application/json'},cache:'no-store'});
    if(!res.ok) throw new Error('GNews HTTP '+res.status);
    const data=await res.json();
    const titles=(data?.articles||[]).map(a=>a?.title).filter(Boolean).slice(0,2);
    if(titles.length) return titles;
  }catch(e){ log('GNewså–å¾—å¤±æ•—:',e); }
  // 2) NHK RSS (XMLç›´fetch)
  try{
    const rss='https://www3.nhk.or.jp/rss/news/cat0.xml';
    const r=await fetch(rss,{cache:'no-store'});
    if(!r.ok) throw new Error('NHK RSS HTTP '+r.status);
    const t=await r.text();
    const doc=new DOMParser().parseFromString(t,'application/xml');
    const titles=Array.from(doc.querySelectorAll('item > title')).map(n=>(n.textContent||'').trim()).filter(Boolean);
    return titles.slice(0,2);
  }catch(e){ log('RSSå–å¾—å¤±æ•—:',e); return []; }
}
function escapeHtmlInline(s){
  return String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
}
async function fetchNewsAndSeasonContext(dateStr){
  const d=new Date(dateStr+"T12:00:00");
  const season=seasonToneByMonth(d.getMonth()+1);
  const news=await fetchNewsTopJP();
  let line=`ä»Šæ—¥ã®ç©ºæ°—æ„Ÿï¼š${season}ã€‚`; // â† å­£ç¯€ã¯å¸¸æ™‚è¡¨ç¤º
  if(news.length){
    const safe=news.map(escapeHtmlInline);
    line+=`<br><span class="muted">ğŸ—ï¸ æœ€è¿‘ã®è©±é¡Œï¼š${safe.join(' ï¼ ')}ã€‚</span>`;
  }
  return line;
}

/***** ãƒ†ãƒ³ãƒ—ãƒ¬æœ€å°ï¼ˆé‡è¤‡å›é¿ã®ãŸã‚IDã‚’ç”Ÿæˆï¼‰ *****/
const TPL = {
  å…¨ä½“é‹: [
    'è‚©ã®åŠ›ã‚’æŠœãã»ã©æµã‚ŒãŒæ•´ã†æ—¥ã€‚å°ã•ãªæ”¹å–„ãŒå¤§ããªå‰é€²ã«ã€‚',
    'æ—©ã‚ã®ç€æ‰‹ãŒå¥½æ©Ÿã‚’å‘¼ã¶ã€‚åˆå‰ä¸­ã®ä¸€æ­©ãŒåˆå¾Œã‚’å¤‰ãˆã‚‹ã€‚',
    'å‘¨å›²ã®å£°ã«ãƒ’ãƒ³ãƒˆã‚ã‚Šã€‚ã¾ãšè´ãã€æ¬¡ã«å‹•ãã€‚'
  ],
  æ‹æ„›: [
    'æŒ¨æ‹¶ï¼‹ä¸€è¨€ã§è·é›¢ãŒç¸®ã‚€ã€‚é€£çµ¡ã¯çŸ­ãæ˜ã‚‹ãã€‚',
    'äºˆå®šã®å…±æœ‰ãŒå‰ã€‚ç›¸æ‰‹ã®éƒ½åˆã‚’å…ˆã«èã„ã¦ã€‚'
  ],
  ä»•äº‹: [
    '5åˆ†ã§ç²—æ¡ˆâ†’15åˆ†ã§å©ãå°ã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒè©•ä¾¡ã«ç›´çµã€‚',
    'ç¢ºèªã¯äºŒæ®µæ§‹ãˆã§ã€‚ä¾é ¼â†’å¾©å”±â†’åˆæ„ã®é †ãŒå®‰å…¨ã€‚'
  ],
  é‡‘é‹: [
    'å›ºå®šè²»ã®è¦‹ç›´ã—æ—¥ã€‚ã‚µãƒ–ã‚¹ã‚¯ã‚’ä¸€ä»¶ã ã‘æ•´ç†ã€‚',
    'ãƒã‚¤ãƒ³ãƒˆå¤±åŠ¹ã®ç¢ºèªã§å¾—ã€‚å°ã•ãªç©ã¿ä¸Šã’ãŒåŠ¹ãã€‚'
  ],
  å¥åº·: [
    'å§¿å‹¢ãƒªã‚»ãƒƒãƒˆã§é›†ä¸­åŠ›UPã€‚æ·±å‘¼å¸Ã—3å›ã‚’ç¿’æ…£ã«ã€‚',
    'ç™½æ¹¯ã‹å¸¸æ¸©æ°´ã‚’å°‘é‡ã“ã¾ã‚ã«ã€‚'
  ]
};
function pickUnique(arr, seed){
  // seedã§æ“¬ä¼¼ä¹±æ•°ï¼ˆå½“æ—¥å›ºå®šï¼‰
  const x=Math.abs(Math.sin(seed))*10000;
  const i=Math.floor(x)%arr.length;
  return arr[i];
}
function usedKey(dateStr, topic, text){
  return `${dateStr}|${topic}|${text}`;
}
function isUsed(key){
  const set=new Set(JSON.parse(localStorage.getItem('horo.used')||'[]'));
  return set.has(key);
}
function markUsed(key){
  const arr=JSON.parse(localStorage.getItem('horo.used')||'[]');
  arr.push(key); if(arr.length>400) arr.shift(); // 120æ—¥ç›¸å½“ã‚’æƒ³å®š
  localStorage.setItem('horo.used', JSON.stringify(arr));
}

/***** éƒ½å¸‚åâ†’ç·¯åº¦çµŒåº¦ *****/
async function onGeocodeClick(){
  const q=($('placeName').value||'').trim();
  if(!q){ alert('éƒ½å¸‚åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

  // 1) Tokyoãªã©ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è‡´
  const alias=snapToPresetIfAlias(q);
  if(alias){
    $('lat').value=alias.lat;
    $('lon').value=alias.lon;
    saveInputs();
    toast(`${q} ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆåº§æ¨™ã«å›ºå®šã—ã¾ã—ãŸ`);
    log(`Preset snap â†’ lat=${alias.lat}, lon=${alias.lon}`);
    return;
  }

  // 2) é€šå¸¸ã‚¸ã‚ªã‚³ãƒ¼ãƒ‰â†’è¿‘å‚å¸ç€
  try{
    toast('ä½ç½®æ¤œç´¢ä¸­â€¦');
    const url='https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();
    if(!data||!data.length){ alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); return; }
    let lat=String(data[0].lat), lon=String(data[0].lon);
    const near=snapNearPreset(lat,lon,30);
    if(near){ lat=near.lat; lon=near.lon; log('è¿‘å‚ã‚¹ãƒŠãƒƒãƒ—é©ç”¨'); }
    $('lat').value=lat; $('lon').value=lon;
    saveInputs();
    toast('åº§æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸ');
  }catch(e){
    alert('ä½ç½®å–å¾—ã«å¤±æ•—: '+(e.message||e));
  }
}

/***** å ã„çµæœç”Ÿæˆ *****/
async function runHoroscope(){
  saveInputs();
  const birth=$('birthDate').value;
  if(!birth){ alert('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
  const lat=parseFloat($('lat').value);
  const lon=parseFloat($('lon').value);
  if(isNaN(lat)||isNaN(lon)){ alert('ç·¯åº¦çµŒåº¦ãŒç„¡åŠ¹ã§ã™ã€‚'); return; }

  const dateStr=new Date().toISOString().split('T')[0];
  const ctx={};
  ctx.seasonNews=await fetchNewsAndSeasonContext(dateStr);

  const topics=['å…¨ä½“é‹','æ‹æ„›','ä»•äº‹','é‡‘é‹','å¥åº·'];
  const seedNum=new Date(dateStr).getDate()+lat+lon;
  let html=`<div class="muted">${ctx.seasonNews}</div>`;

  for(const t of topics){
    const pick=pickUnique(TPL[t],seedNum*(t.length+1));
    const key=usedKey(dateStr,t,pick);
    if(isUsed(key)) continue;
    markUsed(key);
    html+=`
      <div class="card">
        <strong>${t}</strong><br>
        ${escapeHtml(pick)}
      </div>`;
  }

  // èª•ç”Ÿæ—¥è£œæ­£
  const today=new Date();
  const bd=new Date(birth);
  if(bd.getMonth()===today.getMonth() && bd.getDate()===today.getDate()){
    html+=`<div class="card"><strong>ğŸ‚ ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</strong><br>ã‚¹ã‚³ã‚¢+5%ã®å¹¸é‹æ—¥ã€‚</div>`;
  }

  $('resultContainer').innerHTML=html;
  $('inputArea').style.display='none';
  $('outputArea').style.display='block';
}

/***** æˆ»ã‚‹ãƒœã‚¿ãƒ³ *****/
function backToInput(){
  $('outputArea').style.display='none';
  $('inputArea').style.display='block';
}

/***** JPEGä¿å­˜ï¼ˆhtml2canvasã‚’å‹•çš„ãƒ­ãƒ¼ãƒ‰ï¼‰ *****/
let _h2cReady = null;
function loadHtml2Canvas(){
  if(_h2cReady) return _h2cReady;
  _h2cReady = new Promise((resolve, reject)=>{
    const s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
    s.onload=()=>resolve();
    s.onerror=()=>reject(new Error('html2canvas load error'));
    document.head.appendChild(s);
  });
  return _h2cReady;
}
async function saveAsJPEG(){
  try{
    await loadHtml2Canvas();
    const target=$('resultContainer');
    const canvas=await html2canvas(target,{backgroundColor:'#ffffff',scale:2});
    const url=canvas.toDataURL('image/jpeg',0.92);
    const a=document.createElement('a');
    a.href=url; a.download='horoscope.jpg'; a.click();
    toast('JPEGã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  }catch(e){
    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: '+(e.message||e));
  }
}

/***** åˆæœŸåŒ–ï¼†ã‚¤ãƒ™ãƒ³ãƒˆ *****/
function init(){
  loadInputs();
  $('geoBtn').addEventListener('click', onGeocodeClick);
  $('runBtn').addEventListener('click', runHoroscope);
  $('backBtn').addEventListener('click', backToInput);
  $('saveBtn').addEventListener('click', saveAsJPEG);

  // ã‚­ãƒ¼Sã§ä¿å­˜
  window.addEventListener('keydown', (e)=>{
    if((e.key||'').toLowerCase()==='s' && $('outputArea').style.display==='block'){
      e.preventDefault();
      saveAsJPEG();
    }
  });

  // Service Workerï¼ˆv38ï¼‰
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js?v=38');
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
