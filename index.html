<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>æ˜Ÿå ã„ (æœ€çµ‚ç‰ˆ)</title>
<meta name="theme-color" content="#6b46c1">

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª</text></svg>">

<script src="https://cdnjs.cloudflare.com/ajax/libs/astronomy-engine/2.1.19/astronomy.browser.min.js"></script>

<style>
/* ã‚·ãƒ³ãƒ—ãƒ«ã§è¦‹ã‚„ã™ã„ã‚¹ã‚¿ã‚¤ãƒ« */
body{font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background:#fafafa; color:#333; margin:0; padding:20px; text-align:center;}
h1 { color: #6b46c1; margin-bottom: 20px; font-size: 1.5em; }
.card { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:20px; margin-bottom:20px; text-align:left; }
input, button { font-size:16px; padding:12px; width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #ddd; margin-bottom:10px; }
button { background:#6b46c1; color:#fff; font-weight:bold; border:none; cursor:pointer; }
button:active { opacity: 0.8; }
.result-row { display:flex; justify-content:space-between; align-items:center; padding: 10px 0; border-bottom: 1px solid #eee; }
.result-row:last-child { border-bottom: none; }
.planet-name { font-weight: bold; font-size: 1.1em; }
.planet-sign { background: #f3e8ff; color: #6b46c1; padding: 4px 10px; border-radius: 20px; font-weight:bold; }
.debug-msg { font-size: 0.8em; color: red; margin-top: 5px; }
#status { margin-bottom: 20px; font-size: 0.9em; color: #666; }
</style>
</head>
<body>

<h1>ğŸª å¤©ä½“ä½ç½®è¨ˆç®— (æ•‘æ¸ˆç‰ˆ)</h1>

<div id="status">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­...</div>

<div class="card">
    <label>ç”Ÿå¹´æœˆæ—¥:</label>
    <input type="date" id="birthDate">
    <input type="time" id="birthTime" value="12:00">
    <button onclick="calculate()">è¨ˆç®—å®Ÿè¡Œ</button>
</div>

<div id="resultArea" class="card" style="display:none;">
    <div id="luckyResult" style="text-align:center; margin-bottom:15px; padding:10px; background:#fffbe6; border-radius:8px;"></div>
    <div id="planetList"></div>
</div>

<script>
// å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶çš„ã«å‰Šé™¤ã™ã‚‹å‡¦ç†
if(window.navigator && navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations()
    .then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister();
        }
    });
}

// è¦ç´ å–å¾—
const $ = id => document.getElementById(id);
const STATUS = $('status');

// æ˜Ÿåº§å®šç¾©
const SIGNS = ['â™ˆ ç‰¡ç¾Šåº§', 'â™‰ ç‰¡ç‰›åº§', 'â™Š åŒå­åº§', 'â™‹ èŸ¹åº§', 'â™Œ ç…å­åº§', 'â™ ä¹™å¥³åº§', 'â™ å¤©ç§¤åº§', 'â™ è åº§', 'â™ å°„æ‰‹åº§', 'â™‘ å±±ç¾Šåº§', 'â™’ æ°´ç“¶åº§', 'â™“ é­šåº§'];
const PLANETS = [
    {key: 'Sun', label: 'å¤ªé™½'}, {key: 'Moon', label: 'æœˆ'}, 
    {key: 'Mercury', label: 'æ°´æ˜Ÿ'}, {key: 'Venus', label: 'é‡‘æ˜Ÿ'}, 
    {key: 'Mars', label: 'ç«æ˜Ÿ'}, {key: 'Jupiter', label: 'æœ¨æ˜Ÿ'}, 
    {key: 'Saturn', label: 'åœŸæ˜Ÿ'}
];

// åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
window.onload = function() {
    // æ—¥ä»˜ã®åˆæœŸå€¤ã‚’è¨­å®š
    const today = new Date().toISOString().split('T')[0];
    if(!$('birthDate').value) $('birthDate').value = '2000-01-01'; // ãƒ†ã‚¹ãƒˆç”¨åˆæœŸå€¤

    setTimeout(() => {
        if (typeof Astronomy === 'undefined') {
            STATUS.innerHTML = '<span style="color:red">âš ï¸ ã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿å¤±æ•—ã€‚<br>ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</span>';
        } else {
            STATUS.innerHTML = 'âœ… è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³æ­£å¸¸å‹•ä½œä¸­';
            STATUS.style.color = 'green';
        }
    }, 1000);
};

// å®‰å…¨ãªæ—¥ä»˜ç”Ÿæˆ
function getSafeDate() {
    const dStr = $('birthDate').value;
    const tStr = $('birthTime').value || '12:00';
    if(!dStr) return null;
    
    const [y, m, d] = dStr.split('-').map(Number);
    const [h, min] = tStr.split(':').map(Number);
    return new Date(y, m - 1, d, h, min, 0);
}

// è¨ˆç®—å®Ÿè¡Œ
function calculate() {
    const date = getSafeDate();
    if(!date || isNaN(date.getTime())) {
        alert("æ—¥ä»˜ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    if (typeof Astronomy === 'undefined') {
        alert("è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
    }

    let html = '';
    let jupiterLon = 0;

    // æƒ‘æ˜Ÿè¨ˆç®—ãƒ«ãƒ¼ãƒ—
    PLANETS.forEach(p => {
        let lon = 0;
        let errorMsg = '';

        try {
            // â˜…æœ€é‡è¦: ã‚·ãƒ³ãƒ—ãƒ«ãªå‘¼ã³å‡ºã—ã«å¤‰æ›´ (StringæŒ‡å®š)
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã‚’ã‚ãˆã¦ç„¡ãã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã«ä»»ã›ã‚‹
            const vector = Astronomy.GeoVector(p.key, date);
            
            if(!vector) throw new Error("Vector is null");
            
            const ecliptic = Astronomy.Ecliptic(vector);
            lon = ecliptic.lon;

            if(p.key === 'Jupiter') jupiterLon = lon;

        } catch(e) {
            console.error(e);
            errorMsg = e.message;
        }

        const signIndex = Math.floor(lon / 30) % 12;
        const degree = (lon % 30).toFixed(1);
        const signName = SIGNS[signIndex];

        html += `
        <div class="result-row">
            <div class="planet-name">${p.label}</div>
            <div style="text-align:right;">
                <div class="planet-sign">${signName} ${degree}Â°</div>
                ${errorMsg ? `<div class="debug-msg">Err: ${errorMsg}</div>` : ''}
            </div>
        </div>`;
    });

    // çµæœè¡¨ç¤º
    $('planetList').innerHTML = html;
    
    // æœ¨æ˜Ÿé‹å‹¢ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    // ä»Šæ—¥ã®æœ¨æ˜Ÿä½ç½®ï¼ˆæ¦‚ç®—ï¼‰ã¨ã®æ¯”è¼ƒ
    const todayVec = Astronomy.GeoVector('Jupiter', new Date());
    const todayLon = Astronomy.Ecliptic(todayVec).lon;
    let diff = Math.abs(todayLon - jupiterLon);
    if(diff > 180) diff = 360 - diff;
    
    let luckMsg = "æœ¨æ˜Ÿã¯é€šå¸¸é‹è¡Œä¸­ã§ã™";
    if(diff < 10) luckMsg = "âœ¨ 12å¹´ã«ä¸€åº¦ã®å¹¸é‹æœŸã§ã™ï¼";
    else if(Math.abs(diff - 120) < 10) luckMsg = "ğŸŒˆ å¹¸é‹ã®è¿½ã„é¢¨ãŒå¹ã„ã¦ã„ã¾ã™";

    $('luckyResult').innerHTML = `<strong>${luckMsg}</strong><br><small>ç¾åœ¨ã®æœ¨æ˜Ÿã¨ã®è§’åº¦: ${diff.toFixed(0)}åº¦</small>`;
    
    $('resultArea').style.display = 'block';
}
</script>

</body>
</html>