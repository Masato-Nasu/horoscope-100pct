<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>100% ÊòüÂç†„ÅÑ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#B79DF2">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif;
      background: #ffffff;
      color: #333333;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
      text-align: center;
      box-sizing: border-box;
    }
    .app-card {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      padding: 18px 16px 20px;
      box-sizing: border-box;
    }
    .app-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .app-icon {
      font-size: 28px;
    }
    .app-title-block {
      text-align: left;
    }
    .app-title {
      font-size: 16px;
      font-weight: 600;
      color: #7C4DFF;
      margin: 0;
    }

    .form-row {
      margin-bottom: 10px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      color: #555555;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #DDDDFF;
      font-size: 13px;
      font-family: inherit;
    }
    input:focus {
      outline: none;
      border-color: #B79DF2;
      box-shadow: 0 0 0 1px rgba(183,157,242,0.5);
    }
    button {
      width: 100%;
      box-sizing: border-box;
      border: none;
      padding: 11px 12px;
      border-radius: 12px;
      margin-top: 14px;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #B79DF2, #7C4DFF);
      color: #ffffff;
      cursor: pointer;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2) inset;
    }
    /* ‰∏ã„ÅÆ„ÄåÁµêÊûú„Çí‰øùÂ≠ò„Äç„Éú„Çø„É≥Áî®Ôºà„Çª„Ç´„É≥„ÉÄ„É™Ôºâ */
    .secondary-button {
      margin-top: 18px;
      background: #ffffff;
      color: #7C4DFF;
      border: 1px solid #D4C4FF;
      box-shadow: none;
    }
    .secondary-button:active {
      box-shadow: 0 0 0 1px rgba(183,157,242,0.4) inset;
      transform: translateY(0);
    }

    .result {
      margin-top: 16px;
      text-align: left;
    }
    .section-title {
      margin: 18px 0 4px;
      font-size: 14px;
      font-weight: 600;
      color: #7C4DFF;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title span.icon {
      font-size: 18px;
    }
    .section-title span.label {
      flex: 1;
    }
    .section-title span.percent {
      font-size: 13px;
      color: #555555;
    }
    .text-block {
      font-size: 12px;
      color: #555555;
      line-height: 1.7;
      padding: 8px 10px;
      border-radius: 14px;
      background: #F7F4FF;
      margin-bottom: 6px;
    }
    .birthday {
      margin-top: 12px;
      font-size: 12px;
      color: #C06FD8;
      text-align: left;
    }
    #confettiCanvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      .app-card {
        border-radius: 20px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.10);
      }
    }
  </style>

  <!-- Astronomy Engine -->
  <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
  <!-- ÁµêÊûú„ÇíÁîªÂÉèÂåñ„Åô„Çã„Åü„ÇÅ„ÅÆ„É©„Ç§„Éñ„É©„É™ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<canvas id="confettiCanvas"></canvas>

<div class="app-card" id="cardRoot">
  <div class="app-header">
    <div class="app-icon">ü™ê</div>
    <div class="app-title-block">
      <p class="app-title">100% ÊòüÂç†„ÅÑ</p>
    </div>
  </div>

  <div class="form-row">
    <label for="birth">ÁîüÂπ¥ÊúàÊó•</label>
    <input id="birth" type="date" value="1978-12-31">
  </div>

  <div class="form-row">
    <label for="targetDate">Âç†„ÅÑ„Åü„ÅÑÊó•ÔºàÁ©∫Ê¨Ñ„Å™„Çâ‰ªäÊó•Ôºâ</label>
    <input id="targetDate" type="date">
  </div>

  <button type="button" onclick="calc()">„Åì„ÅÆÊó•„ÅÆÈÅãÂã¢„ÇíË¶ã„Çã</button>

  <div id="result" class="result"></div>
  <div id="birthdayMessage" class="birthday"></div>

  <!-- ÂàùÊúüÁä∂ÊÖã„Åß„ÅØÈùûË°®Á§∫„ÄÅÁµêÊûú„ÅåÂá∫„Åü„ÇâË°®Á§∫„Åô„Çã -->
  <button
    type="button"
    id="saveBtn"
    class="secondary-button"
    style="display:none"
    onclick="saveResultImage()"
  >
    ÁµêÊûú„Çí‰øùÂ≠ò
  </button>
</div>

<script>
(function () {
  'use strict';

  // --- PWA: Service Worker ÁôªÈå≤ ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('sw.js')
        .then(function (reg) {
          console.log('ServiceWorker registered:', reg.scope);
        })
        .catch(function (err) {
          console.log('ServiceWorker registration failed:', err);
        });
    });
  }

  function stableSeed(str) {
    var h = 1779033703 ^ str.length;
    for (var i = 0; i < str.length; i++) {
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = (h << 13) | (h >>> 19);
    }
    h = (h ^ (h >>> 16)) >>> 0;
    return h;
  }

  function makeRng(seed) {
    var a = seed >>> 0;
    return function () {
      a |= 0;
      a = (a + 0x6D2B79F5) | 0;
      var t = Math.imul(a ^ (a >>> 15), 1 | a);
      t = t + Math.imul(t ^ (t >>> 7), 61 | t) ^ t;
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  var TEXT_BANK = {
    total: {
      a: [
        "ËøΩ„ÅÑÈ¢®„ÇíÊÑü„Åò„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„ÄÇ„ÇÑ„Çä„Åü„ÅÑ„Åì„Å®„Çí‰∏Ä„Å§„Å†„ÅëÊ±∫„ÇÅ„Å¶„ÄÅ„Åù„Åì„Å´ÊôÇÈñì„Çí‰Ωø„Å£„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Å°„Çá„Å£„Å®„Åó„ÅüË°åÂãï„Åå„ÄÅÊ¨°„ÅÆ„Åç„Å£„Åã„Åë„Å´„Å§„Å™„Åå„Å£„Å¶„ÅÑ„Åç„Åù„ÅÜ„Åß„Åô„ÄÇ",
        "ÂÖ®‰ΩìÁöÑ„Å´„Çπ„É†„Éº„Ç∫„Å´ÊµÅ„Çå„ÇÑ„Åô„ÅÑÊó•„ÄÇÂÆåÁíß„ÇíÁõÆÊåá„Åô„Çà„Çä„ÇÇ„ÄÅ„Äå‰ªäÊó•„ÅØ„Åì„Åì„Åæ„Åß„Åß„Åç„Çå„Å∞ÂçÅÂàÜ„Äç„Å®Ëá™ÂàÜ„Å´Ë®Ä„Å£„Å¶„ÅÇ„Åí„Çã„Å®„ÄÅÊ∞óÊåÅ„Å°„Çà„Åè‰∏ÄÊó•„ÇíÁµÇ„Åà„Çâ„Çå„Åù„ÅÜ„Åß„Åô„ÄÇ"
      ],
      b: [
        "Â§ß„Åç„Å™Â±±„ÅØ„Å™„Åè„Å¶„ÇÇ„ÄÅÊó•Â∏∏„ÇíÊï¥„Åà„ÇÑ„Åô„ÅÑÊó•„ÄÇ„Åô„Åπ„Å¶„Çí‰∏ÄÂ∫¶„Å´Â§â„Åà„Çà„ÅÜ„Å®„Åõ„Åö„ÄÅË∫´„ÅÆÂõû„Çä„ÅÆÂ∞è„Åï„Å™„Å®„Åì„Çç„Åã„ÇâÊï¥„Åà„Å¶„ÅÑ„Åè„Å®„ÄÅÂøÉ„ÇÇËêΩ„Å°ÁùÄ„ÅÑ„Å¶„Åç„Åæ„Åô„ÄÇ",
        "„ÅÑ„Å§„ÇÇÈÄö„Çä„ÅÆ‰∏ÄÊó•„ÅÆ‰∏≠„Å´„ÇÇ„ÄÅÂ∞è„Åï„Å™Ê•Ω„Åó„Åø„ÇíË¶ã„Å§„Åë„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„ÄÇÂ•Ω„Åç„Å™È£≤„ÅøÁâ©„ÇÑÈü≥Ê•Ω„Çí„Å≤„Å®„Å§Ë∂≥„Åó„Å¶„ÄÅËá™ÂàÜ„Å†„Åë„ÅÆ„Åî„Åª„ÅÜ„Å≥ÊôÇÈñì„Çí‰Ωú„Å£„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      ],
      c: [
        "Â∞ë„ÅóÊÖéÈáç„Åï„ÅåÂΩπ„Å´Á´ã„Å§Êó•„ÄÇÁÑ°ÁêÜ„Å´Á≠î„Åà„ÇíÂá∫„Åù„ÅÜ„Å®„Åõ„Åö„ÄÅ„Äå‰ªäÊó•„ÅØÊßòÂ≠ê„ÇíË¶ã„Çã„Äç„Å®Ê±∫„ÇÅ„Çã„Å†„Åë„Åß„ÇÇ„ÄÅÂøÉ„Å´‰ΩôÁôΩ„ÅåÁîü„Åæ„Çå„Åæ„Åô„ÄÇËá™ÂàÜ„ÇíË≤¨„ÇÅ„Åô„Åé„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„Å≠„ÄÇ",
        "ÊÄù„ÅÑÈÄö„Çä„Å´ÈÄ≤„Åæ„Å™„ÅÑÂ†¥Èù¢„ÇÇ„ÅÇ„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„Åå„ÄÅ„Åù„Çå„Åß„ÇÇÂ§ß‰∏àÂ§´„ÄÇ„Åß„Åç„Å™„Åã„Å£„Åü„Åì„Å®„Çà„Çä„ÄÅ‰ªäÊó•„Å°„ÇÉ„Çì„Å®„Åß„Åç„Åü„Åì„Å®„Çí‰∏Ä„Å§ÊÄù„ÅÑÂá∫„Åó„Å¶„ÄÅ„Åù„Å£„Å®Ëá™ÂàÜ„Çí„Å≠„Åé„Çâ„Å£„Å¶„ÅÇ„Åí„Åæ„Åó„Çá„ÅÜ„ÄÇ"
      ]
    },
    love: {
      a: [
        "‰∫∫„Å®„ÅÆË∑ùÈõ¢„ÅåÂøÉÂú∞„Çà„ÅèÁ∏Æ„Åæ„Çä„ÇÑ„Åô„ÅÑÊó•„ÄÇÊÅãÊÑõ„Å´Èôê„Çâ„Åö„ÄÅÁ¥†Áõ¥„Å™„Äå„ÅÇ„Çä„Åå„Å®„ÅÜ„Äç„ÇÑ„Äå„Åä„Å§„Åã„Çå„Åï„Åæ„Äç„Åå„ÄÅÈñ¢‰øÇ„Çí„ÅÇ„Åü„Åü„Åã„Åè„Åó„Å¶„Åè„Çå„Åù„ÅÜ„Åß„Åô„ÄÇ",
        "Ê∞ó„Å´„Å™„Çã‰∫∫„Å®„ÅÆ‰ºöË©±„ÅåÂºæ„Åø„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„ÄÇÂ§ß„Åç„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥„Çà„Çä„ÇÇ„ÄÅ„Å°„Çá„Å£„Å®„Åó„ÅüÊ∞óÈÅ£„ÅÑ„ÇÑ„Çπ„Çø„É≥„Éó„Å≤„Å®„Å§„Åå„ÄÅÁõ∏Êâã„ÅÆÂøÉ„Å´„ÇÑ„Åï„Åó„ÅèÂ±ä„Åç„Åù„ÅÜ„Åß„Åô„ÄÇ"
      ],
      b: [
        "Ë®ÄËëâ„ÅÆË°å„ÅçÈÅï„ÅÑ„Å´ÊïèÊÑü„Å´„Å™„Çä„ÇÑ„Åô„ÅÑÊó•„ÄÇÁõ∏Êâã„ÅÆ‰∏ÄË®Ä„ÇíÊ∑±Ë™≠„Åø„Åó„Åô„Åé„Åö„ÄÅ„Äå‰ªäÊó•„ÅØ„Åù„ÅÜ„ÅÑ„ÅÜÊó•„ÇÇ„ÅÇ„Çã„Äç„Å®Âèó„ÅëÊ≠¢„ÇÅ„Å¶„Åø„Çã„Å®„ÄÅÊ∞óÊåÅ„Å°„ÅåÂ∞ë„ÅóËªΩ„Åè„Å™„Çä„Åæ„Åô„ÄÇ",
        "ÈÅéÂéª„ÅÆÂá∫Êù•‰∫ã„Çí„Åµ„Å®ÊÄù„ÅÑÂá∫„Åó„ÇÑ„Åô„ÅÑ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ„ÅÜ„Åæ„Åè„ÅÑ„Åã„Å™„Åã„Å£„ÅüÁµåÈ®ì„ÇÇ„ÄÅ„Äå„ÅÇ„ÅÆÊôÇ„ÅÆËá™ÂàÜ„ÇÇ„Çà„Åè„Åå„Çì„Å∞„Å£„Å¶„ÅÑ„Åü„Äç„Å®Ë™ç„ÇÅ„Å¶„ÅÇ„Åí„Çã„Å®„ÄÅ‰ªä„ÅÆÊÅã„Å´„ÇÇ„ÇÑ„Åï„Åó„ÅèÂêë„ÅçÂêà„Åà„Åæ„Åô„ÄÇ"
      ],
      c: [
        "Ê∞óÊåÅ„Å°„ÅåÊè∫„Çå„ÇÑ„Åô„ÅÑÊó•„ÄÇÁÑ°ÁêÜ„Å´Êòé„Çã„ÅèÊåØ„ÇãËàû„ÅÜ„Çà„Çä„ÄÅ‰ø°È†º„Åß„Åç„Çã‰∫∫„Å®„ÅÆ„ÇÜ„Çã„ÅÑ‰ºöË©±„ÇÑ‰∏Ä‰∫∫ÊôÇÈñì„ÅßÂøÉ„ÇíËêΩ„Å°ÁùÄ„Åã„Åõ„Çã„Åª„ÅÜ„Åå„ÄÅÊÅã„ÅÆ„Éê„É©„É≥„Çπ„ÇÇÊï¥„ÅÑ„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô„ÄÇ",
        "Áõ∏Êâã„ÅÆ„Éö„Éº„Çπ„Å®Ëá™ÂàÜ„ÅÆ„Éö„Éº„Çπ„ÅÆÈÅï„ÅÑ„Çí„ÄÅÂ∞ë„ÅóÈáç„ÅèÊÑü„Åò„Å¶„Åó„Åæ„ÅÜ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇÁ≠î„Åà„ÇíÊÄ•„Åå„Åö„ÄÅ„Äå‰ªäÊó•„ÅØËá™ÂàÜ„ÅÆÂøÉ„ÅÆÂ£∞„Çí„Çà„ÅèËÅ¥„ÅèÊó•„Äç„Å®Ê±∫„ÇÅ„Å¶ÈÅé„Åî„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      ]
    },
    work: {
      a: [
        "ÈõÜ‰∏≠Âäõ„ÇíÁô∫ÊèÆ„Åó„ÇÑ„Åô„ÅÑÊó•„ÄÇÁü≠„ÅÑÊôÇÈñì„Åß„ÇÇ„Äå„Åì„Åì„Åæ„Åß„ÇÑ„Çã„Äç„Å®Ê±∫„ÇÅ„Å¶Âèñ„ÇäÁµÑ„ÇÄ„Å®„ÄÅÊâãÂøú„Åà„Å®ÈÅîÊàêÊÑü„ÅÆ‰∏°Êñπ„ÇíÂæó„Çâ„Çå„Åù„ÅÜ„Åß„Åô„ÄÇ",
        "ÂæóÊÑè„Å™‰ΩúÊ•≠„ÅßÂë®„Çä„ÇíÊîØ„Åà„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„ÄÇÁÑ°ÁêÜ„ÅÆ„Å™„ÅÑÁØÑÂõ≤„ÅßÊâã„ÇíÂ∑Æ„Åó‰º∏„Åπ„Çã„Å®„ÄÅ‰ø°È†ºÊÑü„Åå„Åê„Å£„Å®È´ò„Åæ„Çä„Åù„ÅÜ„Åß„Åô„ÄÇ"
      ],
      b: [
        "Ê∑°„ÄÖ„Å®Âèñ„ÇäÁµÑ„ÇÄ„Åì„Å®„Åß„ÄÅÊ∞ó„Å•„ÅÑ„Åü„ÇâÈÄ≤„Çì„Åß„ÅÑ„ÇãÊó•„ÄÇ‰ªï‰∫ãÂâç„Å´‰ªäÊó•„ÇÑ„Çã„Åì„Å®„Çí‰∏â„Å§„Å†„ÅëÊõ∏„ÅçÂá∫„Åô„Å®„ÄÅ„Çπ„É†„Éº„Ç∫„Å´Âãï„Åç„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô„ÄÇ",
        "„Äå„Åå„Çì„Å∞„Çã„Äç„Å®„Äå‰ºë„ÇÄ„Äç„ÅÆ„Éê„É©„É≥„Çπ„Çí„Å®„Çä„Åü„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„ÄÇÂêå„ÅòÂßøÂã¢„ÅåÁ∂ö„Åè„Å®„Åç„ÅØ„ÄÅËªΩ„ÅèÈ¶ñ„ÇÑËÇ©„ÇíÂõû„Åó„Å¶„É™„Çª„ÉÉ„Éà„Åó„Å¶„ÅÇ„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      ],
      c: [
        "ÈõÜ‰∏≠„Åó„Å´„Åè„Åï„ÇíÊÑü„Åò„Åü„Çâ„ÄÅ„ÅÑ„Å£„Åü„Çì„Çø„Çπ„ÇØ„ÇíÁ¥∞„Åã„ÅèÂå∫Âàá„Å£„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ„Äå„Åì„Åì„Åæ„Åß„Åß„Åç„Åü„Çâ‰ºëÊÜ©„Äç„Å®Â∞è„Åï„Å™„Ç¥„Éº„É´„Çí‰Ωú„Çã„Å®„ÄÅÊ∞óÊåÅ„Å°„ÅåÂ∞ë„ÅóÊ•Ω„Å´„Å™„Çä„Åæ„Åô„ÄÇ",
        "Âà§Êñ≠„Å´Ëø∑„ÅÜ„Åì„Å®„ÅåÂ¢ó„Åà„Åù„ÅÜ„Å™Êó•„ÄÇÂ§ß„Åç„Å™Ê±∫Êñ≠„ÅØÊòéÊó•‰ª•Èôç„Å´Âõû„Åó„ÄÅ‰ªäÊó•„ÅØÊÉÖÂ†±„ÇíÈõÜ„ÇÅ„ÇãÊó•„Å´„Åô„Çã„ÅÆ„ÇÇ‰∏Ä„Å§„ÅÆÈÅ∏Êäû„Åß„Åô„ÄÇ"
      ]
    },
    money: {
      a: [
        "„ÅäÈáë„Å®„ÅÆ‰ªò„ÅçÂêà„ÅÑÊñπ„ÇíÊï¥„Åà„ÇÑ„Åô„ÅÑÊó•„ÄÇ„É¨„Ç∑„Éº„Éà„ÇÑÊòéÁ¥∞„Çí„Åñ„Å£„Å®Áú∫„ÇÅ„Å¶„ÄÅÊ∞ó„Å´„Å™„ÇãÈ†ÖÁõÆ„Å´Âç∞„Çí„Å§„Åë„Çã„Å†„Åë„Åß„ÇÇ„ÄÅÊµÅ„Çå„ÅåË¶ã„Åà„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô„ÄÇ",
        "Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„Å®ÂøÖË¶Å„Å™„ÇÇ„ÅÆ„ÅÆÁ∑öÂºï„Åç„Åå„Åó„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„ÄÇ‰ªäÊó•„ÅØ„ÄåÊú¨ÂΩì„Å´„Å®„Åç„ÇÅ„Åè„ÇÇ„ÅÆ„Äç„Å†„Åë„ÇíÈÅ∏„Å∂ÊÑèË≠ò„Åß„ÄÅ„ÅäÈáë„Çí‰Ωø„Å£„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
      ],
      b: [
        "„Äå„Å™„Çì„Å®„Å™„Åè„Äç„Åß‰Ωø„Å£„Å¶„Åó„Åæ„ÅÜ„ÅäÈáë„ÇíË¶ãÁõ¥„Åó„Åü„Åè„Å™„ÇãÊó•„ÄÇ„Åô„Åπ„Å¶„ÇíÁÆ°ÁêÜ„Åó„Åç„Çå„Å™„Åè„Å¶„ÇÇ„ÄÅ„Äå„Åì„Çå„ÅØ„ÇÑ„ÇÅ„Å¶„Åø„Çà„ÅÜ„Åã„Å™„Äç„Å®ÊÄù„ÅÜÈ†ÖÁõÆ„Çí‰∏Ä„Å§Ê±∫„ÇÅ„Çã„Å†„Åë„ÅßÂçÅÂàÜ„Åß„Åô„ÄÇ",
        "Â§ß„Åç„Å™Âá∫Ë≤ª„Çà„Çä„ÇÇ„ÄÅÊó•„ÄÖ„ÅÆÂ∞è„Åï„Å™Á©ç„ÅøÈáç„Å≠„ÅåÊ∞ó„Å´„Å™„Çã„Çø„Ç§„Éü„É≥„Ç∞„ÄÇÁÑ°ÁêÜ„Å™ÁØÄÁ¥Ñ„Åß„ÅØ„Å™„Åè„ÄÅ„Äå„Åì„Åì„Å†„ÅëÂ∞ë„ÅóÊéß„Åà„ÇÅ„Å´„Åó„Å¶„Åø„Çà„ÅÜ„Äç„Åè„Çâ„ÅÑ„ÅåÁ∂ö„Åë„ÇÑ„Åô„Åù„ÅÜ„Åß„Åô„ÄÇ"
      ],
      c: [
        "„ÅäÈáë„ÅÆ„Åì„Å®„ÇíËÄÉ„Åà„Çã„Å®Â∞ë„Åó‰∏çÂÆâ„ÅåÂá∫„Å¶„Åç„ÇÑ„Åô„ÅÑÊó•„ÄÇ„Å≤„Å®„Çä„ÅßÊä±„ÅàËæº„Åæ„Åö„ÄÅ‰ø°È†º„Åß„Åç„Çã‰∫∫„Å´ËªΩ„ÅèÁõ∏Ë´á„Åó„Åü„Çä„ÄÅÂÆ∂Ë®à„Ç¢„Éó„É™„ÅßÁèæÁä∂„Çí„ÄåË¶ã„Åà„ÇãÂåñ„Äç„Åô„Çã„Å®„Åì„Çç„Åã„ÇâÂßã„ÇÅ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        "‰ªäÊó•„ÅØÂ§ß„Åç„Å™Â•ëÁ¥Ñ„ÇÑÈ´òÈ°ç„Å™Ë≤∑„ÅÑÁâ©„ÅØÊÖéÈáç„Å´„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êù°‰ª∂„ÇíË¶ãÁõ¥„Åó„Åü„Çä„ÄÅ‰∏ÄÊô©„Åä„ÅÑ„Å¶„Åã„ÇâÊ±∫„ÇÅ„Çã„Å®ÂæåÊÇî„ÅåÂ∞ë„Å™„ÅèÊ∏à„Åø„Åù„ÅÜ„Åß„Åô„ÄÇ"
      ]
    },
    health: {
      a: [
        "‰Ωì„Å®ÂøÉ„ÅÆ„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥„ÇíÊï¥„Åà„ÇÑ„Åô„ÅÑÊó•„ÄÇÊó©„ÇÅ„Å´„ÅäÈ¢®ÂëÇ„Å´ÂÖ•„Å£„Åü„Çä„ÄÅÂ•Ω„Åç„Å™È¶ô„Çä„ÇíÂèñ„ÇäÂÖ•„Çå„Åü„Çä„Å®„ÄÅ‰∫îÊÑü„Åã„Çâ„É™„É©„ÉÉ„ÇØ„Çπ„Åï„Åõ„Å¶„ÅÇ„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        "Â∞è„Åï„Å™„Ç±„Ç¢„ÅåÊòéÊó•„ÅÆËá™ÂàÜ„ÇíÂä©„Åë„Å¶„Åè„Çå„Çã„Çø„Ç§„Éü„É≥„Ç∞„ÄÇÊ∞¥ÂàÜË£úÁµ¶„ÇÑËªΩ„ÅÑ„Çπ„Éà„É¨„ÉÉ„ÉÅ„Å™„Å©„ÄÅÁ∂ö„Åë„ÇÑ„Åô„ÅÑ„Åì„Å®„Çí„Å≤„Å®„Å§ÈÅ∏„Çì„ÅßÊÑèË≠ò„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ"
      ],
      b: [
        "Â§ú„ÅÆ„Çπ„Éû„ÉõÊôÇÈñì„ÇíÂ∞ë„ÅóÁü≠„Åè„Åó„Å¶„Åø„Çã„Å†„Åë„Åß„ÇÇ„ÄÅÁù°Áú†„ÅÆË≥™„ÅåÂ§â„Çè„Å£„Å¶„Åç„Åù„ÅÜ„Å™Êó•„ÄÇÂØù„ÇãÂâç„Å´Ê∑±ÂëºÂê∏„ÇíÊï∞ÂõûÁπ∞„ÇäËøî„Åó„ÄÅ‰Ωì„ÅÆÂäõ„ÇíÊäú„Åè„Ç§„É°„Éº„Ç∏„Çí„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        "„Å™„Çì„Å®„Å™„ÅèÁñ≤„Çå„ÇíÊÑü„Åò„Åü„Çâ„ÄÅ„Äå‰ªäÊó•„ÅØÊó©„ÇÅ„Å´ÂØù„Çã„Äç„Å®Ê±∫„ÇÅ„Å¶„Åó„Åæ„ÅÜ„ÅÆ„ÇÇ„Ç¢„É™„ÄÇËá™ÂàÜ„ÅÆÈôêÁïå„ÇíË∂Ö„Åà„ÇãÂâç„Å´‰ºë„ÇÄ„Åì„Å®„Åå„ÄÅÊòéÊó•„ÅÆ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Å´„Å§„Å™„Åå„Çä„Åæ„Åô„ÄÇ"
      ],
      c: [
        "Áñ≤„Çå„Åå„Åü„Åæ„Çä„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„ÄÇÁÑ°ÁêÜ„Å´‰∫àÂÆö„ÇíË©∞„ÇÅËæº„Åæ„Åö„ÄÅÂ∏∞ÂÆÖÂæå„ÅØ‰Ωì„Çí„ÅÇ„Åü„Åü„ÇÅ„Çã„Åì„Å®„Å®„ÄÅÂçÅÂàÜ„Å™Áù°Áú†„ÇíÂÑ™ÂÖà„Åó„Å¶„ÅÇ„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        "Ê∞óÂúß„ÇÑÊ∞óÊ∏©„ÅÆÂ§âÂåñ„Åß„ÄÅ‰ΩìË™ø„ÇÑÊ∞óÂàÜ„ÅåÊè∫„Çå„ÇÑ„Åô„ÅÑ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇÊ∏©„Åã„ÅÑÈ£≤„ÅøÁâ©„ÇÑ„ÄÅ„ÇÑ„Åï„Åó„ÅÑÂë≥„ÅÆ„ÅîÈ£Ø„Åß„ÄÅÂÜÖÂÅ¥„Åã„Çâ„Åò„Çì„Çè„ÇäÊï¥„Åà„Å¶„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ"
      ]
    }
  };

  function gradeFromScore(score) {
    if (score >= 75) return 'a';
    if (score >= 45) return 'b';
    return 'c';
  }

  function pickText(category, score, seedBase) {
    var g = gradeFromScore(score);
    var bank = (TEXT_BANK[category] && TEXT_BANK[category][g]) || [];
    if (!bank.length) return '';
    var rng = makeRng(stableSeed(category + '|' + g + '|' + seedBase));
    var idx = Math.floor(rng() * bank.length);
    return bank[idx];
  }

  function seasonPhrase(date, seedBase) {
    if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '';
    var month = date.getMonth() + 1;
    var rng = makeRng(stableSeed('season|' + month + '|' + seedBase));
    var arr;
    if (month === 12 || month === 1 || month === 2) {
      arr = [
        "ÂÜ∑„Åü„ÅÑÁ©∫Ê∞ó„ÅÆ‰∏≠„Å´„ÇÇ„ÄÅÈùô„Åã„Å´Êï¥„Åà„ÇãÂäõ„ÅåÊµÅ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊ∏©„Åã„ÅÑÈ£≤„ÅøÁâ©„Åß„Åª„Å£„Å®‰∏ÄÊÅØ„Å§„ÅèÊôÇÈñì„ÇíÂ¢ó„ÇÑ„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        "‰∏ÄÂπ¥„ÅÆÁ∑†„ÇÅ„Åè„Åè„Çä„ÇÑÂßã„Åæ„Çä„ÇíÊÑèË≠ò„Åó„ÇÑ„Åô„ÅÑÂ≠£ÁØÄ„ÄÇÂ∞è„Åï„Å™Âå∫Âàá„Çä„Çí„Å§„Åë„Çã„Åì„Å®„Åß„ÄÅÂøÉ„Å´„ÇÇ‰ΩôÁôΩ„ÅåÁîü„Åæ„Çå„Åù„ÅÜ„Åß„Åô„ÄÇ"
      ];
    } else if (month >= 3 && month <= 5) {
      arr = [
        "Êò•„ÅÆÁ©∫Ê∞ó„Åå„ÇÜ„Å£„Åè„Çä„Å®ÊµÅ„ÇåËæº„Åø„ÄÅÊ∞óÊåÅ„Å°„ÇÇÂ∞ë„Åó„Åö„Å§„Åª„Åê„Çå„ÇÑ„Åô„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„Åß„Åô„ÄÇ‰∫àÂÆö„ÅÆ‰∏≠„Å´„ÄÅÂ∞è„Åï„Å™Ê•Ω„Åó„Åø„ÇíÊ∑∑„Åú„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        "Êñ∞„Åó„ÅÑ„Åì„Å®„ÇíÂßã„ÇÅ„Åü„Åè„Å™„ÇãÂ≠£ÁØÄ„ÄÇÂÖ®ÈÉ®„Çí‰∏ÄÊ∞ó„Å´Â§â„Åà„Çà„ÅÜ„Å®„Åõ„Åö„ÄÅ„Äå„Å≤„Å®„Å§„Å†„ÅëË©¶„Åó„Å¶„Åø„Çã„Äç„Åè„Çâ„ÅÑ„Åå„Å°„Çá„ÅÜ„Å©ËâØ„Åï„Åù„ÅÜ„Åß„Åô„ÄÇ"
      ];
    } else if (month >= 6 && month <= 8) {
      arr = [
        "Êöë„Åï„Åß‰ΩìÂäõ„ÇíÂ•™„Çè„Çå„ÇÑ„Åô„ÅÑÂ≠£ÁØÄ„ÄÇÁÑ°ÁêÜ„ÇíÈÄö„Åô„Çà„Çä„ÄÅ„Åì„Åæ„ÇÅ„Å™‰ºëÊÜ©„Å®Ê∞¥ÂàÜË£úÁµ¶„ÇíÂë≥Êñπ„Å´„Å§„Åë„Å¶„ÅÇ„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        "Êó•Â∑Æ„Åó„ÅåÂº∑„ÅÑ„Å∂„Çì„ÄÅÂøÉ„ÇÇÂ§ñ„Å´Âêë„Åç„ÇÑ„Åô„ÅÑÊôÇÊúü„ÄÇÁñ≤„Çå„ÇíÊÑü„Åò„Åü„Çâ„ÄÅÊ∂º„Åó„ÅÑÂ†¥ÊâÄ„Åß‰∏ÄÊÅØ„Å§„ÅÑ„Å¶„Åã„ÇâÊ¨°„ÅÆ‰∫àÂÆö„Å∏„ÄÇ"
      ];
    } else {
      arr = [
        "Á©∫Ê∞ó„ÅåÂ∞ë„Åó„Åö„Å§ËêΩ„Å°ÁùÄ„ÅÑ„Å¶„Åè„ÇãÂ≠£ÁØÄ„ÄÇ„ÇÜ„Å£„Åè„Çä„Å®ÊåØ„ÇäËøî„ÇãÊôÇÈñì„Çí„Å®„Çã„Åì„Å®„Åß„ÄÅÊ¨°„Å´ÈÄ≤„ÇÄ„Éí„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åù„ÅÜ„Åß„Åô„ÄÇ",
        "Êó•„ÄÖ„ÅÆÂ§âÂåñ„ÇíÊÑü„Åò„ÇÑ„Åô„ÅÑÂ≠£ÁØÄ„ÄÇÂ∞è„Åï„Å™ÈÅï„ÅÑ„Å´Ê∞ó„Å•„Åè„Åª„Å©„ÄÅÊòéÊó•„Å∏„ÅÆÊ•Ω„Åó„Åø„ÇÇÂ¢ó„Åà„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇ"
      ];
    }
    var idx = Math.floor(rng() * arr.length);
    return arr[idx] || '';
  }

  function aspectScore(diff) {
    var aspects = [
      { angle: 0,   sign:  1.0 },
      { angle: 60,  sign:  0.6 },
      { angle: 120, sign:  1.0 },
      { angle: 90,  sign: -0.8 },
      { angle: 180, sign: -0.8 }
    ];
    var sigma = 35;
    var rad2 = 2 * sigma * sigma;
    var score = 0;
    for (var i = 0; i < aspects.length; i++) {
      var a = aspects[i];
      var d = Math.abs(diff - a.angle);
      if (d > 180) d = 360 - d;
      var w = Math.exp(-(d * d) / rad2);
      score += a.sign * w;
    }
    score -= 0.2435;
    return score;
  }

  function clampNorm(x) {
    if (x < -1) return -1;
    if (x >  1) return  1;
    return x;
  }

  function softenBackground(bg, negScale) {
    if (bg < 0) {
      return bg * negScale;
    }
    return bg;
  }

  function mapNormToPercent(n, minP, maxP) {
    if (n < -1) n = -1;
    if (n >  1) n =  1;

    var z = (n < 0) ? -Math.sqrt(-n) : Math.sqrt(n);
    var mid = (minP + maxP) / 2;
    var amp = (maxP - minP) / 2;
    var p = mid + amp * z;

    if (n > 0.96) {
      p = 100;
    }

    if (p < minP) p = minP;
    if (p > 100) p = 100;
    return Math.round(p);
  }

  function parseDateInput(str) {
    if (!str) return null;
    var m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    var y  = parseInt(m[1], 10);
    var mo = parseInt(m[2], 10);
    var d  = parseInt(m[3], 10);
    if (!y || !mo || !d) return null;
    return new Date(y, mo - 1, d, 12, 0, 0);
  }

  function eclLon(body, date) {
    var time = new Astronomy.AstroTime(date);
    var vec  = Astronomy.GeoVector(body, time, true);
    var ecl  = Astronomy.Ecliptic(vec);
    return ecl.elon;
  }

  function fireConfetti() {
    var canvas = document.getElementById('confettiCanvas');
    var ctx = canvas.getContext('2d');
    var w = (canvas.width  = window.innerWidth);
    var h = (canvas.height = window.innerHeight);
    var COUNT = 150;
    var confs = [];
    for (var i = 0; i < COUNT; i++) {
      confs.push({
        x: Math.random() * w,
        y: Math.random() * -h,
        vy: 2 + Math.random() * 3,
        vx: (Math.random() - 0.5) * 1.5,
        size: 4 + Math.random() * 4,
        rot: Math.random() * Math.PI * 2,
        vr: (Math.random() - 0.5) * 0.2
      });
    }
    var start = performance.now();
    function loop(now) {
      var t = now - start;
      ctx.clearRect(0, 0, w, h);
      for (var i = 0; i < confs.length; i++) {
        var c = confs[i];
        c.y += c.vy;
        c.x += c.vx;
        c.rot += c.vr;
        if (c.y > h + 20) {
          c.y = -20;
          c.x = Math.random() * w;
        }
        ctx.save();
        ctx.translate(c.x, c.y);
        ctx.rotate(c.rot);
        ctx.fillStyle = 'hsla(' + (260 + Math.random() * 40) + ',70%,70%,0.9)';
        ctx.fillRect(-c.size / 2, -c.size / 2, c.size, c.size);
        ctx.restore();
      }
      if (t < 2500) {
        requestAnimationFrame(loop);
      } else {
        ctx.clearRect(0, 0, w, h);
      }
    }
    requestAnimationFrame(loop);
  }

  function calc() {
    var birthStr  = document.getElementById('birth').value;
    var targetStr = document.getElementById('targetDate').value;

    if (!birthStr) {
      alert('ÁîüÂπ¥ÊúàÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }
    if (typeof Astronomy === 'undefined') {
      alert('Astronomy Engine „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁí∞Â¢É„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      return;
    }

    var birthDate = parseDateInput(birthStr);
    if (!birthDate) {
      alert('ÁîüÂπ¥ÊúàÊó•„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
      return;
    }

    var now = new Date();
    var targetDate = parseDateInput(targetStr);
    if (!targetDate) {
      targetDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0);
    }

    var Sun  = Astronomy.Body.Sun;
    var Moon = Astronomy.Body.Moon;
    var Merc = Astronomy.Body.Mercury;
    var Ven  = Astronomy.Body.Venus;
    var Mars = Astronomy.Body.Mars;
    var Jup  = Astronomy.Body.Jupiter;
    var Sat  = Astronomy.Body.Saturn;

    var bodies = [Sun, Moon, Merc, Ven, Mars, Jup, Sat];

    var nat = {};
    var cur = {};
    for (var i = 0; i < bodies.length; i++) {
      var b = bodies[i];
      nat[b] = eclLon(b, birthDate);
      cur[b] = eclLon(b, targetDate);
    }

    function diffLon(body) {
      var d = cur[body] - nat[body];
      d = d % 360;
      if (d < 0) d += 360;
      return d;
    }

    function A(body) {
      return aspectScore(diffLon(body));
    }

    var rawBgTotal =
      A(Jup) + A(Sat) + 0.6 * A(Sun);
    var rawDailyTotal =
      0.7 * A(Sun) + 1.0 * A(Moon) +
      0.5 * A(Merc) + 0.5 * A(Ven) +
      0.6 * A(Mars);

    var nBgTotal    = clampNorm(rawBgTotal    * 0.35);
    var nDailyTotal = clampNorm(rawDailyTotal * 0.45);
    nBgTotal = softenBackground(nBgTotal, 0.4);

    var nTotal = clampNorm(nBgTotal * 0.4 + nDailyTotal * 0.6);

    var rawLoveFast =
      1.2 * A(Ven) + 1.0 * A(Moon) + 0.5 * A(Merc);
    var rawLoveBg =
      0.6 * A(Jup);

    var nLoveFast = clampNorm(rawLoveFast * 0.45);
    var nLoveBg   = clampNorm(rawLoveBg   * 0.40);
    nLoveBg = softenBackground(nLoveBg, 0.5);

    var nLove = clampNorm(nLoveFast * 0.7 + nLoveBg * 0.3);

    var rawMoneyFast =
      0.7 * A(Ven) + 0.4 * A(Mars);
    var rawMoneyBg =
      1.0 * A(Jup) + 0.5 * A(Sat);

    var nMoneyFast = clampNorm(rawMoneyFast * 0.40);
    var nMoneyBg   = clampNorm(rawMoneyBg   * 0.35);
    nMoneyBg = softenBackground(nMoneyBg, 0.5);

    var nMoney = clampNorm(nMoneyFast * 0.4 + nMoneyBg * 0.6);

    var rawWorkFast =
      1.0 * A(Mars) + 0.5 * A(Merc) + 0.5 * A(Sun);
    var rawWorkBg =
      1.0 * A(Sat);

    var nWorkFast = clampNorm(rawWorkFast * 0.40);
    var nWorkBg   = clampNorm(rawWorkBg   * 0.35);
    nWorkBg = softenBackground(nWorkBg, 0.5);

    var nWork = clampNorm(nWorkFast * 0.5 + nWorkBg * 0.5);

    var rawHealthFast =
      0.8 * A(Moon) + 0.6 * A(Sun);
    var rawHealthBg =
      0.4 * A(Jup);

    var nHealthFast = clampNorm(rawHealthFast * 0.45);
    var nHealthBg   = clampNorm(rawHealthBg   * 0.35);
    nHealthBg = softenBackground(nHealthBg, 0.5);

    var nHealth = clampNorm(nHealthFast * 0.7 + nHealthBg * 0.3);

    var total  = mapNormToPercent(nTotal,  30, 95);
    var love   = mapNormToPercent(nLove,   25, 95);
    var money  = mapNormToPercent(nMoney,  25, 95);
    var work   = mapNormToPercent(nWork,   25, 95);
    var health = mapNormToPercent(nHealth, 25, 95);

    var seedBase = birthStr + '|' +
      (targetStr || (targetDate.getFullYear() + '-' +
                     (targetDate.getMonth() + 1) + '-' +
                     targetDate.getDate()));

    var overallText = pickText('total',  total,  seedBase);
    var loveText    = pickText('love',   love,   seedBase);
    var moneyText   = pickText('money',  money,  seedBase);
    var workText    = pickText('work',   work,   seedBase);
    var healthText  = pickText('health', health, seedBase);
    var seasonText  = seasonPhrase(targetDate, seedBase);

    var html = '';

    html += '<div class="section-title">' +
              '<span class="icon">ü™ê</span>' +
              '<span class="label">‰ªäÊó•„ÅÆÁ∑èÂêàÈÅã</span>' +
              '<span class="percent">' + total + '%</span>' +
            '</div>';
    var totalText = overallText;
    if (seasonText) {
      totalText += ' ' + seasonText;
    }
    html += '<div class="text-block">' + totalText + '</div>';

    html += '<div class="section-title">' +
              '<span class="icon">üíû</span>' +
              '<span class="label">ÊÅãÊÑõ</span>' +
              '<span class="percent">' + love + '%</span>' +
            '</div>';
    html += '<div class="text-block">' + loveText + '</div>';

    html += '<div class="section-title">' +
              '<span class="icon">üíº</span>' +
              '<span class="label">‰ªï‰∫ã</span>' +
              '<span class="percent">' + work + '%</span>' +
            '</div>';
    html += '<div class="text-block">' + workText + '</div>';

    html += '<div class="section-title">' +
              '<span class="icon">üí∞</span>' +
              '<span class="label">ÈáëÈÅã</span>' +
              '<span class="percent">' + money + '%</span>' +
            '</div>';
    html += '<div class="text-block">' + moneyText + '</div>';

    html += '<div class="section-title">' +
              '<span class="icon">üíó</span>' +
              '<span class="label">ÂÅ•Â∫∑</span>' +
              '<span class="percent">' + health + '%</span>' +
            '</div>';
    html += '<div class="text-block">' + healthText + '</div>';

    document.getElementById('result').innerHTML = html;

    // ÁµêÊûú„ÅåÂá∫„Åü„ÅÆ„Åß„ÄåÁµêÊûú„Çí‰øùÂ≠ò„Äç„Éú„Çø„É≥„ÇíË°®Á§∫
    var saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.style.display = 'block';
    }

    var birthdayEl = document.getElementById('birthdayMessage');
    birthdayEl.textContent = '';

    var now2 = new Date();
    var todayY = now2.getFullYear();
    var todayM = now2.getMonth();
    var todayD = now2.getDate();

    var isTodayTarget =
      targetDate.getFullYear() === todayY &&
      targetDate.getMonth() === todayM &&
      targetDate.getDate() === todayD;

    var isTodayBirthday =
      birthDate.getMonth() === todayM &&
      birthDate.getDate() === todayD;

    if (isTodayTarget && isTodayBirthday) {
      birthdayEl.textContent =
        'üéÇ „ÅäË™ïÁîüÊó•„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ‰ªäÊó•„ÅÆ„ÅÇ„Å™„Åü„Å´„ÄÅ„ÇÑ„Åï„Åó„ÅÑÊµÅ„Çå„Åå„ÅÇ„Çä„Åæ„Åô„Çà„ÅÜ„Å´„ÄÇ';
      fireConfetti();
    }
  }

  // ÁµêÊûú„Ç´„Éº„Éâ„Çí JPEG „Å®„Åó„Å¶‰øùÂ≠ò
  function saveResultImage() {
    var result = document.getElementById('result');
    if (!result || !result.innerHTML.trim()) {
      alert('„Åæ„Åö„Äå„Åì„ÅÆÊó•„ÅÆÈÅãÂã¢„ÇíË¶ã„Çã„Äç„ÅßÁµêÊûú„ÇíË°®Á§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      return;
    }
    if (typeof html2canvas === 'undefined') {
      alert('‰øùÂ≠òÁî®„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁí∞Â¢É„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      return;
    }

    var card = document.getElementById('cardRoot');
    var birthStr  = document.getElementById('birth').value || 'birth';
    var targetStr = document.getElementById('targetDate').value;

    var fileDate = targetStr || 'today';
    var fileBirth = birthStr.replace(/-/g, '');
    var filename = 'horoscope_' + fileDate.replace(/-/g, '') + '_' + fileBirth + '.jpg';

    html2canvas(card, {
      backgroundColor: '#ffffff',
      scale: window.devicePixelRatio > 1 ? 2 : 1
    }).then(function (canvas) {
      var link = document.createElement('a');
      link.href = canvas.toDataURL('image/jpeg', 0.92);
      link.download = filename;
      link.click();
    });
  }

  window.calc = calc;
  window.saveResultImage = saveResultImage;
})();
</script>
</body>
</html>
