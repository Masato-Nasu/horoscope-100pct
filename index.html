<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>æ˜Ÿå ã„ (Complete Fix)</title>
<meta name="theme-color" content="#6b46c1">

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª</text></svg>">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<style>
body{font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background:#f4f4f9; color:#333; margin:0; padding:20px; text-align:center;}
h1 { color: #6b46c1; margin-bottom: 10px; font-size: 1.6em; }
.card { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:20px; margin-bottom:20px; text-align:left; max-width: 600px; margin-left: auto; margin-right: auto; }
input, button { font-size:16px; padding:12px; width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #ddd; margin-bottom:10px; }
button { background:#6b46c1; color:#fff; font-weight:bold; border:none; cursor:pointer; font-size: 1.1em; transition: 0.2s; }
button:active { transform: scale(0.98); opacity: 0.9; }
.result-row { display:flex; justify-content:space-between; align-items:center; padding: 12px 0; border-bottom: 1px solid #eee; }
.result-row:last-child { border-bottom: none; }
.planet-name { font-weight: bold; font-size: 1.1em; color: #444; }
.planet-sign { background: #f3e8ff; color: #6b46c1; padding: 4px 12px; border-radius: 20px; font-weight:bold; font-size: 0.95em; }
#status { margin-bottom: 20px; font-size: 0.9em; font-weight: bold; }
</style>
</head>
<body>

<h1>ğŸª å¤©ä½“ä½ç½®è¨ˆç®—</h1>

<div id="status" style="color:#666;">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>

<div class="card">
    <label>ã‚ãªãŸã®èª•ç”Ÿæ—¥:</label>
    <input type="date" id="birthDate">
    <input type="time" id="birthTime" value="12:00">
    <button onclick="calculate()">é‘‘å®šã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="resultArea" class="card" style="display:none;">
    <div id="luckyResult" style="text-align:center; margin-bottom:20px; padding:15px; background:#fffbe6; border: 2px solid #ffe58f; border-radius:8px;"></div>
    <div id="planetList"></div>
</div>

<script>
// â˜…ã‚¾ãƒ³ãƒ“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®Œå…¨æ¶ˆå»
if(window.navigator && navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) { registration.unregister(); }
    });
}

const $ = id => document.getElementById(id);
const STATUS = $('status');
const SIGNS = ['â™ˆ ç‰¡ç¾Šåº§', 'â™‰ ç‰¡ç‰›åº§', 'â™Š åŒå­åº§', 'â™‹ èŸ¹åº§', 'â™Œ ç…å­åº§', 'â™ ä¹™å¥³åº§', 'â™ å¤©ç§¤åº§', 'â™ è åº§', 'â™ å°„æ‰‹åº§', 'â™‘ å±±ç¾Šåº§', 'â™’ æ°´ç“¶åº§', 'â™“ é­šåº§'];
const PLANETS = [
    {key: 'Sun', label: 'â˜€ï¸ å¤ªé™½'}, {key: 'Moon', label: 'ğŸŒ™ æœˆ'}, 
    {key: 'Mercury', label: 'â˜¿ æ°´æ˜Ÿ'}, {key: 'Venus', label: 'â™€ é‡‘æ˜Ÿ'}, 
    {key: 'Mars', label: 'â™‚ ç«æ˜Ÿ'}, {key: 'Jupiter', label: 'â™ƒ æœ¨æ˜Ÿ'}, 
    {key: 'Saturn', label: 'â™„ åœŸæ˜Ÿ'}
];

// èµ·å‹•ãƒã‚§ãƒƒã‚¯
window.onload = function() {
    if(!$('birthDate').value) $('birthDate').value = '2000-01-01'; 

    let checkCount = 0;
    const checker = setInterval(() => {
        checkCount++;
        if (typeof Astronomy !== 'undefined') {
            STATUS.innerHTML = 'âœ… æº–å‚™å®Œäº†';
            STATUS.style.color = '#2e7d32';
            clearInterval(checker);
        } else if (checkCount > 10) {
            STATUS.innerHTML = 'âš ï¸ èª­ã¿è¾¼ã¿ä¸­... (é•·å¼•ãå ´åˆã¯ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„)';
            STATUS.style.color = '#e65100';
        }
    }, 500);
};

// å®‰å…¨ãªæ—¥ä»˜ç”Ÿæˆ
function getSafeDate() {
    const dStr = $('birthDate').value;
    const tStr = $('birthTime').value || '12:00';
    if(!dStr) return null;
    const [y, m, d] = dStr.split('-').map(Number);
    const [h, min] = tStr.split(':').map(Number);
    return new Date(y, m - 1, d, h, min, 0);
}

// è¨ˆç®—å®Ÿè¡Œ
function calculate() {
    const date = getSafeDate();
    
    if (typeof Astronomy === 'undefined') {
        alert("è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
        return;
    }
    if(!date || isNaN(date.getTime())) {
        alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }

    let html = '';
    let jupiterLon = 0;

    // æƒ‘æ˜Ÿè¨ˆç®—ãƒ«ãƒ¼ãƒ—
    PLANETS.forEach(p => {
        let lon = 0;
        try {
            // â˜…ã“ã“ãŒä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼
            // ç¬¬3å¼•æ•°ã«å¿…ãšã€Œtrueã€ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€undefinedã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã¾ã™
            const vector = Astronomy.GeoVector(p.key, date, true);
            const ecliptic = Astronomy.Ecliptic(vector);
            lon = ecliptic.lon;
            if(p.key === 'Jupiter') jupiterLon = lon;
        } catch(e) {
            console.error(e);
            lon = 0; 
        }

        const signIndex = Math.floor(lon / 30) % 12;
        const degree = (lon % 30).toFixed(1);
        const signName = SIGNS[signIndex];

        html += `
        <div class="result-row">
            <div class="planet-name">${p.label}</div>
            <div class="planet-sign">${signName} ${degree}Â°</div>
        </div>`;
    });

    $('planetList').innerHTML = html;
    
    // æœ¨æ˜Ÿé‹å‹¢åˆ¤å®šï¼ˆã“ã“ã‚‚ true ã‚’å¿˜ã‚Œãšã«è¿½åŠ ï¼‰
    try {
        const todayVec = Astronomy.GeoVector('Jupiter', new Date(), true);
        const todayLon = Astronomy.Ecliptic(todayVec).lon;
        let diff = Math.abs(todayLon - jupiterLon);
        if(diff > 180) diff = 360 - diff;
        
        let luckMsg = "æœ¨æ˜Ÿã¯é€šå¸¸é‹è¡Œä¸­ã§ã™";
        let luckColor = "#333";
        
        if(diff < 8) {
            luckMsg = "âœ¨ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>12å¹´ã«ä¸€åº¦ã®æœ€å¼·å¹¸é‹æœŸã§ã™ï¼";
            luckColor = "#d32f2f";
        } else if(Math.abs(diff - 120) < 8) {
            luckMsg = "ğŸŒˆ å¤§å‰é‹ï¼<br>ç‰©äº‹ãŒã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚€è¿½ã„é¢¨ãŒå¹ã„ã¦ã„ã¾ã™ã€‚";
            luckColor = "#e65100";
        }

        const resDiv = $('luckyResult');
        resDiv.innerHTML = `<div style="color:${luckColor}; font-weight:bold; font-size:1.1em; line-height:1.5;">${luckMsg}</div>`;
        $('resultArea').style.display = 'block';
        resDiv.scrollIntoView({behavior: "smooth", block: "center"});
        
    } catch(e) {
        console.error("Luck calc error:", e);
    }
}
</script>

</body>
</html>