<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æœ¬æ ¼æ˜Ÿå ã„ï¼ˆå˜ä¸€HTMLãƒ»Astronomy Engineå¯¾å¿œç‰ˆï¼‰</title>
<meta name="theme-color" content="#6b46c1" />
<!-- çµµæ–‡å­—SVGã‚’ DataURI ã§ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã« -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸª</text></svg>">

<!-- Astronomy Engine (browser build) - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å›ºå®šã—ã¦èª­ã¿è¾¼ã¿ -->
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<style>
  :root { --accent:#6b46c1; --bg:#f6f7fb; --card:#fff; --muted:#666; }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:#222}
  .wrap{max-width:720px;margin:28px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
  h1{margin:0;font-size:1.25rem;color:var(--accent)}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:16px}
  label{display:block;margin-bottom:6px;font-weight:600;color:#333}
  .row{display:flex;gap:8px}
  input[type="date"], input[type="time"], input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e6f0;font-size:14px}
  button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  .result-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f0f0f6}
  .planet-name{font-weight:700}
  .planet-sign{background:#f3e8ff;color:var(--accent);padding:6px 10px;border-radius:16px;font-weight:700}
  #status{font-size:0.95rem;margin-bottom:10px;color:var(--muted)}
  #luckyResult{padding:12px;border-radius:10px;background:#fffbe6;border:1px solid #ffe58f;margin-bottom:12px;font-weight:700}
  .small{font-size:0.9rem;color:var(--muted)}
  footer{font-size:0.8rem;color:var(--muted);text-align:center;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-size:34px">ğŸª</div>
      <div>
        <h1>æœ¬æ ¼æ˜Ÿå ã„ï¼ˆPWAæº–å‚™æ¸ˆãƒ»å˜ä¸€HTMLï¼‰</h1>
        <div class="small">Astronomy Engine å¯¾å¿œ â€” æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹å …ç‰¢åŒ–ãƒ»SWç™»éŒ²è§£é™¤ä»˜ã</div>
      </div>
    </header>

    <div id="status" class="card">
      <div id="statusText">èµ·å‹•ä¸­â€¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚</div>
      <div class="small" style="margin-top:8px">Service Worker ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è§£é™¤ã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿ï¼‰ã€‚</div>
    </div>

    <div class="card">
      <label for="birthDate">ç”Ÿå¹´æœˆæ—¥ï¼ˆå¿…é ˆï¼‰</label>
      <div class="row" style="margin-bottom:8px">
        <input id="birthDate" type="date" />
        <input id="birthTime" type="time" value="12:00" />
      </div>
      <label for="tzOffset">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è£œæ­£ï¼ˆä»»æ„ã€ä¾‹: +09:00ï¼‰</label>
      <input id="tzOffset" type="text" placeholder="ä¾‹: +09:00ï¼ˆç©ºæ¬„ã§ãƒ–ãƒ©ã‚¦ã‚¶ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä½¿ç”¨ï¼‰" />

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="goBtn">é‘‘å®šã‚’å®Ÿè¡Œ</button>
        <button id="exampleBtn" style="background:#444">ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ2000-01-01 12:00ï¼‰</button>
      </div>
    </div>

    <div id="resultArea" class="card" style="display:none">
      <div id="luckyResult"></div>
      <div id="planetList"></div>
    </div>

    <footer class="small">ç”»åƒã¯ä¸è¦ãƒ»DataURI ä½¿ç”¨ / manifest / sw.js ãŒã‚ã£ã¦ã‚‚ã¾ãšã¯ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§å‹•ä½œã—ã¾ã™</footer>
  </div>

<script>
/* ãƒãƒªã‚·ãƒ¼: ä¸å¯§èªã§è¡¨ç¤ºã—ã¾ã™ */
const STATUS = document.getElementById('statusText');
const PLANETS = [
  { body: Astronomy.Body.Sun, label: 'â˜€ï¸ å¤ªé™½' },
  { body: Astronomy.Body.Moon, label: 'ğŸŒ™ æœˆ' },
  { body: Astronomy.Body.Mercury, label: 'â˜¿ æ°´æ˜Ÿ' },
  { body: Astronomy.Body.Venus, label: 'â™€ é‡‘æ˜Ÿ' },
  { body: Astronomy.Body.Mars, label: 'â™‚ ç«æ˜Ÿ' },
  { body: Astronomy.Body.Jupiter, label: 'â™ƒ æœ¨æ˜Ÿ' },
  { body: Astronomy.Body.Saturn, label: 'â™„ åœŸæ˜Ÿ' },
];
const SIGNS = ['â™ˆ ç‰¡ç¾Šåº§','â™‰ ç‰¡ç‰›åº§','â™Š åŒå­åº§','â™‹ èŸ¹åº§','â™Œ ç…å­åº§','â™ ä¹™å¥³åº§','â™ å¤©ç§¤åº§','â™ è åº§','â™ å°„æ‰‹åº§','â™‘ å±±ç¾Šåº§','â™’ æ°´ç“¶åº§','â™“ é­šåº§'];

function safeLog(...args){ if(console && console.log) console.log(...args); }

// Service Worker ãŒç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚‰è§£é™¤ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿ï¼‰
async function unregisterAllServiceWorkers(){
  if('serviceWorker' in navigator){
    try{
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs){ await r.unregister(); }
      safeLog('ServiceWorker: unregistered', regs);
    }catch(e){
      safeLog('ServiceWorker unregister error', e);
    }
  }
}

// ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç¢ºèª
function checkLibraryReady(timeout=3000){
  return new Promise((resolve, reject) => {
    const start = Date.now();
    (function poll(){
      if(typeof Astronomy !== 'undefined' && Astronomy.Body){
        resolve(true);
      } else if(Date.now() - start > timeout){
        reject(new Error('Astronomy Engine ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
      } else {
        setTimeout(poll, 150);
      }
    })();
  });
}

// æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹ã‚’å …ç‰¢ã«è¡Œã†ï¼ˆHTML date + time + optional TZï¼‰
function parseUserDate(dateStr, timeStr, tzOffsetStr){
  // dateStr: 'YYYY-MM-DD' (from input[type=date])
  // timeStr: 'HH:MM' or empty
  // tzOffsetStr: '+09:00' or '' (optional). If provided, construct ISO string with offset.
  try{
    if(!dateStr) return null;
    const time = timeStr && timeStr.trim() ? timeStr.trim() : '12:00';
    // Basic validation
    const dParts = dateStr.split('-').map(v=>parseInt(v,10));
    if(dParts.length !== 3 || dParts.some(isNaN)) return null;
    const [y,m,d] = dParts;
    // If tz provided and looks like +/-HH:MM, build ISO string
    if(tzOffsetStr && /^\s*[+-]\d{2}:\d{2}\s*$/.test(tzOffsetStr)){
      const iso = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00${tzOffsetStr}`;
      const dt = new Date(iso);
      if(isNaN(dt.getTime())) return null;
      return dt;
    }
    // Otherwise create Date in local timezone (browser)
    const [hh,mm] = time.split(':').map(v=>parseInt(v,10) || 0);
    const dtLocal = new Date(y, m-1, d, hh, mm, 0, 0);
    if(isNaN(dtLocal.getTime())){
      // fallback: try Date.parse on combined string
      const iso2 = `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${time}:00`;
      const dt2 = new Date(iso2);
      if(isNaN(dt2.getTime())) return null;
      return dt2;
    }
    return dtLocal;
  }catch(e){
    safeLog('parseUserDate error', e);
    return null;
  }
}

// çµŒåº¦ã‚’æ­£è¦åŒ– [0,360)
function norm360(x){
  let v = x % 360;
  if(v < 0) v += 360;
  return v;
}

// çµŒåº¦å·®ã‚’ -180..+180 ã«ã—ã¦çµ¶å¯¾å€¤
function angleDiff(a, b){
  let diff = Math.abs(norm360(a) - norm360(b));
  if(diff > 180) diff = 360 - diff;
  return diff;
}

// çµæœè¡¨ç¤º
function renderPlanetList(itemsHtml, luckHtml){
  document.getElementById('planetList').innerHTML = itemsHtml;
  document.getElementById('luckyResult').innerHTML = luckHtml;
  document.getElementById('resultArea').style.display = 'block';
  window.scrollTo({top: document.getElementById('resultArea').offsetTop - 20, behavior: 'smooth'});
}

// å®Ÿè¨ˆç®—: ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰å¤ªé™½ã€œåœŸæ˜Ÿã¾ã§ç®—å‡ºã€æœ¨æ˜Ÿã§ã€Œ12å¹´ã«ä¸€åº¦ã€åˆ¤å®š
async function calculate(){
  const dateInput = document.getElementById('birthDate').value;
  const timeInput = document.getElementById('birthTime').value;
  const tzInput = document.getElementById('tzOffset').value.trim();

  const natalDate = parseUserDate(dateInput, timeInput, tzInput);
  if(!natalDate){
    alert('ç”Ÿå¹´æœˆæ—¥ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 1990-05-01ï¼‰');
    return;
  }

  // Astronomy ãŒã‚ã‚Œã°å®Ÿè¡Œ
  if(typeof Astronomy === 'undefined' || !Astronomy.Body){
    alert('Astronomy Engine ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ä¸‹ã•ã„ã€‚');
    return;
  }

  // å„æƒ‘æ˜Ÿã®çµŒåº¦ã‚’è¨ˆç®—
  const items = [];
  let natalJupiterLon = null;

  for(const p of PLANETS){
    try{
      // GeoVector ã¯ (Body, Time, aberration:boolean) â€” æœ€æ–°API ã«åˆã‚ã›ã¦ Body åˆ—æŒ™å‹ã‚’æ¸¡ã™
      // aberration = true ã‚’æ¸¡ã™ã¨è¦‹ã‹ã‘ä½ç½®ã®è£œæ­£ãŒå…¥ã‚‹ï¼ˆé€šå¸¸ã¯ true ãŒæœ›ã¾ã—ã„ï¼‰
      const vec = Astronomy.GeoVector(p.body, natalDate, true);
      const ecl = Astronomy.Ecliptic(vec); // { lon, lat, ... }
      const lon = norm360(ecl.lon);
      // ç›¤é¢è¡¨ç¤ºç”¨ï¼šæ˜Ÿåº§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨åº¦æ•°
      const signIndex = Math.floor(lon / 30) % 12;
      const degree = (lon % 30);
      items.push({ label: p.label, lon, sign: SIGNS[signIndex], degree: degree });
      if(p.body === Astronomy.Body.Jupiter){
        natalJupiterLon = lon;
      }
    }catch(err){
      safeLog('planet calc error', p, err);
      items.push({ label: p.label, lon: NaN, sign: 'è¨ˆç®—ä¸èƒ½', degree: NaN });
    }
  }

  // ä»Šæ—¥ã®æœ¨æ˜ŸçµŒåº¦ï¼ˆæ¯”è¼ƒç”¨ï¼‰
  let todayJupiterLon = null;
  try{
    const today = new Date();
    const vecT = Astronomy.GeoVector(Astronomy.Body.Jupiter, today, true);
    todayJupiterLon = norm360(Astronomy.Ecliptic(vecT).lon);
  }catch(e){
    safeLog('today jupiter calc failed', e);
  }

  // HTML ä½œæˆ
  let html = '';
  for(const it of items){
    const degText = (Number.isFinite(it.degree) ? it.degree.toFixed(1) + 'Â°' : 'â€”');
    html += `<div class="result-row">
      <div class="planet-name">${it.label}</div>
      <div class="planet-sign">${it.sign} ${degText}</div>
    </div>`;
  }

  // æœ¨æ˜Ÿã®12å¹´ã«ä¸€åº¦åˆ¤å®šï¼ˆé–¾å€¤ã‚’8åº¦ç¨‹åº¦ã«è¨­å®šï¼‰
  let luckHtml = 'æœ¨æ˜Ÿã®æ¯”è¼ƒæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
  if(Number.isFinite(natalJupiterLon) && Number.isFinite(todayJupiterLon)){
    const diff = angleDiff(natalJupiterLon, todayJupiterLon);
    // åˆ¤å®šãƒ«ãƒ¼ãƒ«ï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯ï¼‰:
    // - diff < 8Â° : æœ¨æ˜Ÿå¸°é‚„ï¼ˆ12å¹´ã«ä¸€åº¦ã®å¹¸é‹æœŸã®åˆ°æ¥ï¼‰
    // - diff â‰ˆ 120Â° Â± 8Â° : ãƒˆãƒ©ã‚¤ãƒ³ï¼ˆè‰¯ã„å½±éŸ¿ï¼‰
    // - diff â‰ˆ 60Â° Â± 6Â° : ã‚»ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç©ã‚„ã‹ãªè¿½ã„é¢¨ï¼‰
    if(diff < 8){
      luckHtml = `<div style="color:#1b5e20">âœ¨ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>ç¾åœ¨ã¯ <strong>12å¹´ã«ä¸€åº¦ã®æœ¨æ˜Ÿå¸°é‚„ï¼ˆæœ€å¼·ã®å¹¸é‹æœŸï¼‰</strong> ã«è¿‘ã„ä½ç½®ã§ã™ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    } else if(Math.abs(diff - 120) < 8){
      luckHtml = `<div style="color:#e65100">ğŸŒˆ å¤§å‰é‹ï¼ˆãƒˆãƒ©ã‚¤ãƒ³ï¼‰: æœ¨æ˜Ÿã‹ã‚‰è¿½ã„é¢¨ãŒæ¥ã¦ã„ã¾ã™ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    } else if(Math.abs(diff - 60) < 6){
      luckHtml = `<div style="color:#2e7d32">ğŸ‘ è‰¯ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆã‚»ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰: ç©ã‚„ã‹ãªå¥½æ©Ÿï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    } else {
      luckHtml = `<div>æœ¨æ˜Ÿã¯ç‰¹åˆ¥ãªè§’åº¦ã«ã‚ã‚Šã¾ã›ã‚“ï¼ˆå·® ${diff.toFixed(1)}Â°ï¼‰ã€‚</div>`;
    }
    luckHtml += `<div class="small" style="margin-top:8px">å‡ºç”Ÿæ™‚ã®æœ¨æ˜ŸçµŒåº¦: ${natalJupiterLon.toFixed(1)}Â° / ä»Šæ—¥ã®æœ¨æ˜ŸçµŒåº¦: ${todayJupiterLon.toFixed(1)}Â°</div>`;
  }

  renderPlanetList(html, luckHtml);
}

// UI åˆæœŸåŒ–
(async function init(){
  // ServiceWorker ã‚’è§£é™¤ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿ï¼‰
  await unregisterAllServiceWorkers();

  try{
    await checkLibraryReady(4000);
    document.getElementById('statusText').textContent = 'âœ… æº–å‚™å®Œäº† â€” è¨ˆç®—å¯èƒ½ã§ã™ï¼ˆAstronomy Engine èª­ã¿è¾¼ã¿æ¸ˆï¼‰';
  }catch(e){
    document.getElementById('statusText').textContent = 'âš ï¸ Astronomy Engine ã®ãƒ­ãƒ¼ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
    safeLog(e);
  }

  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('goBtn').addEventListener('click', function(){
    calculate();
  });
  document.getElementById('exampleBtn').addEventListener('click', function(){
    document.getElementById('birthDate').value = '2000-01-01';
    document.getElementById('birthTime').value = '12:00';
  });

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»Šæ—¥ã‚’ã‚»ãƒƒãƒˆã—ãªã„ï¼ˆèª•ç”Ÿæ—¥ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹å‰æï¼‰ã€‚
  // ãŸã ã—åˆ©ä¾¿æ€§ã®ãŸã‚ã«ç©ºæ¬„ã§ã¯ãªã place-holder ã‚’æ®‹ã™ã€‚
})();
</script>
</body>
</html>
