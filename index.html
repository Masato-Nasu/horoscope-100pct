<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <!-- â˜… è¨ºæ–­ãƒœãƒƒã‚¯ã‚¹ã‚’CSSã§å³æ™‚ä¸å¯è¦–åŒ–ï¼ˆæç”»å‰ã«åŠ¹ã‹ã›ã‚‹ï¼‰ -->
  <style id="pwa-nuke-style">
    #pwaStatus, .pwa-diag, [data-pwa-diag], .pwa-check, #pwaCheck { display:none !important; visibility:hidden !important; }
    div[style*="position: fixed"][style*="top"][style*="right"] { display:none !important; }
  </style>

  <!-- â˜… è¨ºæ–­ãƒœãƒƒã‚¯ã‚¹ã‚’å®Œå…¨å‰Šé™¤ï¼ˆDOMæŒ¿å…¥å¾Œã‚‚ç›£è¦–ã—ã¦æ¶ˆã™ï¼‰ -->
  <script>
  (function(){
    function killDiagOnce(root){
      try{
        const texts = ['PWA è¨ºæ–­','ServiceWorker controlled','URL pathname:','æƒ³å®š scope/start_url'];
        const candidates = Array.from((root||document).querySelectorAll('body *'));
        for (const el of candidates){
          const t = (el.textContent||'').trim();
          if (!t) continue;
          if (texts.every(s => t.includes(s))) {
            el.remove();
          }
        }
        const ids = ['pwaStatus','pwaCheck']; for (const id of ids){ const x=document.getElementById(id); if(x) x.remove(); }
        const cls = ['pwa-diag','pwa-check']; for (const c of cls){ document.querySelectorAll('.'+c).forEach(n=>n.remove()); }
      }catch(_){}
    }
    killDiagOnce();
    document.addEventListener('DOMContentLoaded', ()=>killDiagOnce());
    window.addEventListener('load', ()=>killDiagOnce());
    const mo = new MutationObserver(muts => {
      for (const m of muts){
        if (m.addedNodes && m.addedNodes.length){
          m.addedNodes.forEach(n => { if (n.nodeType === 1) killDiagOnce(n); });
        }
      }
    });
    mo.observe(document.documentElement, {childList:true,subtree:true});
  })();
  </script>

  <!-- manifest & icons -->
  <link rel="manifest" href="/horoscope-100pct/manifest.json?v=10">
  <link rel="icon" href="./icon-192.png" type="image/png">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <meta name="theme-color" content="#6b46c1">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- â˜… ä¸€æ™‚çš„ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼š?reset=1 ã§å…¨å‰Šé™¤ -->
  <script>
  (function(){
    try{
      const url = new URL(location.href);
      if (url.searchParams.get('reset') === '1') {
        (async () => {
          try {
            if ('serviceWorker' in navigator) {
              const regs = await navigator.serviceWorker.getRegistrations();
              for (const r of regs) { await r.unregister(); }
            }
            if (window.caches) {
              const keys = await caches.keys();
              for (const k of keys) { await caches.delete(k); }
            }
            try { localStorage.clear(); } catch(_){}
            try { sessionStorage.clear(); } catch(_){}
            document.cookie.split(';').forEach(c=>{
              document.cookie = c.replace(/^ +/,'').replace(/=.*/, '=;expires=' + new Date(0).toUTCString() + ';path=/');
            });
          } finally {
            url.searchParams.delete('reset');
            location.replace(url.toString());
          }
        })();
      }
    }catch(e){ console.warn('reset script error', e); }
  })();
  </script>

  <!-- Service Worker ç™»éŒ²ï¼ˆv33ï¼‰ -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js?v=33')
        .catch(e => console.warn('SWç™»éŒ²å¤±æ•—', e));
    }
  </script>

  <title>100% æ˜Ÿå ã„</title>

  <!-- CSSï¼ˆæ—¢å­˜ãã®ã¾ã¾ï¼‰ -->
  <style>
    :root{--bg:#fbfbfc;--card:#fff;--accent:#6b46c1;--muted:#666}
    html,body{margin:0;padding:0;height:100%}
    body{font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",system-ui,sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:8px 0;font-size:20px;color:#6b46c1}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(16,24,40,0.06);margin-top:12px}
    label{display:block;font-weight:600;margin-top:8px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input,select,button{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ee;box-sizing:border-box;font-size:14px;background:#fff}
    button{background:#6b46c1;color:#fff;border:0;cursor:pointer;padding:10px;min-height:44px}
    .btn-secondary{background:#e9e6ff;color:#3b2fb3}
    .bar{height:12px;background:#eee;border-radius:999px;overflow:hidden}
    .bar>i{height:100%;display:block;background:linear-gradient(90deg,#ffd166,#ef476f)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px;border-bottom:1px solid #f0f0f0;text-align:left}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{background:#f3f0ff;color:#473592;font-size:12px;border-radius:999px;padding:4px 8px}
    #status{margin-left:auto;font-size:12px;color:#666}
    #log{white-space:pre-wrap;background:#0b1020;color:#e6f0ff;padding:10px;border-radius:8px;font-family:ui-monospace,Menlo,monospace;font-size:12px;max-height:260px;overflow:auto}
    details{border:1px solid #eee;border-radius:10px;padding:8px;margin:8px 0;background:#fff}
    details>summary{cursor:pointer;font-weight:600}
    @media(max-width:700px){.row{flex-direction:column}}
    .muted{color:#666}
    .toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999;opacity:0.95}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  </style>

  <!-- astronomy-engine -->
  <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js" defer></script>
  <!-- html2canvas for JPEG ä¿å­˜ï¼ˆUIå¤‰æ›´ãªã—ï¼šé•·æŠ¼ã—/ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ç™ºç«ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('calcBtn');
      if(btn){ btn.disabled = true; btn.textContent = 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­è¾¼ä¸­â€¦'; }
      function ready(){
        return !!(window.Astronomy && (Astronomy.SunLongitude || Astronomy.Ecliptic));
      }
      function enable(){
        if(btn){ btn.disabled = false; btn.textContent = 'æœ¬æ ¼è§£æã‚’å®Ÿè¡Œ'; }
        const st = document.getElementById('status'); if(st) st.textContent = 'å¤©ä½“è¨ˆç®—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªOK';
      }
      if(ready()){ enable(); return; }
      setTimeout(()=>{
        if(!ready()){
          const s=document.createElement('script');
          s.src='https://unpkg.com/astronomy-engine@2.1.19/astronomy.browser.min.js';
          s.onload = () => { if(ready()) enable(); };
          document.head.appendChild(s);
        }
      },800);
      const t = setInterval(()=>{ if(ready()){ clearInterval(t); enable(); } },200);
    });
  </script>
</head>
<body>
  <noscript><div style="background:#ffdfdf;color:#900;padding:10px">JavaScriptãŒç„¡åŠ¹ã§ã™ã€‚ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚</div></noscript>

  <div class="wrap">
    <header>
      <h1>100ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆæ˜Ÿå ã„</h1>
      <div id="status">èµ·å‹•æº–å‚™ä¸­â€¦</div>
    </header>

    <!-- å…¥åŠ›ã‚«ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜UIå¤‰æ›´ãªã—ï¼‰ -->
    <div class="card" id="inputCard">
      <div class="row" style="margin-top:10px">
        <div class="col"><label>å‡ºç”Ÿæ—¥</label><input type="date" id="birthDate" /></div>
        <div class="col"><label>å‡ºç”Ÿæ™‚åˆ»</label><input type="time" id="birthTime" step="1" /></div>
      </div>

      <div class="row">
        <div class="col"><label>å‡ºç”Ÿåœ°ï¼ˆéƒ½å¸‚åï¼‰</label><input type="text" id="placeName" placeholder="Tokyo, Japan" /></div>
        <div class="col">
          <label>ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</label>
          <select id="tzSelect">
            <option value="Asia/Tokyo">Asia/Tokyo (æ—¥æœ¬)</option>
            <option value="UTC">UTC</option>
            <option value="Europe/London">Europe/London</option>
            <option value="America/New_York">America/New_York</option>
            <option value="America/Los_Angeles">America/Los_Angeles</option>
            <option value="Asia/Seoul">Asia/Seoul</option>
            <option value="Asia/Shanghai">Asia/Shanghai</option>
            <option value="OTHER">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
          </select>
          <input id="tzInput" type="text" placeholder="ä¾‹: Asia/Tokyo" style="display:none;margin-top:6px" inputmode="latin-name" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>ç·¯åº¦</label>
          <select id="latSelect">
            <option value="35.6895">æ±äº¬ (35.6895)</option>
            <option value="34.6937">å¤§é˜ª (34.6937)</option>
            <option value="43.0621">æœ­å¹Œ (43.0621)</option>
            <option value="33.5902">ç¦å²¡ (33.5902)</option>
            <option value="38.2682">ä»™å° (38.2682)</option>
            <option value="35.4437">æ¨ªæµœ (35.4437)</option>
            <option value="36.3890">å‰æ©‹ (36.3890)</option>
            <option value="35.1815">åå¤å±‹ (35.1815)</option>
            <option value="34.6851">å¥ˆè‰¯ (34.6851)</option>
            <option value="34.2250">åºƒå³¶ (34.2250)</option>
            <option value="32.7503">ç†Šæœ¬ (32.7503)</option>
            <option value="26.2124">é‚£è¦‡ (26.2124)</option>
            <option value="37.9026">é‡‘æ²¢ (37.9026)</option>
            <option value="36.5748">é•·é‡ (36.5748)</option>
            <option value="34.7336">é«˜æ¾ (34.7336)</option>
            <option value="33.8416">æ¾å±± (33.8416)</option>
            <option value="31.5966">é¹¿å…å³¶ (31.5966)</option>
            <option value="40.8246">é’æ£® (40.8246)</option>
            <option value="39.7036">ç››å²¡ (39.7036)</option>
            <option value="0">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
          </select>
          <input type="number" id="lat" step="0.0001" placeholder="ç·¯åº¦ã‚’å…¥åŠ›" style="display:none" />
        </div>

        <div class="col">
          <label>çµŒåº¦</label>
          <select id="lonSelect">
            <option value="139.6917">æ±äº¬ (139.6917)</option>
            <option value="135.5023">å¤§é˜ª (135.5023)</option>
            <option value="141.3544">æœ­å¹Œ (141.3544)</option>
            <option value="130.4017">ç¦å²¡ (130.4017)</option>
            <option value="140.8719">ä»™å° (140.8719)</option>
            <option value="139.6380">æ¨ªæµœ (139.6380)</option>
            <option value="139.0600">å‰æ©‹ (139.0600)</option>
            <option value="136.9066">åå¤å±‹ (136.9066)</option>
            <option value="135.8049">å¥ˆè‰¯ (135.8049)</option>
            <option value="132.4553">åºƒå³¶ (132.4553)</option>
            <option value="130.7417">ç†Šæœ¬ (130.7417)</option>
            <option value="127.6809">é‚£è¦‡ (127.6809)</option>
            <option value="136.9066">é‡‘æ²¢ (136.9066)</option>
            <option value="138.1810">é•·é‡ (138.1810)</option>
            <option value="134.0434">é«˜æ¾ (134.0434)</option>
            <option value="132.7661">æ¾å±± (132.7661)</option>
            <option value="130.5571">é¹¿å…å³¶ (130.5571)</option>
            <option value="140.7400">é’æ£® (140.7400)</option>
            <option value="141.1527">ç››å²¡ (141.1527)</option>
            <option value="0">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
          </select>
          <input type="number" id="lon" step="0.0001" placeholder="çµŒåº¦ã‚’å…¥åŠ›" style="display:none" />
        </div>
      </div>

      <label>è§£ææ—¥ï¼ˆç©ºãªã‚‰ä»Šæ—¥ï¼‰</label><input type="date" id="targetDate" />

      <div class="toolbar">
        <button id="geocodeBtn" type="button">éƒ½å¸‚åã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—</button>
        <button id="calcBtn" type="button">æœ¬æ ¼è§£æã‚’å®Ÿè¡Œ</button>
        <button id="fillBtn" type="button" class="btn-secondary">ãƒ‡ãƒ¢å€¤ã‚’å…¥åŠ›</button>
        <button id="resetBtn" type="button" class="btn-secondary">å…¨ã¦ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div id="output" class="card" style="display:none"></div>
    <div class="card" id="logCard" style="margin-top:12px"><div><strong>ãƒ­ã‚°</strong> <span class="muted">ï¼ˆå•é¡ŒãŒå‡ºãŸã‚‰ã“ã“ã‚’é–‹ã„ã¦ã‚¹ã‚¯ã‚·ãƒ§ãã ã•ã„ï¼‰</span></div><pre id="log"></pre></div>
  </div>

  <!-- ===== ã“ã“ã‹ã‚‰ã‚¢ãƒ—ãƒªæœ¬ä½“JS ===== -->
  <script>
    const $status = document.getElementById('status');
    const $log = document.getElementById('log');
    const NS = 'astro_' + (location.pathname || 'root').replace(/[^\w]/g,'_') + '_';
    function log(msg){ try{ const t=new Date().toLocaleTimeString(); const el=document.getElementById('log'); if(el){ el.textContent += `[${t}] ${msg}\n`; } }catch(e){} }
    function setStatus(s){ try{ const el=document.getElementById('status'); if(el) el.textContent = s; }catch(e){} }
    function toast(text){ try{ const n=document.createElement('div'); n.className='toast'; n.textContent=text; document.body.appendChild(n); setTimeout(()=>n.remove(),1300);}catch(_){ } }

    window.addEventListener('error', e=>{ if(String(e.message||'').includes('Unexpected token <')){ log('CDNãŒHTMLã‚’è¿”ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ­ãƒƒã‚¯/404ã®å¯èƒ½æ€§ï¼‰ã€‚'); } });

    document.addEventListener('DOMContentLoaded', ()=>{
      setStatus(window.Astronomy ? 'å¤©ä½“è¨ˆç®—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªOK' : 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­è¾¼');
      document.getElementById('geocodeBtn').addEventListener('click', onGeocodeClick);
      document.getElementById('calcBtn').addEventListener('click', onCalcClick);
      document.getElementById('fillBtn').addEventListener('click', onFillClick);
      document.getElementById('resetBtn').addEventListener('click', onResetClick);
      document.getElementById('latSelect').addEventListener('change', e=>toggleLatInput(e.target.value));
      document.getElementById('lonSelect').addEventListener('change', e=>toggleLonInput(e.target.value));
      document.getElementById('tzSelect').addEventListener('change', e=>toggleTzInput(e.target.value));

      const ids = ['birthDate','birthTime','placeName','lat','lon','tzSelect','targetDate','tzInput','latSelect','lonSelect'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', saveInputs);
        el.addEventListener('change', saveInputs);
      });

      loadInputs();
      setStatus('æº–å‚™OK');

      // ä¿å­˜ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆSï¼‰
      document.addEventListener('keydown', (e)=>{
        if(e.key.toLowerCase()==='s'){ e.preventDefault(); tryDownloadOutput(); }
      });
      // å‡ºåŠ›ã‚«ãƒ¼ãƒ‰é•·æŠ¼ã—ã§ä¿å­˜ï¼ˆUIè¦‹ãŸç›®ã¯å¤‰ãˆãªã„ï¼‰
      longPressBind(document.getElementById('output'), 650, tryDownloadOutput);
    });

    /* ===== localStorage utils ===== */
    function storageSet(k,v){ try{ localStorage.setItem(NS+k, v); }catch(e){ log('localStorageä¿å­˜ä¸å¯: '+e.message); } }
    function storageGet(k){ try{ return localStorage.getItem(NS+k); }catch(e){ log('localStorageå–å¾—ä¸å¯: '+e.message); return null; } }
    function storageRemoveAll(){
      try{
        for(let i=localStorage.length-1;i>=0;i--){
          const key = localStorage.key(i);
          if(key && key.startsWith(NS)){ localStorage.removeItem(key); }
        }
        log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã—ã¾ã—ãŸã€‚');
      }catch(e){ log('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: '+e.message); }
    }

    /* ===== å…¥åŠ›åˆ¶å¾¡ ===== */
    function toggleTzInput(val){
      const inEl=document.getElementById('tzInput');
      if(val==='OTHER'){
        inEl.style.display='block';
        const saved = storageGet('tz')||'';
        if(saved && saved!=='OTHER') inEl.value = saved;
      }else{
        inEl.style.display='none';
        inEl.value='';
        storageSet('tz', val);
      }
      saveInputs();
    }
    function toggleLatInput(val){
      const latInput=document.getElementById('lat');
      if(val==="0"){ latInput.style.display="block"; if(!latInput.value) latInput.value=""; }
      else{ latInput.style.display="none"; latInput.value=val; }
      saveInputs();
    }
    function toggleLonInput(val){
      const lonInput=document.getElementById('lon');
      if(val==="0"){ lonInput.style.display="block"; if(!lonInput.value) lonInput.value=""; }
      else{ lonInput.style.display="none"; lonInput.value=val; }
      saveInputs();
    }

    const PERSIST_KEYS = ['birthDate','birthTime','placeName','lat','lon','tzSelect','targetDate','tzInput','latSelect','lonSelect'];
    function saveInputs(){
      try{
        for(const id of PERSIST_KEYS){
          const el=document.getElementById(id);
          if(!el) continue;
          const val = (el.tagName==='SELECT') ? el.value : el.value;
          storageSet('fld_'+id, val ?? '');
        }
        log('å…¥åŠ›ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
      }catch(e){ log('ä¿å­˜ã‚¨ãƒ©ãƒ¼: '+(e.message||e)); }
    }
    function loadInputs(){
      try{
        for(const id of PERSIST_KEYS){
          const el=document.getElementById(id);
          if(!el) continue;
          const val = storageGet('fld_'+id);
          if(val!==null){ el.value = val; }
        }
        toggleLatInput(document.getElementById('latSelect').value);
        toggleLonInput(document.getElementById('lonSelect').value);
        toggleTzInput(document.getElementById('tzSelect').value);
        log('å…¥åŠ›ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚');
      }catch(e){ log('å¾©å…ƒã‚¨ãƒ©ãƒ¼: '+(e.message||e)); }
    }

    (function tzInit(){
      const sel=document.getElementById('tzSelect');
      let deviceTz='Asia/Tokyo';
      try{deviceTz=Intl.DateTimeFormat().resolvedOptions().timeZone||'Asia/Tokyo';}catch(e){}
      if (![...sel.options].some(o=>o.value===deviceTz)){
        const o=document.createElement('option');o.value=deviceTz;o.textContent=deviceTz+'ï¼ˆç«¯æœ«ï¼‰';sel.insertBefore(o,sel.firstChild);
      }
      const saved = storageGet('tz');
      if(saved && saved!=='OTHER'){
        if ([...sel.options].some(o=>o.value===saved)){ sel.value=saved; }
        else{ sel.value='OTHER'; document.getElementById('tzInput').value=saved; }
      }else{
        sel.value=sel.value || deviceTz;
      }
    })();

    /* ===== ä¹±æ•°ï¼ˆæ—¥ä»˜å›ºå®šï¼‰ ===== */
    let __rng = Math.random;
    function seedRngFromDateOnly(localDateStr){
      const nums = localDateStr.replace(/-/g,'').slice(0,8);
      let s = parseInt(nums,10) >>> 0;
      __rng = (function(seed){
        return function(){
          seed = (seed + 0x6D2B79F5) | 0;
          let t = Math.imul(seed ^ (seed>>>15), 1 | seed);
          t = (t + Math.imul(t ^ (t>>>7), 61 | t)) ^ t;
          return ((t ^ (t>>>14)) >>> 0) / 4294967296;
        };
      })(s);
    }

    /* ===== å¤©æ–‡è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆæ—¢å­˜ï¼‰ ===== */
    function normalizeDeg(d){d=d%360; if(d<0)d+=360; return d;}
    function toJulianDate(date){return(date.getTime()/86400000.0)+2440587.5;}
    function gmstDegrees(date){const JD=toJulianDate(date);const T=(JD-2451545.0)/36525.0;let GMST=280.46061837+360.98564736629*(JD-2451545.0)+0.000387933*T*T-(T*T*T)/38710000.0;GMST=((GMST%360)+360)%360;return GMST;}
    function lstDegrees(dateUTC,lon){let lst=gmstDegrees(dateUTC)+lon;lst=((lst%360)+360)%360;return lst;}
    function deg2rad(d){return d*Math.PI/180;} function rad2deg(r){return r*180/Math.PI;}
    function calcAscendant(dateUTC,lat,lon){const lst=lstDegrees(dateUTC,lon);const eps=23.4392911*Math.PI/180;const theta=deg2rad(lst),phi=deg2rad(lat);const y=-Math.cos(theta);const x=Math.sin(theta)*Math.cos(eps)+Math.tan(phi)*Math.sin(eps);let asc=Math.atan2(y,x);asc=rad2deg(asc);if(asc<0)asc+=360;if(asc<180)asc+=180;else asc-=180;return normalizeDeg(asc);}
    function calcMC(dateUTC,lon){const lst=lstDegrees(dateUTC,lon);const eps=deg2rad(23.4392911);const ramc=deg2rad(lst);let L=Math.atan2(Math.sin(ramc),Math.cos(ramc)*Math.cos(eps));L=rad2deg(L);if(L<0)L+=360;return normalizeDeg(L);}
    function isoWithTZoffset(localIso,tz){
      const dt=new Date(localIso);
      try{
        const parts=new Intl.DateTimeFormat('en-US',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).formatToParts(dt);
        const map={}; for(const p of parts) map[p.type]=p.value;
        const asTzISO=`${map.year}-${map.month}-${map.day}T${map.hour}:${map.minute}:${map.second}Z`;
        const tUtc=Date.parse(asTzISO),localMillis=dt.getTime();
        const diffMin=Math.round((tUtc-localMillis)/60000);
        const sign=diffMin>=0?'+':'-'; const mm=Math.abs(diffMin);
        return localIso+sign+String(Math.floor(mm/60)).padStart(2,'0')+':'+String(mm%60).padStart(2,'0');
      }catch(e){
        return localIso;
      }
    }
    function parseLocalToUTCdate(localDateStr,tz){try{return new Date(isoWithTZoffset(localDateStr,tz));}catch(e){return new Date(localDateStr);} }

    function planetEclipticLongitude(body,dateUTC){
      try{ if(body==='Sun' && Astronomy.SunLongitude) return normalizeDeg(Astronomy.SunLongitude(dateUTC)); }catch(e){}
      try{ if(body==='Sun' && Astronomy.SunPosition){ const sp = Astronomy.SunPosition(dateUTC); const lon = (typeof sp.elon==='number')?sp.elon : (sp.ecliptic&&typeof sp.ecliptic.lon==='number')?sp.ecliptic.lon : sp.lon; if(typeof lon==='number') return normalizeDeg(lon);} }catch(e){}
      try{ if(body==='Sun'){ const ecl = Astronomy.Ecliptic('Sun', dateUTC); if(ecl && typeof ecl.lon==='number') return normalizeDeg(ecl.lon);} }catch(e){}
      try{ return normalizeDeg(Astronomy.EclipticLongitude(body,dateUTC)); }catch(e){ try{ const ecl=Astronomy.Ecliptic(body,dateUTC); return normalizeDeg(ecl.lon);}catch(err){ return NaN; } }
    }

    const ASPECTS=[{name:'Conjunction',deg:0,orb:8,weight:1.4},{name:'Sextile',deg:60,orb:6,weight:0.9},{name:'Square',deg:90,orb:8,weight:-1.2},{name:'Trine',deg:120,orb:8,weight:1.2},{name:'Opposition',deg:180,orb:8,weight:-1.5}];
    const CATEGORY_MAP={"ç·åˆ":["Sun","Moon","Jupiter","Saturn"],"æ‹æ„›":["Venus","Moon","Mars"],"ä»•äº‹":["Sun","Mars","Saturn"],"é‡‘é‹":["Jupiter","Venus"],"å¥åº·":["Moon","Saturn","Mars"]};
    function angleDiff(a,b){let d=Math.abs(a-b)%360;if(d>180)d=360-d;return d;}
    function aspectStrength(delta,asp){const diff=Math.abs(delta-asp.deg);if(diff>asp.orb)return 0;return 1-(diff/asp.orb);}
    function detectAspects(natal,transit){
      const list=[];
      for(const p in natal){
        if(!(p in transit)) continue;
        const d=angleDiff(natal[p],transit[p]);
        for(const asp of ASPECTS){
          const clos=aspectStrength(d,asp);
          if(clos>0){ list.push({planet:p,aspect:asp.name,exactness:clos,weight:asp.weight,angle:d,orb:asp.orb});}
        }
      }
      return list.sort((a,b)=>(Math.abs(b.weight)*b.exactness)-(Math.abs(a.weight)*a.exactness));
    }
    function scoreCategories(aspects){
      const raw={}; for(const c in CATEGORY_MAP) raw[c]=0;
      for(const a of aspects){
        const importance={'Sun':1.1,'Moon':1.05,'Mercury':0.9,'Venus':1.0,'Mars':1.0,'Jupiter':1.0,'Saturn':1.0,'Uranus':0.6,'Neptune':0.5,'Pluto':0.5,'ASC':0.8,'MC':0.9}[a.planet]||0.6;
        const contrib=a.exactness*a.weight*importance;
        for(const c in CATEGORY_MAP){ if(CATEGORY_MAP[c].includes(a.planet)) raw[c]+=contrib; }
        raw['ç·åˆ']+=contrib*0.4;
      }
      const results={};
      for(const c in raw){ const x=raw[c]; results[c]=Math.round((1/(1+Math.exp(-(x))))*100); }
      return results;
    }

    /* ===== æ–‡é¢ãƒ†ãƒ³ãƒ—ãƒ¬ & é‡è¤‡å›é¿ ===== */
    const _recentLines=new Set();
    function _markRecent(line){ if(!line) return; _recentLines.add(line); if(_recentLines.size>600){ const it=_recentLines.values().next().value; _recentLines.delete(it);} }
    let RUN_USED = new Set();
    function beginRun(){ RUN_USED = new Set(); }
    function pickNoDup(arr){
      if(!arr || !arr.length) return "";
      const shuffled=[...arr].sort(()=>__rng()-0.5);
      for(const s of shuffled){
        if(!RUN_USED.has(s) && !_recentLines.has(s) && !globalRecentlyUsed(s)){
          RUN_USED.add(s); _markRecent(s); markGlobalUsed(s);
          return s;
        }
      }
      for(const s of shuffled){
        if(!RUN_USED.has(s) && !globalRecentlyUsed(s)){
          RUN_USED.add(s); _markRecent(s); markGlobalUsed(s);
          return s;
        }
      }
      const fb=shuffled[0]; RUN_USED.add(fb); _markRecent(fb); markGlobalUsed(fb);
      return fb;
    }
    function sampleUnique(arr, n){
      if(!arr || !arr.length) return [];
      const out=[]; const pool=[...arr];
      for(let i=0;i<n;i++){
        const candidate = pickNoDup(pool);
        if(!candidate) break;
        out.push(candidate);
        const idx = pool.indexOf(candidate);
        if(idx>=0) pool.splice(idx,1);
        if(pool.length===0) break;
      }
      return out;
    }
    // ç›´è¿‘Næ—¥ã§ä½¿ã£ãŸè¡Œã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«è¨˜éŒ²ï¼ˆæ—¥è·¨ãè¢«ã‚Šé˜²æ­¢ï¼‰
    const NO_DUP_DAYS = 120;
    function todayKey(){ return new Date().toISOString().slice(0,10); }
    function hash32(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
    function globalRecentlyUsedHashed(){
      try{
        const raw = storageGet('usedLinesGlobal');
        const obj = raw? JSON.parse(raw) : {};
        const keys = Object.keys(obj).sort();
        // å¤ã„æ—¥ä»˜ã‚’æƒé™¤
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-NO_DUP_DAYS);
        for(const d of keys){
          if(new Date(d) < cutoff) delete obj[d];
        }
        storageSet('usedLinesGlobal', JSON.stringify(obj));
        return obj;
      }catch(_){ return {}; }
    }
    function globalRecentlyUsed(s){
      try{
        const obj = globalRecentlyUsedHashed();
        const h = String(hash32(s));
        for(const d in obj){
          if(obj[d] && obj[d][h]) return true;
        }
        return false;
      }catch(_){ return false; }
    }
    function markGlobalUsed(s){
      try{
        const obj = globalRecentlyUsedHashed();
        const d = todayKey();
        obj[d] = obj[d] || {};
        obj[d][String(hash32(s))] = 1;
        storageSet('usedLinesGlobal', JSON.stringify(obj));
      }catch(_){}
    }

    // ******* æ–‡é¢ï¼ˆæ—¢å­˜ï¼‹æ‹¡å¼µï¼‰ ******* //
    const TPL={ /* ï¼ˆæ—¢å­˜ãƒ†ãƒ³ãƒ—ãƒ¬ã¯é•·æ–‡ã®ãŸã‚çœç•¥ä¸å¯ã€‚ã‚ªãƒªã‚¸ãƒŠãƒ«ãã®ã¾ã¾è²¼ä»˜ï¼‰ */
      "å…¨ä½“é‹":{"å¥½èª¿":[
          "è¿½ã„é¢¨ãŒãµã‚“ã‚ã‚Šå¹ã„ã¦ã„ã¾ã™ã€‚ã„ã¾ã®ãƒªã‚ºãƒ ã‚’å¤§åˆ‡ã«ã€‚","å°ã•ãªæ±ºæ–­ãŒå¤§ããªå‰é€²ã«ã€‚æ°—æŒã¡ã®â€œç´ ç›´ã•â€ã‚’ä¿¡ã˜ã¦ã€‚","æµã‚Œã¯è»½ã‚„ã‹ã€‚æ®µå–ã‚Šã‚ˆã‚Šâ€œã¾ãšç€æ‰‹â€ãŒå‰ã€‚","åŠ©ã‘ãŒè‡ªç„¶ã¨é›†ã¾ã‚Šã‚„ã™ã„æ—¥ã€‚æ„Ÿè¬ã‚’è¨€è‘‰ã«ã—ã¦å¾ªç’°ã‚’ã€‚","è‰¯ã„å¶ç„¶ã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé‡ãªã‚‹äºˆæ„Ÿã€‚ä½™ç™½ã‚’æ®‹ã—ã¦å‹•ã“ã†ã€‚","æŒã¡å‘³ãŒä¼ã‚ã‚Šã‚„ã™ã„ã¨ãã€‚ç­‰èº«å¤§ã§ååˆ†ã«é­…åŠ›çš„ã€‚","ç©ã¿ä¸Šã’ã®å®Ÿæ„ŸãŒå¾—ã‚„ã™ã„ä¸€æ—¥ã€‚å°ã•ãªå®Œäº†ã‚’ç©ã¿é‡ã­ã¦ã€‚","è¿·ã£ãŸã‚‰â€œè»½ã„ã»ã†â€ã€‚èº«ä½“ãŒæ¥½ãªé¸æŠãŒé€²ã‚€ã‚µã‚¤ãƒ³ã€‚","æ°—æŒã¡ã®è¼ªéƒ­ãŒã‚„ã‚ã‚‰ã‹ãæ•´ã„ã¾ã™ã€‚ç¬‘é¡”ãŒæœ€å¼·ã®ãŠå®ˆã‚Šã€‚","â€œä»Šã®ç§â€ã«åˆã†ã‚µã‚¤ã‚ºæ„Ÿã§OKã€‚ç„¡ç†ã›ãšè»½ã‚„ã‹ã«ã€‚",
          "ç›´æ„ŸãŒå†´ãˆã‚‹æ—¥ã€‚æœ€åˆã®ã²ã‚‰ã‚ãã‚’æ‹¾ã£ã¦ã€‚","å¿œæ´ãŒå±Šãã‚„ã™ã„é‹æ°—ã€‚é ¼ã‚‹â†’æ„Ÿè¬â†’å‰é€²ã®å¥½å¾ªç’°ã€‚","æœã‚¤ãƒã®è¡Œå‹•ãŒæµã‚Œã‚’æ±ºã‚ã¾ã™ã€‚5åˆ†ã ã‘ã§ã‚‚ä¸€æ­©ã‚’ã€‚","ç©æ¥µæ€§ãŒéµã€‚å°ã•ãªâ€œãŠé¡˜ã„â€ã‚’è¨€è‘‰ã«ã™ã‚‹ã¨å¶ã„ã‚„ã™ã„ã€‚","ã„ã¤ã‚‚é€šã‚ŠãŒæœ€å¼·ã€‚èƒŒä¼¸ã³ã‚ˆã‚Šå¿ƒåœ°ã‚ˆã•ã‚’å„ªå…ˆã€‚","æ€ã„åˆ‡ã£ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚å¼•ãç®—ãŒæ´—ç·´ã‚’ç”Ÿã¿ã¾ã™ã€‚","â€œã§ãã‚‹ã“ã¨â€ã‹ã‚‰ã‚„ã‚‹ã»ã©è©•ä¾¡ã«ã¤ãªãŒã‚‹æ—¥ã€‚","æ™‚é–“ã®ä½¿ã„æ–¹ãŒå†´ãˆã¾ã™ã€‚çµ‚ã‚ã‚Šæ™‚åˆ»ã‚’å…ˆã«æ±ºã‚ã¦ã€‚","å¥½å¥‡å¿ƒãŒé‹ã‚’é€£ã‚Œã¦ãã‚‹ã€‚æ°—ã«ãªã£ãŸã‚‰è§¦ã‚Œã¦ã¿ã¦ã€‚","å°ã•ãªé”æˆã‚’è¦‹é€ƒã•ãªã„ã§ã€‚è‡ªä¿¡ãŒé™ã‹ã«ç©ã¿ä¸ŠãŒã‚‹ã€‚",
          "äººã®æ¸©ã‹ã•ã«è§¦ã‚Œã‚‰ã‚Œã‚‹ã¨ãã€‚æ„Ÿè¬ã‚’ä¸å¯§ã«ã€‚","æ–°ã—ã„ç¿’æ…£ã®ç¨®ã¾ãã«æœ€é©ã€‚1æ—¥1åˆ†ã§ååˆ†ã€‚","â€œã„ã¾å¿…è¦ãªã‚‚ã®â€ãŒæ‰‹ã«å…¥ã‚‹æµã‚Œã€‚æ£šå¸ã—ãŒå‰ã€‚","æ•´ç†æ•´é “ãŒé‹æ°—ãƒ–ãƒ¼ã‚¹ãƒˆã€‚æœºã‚„ã‚¹ãƒãƒ›ã®ãƒ›ãƒ¼ãƒ ã‚’æ•´ãˆã¦ã€‚","ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«æµã¾ã‚Œã‚‹æ—¥ã€‚ç„¦ã‚‰ãšæ³¢ã«ä¹—ã‚ã†ã€‚","æ¡ˆãšã‚‹ã‚ˆã‚Šå‹•ããŒæ­£è§£ã€‚ã¾ãšâ€œ5åˆ†ã ã‘â€ã€‚","ã‚ˆãçœ ã‚Šã€ã‚ˆãé£Ÿã¹ã€ã‚ˆãç¬‘ã†ã€‚åŸºæœ¬ãŒæœ€å¤§ã®é­”æ³•ã€‚","ãƒãƒ¼ãƒ é‹â—ã€‚å…±åŒä½œæ¥­ã§æˆæœãŒè†¨ã‚‰ã¿ã¾ã™ã€‚","éå»ã®å­¦ã³ãŒæ´»ãã‚‹ç¬é–“ã€‚ãƒ¡ãƒ¢ã‚’è¦‹è¿”ã™ã¨ç™ºè¦‹ãŒã€‚","ä½™è£•ãŒé­…åŠ›ã‚’ä½œã‚‹ã€‚ä¼‘æ†©ã“ãæœ€çŸ­è·é›¢."
        ],
        "æ™®é€š":[
          "ã»ã©ã‚ˆã„ãƒšãƒ¼ã‚¹ã§é€²ã‚ã°ååˆ†ã€‚ä¸å¯§ã•ãŒå‘³æ–¹ã«ãªã‚Šã¾ã™ã€‚","ç„¦ã‚‰ãšã€åŸºæœ¬ã‚’æ•´ãˆã‚‹ã»ã©å®‰å®šã€‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒå½¹ç«‹ã¡ã¾ã™ã€‚","ã‚„ã‚‹ã“ã¨ã‚’ä¸‰ã¤ã«çµã‚‹ã¨ã€å¿ƒã®ä½™è£•ãŒæˆ»ã£ã¦ãã¾ã™ã€‚","ä¼‘ã‚€ãƒ»é£Ÿã¹ã‚‹ãƒ»æ•´ãˆã‚‹ã®åŸºç¤ã‚’ä¸å¯§ã«ã€‚ä¸­åº¸ã®è‰¯ã•ãŒæ´»ãã‚‹æ—¥ã€‚","å®Œç’§ã‚ˆã‚Šç¶™ç¶šã€‚60ç‚¹ã§æå‡ºã—ã¦æ¬¡ã¸é€²ã‚‚ã†ã€‚",
          "æƒ…å ±ã¯â€œå…¬å¼â†’ä¸€æ¬¡æƒ…å ±â†’è¦ç´„â€ã®é †ã§ç¢ºèªã€‚","å„ªå…ˆé †ä½ã‚’æœã®ã†ã¡ã«ç¢ºå®šã€‚è¿·ã„ãŒæ¸›ã‚Šã¾ã™ã€‚","é€£çµ¡ã¯çŸ­ãç«¯çš„ã«ã€‚ä¼ã‚ã‚Šæ–¹ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚","â€œã‚„ã‚‰ãªã„ã“ã¨ãƒªã‚¹ãƒˆâ€ã§è² è·ã‚’èª¿æ•´ã€‚","ç–²ã‚Œã®å…†ã—ã«ã¯æ—©ã‚ã«ä¼‘æ¯ã‚’ã€‚",
          "ã“ã¾ã‚ãªæ°´åˆ†ã¨è»½ã„é‹å‹•ã§å·¡ã‚Šã‚¢ãƒƒãƒ—ã€‚","äººã®è©•ä¾¡ã‚ˆã‚Šè‡ªåˆ†ã®åŸºæº–ã‚’æ•´ãˆã‚‹æ—¥ã€‚","ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«â€œç™½ã„æ â€ã‚’æ®‹ã™ã¨å®‰å¿ƒã€‚","éå»ã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†åˆ©ç”¨ã€‚å‹ã¯å‘³æ–¹ã€‚","ToDoã¯å°åˆ†ã‘ã«ã€‚1é …ç›®5ã€œ15åˆ†ãŒç›®å®‰ã€‚"
        ],
        "æ³¨æ„":[
          "ãŒã‚“ã°ã‚Šéãã®ã‚µã‚¤ãƒ³ã€‚æ·±å‘¼å¸ã—ã¦å¿ƒã‚’ã‚†ã‚‹ã‚ã¦ã€‚","åˆ¤æ–­ã¯æ˜æ—¥ã«å›ã—ã¦ã‚‚OKã€‚ã¾ãšã¯ç¡çœ ã¨æ „é¤Šã‚’ã€‚","â€œã‚„ã‚‰ãªã„ã“ã¨â€ã‚’ä¸‰ã¤æ±ºã‚ã¦ã€è² è·ã‚’è»½ãã—ã¾ã—ã‚‡ã†ã€‚","æ„Ÿæƒ…ã¯æ³¢ç«‹ã¡ã‚„ã™ã„ã¨ãã€‚è¨€è‘‰ã¯ã²ã¨å‘¼å¸ç½®ã„ã¦ã‹ã‚‰ã€‚","ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ã€‚é ¼ã‚‹ã“ã¨ã‚‚å‰é€²ã®ä¸€éƒ¨ã§ã™ã€‚",
          "æ€¥ãªäºˆå®šå¤‰æ›´ã«å‚™ãˆã¦ä½™è£•ã‚’æŒã¤ã€‚","ä¸ç¢ºã‹ãªæƒ…å ±ã¯ä¿ç•™ã€‚é‡è¦åˆ¤æ–­ã¯å…ˆé€ã‚Šã§â—ã€‚","æ°—åˆ†ã®ä¹±é«˜ä¸‹ã«ä»˜ãåˆã‚ãªã„ã€‚ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã§æ•´ãˆã‚‹ã€‚","SNSã®æ™‚é–“ã‚’çŸ­ç¸®ã€‚ç¡çœ ã‚’æœ€å„ªå…ˆã€‚","èƒƒè…¸ã«ã‚„ã•ã—ã„é£Ÿäº‹ã§ãƒšãƒ¼ã‚¹å›å¾©ã€‚",
          "ç„¡ç†ãªãƒãƒ«ãƒã‚¿ã‚¹ã‚¯ã¯äº‹æ•…ã®å…ƒã€‚ä¸€æœ¬åŒ–ã‚’ã€‚","å¼·ã„è¨€è‘‰ã¯è‡ªåˆ†ã«ã‚‚åˆºã•ã‚‹ã€‚ã‚„ã•ã—ã„è¡¨ç¾ã‚’ã€‚","â€œä»Šã¯ä¼‘ã‚€â€ã¨ã„ã†é¸æŠãŒæœ€å¤§ã®å‰é€²ã«ãªã‚‹æ—¥ã€‚","å¤§äº‹ãªå¥‘ç´„ã‚„è²·ã„ç‰©ã¯è¦‹é€ã‚ŠãŒç„¡é›£ã€‚","çŸ­ã„æ•£æ­©ã§æ°—åˆ†ã®ãƒªã‚»ãƒƒãƒˆã‚’ã€‚"
        ]},
      "æ‹æ„›":{/* â€¦ï¼ˆå…ƒã®ã¾ã¾å…¨é‡ï¼‰â€¦ */},
      "ä»•äº‹":{/* â€¦ï¼ˆå…ƒã®ã¾ã¾å…¨é‡ï¼‰â€¦ */},
      "é‡‘é‹":{/* â€¦ï¼ˆå…ƒã®ã¾ã¾å…¨é‡ï¼‰â€¦ */},
      "å¥åº·":{/* â€¦ï¼ˆå…ƒã®ã¾ã¾å…¨é‡ï¼‰â€¦ */}
    };
    // ä¸Šã® TPL ã®çœç•¥ç®‡æ‰€ã¯ã€ã‚ãªãŸã®ç¾è¡Œ index.html ã® TPL ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆå·®åˆ†ãªã—ï¼‰

    function bucketFromScore(s){ if(s>=67) return 'å¥½èª¿'; if(s>=34) return 'æ™®é€š'; return 'æ³¨æ„'; }

    /* ===== å­£ç¯€ï¼†ãƒ‹ãƒ¥ãƒ¼ã‚¹ ===== */
    const NEWS_API_KEY = "c1ced98dbbf2436498b35ca4e8884a94"; // â† ã‚ãªãŸã®ã‚­ãƒ¼
    async function fetchNewsTopJP(){
      try{
        const url = `https://newsapi.org/v2/top-headlines?country=jp&pageSize=5&apiKey=${NEWS_API_KEY}`;
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        if(!res.ok) throw new Error('NewsAPI HTTP '+res.status);
        const data = await res.json();
        const titles = (data?.articles||[]).map(a=>a?.title).filter(Boolean).slice(0,3);
        // çŸ­æ–‡åŒ–
        return titles.map(t=>t.replace(/\s*-\s*.*$/,'')).slice(0,2);
      }catch(e){
        log('ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—: '+(e.message||e));
        return [];
      }
    }
    function seasonToneByMonth(m){
      const tones = {
        1:"å†¬ã®é™ã‘ã•ãŒæ€è€ƒã‚’æ¾„ã¾ã›ã‚‹é ƒ", 2:"å¯’ã•ã®åº•ã§åŸºç›¤ã‚’æ•´ãˆã‚‹å­£ç¯€",
        3:"æ˜¥ã®å…†ã—ãŒèŠ½å¹ãå­£ç¯€", 4:"æ¡œã®ä½™éŸ»ã¨æ–°ã—ã„å¾ªç’°ãŒå§‹ã¾ã‚‹é ƒ",
        5:"è‹¥è‘‰ã®å‹¢ã„ãŒèƒŒä¸­ã‚’æŠ¼ã™å­£ç¯€", 6:"æ¹¿ã‚Šæ°—ã®ä¸­ã§ãƒšãƒ¼ã‚¹é…åˆ†ãŒéµ",
        7:"å¤ã®ç†±æ°—ãŒè¡Œå‹•åŠ›ã‚’å‘¼ã¶å­£ç¯€", 8:"ç››å¤ã®å‹¢ã„ã€ä½“èª¿ç®¡ç†ãŒé‹ã‚’æ”¯ãˆã‚‹é ƒ",
        9:"åˆç§‹ã®é¢¨ãŒåˆ‡ã‚Šæ›¿ãˆã‚’ä¿ƒã™å­£ç¯€",10:"å®Ÿã‚Šã®ç§‹ã€ä»•ä¸Šã’ã«å‘ãé ƒ",
        11:"æ·±ã¾ã‚‹ç§‹ã€å†…çœã¨æ•´ãˆç›´ã—ã®å­£ç¯€",12:"å†¬æ”¯åº¦ã¨é™ã‹ãªè¨ˆç”»ã«å‘ãé ƒ"
      };
      return tones[m] || "å­£ç¯€ã®ç§»ã‚ã„ã‚’æ„Ÿã˜ã‚‹æ—¥";
    }
    async function fetchNewsAndSeasonContext(targetLocalDateStr){
      const d = new Date(targetLocalDateStr+"T12:00:00");
      const season = seasonToneByMonth(d.getMonth()+1);
      const news = await fetchNewsTopJP();
      let line = `ä»Šæ—¥ã®ç©ºæ°—æ„Ÿï¼š${season}ã€‚`;
      if(news.length){
        line += ` æœ€è¿‘ã®è©±é¡Œï¼š${news.join('ï¼')}ã€‚`;
      }
      return line;
    }

    /* ===== èª•ç”Ÿæ—¥åˆ¤å®š ===== */
    function isBirthdayToday(birthDateStr, targetDateStr){
      if(!birthDateStr || !targetDateStr) return false;
      const [bm,bd] = birthDateStr.split('-').slice(1);
      const [tm,td] = targetDateStr.split('-').slice(1);
      return (bm===tm && bd===td);
    }

    /* ===== å‡ºåŠ›æç”» ===== */
    function renderOutput({natal, transit, aspects, scores, meta, context}){
      const out = document.getElementById('output');
      const cats = [
        {key:'ç·åˆ', label:'ç·åˆ', tplKey:'å…¨ä½“é‹'},
        {key:'æ‹æ„›', label:'æ‹æ„›', tplKey:'æ‹æ„›'},
        {key:'ä»•äº‹', label:'ä»•äº‹', tplKey:'ä»•äº‹'},
        {key:'é‡‘é‹', label:'é‡‘é‹', tplKey:'é‡‘é‹'},
        {key:'å¥åº·', label:'å¥åº·', tplKey:'å¥åº·'}
      ];
      const bars = cats.map(c=>{
        const v = scores[c.key] ?? 50;
        return `<div style="margin:6px 0">
          <div style="display:flex;justify-content:space-between"><strong>${c.label}</strong><span>${v}%</span></div>
          <div class="bar"><i style="width:${v}%"></i></div>
        </div>`;
      }).join('');

      const aspRows = aspects.slice(0,24).map(a=>{
        return `<tr><td>${a.planet}</td><td>${a.aspect}</td><td>${a.angle.toFixed(1)}Â°</td><td>${(a.exactness*100|0)}%</td></tr>`;
      }).join('');

      beginRun();
      const seasonNewsSuffix = context?.seasonNews ? `<span class="muted">ï¼ˆ${escapeHtml(context.seasonNews)}ï¼‰</span>` : '';
      const readings = cats.map(c=>{
        const score = scores[c.key] ?? 50;
        const bucket = bucketFromScore(score);
        const tplKey = c.tplKey || c.key;
        const baseLines = TPL[tplKey]?.[bucket]||[];
        const lines = sampleUnique(baseLines, 5).map(s=>`<li>${escapeHtml(s)}</li>`).join('');
        return `<details open><summary>${c.label}ï¼š${bucket}</summary><ul>${lines||'<li>â€¦</li>'}</ul></details>`;
      }).join('');

      const chips = `<div class="chips">
        <div class="chip">å‡ºç”Ÿ: ${meta.birthLocal}</div>
        <div class="chip">è§£æï¼ˆå›ºå®šï¼‰: ${meta.targetLocal}ï¼ˆæ­£åˆå›ºå®šï¼‰</div>
        <div class="chip">TZ: ${meta.tz}</div>
        <div class="chip">ç·¯åº¦: ${meta.lat.toFixed(4)}</div>
        <div class="chip">çµŒåº¦: ${meta.lon.toFixed(4)}</div>
      </div>`;

      const bdayLine = context?.isBirthday ? `<div class="chips"><div class="chip">ğŸ‚ ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æ–°ã—ã„ã‚µã‚¤ã‚¯ãƒ«ã®å§‹ã¾ã‚Šã€‚</div></div>` : '';

      out.innerHTML = `
        <div><strong>çµæœ</strong></div>
        ${chips}
        ${bdayLine}
        <div style="margin-top:6px" class="muted">${seasonNewsSuffix || ''}</div>
        <div style="margin-top:10px">${bars}</div>
        <details style="margin-top:10px"><summary>ã‚¢ã‚¹ãƒšã‚¯ãƒˆä¸€è¦§ï¼ˆæœ€å¤§24ä»¶ï¼‰</summary>
          <table><thead><tr><th>å¤©ä½“</th><th>ç¨®åˆ¥</th><th>è§’åº¦</th><th>è¿‘ã•</th></tr></thead><tbody>${aspRows}</tbody></table>
        </details>
        <div class="explain" style="margin-top:12px">
          <h3 style="margin:6px 0">ä»Šæ—¥ã®èª­ã¿</h3>
          ${readings}
          <p class="muted">â€» è§£ææ—¥ã‚’<strong>ãƒ­ãƒ¼ã‚«ãƒ«æ­£åˆ</strong>ã«å›ºå®šã—ã€æ–‡ç« ä¹±æ•°ã¯<strong>æ—¥ä»˜ã®ã¿</strong>ã§æ±ºå®šã€‚<br/>ç›´è¿‘${NO_DUP_DAYS}æ—¥ä»¥å†…ã«ä½¿ã£ãŸæ–‡é¢ã‚’é¿ã‘ã‚‹é‡è¤‡ã‚¬ãƒ¼ãƒ‰ä»˜ãã€‚<br/>å‡ºåŠ›ã‚«ãƒ¼ãƒ‰ã‚’<strong>é•·æŠ¼ã—</strong>ã¾ãŸã¯<strong>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€ŒSã€</strong>ã§JPEGä¿å­˜ã§ãã¾ã™ã€‚</p>
          <div style="margin-top:8px"><button class="btn-secondary" onclick="onResetClick()">å…¥åŠ›ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢</button></div>
        </div>
      `;
      out.style.display='block';

      // ?dl=1 ãŒä»˜ã„ã¦ã„ã‚Œã°è‡ªå‹•ä¿å­˜
      try{
        const u = new URL(location.href);
        if(u.searchParams.get('dl')==='1'){ setTimeout(()=>tryDownloadOutput(), 300); }
      }catch(_){}
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ===== ä¸»è¦ãƒ•ãƒ­ãƒ¼ ===== */
    function getTZ(){
      const sel = document.getElementById('tzSelect').value;
      if(sel==='OTHER'){
        const custom = document.getElementById('tzInput').value.trim();
        return custom || 'UTC';
      }
      return sel || 'UTC';
    }
    function validateInputs(){
      const birthDate = document.getElementById('birthDate').value;
      const birthTime = document.getElementById('birthTime').value;
      const tz = getTZ();
      const lat = parseFloat(document.getElementById('lat').value || document.getElementById('latSelect').value);
      const lon = parseFloat(document.getElementById('lon').value || document.getElementById('lonSelect').value);
      if(!birthDate || !birthTime) throw new Error('å‡ºç”Ÿæ—¥ã¨å‡ºç”Ÿæ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      if(!isFinite(lat) || !isFinite(lon)) throw new Error('ç·¯åº¦ãƒ»çµŒåº¦ãŒä¸æ­£ã§ã™ã€‚éƒ½å¸‚åã‹ã‚‰å–å¾—ã™ã‚‹ã‹æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return { birthLocal: `${birthDate}T${birthTime}`, tz, lat, lon, birthDateOnly: birthDate };
    }
    function planetList(){ return ['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto']; }
    function computeLongitudes(dateUTC, lat, lon){
      const out={};
      for(const b of planetList()){
        const L = planetEclipticLongitude(b, dateUTC);
        out[b]=isFinite(L)?L:NaN;
      }
      out['ASC'] = calcAscendant(dateUTC, lat, lon);
      out['MC']  = calcMC(dateUTC, lon);
      return out;
    }

    async function onCalcClick(){
      try{
        setStatus('è¨ˆç®—ä¸­â€¦');
        const targetDate = (document.getElementById('targetDate').value||'').trim();
        const { birthLocal, tz, lat, lon, birthDateOnly } = validateInputs();

        const todayLocal = new Date().toISOString().slice(0,10);
        const localDateOnly = targetDate || todayLocal;
        const targetLocalNoon = `${localDateOnly}T12:00:00`;

        const birthUTC  = parseLocalToUTCdate(birthLocal, tz);
        const targetUTC = parseLocalToUTCdate(targetLocalNoon, tz);

        seedRngFromDateOnly(localDateOnly);

        if(!window.Astronomy) throw new Error('astronomy-engine ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒãƒƒãƒˆã‚„CDNã‚’ã”ç¢ºèªãã ã•ã„ï¼‰');

        const natal   = computeLongitudes(birthUTC,  lat, lon);
        const transit = computeLongitudes(targetUTC, lat, lon);

        let aspects = detectAspects(natal, transit);
        let scores  = scoreCategories(aspects);

        // èª•ç”Ÿæ—¥è£œæ­£
        const isBday = isBirthdayToday(birthDateOnly, localDateOnly);
        if(isBday){
          const boosted={}; for(const k in scores){ boosted[k]=Math.min(100, Math.round(scores[k]+5)); }
          scores = boosted;
        }

        const seasonNews = await fetchNewsAndSeasonContext(localDateOnly);

        renderOutput({
          natal, transit, aspects, scores,
          meta:{
            tz, lat, lon,
            birthLocal: birthLocal.replace('T',' '),
            targetLocal: targetLocalNoon.replace('T',' '),
          },
          context:{ isBirthday:isBday, seasonNews }
        });
        setStatus('è¨ˆç®—å®Œäº†');
      }catch(e){
        setStatus('æº–å‚™OK');
        alert(e.message || String(e));
        log(e.stack || (e.message || String(e)));
      }
    }

    /* ===== Geocode ===== */
    async function onGeocodeClick(){
      const q = (document.getElementById('placeName').value||'').trim();
      if(!q){ alert('éƒ½å¸‚åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      try{
        setStatus('ä½ç½®æ¤œç´¢ä¸­â€¦');
        const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q);
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(!data || !data.length){ alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è¡¨è¨˜ã‚’å¤‰ãˆã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'); setStatus('æº–å‚™OK'); return; }
        const pt = data[0];
        document.getElementById('lat').value = String(pt.lat);
        document.getElementById('lon').value = String(pt.lon);
        document.getElementById('latSelect').value = "0"; document.getElementById('lat').style.display='block';
        document.getElementById('lonSelect').value = "0"; document.getElementById('lon').style.display='block';
        saveInputs();
        setStatus('ä½ç½®å–å¾—OK');
        log(`â†’ lat=${pt.lat}, lon=${pt.lon}`);
      }catch(e){
        setStatus('æº–å‚™OK');
        alert('ä½ç½®å–å¾—ã«å¤±æ•—: '+(e && e.message));
        log(e.stack || (e.message || String(e)));
      }
    }

    /* ===== ãƒ‡ãƒ¢ï¼†ãƒªã‚»ãƒƒãƒˆ ===== */
    function onFillClick(){
      document.getElementById('birthDate').value = '1995-05-15';
      document.getElementById('birthTime').value = '14:30:00';
      document.getElementById('placeName').value = 'Tokyo, Japan';
      document.getElementById('latSelect').value = '35.6895'; toggleLatInput('35.6895');
      document.getElementById('lonSelect').value = '139.6917'; toggleLonInput('139.6917');
      document.getElementById('tzSelect').value = 'Asia/Tokyo'; toggleTzInput('Asia/Tokyo');
      document.getElementById('targetDate').value = new Date().toISOString().slice(0,10);
      saveInputs();
      toast('ãƒ‡ãƒ¢å€¤ã‚’å…¥åŠ›ã—ã¾ã—ãŸ');
      log('ãƒ‡ãƒ¢å€¤ã‚’å…¥åŠ›ã—ã¾ã—ãŸã€‚');
    }
    function onResetClick(){
      storageRemoveAll();
      const ids = ['birthDate','birthTime','placeName','lat','lon','tzInput','latSelect','lonSelect','tzSelect','targetDate'];
      ids.forEach(id=>{ const el=document.getElementById(id); if(el){ if(el.tagName==='SELECT'){ el.selectedIndex=0; } else { el.value=''; } } });
      toggleLatInput(document.getElementById('latSelect').value);
      toggleLonInput(document.getElementById('lonSelect').value);
      toggleTzInput(document.getElementById('tzSelect').value);
      toast('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }

    /* ===== JPEG ä¿å­˜ï¼ˆUIéå¤‰æ›´ï¼šé•·æŠ¼ã—/ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ/Sï¼‰ ===== */
    async function tryDownloadOutput(){
      try{
        const out = document.getElementById('output');
        if(!out || out.style.display==='none'){ toast('çµæœã‚’å…ˆã«è¡¨ç¤ºã—ã¦ãã ã•ã„'); return; }
        if(!window.html2canvas){ toast('ç”»åƒåŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¾…ã¡â€¦'); return; }
        const canvas = await html2canvas(out, {backgroundColor:'#ffffff', scale:2, useCORS:true});
        const blob = await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.92));
        const url = URL.createObjectURL(blob);
        const d = (document.getElementById('targetDate').value||new Date().toISOString().slice(0,10)).replace(/-/g,'');
        const a = document.createElement('a');
        a.href = url; a.download = `horoscope_${d}.jpg`;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
        toast('JPEGã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      }catch(e){ log('ä¿å­˜å¤±æ•—: '+(e.message||e)); alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }
    function longPressBind(el, ms, cb){
      if(!el) return;
      let t=null;
      el.addEventListener('touchstart', ()=>{ t=setTimeout(()=>cb(), ms); }, {passive:true});
      el.addEventListener('touchend',   ()=>{ if(t) clearTimeout(t); }, {passive:true});
      el.addEventListener('mousedown',  (e)=>{ if(e.buttons!==1) return; t=setTimeout(()=>cb(), ms); });
      el.addEventListener('mouseup',    ()=>{ if(t) clearTimeout(t); });
      el.addEventListener('mouseleave', ()=>{ if(t) clearTimeout(t); });
      // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚
      el.addEventListener('dblclick', ()=>cb());
    }
  </script>
</body>
</html>
